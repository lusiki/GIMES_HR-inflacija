print(head(freq, 20))
# ------------------------------------------------------------------------------
# SAVE
# ------------------------------------------------------------------------------
message("\n=== SAVING ===")
# Select final columns
dt_final <- dt[, .(
DATE,
FROM,
URL,
TITLE,
FULL_TEXT,
MENTION_SNIPPET,
SOURCE_TYPE,
AUTHOR,
source_category,
text_length,
matched_terms,
REACH,
INTERACTIONS
)]
# Save RDS
write_path_rds <- "C:/Users/lsikic/Desktop/polarization_filtered.rds"
saveRDS(dt_final, write_path_rds)
message("Saved RDS: ", write_path_rds)
# Save Excel for QC
library(openxlsx)
write_path_xlsx <- "C:/Users/lsikic/Desktop/polarization_filtered.xlsx"
dt_excel <- copy(dt_final)
message("Saving all ", format(nrow(dt_excel), big.mark = ","), " rows to Excel...")
# Truncate FULL_TEXT for Excel (too large)
#dt_excel[, FULL_TEXT := substr(FULL_TEXT, 1, 500)]
write.xlsx(dt_excel, write_path_xlsx, overwrite = TRUE)
message("Saved Excel: ", write_path_xlsx)
message("\n=== DONE ===")
# ==============================================================================
# SOCIAL TRUST & OPTIMISM ARTICLE SEARCH - REGEX VERSION
# ==============================================================================
library(duckdb)
library(DBI)
# ------------------------------------------------------------------------------
# CONNECTION
# ------------------------------------------------------------------------------
duckdb_file_path <- "C:/Users/lsikic/Luka C/DetermDB/determDB.duckdb"
con <- dbConnect(duckdb::duckdb(), dbdir = duckdb_file_path, read_only = TRUE)
dbExecute(con, "SET memory_limit='48GB';")
message("Connected to database")
# ------------------------------------------------------------------------------
# SOCIAL TRUST REGEX PATTERN
# ------------------------------------------------------------------------------
trust_regex <- paste0(
"(",
# --- CONFIDENCE/TRUST INDICES ---
"indeks (povjerenja|optimizma|pesimizma|raspolo[zž]enja)|",
"indeks potro[sš]a[cč]kog (povjerenja|optimizma|raspolo[zž]enja)|",
"barometar (povjerenja|optimizma|raspolo[zž]enja)|",
# --- EUROBAROMETER & MAJOR SURVEYS ---
"eurobarometar|",
"europsko dru[sš]tveno istra[zž]ivanj|",
"europsko istra[zž]ivanje vrijednosti|",
"gallup|",
"ipsos.+(povjerenje|optimizam|zadovoljstvo|gra[dđ]an)|",
"promocija plus.+(povjerenje|optimizam|zadovoljstvo|gra[dđ]an)|",
# --- INSTITUTIONAL TRUST ---
"povjerenje u (institucije|vladu|sabor|predsjednika|sudstvo|pravosu[dđ]e|policiju|vojsku|medije|crkvu|eu)|",
"(ne)?povjerenje (gra[dđ]ana|javnosti|stanovni[sš]tva) u|",
"(rast|pad|gubitak|kriza) povjerenja|",
# --- LIFE SATISFACTION (survey term) ---
"zadovoljstvo [zž]ivotom|",
"zadovoljstvo (standardom|kvalitetom [zž]ivota)|",
"kvalitet[aeu]+ [zž]ivota.+(istra[zž]ivanj|anket|indeks|posto)|",
"[zž]ivotn[aeiou]+ (uvjet[aei]?|standard).+(istra[zž]ivanj|anket|indeks|posto)|",
# --- SOCIAL MOOD/SENTIMENT (collective) ---
"dru[sš]tven[aeiou]+ raspolo[zž]enj|",
"raspolo[zž]enje (gra[dđ]ana|javnosti|stanovni[sš]tva|u dru[sš]tvu)|",
"op[cć][aeiou]+ raspolo[zž]enj|",
"atmosfera u dru[sš]tvu|",
# --- COLLECTIVE OPTIMISM/PESSIMISM ---
"(optimizam|pesimizam) (gra[dđ]ana|javnosti|stanovni[sš]tva|hrvata|u hrvatskoj)|",
"(gra[dđ]ani|hrvati|stanovni[sš]tvo|javnost).+(optimisti[cč]n|pesimisti[cč]n)|",
"(ve[cć]ina|manjina|polovica|tre[cć]ina).+(optimisti[cč]n|pesimisti[cč]n|zadovolj|nezadovolj)|",
# --- COLLECTIVE SATISFACTION/DISSATISFACTION ---
"(ne)?zadovoljstvo (gra[dđ]ana|javnosti|stanovni[sš]tva)|",
"(gra[dđ]ani|hrvati|stanovni[sš]tvo).+(zadovolj|nezadovolj)|",
# --- FEAR/WORRY (collective, with survey context) ---
"(strah|zabrinutost|tjeskoba) (gra[dđ]ana|javnosti|stanovni[sš]tva)|",
"(gra[dđ]ani|hrvati|stanovni[sš]tvo).+(strahuju|zabrinuti|boje se)|",
"(ve[cć]ina|manjina|posto).+(strahuje|zabrinut|boji se)|",
# --- SOCIAL COHESION ---
"dru[sš]tven[aeiou]+ kohezij|",
"socijalna kohezij|",
"dru[sš]tven[aeiou]+ solidarnost|",
"dru[sš]tven[aeiou]+ povjerenj|",
"me[dđ]uljudsk[aeiou]+ povjerenj|",
# --- FUTURE OUTLOOK (collective) ---
"(o[cč]ekivanja|izgledi|perspektiv[aeu]) (gra[dđ]ana|za hrvatsku|za budu[cć]nost)|",
"(gra[dđ]ani|hrvati|stanovni[sš]tvo).+(o[cč]ekuju|vjeruju|smatraju).+(budu[cć]nost|bolje|lo[sš]ije)|",
"budu[cć]nost hrvatske.+(optimiz|pesimiz|istra[zž]ivanj)|",
# --- SURVEY RESULTS ON SENTIMENT ---
"(anket[aeu]?|istra[zž]ivanj[aeu]?) (pokazuje|pokazalo|otkriva|otkriva).+(zadovolj|optimiz|pesimiz|povjerenj|strah)|",
"prema (anketi|istra[zž]ivanju).+(zadovolj|optimiz|pesimiz|povjerenj)|",
"rezultati (ankete|istra[zž]ivanja).+(zadovolj|optimiz|pesimiz|povjerenj)|",
# --- PERCENTAGE + SENTIMENT ---
"[0-9]+.?posto.+(zadovolj|nezadovolj|optimist|pesimist|vjeruje|ne vjeruje|smatra)|",
"(ve[cć]ina|manjina|polovica).+(gra[dđ]ana|ispitanika|hrvata).+(zadovolj|optimist|pesimist|vjeruje)|",
# --- WELLBEING INDICES ---
"indeks (dobrobiti|blagostanja|sre[cć]e)|",
"indeks ljudskog razvoja|",
"hdi.+hrvat|",
# --- PERCEPTION OF PROGRESS ---
"(hrvatska|zemlja|dr[zž]ava).+(napreduje|nazaduje|stagnira).+(istra[zž]ivanj|anket|smatraju gra[dđ]ani)|",
"(napredak|nazadovanje|stagnacija) (dru[sš]tva|hrvatske)|",
")"
)
# ------------------------------------------------------------------------------
# BUILD QUERY
# ------------------------------------------------------------------------------
query <- paste0("
SELECT *
FROM media_data
WHERE DATE >= '2021-01-01'
AND DATE <= '2024-05-31'
AND REGEXP_MATCHES(LOWER(FULL_TEXT), '", tolower(trust_regex), "')
")
# ------------------------------------------------------------------------------
# EXECUTE
# ------------------------------------------------------------------------------
message("Retrieving social trust articles using regex pattern...")
message("This searches ~25M rows for matching articles...")
start_time <- Sys.time()
trust_articles <- dbGetQuery(con, query)
elapsed <- round(difftime(Sys.time(), start_time, units = "mins"), 2)
message("Done in ", elapsed, " minutes")
message("Articles retrieved: ", format(nrow(trust_articles), big.mark = ","))
# ------------------------------------------------------------------------------
# QUICK STATS
# ------------------------------------------------------------------------------
if(nrow(trust_articles) > 0) {
message("\n=== QUICK STATS ===")
message("By SOURCE_TYPE:")
print(table(trust_articles$SOURCE_TYPE))
message("\nTop 10 Sources:")
print(head(sort(table(trust_articles$FROM), decreasing = TRUE), 10))
message("\nSample Titles:")
set.seed(123)
sample_idx <- sample(nrow(trust_articles), min(10, nrow(trust_articles)))
for(i in seq_along(sample_idx)) {
message("  ", i, ". ", substr(trust_articles$TITLE[sample_idx[i]], 1, 80))
}
}
# ------------------------------------------------------------------------------
# CLEANUP
# ------------------------------------------------------------------------------
dbDisconnect(con, shutdown = TRUE)
message("\nDatabase connection closed")
# ------------------------------------------------------------------------------
# SAVE
# ------------------------------------------------------------------------------
write_path <- "C:/Users/lsikic/Desktop/trust_articles.rds"
saveRDS(trust_articles, write_path)
message("Saved to: ", write_path)
# ==============================================================================
# SOCIAL TRUST & OPTIMISM ARTICLE FILTERING - MERGED PIPELINE
# ==============================================================================
library(data.table)
library(stringi)
# Set max threads
setDTthreads(0)
message("Using ", getDTthreads(), " threads")
# ------------------------------------------------------------------------------
# LOAD DATA
# ------------------------------------------------------------------------------
message("\n=== LOADING DATA ===")
#trust_articles <- readRDS("C:/Users/lsikic/Desktop/trust_articles.rds")
if(!is.data.table(trust_articles)) {
setDT(trust_articles)
}
message("Total articles loaded: ", format(nrow(trust_articles), big.mark = ","))
# ------------------------------------------------------------------------------
# FILTER 1: SOURCE TYPE - Keep only web
# ------------------------------------------------------------------------------
message("\n=== FILTER 1: SOURCE TYPE ===")
dt <- trust_articles[SOURCE_TYPE == "web"]
message("After web filter: ", format(nrow(dt), big.mark = ","))
# ------------------------------------------------------------------------------
# FILTER 2: RELEVANT NEWS PORTALS
# ------------------------------------------------------------------------------
message("\n=== FILTER 2: RELEVANT NEWS PORTALS ===")
# Major national news portals
national_news <- c(
"index.hr", "jutarnji.hr", "vecernji.hr", "24sata.hr",
"tportal.hr", "dnevnik.hr", "net.hr", "rtl.hr", "hrt.hr",
"telegram.hr", "nacional.hr", "direktno.hr", "n1info.com", "n1info.hr",
"hina.hr", "novosti.hr"
)
# Business/Economic news
business_news <- c(
"poslovni.hr", "seebiz.eu", "lidermedia.hr", "lider.media",
"bloombergadria.com", "hrportfolio.hr", "energypress.net",
"energetika-net.com", "jatrgovac.com", "gospodarski.hr",
"privredni.hr", "ictbusiness.info"
)
# Regional news portals
regional_news <- c(
"slobodnadalmacija.hr", "dalmatinskiportal.hr", "dalmacijadanas.hr",
"dalmacijanews.hr", "antenazadar.hr", "zadarskilist.hr", "057info.hr",
"sibenik.in", "sibenskiportal.hr", "dulist.hr", "dubrovnikinsider.hr",
"dubrovnikportal.com", "dubrovnikpress.hr", "makarska-danas.com",
"kastela.org", "plavakamenica.hr",
"glasistre.hr", "novilist.hr", "istra24.hr", "istrain.hr",
"rijekadanas.com", "istarski.hr", "porestina.info",
"glas-slavonije.hr", "icv.hr", "034portal.hr", "035portal.hr",
"slavonijainfo.com", "brodportal.hr", "ebrod.net", "epodravina.hr",
"podravski.hr", "glaspodravine.hr", "pozeska-kronika.hr", "pozega.eu",
"pozeski.hr",
"zagreb.info", "01portal.hr", "prigorski.hr",
"varazdinske-vijesti.hr", "sjever.hr", "medjimurjepress.net",
"medjimurski.hr", "zagorje.com", "zagorje-international.hr",
"vzaktualno.hr", "evarazdin.hr", "muralist.hr", "drava.info",
"sjeverni.info",
"karlovacki.hr", "radio-banovina.hr", "likaclub.eu", "044portal.hr",
"radiokrizevci.hr", "bjelovar.live", "mnovine.hr"
)
# Specialized news
specialized_news <- c(
"agroklub.com", "mirovina.hr", "legalis.hr", "srednja.hr",
"studentski.hr", "gov.hr", "fino.hr"
)
# Opinion/Analysis portals (important for trust/sentiment topics)
opinion_portals <- c(
"7dnevno.hr", "dnevno.hr", "hrvatska-danas.com", "otvoreno.hr",
"narod.hr", "glas.hr", "novine.hr", "priznajem.hr", "kamenjar.com",
"politikaplus.com", "maxportal.hr", "novo.hr", "logicno.com",
"totalinfo.hr", "geopolitika.news", "nacionalno.hr", "portalnovosti.com",
"liberoportal.hr", "hrvatski-fokus.hr", "objektivno.hr", "stvarnost.hr",
"tockanai.hr", "suvremena.hr", "cronika.hr", "hrv.hr"
)
relevant_sources <- unique(c(national_news, business_news, regional_news,
specialized_news, opinion_portals))
dt <- dt[FROM %in% relevant_sources]
message("After source filter: ", format(nrow(dt), big.mark = ","))
# Add source category
dt[, source_category := fcase(
FROM %in% national_news, "national",
FROM %in% business_news, "business",
FROM %in% regional_news, "regional",
FROM %in% specialized_news, "specialized",
FROM %in% opinion_portals, "opinion",
default = "other"
)]
cat("\nBy category:\n")
print(dt[, .N, by = source_category][order(-N)])
# ------------------------------------------------------------------------------
# FILTER 3: MINIMUM TEXT LENGTH
# ------------------------------------------------------------------------------
message("\n=== FILTER 3: TEXT LENGTH ===")
dt[, text_length := nchar(FULL_TEXT)]
dt <- dt[text_length >= 500]
message("After length filter (>=500 chars): ", format(nrow(dt), big.mark = ","))
# ------------------------------------------------------------------------------
# FILTER 4: TITLE MUST CONTAIN TRUST/OPTIMISM-RELATED TERM
# ------------------------------------------------------------------------------
message("\n=== FILTER 4: TITLE RELEVANCE ===")
title_pattern <- paste0(
"(",
# Direct sentiment terms
"optimiz|pesimiz|povjerenje|nepovjerenje|",
"zadovoljstvo|nezadovoljstvo|",
# Surveys/Research
"istra[zž]ivanj|anket[aeu]|Eurobarometar|Gallup|Ipsos|",
# Collective mood
"gra[dđ]ani (smatraju|misle|vjeruju|o[cč]ekuju)|",
"raspolo[zž]enj|",
"strah.*gra[dđ]an|gra[dđ]ani.*strah|",
"zabrinutost|",
# Institutions
"povjerenje.*institucij|institucij.*povjerenje|",
"povjerenje.*(vlad|sabor|sud|policij|crkv)|",
# Quality of life
"kvalitet.*[zž]ivot|[zž]ivot.*kvalitet|",
"zadovoljstvo [zž]ivotom|",
"[zž]ivotni (standard|uvjeti)|",
# Social cohesion
"dru[sš]tven.*kohezij|solidarnost|",
# Future outlook
"budu[cć]nost.*hrvatsk|hrvatsk.*budu[cć]nost|",
"perspektiv|izgled|o[cč]ekivanj.*gra[dđ]an|",
# Indices
"indeks (povjerenja|optimizma|dobrobiti|sre[cć]e)",
")"
)
dt[, title_relevant := stri_detect_regex(TITLE, title_pattern, case_insensitive = TRUE)]
dt <- dt[title_relevant == TRUE]
message("After title filter: ", format(nrow(dt), big.mark = ","))
# ------------------------------------------------------------------------------
# FILTER 5: CORE TRUST/OPTIMISM TERM IN TEXT
# ------------------------------------------------------------------------------
message("\n=== FILTER 5: CORE TERM VERIFICATION ===")
core_pattern <- paste0(
"(",
# --- CONFIDENCE/TRUST INDICES ---
"indeks (povjerenja|optimizma|pesimizma|raspolo[zž]enja)|",
"indeks potro[sš]a[cč]kog (povjerenja|optimizma)|",
"barometar (povjerenja|optimizma|raspolo[zž]enja)|",
# --- EUROBAROMETER & MAJOR SURVEYS ---
"eurobarometar|",
"europsko dru[sš]tveno istra[zž]ivanj|",
"europsko istra[zž]ivanje vrijednosti|",
"gallup|",
# --- INSTITUTIONAL TRUST ---
"povjerenje u (institucije|vladu|sabor|predsjednika|sudstvo|pravosu[dđ]e|policiju|vojsku|medije|crkvu|eu)|",
"(ne)?povjerenje (gra[dđ]ana|javnosti|stanovni[sš]tva) u|",
"(rast|pad|gubitak|kriza) povjerenja|",
# --- LIFE SATISFACTION ---
"zadovoljstvo [zž]ivotom|",
"zadovoljstvo (standardom|kvalitetom [zž]ivota)|",
"kvalitet[aeu]+ [zž]ivota|",
# --- SOCIAL MOOD/SENTIMENT (collective) ---
"dru[sš]tven[aeiou]+ raspolo[zž]enj|",
"raspolo[zž]enje (gra[dđ]ana|javnosti|stanovni[sš]tva|u dru[sš]tvu)|",
"op[cć][aeiou]+ raspolo[zž]enj|",
"atmosfera u dru[sš]tvu|",
# --- COLLECTIVE OPTIMISM/PESSIMISM ---
"(optimizam|pesimizam) (gra[dđ]ana|javnosti|stanovni[sš]tva|hrvata)|",
"(gra[dđ]ani|hrvati|stanovni[sš]tvo|javnost).+(optimisti[cč]n|pesimisti[cč]n)|",
"(ve[cć]ina|manjina|polovica).+(optimisti[cč]n|pesimisti[cč]n|zadovolj|nezadovolj)|",
# --- COLLECTIVE SATISFACTION ---
"(ne)?zadovoljstvo (gra[dđ]ana|javnosti|stanovni[sš]tva)|",
"(gra[dđ]ani|hrvati|stanovni[sš]tvo).+(zadovolj|nezadovolj)|",
# --- FEAR/WORRY (collective) ---
"(strah|zabrinutost|tjeskoba) (gra[dđ]ana|javnosti|stanovni[sš]tva)|",
"(gra[dđ]ani|hrvati|stanovni[sš]tvo).+(strahuju|zabrinuti)|",
"(ve[cć]ina|manjina|posto).+(strahuje|zabrinut)|",
# --- SOCIAL COHESION ---
"dru[sš]tven[aeiou]+ kohezij|",
"socijalna kohezij|",
"dru[sš]tven[aeiou]+ solidarnost|",
"dru[sš]tven[aeiou]+ povjerenj|",
"me[dđ]uljudsk[aeiou]+ povjerenj|",
# --- FUTURE OUTLOOK (collective) ---
"(o[cč]ekivanja|izgledi|perspektiv[aeu]) (gra[dđ]ana|za hrvatsku)|",
"budu[cć]nost hrvatske|",
# --- SURVEY RESULTS ON SENTIMENT ---
"(anket[aeu]?|istra[zž]ivanj[aeu]?).+(zadovolj|optimiz|pesimiz|povjerenj|strah)|",
"prema (anketi|istra[zž]ivanju).+(zadovolj|optimiz|pesimiz|povjerenj)|",
"rezultati (ankete|istra[zž]ivanja).+(zadovolj|optimiz|pesimiz|povjerenj)|",
# --- PERCENTAGE + SENTIMENT ---
"[0-9]+.?posto.+(zadovolj|nezadovolj|optimist|pesimist|vjeruje|ne vjeruje)|",
"(ve[cć]ina|manjina|polovica).+(gra[dđ]ana|ispitanika).+(zadovolj|optimist|pesimist|vjeruje)|",
# --- WELLBEING INDICES ---
"indeks (dobrobiti|blagostanja|sre[cć]e)|",
"indeks ljudskog razvoja",
")"
)
dt[, has_core := stri_detect_regex(FULL_TEXT, core_pattern, case_insensitive = TRUE)]
dt <- dt[has_core == TRUE]
message("After core term filter: ", format(nrow(dt), big.mark = ","))
# ------------------------------------------------------------------------------
# FILTER 6: EXCLUSION CHECK
# ------------------------------------------------------------------------------
message("\n=== FILTER 6: EXCLUSION CHECK ===")
excl_pattern <- paste0(
"(",
# Sports
"nogomet|ko[sš]ark|rukomet|tenis|vaterpolo|",
"liga prvak|premijer lig|bundeslig|",
"utakmic|golova|igra[cč]|trener|mom[cč]ad|",
"Dinamo|Hajduk|UEFA|FIFA|NBA|olimpijsk|",
"sportski|reprezentacij|prvenstv|",
"optimizam (pred|uo[cč]i|nakon) utakmic|",
# Entertainment
"glumac|glumic|redatelj|",
"koncert|festival|",
"pjeva[cč]|album|pjesm|",
"reality|showbiz|celebrity|",
# Product/Customer satisfaction (not social)
"zadovoljstvo kupaca|zadovoljstvo korisnika|",
"recenzij[aeu]|ocjen[aeu] proizvod|",
# Other noise
"horoskop|astrolog|",
"vremenska prognoza|",
"tv program",
")"
)
override_pattern <- paste0(
"(",
"eurobarometar|",
"indeks (povjerenja|optimizma|pesimizma)|",
"povjerenje u institucij|",
"povjerenje (gra[dđ]ana|javnosti|stanovni[sš]tva)|",
"zadovoljstvo [zž]ivotom|",
"kvaliteta [zž]ivota|",
"dru[sš]tven[aeiou]+ (raspolo[zž]enj|kohezij|povjerenj)|",
"istra[zž]ivanje.+(povjerenj|optimiz|pesimiz|zadovoljstv)|",
"anket[aeu].+(povjerenj|optimiz|pesimiz|zadovoljstv)|",
"gallup|ipsos|promocija plus",
")"
)
dt[, excl := stri_detect_regex(FULL_TEXT, excl_pattern, case_insensitive = TRUE)]
dt[, override := stri_detect_regex(FULL_TEXT, override_pattern, case_insensitive = TRUE)]
dt[, passes_exclusion := (!excl | override)]
excluded_count <- sum(!dt$passes_exclusion)
message("Excluded by sports/entertainment (without override): ", excluded_count)
dt <- dt[passes_exclusion == TRUE]
message("After exclusion filter: ", format(nrow(dt), big.mark = ","))
# ------------------------------------------------------------------------------
# FILTER 7: CROATIAN CONTEXT
# ------------------------------------------------------------------------------
message("\n=== FILTER 7: CROATIAN CONTEXT ===")
croatian_pattern <- paste0(
"(",
# Country references
"\\bHrvatsk[aeiou]?[mj]?|\\bRH\\b|\\bHR\\b|",
# Institutions
"Vlad[aeiou] RH|Vlad[aeiou] Republike Hrvatske|",
"Sabor|Hrvatski sabor|",
"predsjednik.*RH|predsjedni[ck].*Hrvatske|",
# People references
"gra[dđ]ani Hrvatske|hrvatski gra[dđ]ani|Hrvati|",
"hrvatsko dru[sš]tvo|hrvatsk[aeiou] javnost|",
"stanovni[sš]tvo Hrvatske|",
# Cities (major ones)
"Zagreb|Split|Rijeka|Osijek|Zadar|Pula|Slavonski Brod|",
"Karlovac|Vara[zž]din|[SŠ]ibenik|Dubrovnik|",
# Regional
"\\bu nas\\b|kod nas|na[sš][aeiou]? dru[sš]tv|hrvatsk[aeiou]? dru[sš]tv|",
# Comparative
"\\bEU prosjek|europski prosjek.*Hrvatska|Hrvatska.*europski prosjek|",
"u (odnosu na|usporedbi s) (EU|Europu|europsk)",
")"
)
dt[, croatian_context := stri_detect_regex(FULL_TEXT, croatian_pattern, case_insensitive = TRUE)]
message("Articles WITH Croatian context: ", format(sum(dt$croatian_context), big.mark = ","))
message("Articles WITHOUT Croatian context: ", format(sum(!dt$croatian_context), big.mark = ","))
dt <- dt[croatian_context == TRUE]
message("After Croatian context filter: ", format(nrow(dt), big.mark = ","))
# ------------------------------------------------------------------------------
# FINAL DATASET
# ------------------------------------------------------------------------------
message("\n", strrep("=", 80))
message("FINAL RESULTS")
message(strrep("=", 80))
message("\nFinal article count: ", format(nrow(dt), big.mark = ","))
message("\nBy source category:")
print(dt[, .N, by = source_category][order(-N)])
message("\nTop 15 sources:")
print(head(sort(table(dt$FROM), decreasing = TRUE), 15))
message("\nBy year:")
dt[, year := format(as.Date(DATE), "%Y")]
print(dt[, .N, by = year][order(year)])
# ------------------------------------------------------------------------------
# QUALITY CONTROL - SAMPLE TITLES
# ------------------------------------------------------------------------------
message("\n", strrep("=", 80))
message("QUALITY CONTROL - 20 RANDOM TITLES")
message(strrep("=", 80))
set.seed(123)
sample_idx <- sample(nrow(dt), min(20, nrow(dt)))
for(i in seq_along(sample_idx)) {
idx <- sample_idx[i]
message(sprintf("%2d. [%s] %s", i, dt$FROM[idx], substr(dt$TITLE[idx], 1, 80)))
}
# ------------------------------------------------------------------------------
# EXTRACT MATCHED WORDS FOR QC
# ------------------------------------------------------------------------------
message("\n=== EXTRACTING MATCHED TERMS ===")
extract_words <- function(text, pattern) {
matches <- stri_extract_all_regex(text, pattern, case_insensitive = TRUE)
sapply(matches, function(x) paste(unique(na.omit(x)), collapse = "; "))
}
dt[, matched_terms := extract_words(FULL_TEXT, core_pattern)]
# Word frequency
message("\nTop 20 matched terms:")
all_words <- unlist(stri_split_fixed(dt$matched_terms, "; "))
all_words <- all_words[all_words != ""]
all_words <- tolower(all_words)
freq <- sort(table(all_words), decreasing = TRUE)
print(head(freq, 20))
# ------------------------------------------------------------------------------
# SAVE
# ------------------------------------------------------------------------------
message("\n=== SAVING ===")
# Select final columns
dt_final <- dt[, .(
DATE,
FROM,
URL,
TITLE,
FULL_TEXT,
MENTION_SNIPPET,
SOURCE_TYPE,
AUTHOR,
source_category,
text_length,
matched_terms,
REACH,
INTERACTIONS
)]
# Save RDS
write_path_rds <- "C:/Users/lsikic/Desktop/trust_filtered.rds"
saveRDS(dt_final, write_path_rds)
message("Saved RDS: ", write_path_rds)
# Save Excel for QC
library(openxlsx)
write_path_xlsx <- "C:/Users/lsikic/Desktop/trust_filtered.xlsx"
dt_excel <- copy(dt_final)
message("Saving all ", format(nrow(dt_excel), big.mark = ","), " rows to Excel...")
# Truncate FULL_TEXT for Excel (too large)
#dt_excel[, FULL_TEXT := substr(FULL_TEXT, 1, 500)]
write.xlsx(dt_excel, write_path_xlsx, overwrite = TRUE)
message("Saved Excel: ", write_path_xlsx)
message("\n=== DONE ===")
