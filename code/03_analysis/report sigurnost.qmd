---
title: "Analiza medijske pokrivenosti sigurnosti i stabilnosti u Hrvatskoj"
subtitle: "Semantička analiza, konstrukcija indeksa i vremenske dinamike"
author: "GIMES Research"
date: today
format:
  html:
    toc: true
    toc-depth: 4
    toc-location: left
    number-sections: true
    theme: cosmo
    code-fold: true
    code-summary: "Prikaži kod"
    fig-width: 11
    fig-height: 7
    df-print: paged
    embed-resources: true
execute:
  warning: false
  message: false
  echo: false
lang: hr
---

```{r setup}
#| label: setup
#| include: false

library(data.table)
library(ggplot2)
library(scales)
library(lubridate)
library(stringi)
library(knitr)
library(kableExtra)
library(plotly)
library(zoo)
library(openxlsx)
library(RColorBrewer)
library(gridExtra)
library(here)
library(forecast)
library(corrplot)

options(scipen = 999)
theme_set(theme_minimal(base_size = 12))

colors_gimes <- c(
  "primary" = "#2C3E50",
  "secondary" = "#C0392B",
  "accent" = "#3498DB",
  "warning" = "#E67E22",
  "success" = "#27AE60",
  "light" = "#ECF0F1",
  "purple" = "#8E44AD",
  "crime" = "#E74C3C",
  "disaster" = "#F39C12",
  "emergency" = "#1ABC9C"
)
```

# Uvod

U ovom izvještaju se predstavlja sveobuhvatna analiza medijske pokrivenosti sigurnosti i stabilnosti u Hrvatskoj. Analizom se obuhvaća praćenje kriminaliteta, prometnih nesreća, požara, prirodnih katastrofa, rada hitnih službi i institucionalnog odgovora na sigurnosne prijetnje temeljem članaka iz hrvatskih online medija.

## Motivacija i kontekst

Sigurnost i stabilnost predstavljaju temeljne preduvjete za funkcioniranje društva i gospodarstva. Ovim izvještajem se nastoji odgovoriti na ključna pitanja:

1. Kako se medijsko izvještavanje o sigurnosnim temama razvijalo kroz vrijeme?
2. Koje su kategorije sigurnosnih prijetnji najzastupljenije u hrvatskim medijima?
3. Postoje li sezonski obrasci u izvještavanju o određenim vrstama incidenata?
4. Kako se različiti aspekti sigurnosti međusobno odnose?

## Struktura izvještaja

U izvještaju se obrađuju sljedeće teme: metodologija identifikacije relevantnih članaka, eksploratorni pregled dataseta, semantička taksonomija sigurnosnih pojmova, konstrukcija specijaliziranih indeksa, vremenske dinamike i međusobne korelacije različitih aspekata sigurnosti.

```{r load-data}
#| label: load-data

#dt <- as.data.table(read.xlsx(here("data", "security_filtered.xlsx")))
dt <- as.data.table(read.xlsx("C:/Users/lsikic/Desktop/inflacija_filtered.xlsx"))

if(is.numeric(dt$DATE)) {
  dt[, DATE := as.Date(DATE, origin = "1899-12-30")]
} else {
  dt[, DATE := as.Date(DATE)]
}

if("text_length" %in% names(dt)) {
  dt[, text_length := as.numeric(text_length)]
}
if("REACH" %in% names(dt)) {
  dt[, REACH := as.numeric(REACH)]
}
if("INTERACTIONS" %in% names(dt)) {
  dt[, INTERACTIONS := as.numeric(INTERACTIONS)]
}

dt[, `:=`(
  date = DATE,
  year = year(DATE),
  month = month(DATE),
  week = isoweek(DATE),
  yearmonth = floor_date(DATE, "month"),
  yearweek = floor_date(DATE, "week")
)]
```

# Metodologija identifikacije članaka

## Pregled procesa filtriranja

Identifikacija relevantnih članaka se provodi kroz sedmostupanjski proces filtriranja koji kombinira strukturne kriterije, ključne riječi i kontekstualnu validaciju. Proces osigurava da u analizu ulaze samo članci koji su stvarno relevantni za tematiku sigurnosti i stabilnosti u hrvatskom kontekstu.

::: {.callout-note collapse="true" title="Detaljna metodologija filtriranja"}

**Filter 1: Tip izvora**

Odabiru se samo web izvori kako bi se osigurala konzistentnost formata i dostupnost punog teksta članka.

**Filter 2: Relevantni news portali**

Koristi se lista verificiranih hrvatskih news portala kategoriziranih u pet skupina: nacionalni mediji, poslovni mediji, regionalni mediji, specijalizirani mediji (uključujući policija.hr, vatrogasci.hr, morh.hr) i opinion portali.

**Filter 3: Minimalna duljina teksta**

Članci moraju sadržavati minimalno 500 znakova u punom tekstu.

**Filter 4: Naslov članka**

Naslov članka mora sadržavati sigurnosne pojmove: kriminal, nesreće, požari, katastrofe, hitne službe, terorizam.

**Filter 5: Core sigurnosni pojmovi**

Puni tekst članka mora sadržavati core sigurnosne pojmove s institucionalnim okvirom (policija, DORH, USKOK, vatrogasci, HGSS).

**Filter 6: Isključivanje irelevantnog sadržaja**

Isključuju se članci o sportu, zabavi i fikcionalnom kriminalu (serije, filmovi), osim ako sadrže snažne override pojmove.

**Filter 7: Hrvatski kontekst**

Članci moraju sadržavati reference na hrvatske sigurnosne institucije, gradove i lokacije.

:::

# Eksploratorni pregled podataka

## Osnovne statistike

U ovom poglavlju se prikazuju osnovne deskriptivne statistike dataseta.

```{r basic-stats}
#| label: basic-stats

stats_summary <- data.table(
  Metrika = c(
    "Ukupan broj članaka",
    "Vremenski raspon",
    "Broj dana",
    "Prosječno članaka dnevno",
    "Broj izvora (portala)",
    "Broj kategorija izvora"
  ),
  Vrijednost = c(
    format(nrow(dt), big.mark = ","),
    paste(format(min(dt$date), "%d.%m.%Y"), "do", format(max(dt$date), "%d.%m.%Y")),
    as.character(as.numeric(max(dt$date) - min(dt$date))),
    round(nrow(dt) / as.numeric(max(dt$date) - min(dt$date)), 2),
    length(unique(dt$FROM)),
    length(unique(dt$source_category))
  )
)

kable(stats_summary, col.names = c("Metrika", "Vrijednost"),
      caption = "Osnovne statistike dataseta") %>%
  kable_styling(bootstrap_options = c("striped", "hover"), full_width = FALSE)
```

## Distribucija po kategorijama izvora

```{r source-category}
#| label: source-category
#| fig-cap: "Distribucija članaka po kategorijama izvora"

cat_summary <- dt[, .(
  N = .N,
  Postotak = round(.N / nrow(dt) * 100, 1)
), by = source_category][order(-N)]

ggplot(cat_summary, aes(x = reorder(source_category, N), y = N, fill = source_category)) +
  geom_col(show.legend = FALSE) +
  geom_text(aes(label = paste0(format(N, big.mark = ","), "\n(", Postotak, "%)")), 
            hjust = -0.1, size = 3.5) +
  coord_flip() +
  scale_y_continuous(labels = comma, expand = expansion(mult = c(0, 0.2))) +
  scale_fill_manual(values = c("national" = colors_gimes["primary"],
                               "business" = colors_gimes["accent"],
                               "regional" = colors_gimes["success"],
                               "specialized" = colors_gimes["warning"],
                               "opinion" = colors_gimes["purple"])) +
  labs(
    title = "Broj članaka po kategoriji izvora",
    subtitle = "Specijalizirani izvori uključuju policija.hr, vatrogasci.hr, morh.hr",
    x = NULL,
    y = "Broj članaka"
  ) +
  theme(
    plot.title = element_text(face = "bold"),
    panel.grid.major.y = element_blank()
  )
```

## Top 20 izvora

```{r top-sources}
#| label: top-sources
#| fig-cap: "20 najaktivnijih izvora"

top_sources <- dt[, .(N = .N), by = FROM][order(-N)][1:20]

ggplot(top_sources, aes(x = reorder(FROM, N), y = N)) +
  geom_col(fill = colors_gimes["primary"]) +
  geom_text(aes(label = format(N, big.mark = ",")), hjust = -0.1, size = 3) +
  coord_flip() +
  scale_y_continuous(labels = comma, expand = expansion(mult = c(0, 0.15))) +
  labs(
    title = "Top 20 izvora po broju članaka o sigurnosti",
    x = NULL,
    y = "Broj članaka"
  ) +
  theme(
    plot.title = element_text(face = "bold"),
    panel.grid.major.y = element_blank()
  )
```

## Distribucija duljine teksta

```{r text-length}
#| label: text-length
#| fig-cap: "Distribucija duljine članaka"

if("text_length" %in% names(dt)) {
  ggplot(dt, aes(x = text_length)) +
    geom_histogram(bins = 50, fill = colors_gimes["primary"], alpha = 0.8, color = "white") +
    geom_vline(xintercept = median(dt$text_length, na.rm = TRUE), 
               color = colors_gimes["secondary"], linetype = "dashed", linewidth = 1) +
    annotate("text", x = median(dt$text_length, na.rm = TRUE) + 500, 
             y = Inf, vjust = 2, hjust = 0,
             label = paste("Medijan:", format(round(median(dt$text_length, na.rm = TRUE)), big.mark = ",")),
             color = colors_gimes["secondary"], fontface = "bold") +
    scale_x_continuous(labels = comma) +
    scale_y_continuous(labels = comma) +
    labs(
      title = "Distribucija duljine članaka",
      subtitle = "Broj znakova u punom tekstu",
      x = "Broj znakova",
      y = "Broj članaka"
    ) +
    theme(plot.title = element_text(face = "bold"))
}
```

# Vremenska analiza

## Dnevna frekvencija članaka

Na sljedećem grafikonu se prikazuje dnevni broj članaka o sigurnosti s kliznim prosjekom.

```{r daily-frequency}
#| label: daily-frequency
#| fig-cap: "Dnevni broj članaka o sigurnosti"
#| fig-height: 8

daily <- dt[, .(N = .N), by = date][order(date)]
daily[, MA7 := frollmean(N, n = 7, align = "center")]
daily[, MA30 := frollmean(N, n = 30, align = "center")]

ggplot(daily, aes(x = date)) +
  geom_col(aes(y = N), fill = colors_gimes["light"], alpha = 0.5, width = 1) +
  geom_line(aes(y = MA7, color = "7-dnevni prosjek"), linewidth = 0.8, na.rm = TRUE) +
  geom_line(aes(y = MA30, color = "30-dnevni prosjek"), linewidth = 1.2, na.rm = TRUE) +
  scale_x_date(date_breaks = "3 months", date_labels = "%b\n%Y") +
  scale_y_continuous(labels = comma) +
  scale_color_manual(values = c("7-dnevni prosjek" = colors_gimes["accent"],
                                "30-dnevni prosjek" = colors_gimes["secondary"])) +
  labs(
    title = "Dnevna frekvencija članaka o sigurnosti i stabilnosti",
    subtitle = "Broj članaka po danu sa kliznim prosjekom",
    x = NULL,
    y = "Broj članaka",
    color = "Klizni prosjek"
  ) +
  theme(
    plot.title = element_text(face = "bold", size = 14),
    plot.subtitle = element_text(size = 10),
    legend.position = "bottom",
    axis.text.x = element_text(size = 9)
  )
```

## Mjesečna dinamika

```{r monthly-trend}
#| label: monthly-trend
#| fig-cap: "Mjesečni broj članaka"

monthly <- dt[, .(N = .N), by = yearmonth][order(yearmonth)]
monthly[, MA3 := frollmean(N, n = 3, align = "center")]

ggplot(monthly, aes(x = yearmonth)) +
  geom_col(aes(y = N), fill = colors_gimes["primary"], alpha = 0.7, width = 25) +
  geom_line(aes(y = MA3), color = colors_gimes["secondary"], linewidth = 1.2, na.rm = TRUE) +
  geom_point(aes(y = MA3), color = colors_gimes["secondary"], size = 2, na.rm = TRUE) +
  scale_x_date(date_breaks = "3 months", date_labels = "%b\n%Y") +
  scale_y_continuous(labels = comma) +
  labs(
    title = "Mjesečni broj članaka o sigurnosti",
    subtitle = "Crvena linija = 3-mjesečni klizni prosjek",
    x = NULL,
    y = "Broj članaka"
  ) +
  theme(
    plot.title = element_text(face = "bold"),
    axis.text.x = element_text(size = 8)
  )
```

## Godišnja usporedba

```{r yearly-comparison}
#| label: yearly-comparison
#| fig-cap: "Usporedba mjesečne dinamike po godinama"

yearly_monthly <- dt[, .(N = .N), by = .(year, month)][order(year, month)]

ggplot(yearly_monthly, aes(x = month, y = N, color = factor(year), group = year)) +
  geom_line(linewidth = 1.2) +
  geom_point(size = 2.5) +
  scale_x_continuous(breaks = 1:12, labels = c("Sij", "Velj", "Ožu", "Tra", "Svi", "Lip",
                                                "Srp", "Kol", "Ruj", "Lis", "Stu", "Pro")) +
  scale_y_continuous(labels = comma) +
  scale_color_brewer(palette = "Set1") +
  labs(
    title = "Mjesečna dinamika po godinama",
    subtitle = "Sezonski obrasci vidljivi u požarima (ljeto) i prometnim nesrećama",
    x = "Mjesec",
    y = "Broj članaka",
    color = "Godina"
  ) +
  theme(
    plot.title = element_text(face = "bold"),
    legend.position = "bottom"
  )
```

# Semantička taksonomija sigurnosnih pojmova

U ovoj sekciji se definira sveobuhvatna semantička taksonomija za analizu sigurnosti i stabilnosti. Taksonomija se organizira u 12 kategorija koje obuhvaćaju različite aspekte sigurnosnih prijetnji i institucionalnog odgovora u hrvatskom kontekstu.

## Definicija semantičkog rječnika

Semantički rječnik se temelji na pojmovima identificiranima u procesu filtriranja članaka. Pojmovi se definiraju pomoću korijena riječi (stem) kako bi se osigurala šira morfološka pokrivenost hrvatskog jezika.

::: {.callout-note collapse="true" title="Detaljna metodologija semantičke taksonomije"}

**Princip konstrukcije rječnika:**

1. **Kategorije** predstavljaju konceptualno različite aspekte sigurnosti
2. **Regex uzorci** se koriste za fleksibilno prepoznavanje morfoloških varijanti
3. **Korijenski oblici** osiguravaju prepoznavanje svih padežnih i glagolskih oblika

**Morfološka pokrivenost:**

Za hrvatski jezik koji ima bogatu morfologiju, koriste se:

- Korijenski oblici s opcionalnim nastavcima: `ubojstv[a-zčćžšđ]*` prepoznaje ubojstvo, ubojstva, ubojstvom...
- Alternativni oblici za palatalizaciju: `[sš]`, `[cč]`, `[zž]`
- Wildcard znakovi: `.{0,15}` dopušta do 15 bilo kojih znakova između riječi

**Formula za brojanje:**

$$
\text{count}_{c,d} = \sum_{p \in P_c} \text{matches}(p, d)
$$

gdje je $P_c$ skup regex uzoraka za kategoriju $c$, a $d$ je tekst dokumenta.

:::

```{r semantic-dictionary}
#| label: semantic-dictionary

# Definicija rječnika sigurnosnih pojmova - STEMMED VERSION
semantic_terms <- list(
  
  # 1. NASILNI KRIMINAL
  nasilni_kriminal = c(
    "ubojstv[a-zčćžšđ]*",                  # ubojstvo
    "ubij[a-zčćžšđ]*",                     # ubiti, ubijen
    "umorst[a-zčćžšđ]*",                   # umorstvo
    "(fizi[cč]ki|no[zž]em|oru[zž]jem).{0,10}napad",
    "brutalan.{0,5}napad",
    "silovanj[a-zčćžšđ]*",                 # silovanje
    "seksualn[a-zčćžšđ]*.{0,10}(napad|nasilj|zlostavljanj)",
    "obiteljsk[a-zčćžšđ]*.{0,10}nasilj",   # obiteljsko nasilje
    "nasilj[a-zčćžšđ]*.{0,10}obitelji"
  ),
  
  # 2. IMOVINSKI KRIMINAL
  imovinski_kriminal = c(
    "pljačk[a-zčćžšđ]*",                   # pljačka
    "razbojni[sš]tv[a-zčćžšđ]*",           # razbojništvo
    "kra[dđ][a-zčćžšđ]*",                  # krađa
    "proval[a-zčćžšđ]*",                   # provale
    "provalnik[a-zčćžšđ]*",                # provalnik
    "vandaliz[a-zčćžšđ]*",                 # vandalizam
    "pale[zž][a-zčćžšđ]*",                 # palež
    "(oružana|bankovna).{0,5}pljačk"
  ),
  
  # 3. ORGANIZIRANI KRIMINAL
  organizirani_kriminal = c(
    "organiziran[a-zčćžšđ]*.{0,10}kriminal",
    "kriminaln[a-zčćžšđ]*.{0,10}(skupin|organ|mre[zž])",
    "krijum[cč]arenj[a-zčćžšđ]*",          # krijumčarenje
    "trgovin[a-zčćžšđ]*.{0,10}ljudima",
    "narko.?(kartel|bos|mafij|diler)",
    "mafija[sš]k[a-zčćžšđ]*",
    "reketarenj[a-zčćžšđ]*",
    "drog[a-zčćžšđ]*",                     # droga
    "narkotik[a-zčćžšđ]*"
  ),
  
  # 4. UHIĆENJA I PRITVORI
  uhicenja_pritvori = c(
    "uhi[cć]en[a-zčćžšđ]*",                # uhićen
    "priveden[a-zčćžšđ]*",                 # priveden
    "pritvor[a-zčćžšđ]*",                  # pritvor
    "istra[zž]n[a-zčćžšđ]*.{0,10}zatvor",
    "osumnji[cč]en[a-zčćžšđ]*",            # osumnjičen
    "policijsk[a-zčćžšđ]*.{0,10}(akcij|racija|potjera)"
  ),
  
  # 5. TUŽITELJSTVO I SUDSTVO
  tuziteljstvo_sudstvo = c(
    "\\bdorh\\b",                           # DORH
    "dr[zž]avn[a-zčćžšđ]*.{0,10}odvjetni[sš]tv",
    "tu[zž]iteljstv[a-zčćžšđ]*",           # tužiteljstvo
    "\\buskok\\b",                          # USKOK
    "\\bpnuskok\\b",                        # PNUSKOK
    "kaznen[a-zčćžšđ]*.{0,10}prijav",
    "optu[zž]nic[a-zčćžšđ]*",              # optužnica
    "pravomo[cć]n[a-zčćžšđ]*.{0,10}presud",
    "[zž]upanijski.{0,5}sud",
    "op[cć]inski.{0,5}sud"
  ),
  
  # 6. PROMETNE NESREĆE
  prometne_nesrece = c(
    "prometn[a-zčćžšđ]*.{0,10}nesre[cć]",
    "sudar[a-zčćžšđ]*",                    # sudar
    "slijetanj[a-zčćžšđ]*",                # slijetanje
    "(poginuo|poginula|smrtno stradao).{0,10}promet",
    "te[sš]k[a-zčćžšđ]*.{0,10}prometn",
    "alkohol.{0,10}volan",
    "pijan.{0,10}volan",
    "autocest[a-zčćžšđ]*",
    "dr[zž]avn[a-zčćžšđ]*.{0,10}cest"
  ),
  
  # 7. POŽARI
  pozari = c(
    "po[zž]ar[a-zčćžšđ]*",                 # požar
    "[sš]umski.{0,5}po[zž]ar",
    "stambeni.{0,5}po[zž]ar",
    "vatrogasc[a-zčćžšđ]*",                # vatrogasci
    "\\bjvp\\b",                            # JVP
    "\\bdvd\\b",                            # DVD
    "ga[sš]enj[a-zčćžšđ]*.{0,10}po[zž]ar",
    "izgorjel[a-zčćžšđ]*",
    "izbio.{0,5}po[zž]ar"
  ),
  
  # 8. PRIRODNE KATASTROFE
  prirodne_katastrofe = c(
    "potres[a-zčćžšđ]*",                   # potres
    "magnitud[a-zčćžšđ]*",
    "richter[a-zčćžšđ]*",
    "seizmolo[sš]k[a-zčćžšđ]*",
    "poplav[a-zčćžšđ]*",                   # poplave
    "izlijevanj[a-zčćžšđ]*.{0,10}rijeke",
    "bujic[a-zčćžšđ]*",                    # bujica
    "oluj[a-zčćžšđ]*",                     # oluja
    "nevrijem[a-zčćžšđ]*",                 # nevrijeme
    "klizi[sš]t[a-zčćžšđ]*",               # klizište
    "odron[a-zčćžšđ]*"                     # odron
  ),
  
  # 9. HITNE SLUŽBE
  hitne_sluzbe = c(
    "\\bhgss\\b",                           # HGSS
    "hrvatska gorska slu[zž]ba",
    "sto[zž]er.{0,10}civilne za[sš]tite",
    "civiln[a-zčćžšđ]*.{0,10}za[sš]tit",
    "evakuacij[a-zčćžšđ]*",                # evakuacija
    "spa[sš]avanj[a-zčćžšđ]*",             # spašavanje
    "interventn[a-zčćžšđ]*",
    "hitn[a-zčćžšđ]*.{0,10}(pomo[cć]|slu[zž]b)"
  ),
  
  # 10. TERORIZAM
  terorizam = c(
    "teroriz[a-zčćžšđ]*",                  # terorizam
    "terorist[a-zčćžšđ]*",                 # teroristi
    "radikalizacij[a-zčćžšđ]*",
    "eksplozij[a-zčćžšđ]*",                # eksplozija
    "detonacij[a-zčćžšđ]*",                # detonacija
    "bomb[a-zčćžšđ]*",                     # bomba
    "podmetnuta.{0,5}bomb"
  ),
  
  # 11. CYBER KRIMINAL
  cyber_kriminal = c(
    "cyber.{0,5}(napad|kriminal|sigurnost)",
    "hakersk[a-zčćžšđ]*.{0,10}napad",
    "kra[dđ][a-zčćžšđ]*.{0,10}podatak",
    "ransomware",
    "phishing",
    "malware",
    "kibernetsk[a-zčćžšđ]*"
  ),
  
  # 12. ŽRTVE I ŠTETE
  zrtve_stete = c(
    "(smrtn|smrtno).{0,5}stradal",
    "[zž]rtv[a-zčćžšđ]*",                  # žrtve
    "ozlije[dđ]en[a-zčćžšđ]*",             # ozlijeđen
    "ranjen[a-zčćžšđ]*",                   # ranjen
    "poginul[a-zčćžšđ]*",                  # poginuo
    "[zž]ivotno.{0,5}ugro[zž]en",
    "te[sš]k[a-zčćžšđ]*.{0,10}ozljed",
    "materijalna.{0,5}[sš]tet",
    "procjena.{0,5}[sš]tet",
    "sanacija.{0,5}[sš]tet"
  )
)

term_summary <- data.table(
  Kategorija = names(semantic_terms),
  Broj_pojmova = sapply(semantic_terms, length),
  Primjeri = sapply(semantic_terms, function(x) paste(head(x, 2), collapse = ", "))
)
```

<details>
<summary>**Kliknite za prikaz kompletne tablice semantičkog rječnika**</summary>

```{r semantic-table}
#| label: semantic-table

# Formatiraj nazive kategorija
category_display <- c(
  "nasilni_kriminal" = "Nasilni kriminal",
  "imovinski_kriminal" = "Imovinski kriminal",
  "organizirani_kriminal" = "Organizirani kriminal",
  "uhicenja_pritvori" = "Uhićenja i pritvori",
  "tuziteljstvo_sudstvo" = "Tužiteljstvo i sudstvo",
  "prometne_nesrece" = "Prometne nesreće",
  "pozari" = "Požari",
  "prirodne_katastrofe" = "Prirodne katastrofe",
  "hitne_sluzbe" = "Hitne službe",
  "terorizam" = "Terorizam",
  "cyber_kriminal" = "Cyber kriminal",
  "zrtve_stete" = "Žrtve i štete"
)

term_summary[, Kategorija_display := category_display[Kategorija]]

kable(term_summary[, .(Kategorija_display, Broj_pojmova, Primjeri)], 
      col.names = c("Kategorija", "Broj pojmova", "Primjeri regex uzoraka"),
      caption = "Pregled rječnika semantičkih pojmova za sigurnost") %>%
  kable_styling(bootstrap_options = c("striped", "hover"), full_width = FALSE)
```

</details>

## Brojanje semantičkih pojmova po člancima

Za svaki članak se zbrajaju pojavljivanja pojmova iz svake kategorije. Brojanje se provodi korištenjem regularnih izraza (regex) koji prepoznaju morfološke varijante pojmova.

```{r count-semantic-terms}
#| label: count-semantic-terms

count_terms <- function(text, patterns) {
  if(is.na(text) || text == "") return(0)
  text_lower <- tolower(text)
  sum(sapply(patterns, function(p) {
    stri_count_regex(text_lower, p)
  }))
}

for(cat_name in names(semantic_terms)) {
  col_name <- paste0("count_", cat_name)
  dt[, (col_name) := sapply(FULL_TEXT, count_terms, patterns = semantic_terms[[cat_name]])]
}

dt[, count_all_semantic := rowSums(.SD), .SDcols = patterns("^count_")]
```

## Mjesečna agregacija semantičkih pojmova

Podaci se agregiraju na mjesečnoj razini kako bi se omogućila analiza vremenskih trendova za svaku semantičku kategoriju.

```{r monthly-semantic}
#| label: monthly-semantic

semantic_cols <- names(dt)[grepl("^count_", names(dt))]

monthly_semantic <- dt[, c(
  .(N = .N),
  lapply(.SD, sum, na.rm = TRUE),
  lapply(.SD, mean, na.rm = TRUE) |> setNames(paste0(names(.SD), "_avg"))
), by = yearmonth, .SDcols = semantic_cols][order(yearmonth)]

monthly_semantic[, total_mentions := count_all_semantic]
```

## Vizualizacija semantičkih kategorija kroz vrijeme

Na sljedećem grafikonu se prikazuje dinamika svih 12 semantičkih kategorija kroz vrijeme.

```{r semantic-time-series}
#| label: semantic-time-series
#| fig-cap: "Dinamika semantičkih kategorija kroz vrijeme"
#| fig-height: 12

semantic_long <- melt(
  monthly_semantic[, .(yearmonth, 
                       count_nasilni_kriminal,
                       count_imovinski_kriminal,
                       count_organizirani_kriminal,
                       count_uhicenja_pritvori,
                       count_tuziteljstvo_sudstvo,
                       count_prometne_nesrece,
                       count_pozari,
                       count_prirodne_katastrofe,
                       count_hitne_sluzbe,
                       count_terorizam,
                       count_cyber_kriminal,
                       count_zrtve_stete)],
  id.vars = "yearmonth",
  variable.name = "kategorija",
  value.name = "broj"
)

category_labels <- c(
  "count_nasilni_kriminal" = "Nasilni kriminal",
  "count_imovinski_kriminal" = "Imovinski kriminal",
  "count_organizirani_kriminal" = "Organizirani kriminal",
  "count_uhicenja_pritvori" = "Uhićenja/Pritvori",
  "count_tuziteljstvo_sudstvo" = "Tužiteljstvo/Sudstvo",
  "count_prometne_nesrece" = "Prometne nesreće",
  "count_pozari" = "Požari",
  "count_prirodne_katastrofe" = "Prirodne katastrofe",
  "count_hitne_sluzbe" = "Hitne službe",
  "count_terorizam" = "Terorizam",
  "count_cyber_kriminal" = "Cyber kriminal",
  "count_zrtve_stete" = "Žrtve/Štete"
)

semantic_long[, kategorija_label := category_labels[as.character(kategorija)]]

ggplot(semantic_long, aes(x = yearmonth, y = broj, color = kategorija_label)) +
  geom_line(linewidth = 1) +
  facet_wrap(~kategorija_label, ncol = 3, scales = "free_y") +
  scale_x_date(date_breaks = "6 months", date_labels = "%b %y") +
  scale_color_brewer(palette = "Set3") +
  labs(
    title = "Dinamika semantičkih kategorija sigurnosti kroz vrijeme",
    subtitle = "Mjesečni broj spominjanja po kategoriji pojmova",
    x = NULL,
    y = "Broj spominjanja",
    color = NULL
  ) +
  theme(
    plot.title = element_text(face = "bold"),
    legend.position = "none",
    axis.text.x = element_text(angle = 45, hjust = 1, size = 7),
    strip.text = element_text(face = "bold", size = 9)
  )
```

# Konstrukcija indeksa sigurnosti

## Metodologija

U ovoj sekciji se konstruira skup specijaliziranih indeksa za praćenje različitih aspekata sigurnosti i stabilnosti u hrvatskim medijima. Indeksi se temelje na semantičkim kategorijama i normaliziraju se na skalu 0-100.

### Pregled indeksa

Konstruira se 10 specijaliziranih indeksa:

1. **VCI** (Violent Crime Index) mjeri intenzitet diskursa o nasilnom kriminalu
2. **PCI** (Property Crime Index) prati imovinski kriminal
3. **OCI** (Organized Crime Index) mjeri organizirani kriminal
4. **PAI** (Prosecution & Arrests Index) prati uhićenja i kazneni progon
5. **TAI** (Traffic Accident Index) mjeri prometne nesreće
6. **FRI** (Fire Index) prati požare
7. **NDI** (Natural Disaster Index) mjeri prirodne katastrofe
8. **ESI** (Emergency Services Index) prati rad hitnih službi
9. **TRI** (Terrorism Index) mjeri terorizam
10. **CSI** (Composite Security Index) kompozitni indeks svih kategorija

::: {.callout-note collapse="true" title="Tehnička metodologija konstrukcije indeksa"}

**Formula za pojedinačne indekse:**

$$
\text{Indeks}_{i,t} = \text{normalize}_{0-100}\left(\frac{\sum_{p \in P_i} \text{count}_{p,t}}{N_t}\right)
$$

gdje je $P_i$ skup pojmova za kategoriju $i$, $\text{count}_{p,t}$ broj pojavljivanja pojma $p$ u mjesecu $t$, a $N_t$ ukupan broj članaka u mjesecu $t$.

**Normalizacija (min-max):**

$$
X_{norm} = \frac{X - \min(X)}{\max(X) - \min(X)} \times 100
$$

**Kompozitni indeks (CSI):**

$$
\text{CSI}_t = \frac{1}{12} \sum_{i=1}^{12} \text{Indeks}_{i,t}
$$

**Interpretacija vrijednosti:**

- 0-25: Niska razina sigurnosnog diskursa
- 25-50: Umjerena razina
- 50-75: Visoka razina
- 75-100: Vrlo visoka razina (krizna razdoblja, veliki incidenti)

:::

```{r index-calculation}
#| label: index-calculation

index_data <- dt[, .(
  volume = .N,
  avg_length = mean(text_length, na.rm = TRUE),
  avg_reach = if("REACH" %in% names(.SD)) mean(REACH, na.rm = TRUE) else NA_real_,
  
  # Semantic categories
  sem_nasilni = sum(count_nasilni_kriminal, na.rm = TRUE),
  sem_imovinski = sum(count_imovinski_kriminal, na.rm = TRUE),
  sem_organizirani = sum(count_organizirani_kriminal, na.rm = TRUE),
  sem_uhicenja = sum(count_uhicenja_pritvori, na.rm = TRUE),
  sem_tuziteljstvo = sum(count_tuziteljstvo_sudstvo, na.rm = TRUE),
  sem_prometne = sum(count_prometne_nesrece, na.rm = TRUE),
  sem_pozari = sum(count_pozari, na.rm = TRUE),
  sem_katastrofe = sum(count_prirodne_katastrofe, na.rm = TRUE),
  sem_hitne = sum(count_hitne_sluzbe, na.rm = TRUE),
  sem_terorizam = sum(count_terorizam, na.rm = TRUE),
  sem_cyber = sum(count_cyber_kriminal, na.rm = TRUE),
  sem_zrtve = sum(count_zrtve_stete, na.rm = TRUE),
  sem_total = sum(count_all_semantic, na.rm = TRUE)
), by = yearmonth][order(yearmonth)]

# Normalize function
normalize <- function(x) {
  if(all(is.na(x))) return(rep(50, length(x)))
  min_x <- min(x, na.rm = TRUE)
  max_x <- max(x, na.rm = TRUE)
  if(max_x == min_x) return(rep(50, length(x)))
  (x - min_x) / (max_x - min_x) * 100
}

# Calculate normalized indices
index_data[, `:=`(
  VCI = normalize(sem_nasilni / volume),        # Violent Crime Index
  PCI = normalize(sem_imovinski / volume),      # Property Crime Index
  OCI = normalize(sem_organizirani / volume),   # Organized Crime Index
  PAI = normalize((sem_uhicenja + sem_tuziteljstvo) / volume),  # Prosecution & Arrests Index
  TAI = normalize(sem_prometne / volume),       # Traffic Accident Index
  FRI = normalize(sem_pozari / volume),         # Fire Index
  NDI = normalize(sem_katastrofe / volume),     # Natural Disaster Index
  ESI = normalize(sem_hitne / volume),          # Emergency Services Index
  TRI = normalize(sem_terorizam / volume),      # Terrorism Index
  CYI = normalize(sem_cyber / volume),          # Cyber Crime Index
  VDI = normalize(sem_zrtve / volume)           # Victims & Damage Index
)]

# Composite Security Index (simple average of all)
index_data[, CSI := (VCI + PCI + OCI + PAI + TAI + FRI + NDI + ESI + TRI + CYI + VDI) / 11]

# 3-month moving averages
index_cols <- c("VCI", "PCI", "OCI", "PAI", "TAI", "FRI", "NDI", "ESI", "TRI", "CYI", "VDI", "CSI")
for(col in index_cols) {
  ma_col <- paste0(col, "_MA3")
  index_data[, (ma_col) := frollmean(get(col), n = 3, align = "center")]
}

# Year-over-year changes
index_data[, CSI_yoy := (CSI / shift(CSI, 12) - 1) * 100]
```

## Prikaz indeksa kroz vrijeme

### Kompozitni indeks sigurnosti (CSI)

Na sljedećem grafikonu se prikazuje Kompozitni indeks sigurnosti (CSI) kroz vrijeme. CSI predstavlja prosječnu vrijednost svih 11 specijaliziranih indeksa.

```{r csi-plot}
#| label: csi-plot
#| fig-cap: "Kompozitni indeks sigurnosti (CSI)"
#| fig-height: 7

ggplot(index_data, aes(x = yearmonth)) +
  geom_ribbon(aes(ymin = 0, ymax = CSI), fill = colors_gimes["secondary"], alpha = 0.3) +
  geom_line(aes(y = CSI), color = colors_gimes["secondary"], linewidth = 0.8, alpha = 0.5) +
  geom_line(aes(y = CSI_MA3), color = colors_gimes["primary"], linewidth = 1.2, na.rm = TRUE) +
  geom_point(aes(y = CSI_MA3), color = colors_gimes["primary"], size = 2, na.rm = TRUE) +
  scale_x_date(date_breaks = "3 months", date_labels = "%b\n%Y") +
  scale_y_continuous(limits = c(0, 100), breaks = seq(0, 100, 20)) +
  labs(
    title = "Kompozitni indeks sigurnosti (CSI)",
    subtitle = "Prosjek svih kategorija sigurnosti (0-100) | Tamna linija = 3-mj. klizni prosjek",
    x = NULL,
    y = "CSI"
  ) +
  theme(
    plot.title = element_text(face = "bold", size = 14),
    plot.subtitle = element_text(size = 10, color = "gray40"),
    panel.grid.minor = element_blank()
  )
```

### Indeksi kriminala

```{r crime-indices-plot}
#| label: crime-indices-plot
#| fig-cap: "Indeksi kriminala kroz vrijeme"
#| fig-height: 8

crime_indices <- melt(
  index_data[, .(yearmonth, VCI, PCI, OCI, PAI)],
  id.vars = "yearmonth",
  variable.name = "indeks",
  value.name = "vrijednost"
)

crime_labels <- c(
  "VCI" = "Nasilni kriminal",
  "PCI" = "Imovinski kriminal",
  "OCI" = "Organizirani kriminal",
  "PAI" = "Uhićenja/Kazneni progon"
)

crime_indices[, indeks_label := crime_labels[as.character(indeks)]]

ggplot(crime_indices, aes(x = yearmonth, y = vrijednost, color = indeks_label)) +
  geom_line(linewidth = 1) +
  facet_wrap(~indeks_label, ncol = 2, scales = "free_y") +
  scale_x_date(date_breaks = "6 months", date_labels = "%b %y") +
  scale_color_manual(values = c(
    "Nasilni kriminal" = colors_gimes["crime"],
    "Imovinski kriminal" = colors_gimes["warning"],
    "Organizirani kriminal" = colors_gimes["purple"],
    "Uhićenja/Kazneni progon" = colors_gimes["primary"]
  )) +
  labs(
    title = "Indeksi kriminala kroz vrijeme",
    subtitle = "Normalizirane vrijednosti (0-100)",
    x = NULL,
    y = "Vrijednost indeksa",
    color = NULL
  ) +
  theme(
    plot.title = element_text(face = "bold"),
    legend.position = "none",
    axis.text.x = element_text(angle = 45, hjust = 1, size = 7),
    strip.text = element_text(face = "bold", size = 9)
  )
```

### Indeksi nesreća i katastrofa

```{r disaster-indices-plot}
#| label: disaster-indices-plot
#| fig-cap: "Indeksi nesreća i katastrofa"
#| fig-height: 8

disaster_indices <- melt(
  index_data[, .(yearmonth, TAI, FRI, NDI, ESI)],
  id.vars = "yearmonth",
  variable.name = "indeks",
  value.name = "vrijednost"
)

disaster_labels <- c(
  "TAI" = "Prometne nesreće",
  "FRI" = "Požari",
  "NDI" = "Prirodne katastrofe",
  "ESI" = "Hitne službe"
)

disaster_indices[, indeks_label := disaster_labels[as.character(indeks)]]

ggplot(disaster_indices, aes(x = yearmonth, y = vrijednost, color = indeks_label)) +
  geom_line(linewidth = 1) +
  facet_wrap(~indeks_label, ncol = 2, scales = "free_y") +
  scale_x_date(date_breaks = "6 months", date_labels = "%b %y") +
  scale_color_manual(values = c(
    "Prometne nesreće" = colors_gimes["accent"],
    "Požari" = colors_gimes["disaster"],
    "Prirodne katastrofe" = colors_gimes["secondary"],
    "Hitne službe" = colors_gimes["emergency"]
  )) +
  labs(
    title = "Indeksi nesreća i katastrofa kroz vrijeme",
    subtitle = "Normalizirane vrijednosti (0-100)",
    x = NULL,
    y = "Vrijednost indeksa",
    color = NULL
  ) +
  theme(
    plot.title = element_text(face = "bold"),
    legend.position = "none",
    axis.text.x = element_text(angle = 45, hjust = 1, size = 7),
    strip.text = element_text(face = "bold", size = 9)
  )
```

## Objašnjenja pojedinačnih indeksa

### VCI (Violent Crime Index)

Indeks nasilnog kriminala (VCI) mjeri intenzitet diskursa o nasilnim kaznenim djelima uključujući ubojstva, napade, silovanja i obiteljsko nasilje.

::: {.callout-note collapse="true" title="Tehnička metodologija VCI indeksa"}

**Formula:**

$$
\text{VCI}_t = \text{normalize}_{0-100}\left(\frac{\text{count}_{nasilni,t}}{N_t}\right)
$$

**Uključeni pojmovi:** ubojstvo, fizički napad, napad nožem/oružjem, silovanje, seksualno nasilje, obiteljsko nasilje

**Interpretacija:** Visoke vrijednosti ukazuju na intenzivan medijski diskurs o nasilnom kriminalu.

:::

### TAI (Traffic Accident Index)

Indeks prometnih nesreća (TAI) prati intenzitet diskursa o prometnim nesrećama i sigurnosti u prometu.

::: {.callout-note collapse="true" title="Tehnička metodologija TAI indeksa"}

**Formula:**

$$
\text{TAI}_t = \text{normalize}_{0-100}\left(\frac{\text{count}_{prometne,t}}{N_t}\right)
$$

**Uključeni pojmovi:** prometna nesreća, sudar, slijetanje, poginuo u prometu, alkohol za volanom, autocesta

**Interpretacija:** Sezonski obrazac vidljiv s vrhovima tijekom ljetne sezone i blagdana.

:::

### FRI (Fire Index)

Indeks požara (FRI) mjeri intenzitet diskursa o požarima i vatrogasnim intervencijama.

::: {.callout-note collapse="true" title="Tehnička metodologija FRI indeksa"}

**Formula:**

$$
\text{FRI}_t = \text{normalize}_{0-100}\left(\frac{\text{count}_{pozari,t}}{N_t}\right)
$$

**Uključeni pojmovi:** požar, šumski požar, stambeni požar, vatrogasci, JVP, DVD, gašenje požara

**Interpretacija:** Snažan sezonski obrazac s vrhovima u ljetnim mjesecima (lipanj-rujan).

:::

### NDI (Natural Disaster Index)

Indeks prirodnih katastrofa (NDI) prati intenzitet diskursa o potresima, poplavama, olujama i drugim prirodnim nepogodama.

::: {.callout-note collapse="true" title="Tehnička metodologija NDI indeksa"}

**Formula:**

$$
\text{NDI}_t = \text{normalize}_{0-100}\left(\frac{\text{count}_{katastrofe,t}}{N_t}\right)
$$

**Uključeni pojmovi:** potres, magnituda, Richter, seizmološki, poplava, bujica, oluja, nevrijeme, klizište, odron

**Interpretacija:** Vrhovi koincidiraju s velikim prirodnim nepogodama (npr. potres u Petrinji 2020).

:::

### PAI (Prosecution & Arrests Index)

Indeks kaznenog progona (PAI) mjeri intenzitet diskursa o uhićenjima, optužnicama i radu pravosudnih institucija.

::: {.callout-note collapse="true" title="Tehnička metodologija PAI indeksa"}

**Formula:**

$$
\text{PAI}_t = \text{normalize}_{0-100}\left(\frac{\text{count}_{uhicenja,t} + \text{count}_{tuziteljstvo,t}}{N_t}\right)
$$

**Uključeni pojmovi:** uhićen, priveden, pritvor, DORH, USKOK, PNUSKOK, optužnica, kaznena prijava, presuda

**Interpretacija:** Visoke vrijednosti signaliziraju intenzivne policijske i pravosudne aktivnosti.

:::

## Tablica indeksa

```{r index-table}
#| label: index-table

index_table <- index_data[, .(
  Mjesec = format(yearmonth, "%b %Y"),
  `Broj članaka` = format(volume, big.mark = ","),
  CSI = round(CSI, 1),
  VCI = round(VCI, 1),
  TAI = round(TAI, 1),
  FRI = round(FRI, 1),
  NDI = round(NDI, 1),
  PAI = round(PAI, 1)
)]

kable(tail(index_table, 12), 
      caption = "Indeksi sigurnosti - zadnjih 12 mjeseci",
      align = c("l", "r", rep("r", 6))) %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"), full_width = FALSE) %>%
  row_spec(0, bold = TRUE, background = colors_gimes["primary"], color = "white")
```

# Korelacijska analiza

## Korelacijska matrica indeksa

Korelacijska matrica prikazuje međusobne odnose između svih konstruiranih indeksa. Pozitivna korelacija ukazuje na to da dva indeksa tendiraju rasti i padati zajedno.

```{r correlation-matrix}
#| label: correlation-matrix
#| fig-cap: "Korelacijska matrica indeksa sigurnosti"
#| fig-height: 10

cor_vars <- c("VCI", "PCI", "OCI", "PAI", "TAI", "FRI", "NDI", "ESI", "TRI", "CYI", "VDI", "CSI")
cor_data <- index_data[, .SD, .SDcols = cor_vars]
cor_matrix <- cor(cor_data, use = "pairwise.complete.obs")

corrplot(cor_matrix,
         method = "color",
         type = "upper",
         order = "hclust",
         tl.col = "black",
         tl.srt = 45,
         tl.cex = 0.8,
         addCoef.col = "black",
         number.cex = 0.6,
         col = colorRampPalette(c(colors_gimes["accent"], "white", colors_gimes["secondary"]))(100),
         title = "Korelacijska matrica indeksa sigurnosti",
         mar = c(0, 0, 2, 0))
```

## Korelacijska tablica

```{r correlation-table}
#| label: correlation-table

# Korelacije s CSI
csi_correlations <- data.table(
  Indeks = cor_vars[cor_vars != "CSI"],
  Korelacija_s_CSI = sapply(cor_vars[cor_vars != "CSI"], function(x) {
    round(cor(index_data[[x]], index_data$CSI, use = "complete.obs"), 3)
  })
)[order(-Korelacija_s_CSI)]

kable(csi_correlations, 
      col.names = c("Indeks", "Korelacija s CSI"),
      caption = "Korelacije pojedinačnih indeksa s Kompozitnim indeksom sigurnosti") %>%
  kable_styling(bootstrap_options = c("striped", "hover"), full_width = FALSE)
```

# Dinamike različitih frekvencija

## Sezonska prilagodba

Sezonska prilagodba se provodi korištenjem STL (Seasonal and Trend decomposition using Loess) dekompozicije. Sigurnosni podaci pokazuju izražene sezonske obrasce, posebno za požare i prometne nesreće.

::: {.callout-note collapse="true" title="Tehnička metodologija sezonske prilagodbe"}

**STL dekompozicija:**

$$
Y_t = T_t + S_t + R_t
$$

gdje je $T_t$ trend, $S_t$ sezonska komponenta, a $R_t$ ostatak.

**Sezonski prilagođena serija:**

$$
Y_{SA,t} = T_t + R_t = Y_t - S_t
$$

**Napomena za sigurnosne podatke:**

Sezonska komponenta je posebno značajna za:
- Požare (vrhunac ljeti)
- Prometne nesreće (vrhunac ljeti i tijekom blagdana)
- Prirodne katastrofe (ovisno o tipu)

:::

```{r seasonal-adjustment}
#| label: seasonal-adjustment

csi_ts <- ts(index_data$CSI, 
             start = c(year(min(index_data$yearmonth)), month(min(index_data$yearmonth))),
             frequency = 12)

stl_csi <- tryCatch({
  stl(csi_ts, s.window = "periodic", robust = TRUE)
}, error = function(e) {
  message("STL dekompozicija nije uspjela: ", e$message)
  NULL
})

if(!is.null(stl_csi)) {
  index_data[, CSI_sa := as.numeric(seasadj(stl_csi))]
} else {
  index_data[, CSI_sa := CSI]
}
```

## Vizualizacija sezonske komponente

```{r seasonal-decomposition-plot}
#| label: seasonal-decomposition-plot
#| fig-cap: "STL dekompozicija Kompozitnog indeksa sigurnosti"
#| fig-height: 10

if(!is.null(stl_csi)) {
  decomp_df <- data.table(
    yearmonth = index_data$yearmonth,
    Original = as.numeric(csi_ts),
    Trend = as.numeric(stl_csi$time.series[, "trend"]),
    Sezonska = as.numeric(stl_csi$time.series[, "seasonal"]),
    Ostatak = as.numeric(stl_csi$time.series[, "remainder"]),
    SA = as.numeric(seasadj(stl_csi))
  )
  
  decomp_long <- melt(decomp_df, id.vars = "yearmonth", 
                      variable.name = "komponenta", value.name = "vrijednost")
  
  ggplot(decomp_long, aes(x = yearmonth, y = vrijednost)) +
    geom_line(color = colors_gimes["primary"], linewidth = 0.8) +
    facet_wrap(~komponenta, ncol = 1, scales = "free_y") +
    scale_x_date(date_breaks = "6 months", date_labels = "%b %Y") +
    labs(
      title = "STL dekompozicija Kompozitnog indeksa sigurnosti",
      subtitle = "Original = Trend + Sezonska + Ostatak | SA = Sezonski prilagođeno",
      x = NULL,
      y = "Vrijednost"
    ) +
    theme(
      plot.title = element_text(face = "bold"),
      strip.text = element_text(face = "bold")
    )
}
```

## Izračun različitih dinamika

```{r calculate-dynamics}
#| label: calculate-dynamics

annualize_rate <- function(rate, periods_per_year) {
  ((1 + rate/100)^periods_per_year - 1) * 100
}

index_data[, `:=`(
  CSI_mom_sa = (CSI_sa / shift(CSI_sa, 1) - 1) * 100,
  CSI_yoy_pct = (CSI / shift(CSI, 12) - 1) * 100
)]

index_data[, CSI_3m_avg := frollmean(CSI_sa, n = 3, align = "right")]
index_data[, CSI_3m_prev := shift(CSI_3m_avg, 3)]
index_data[, CSI_3m_ann := annualize_rate((CSI_3m_avg / CSI_3m_prev - 1) * 100, 4)]

index_data[, CSI_6m_avg := frollmean(CSI_sa, n = 6, align = "right")]
index_data[, CSI_6m_prev := shift(CSI_6m_avg, 6)]
index_data[, CSI_6m_ann := annualize_rate((CSI_6m_avg / CSI_6m_prev - 1) * 100, 2)]
```

## Usporedba različitih dinamika

```{r dynamics-comparison}
#| label: dynamics-comparison
#| fig-cap: "Usporedba različitih dinamika CSI"
#| fig-height: 10

dynamics_df <- index_data[, .(
  yearmonth,
  `Y/Y (%)` = CSI_yoy_pct,
  `M/M SA (%)` = CSI_mom_sa,
  `3M ann. SA (%)` = CSI_3m_ann,
  `6M ann. SA (%)` = CSI_6m_ann
)]

dynamics_long <- melt(dynamics_df, id.vars = "yearmonth",
                      variable.name = "dinamika", value.name = "stopa")

ggplot(dynamics_long[!is.na(stopa)], aes(x = yearmonth, y = stopa, color = dinamika)) +
  geom_hline(yintercept = 0, color = "gray50", linetype = "dashed") +
  geom_line(linewidth = 1) +
  facet_wrap(~dinamika, ncol = 2, scales = "free_y") +
  scale_x_date(date_breaks = "6 months", date_labels = "%b %y") +
  scale_color_manual(values = c(
    "Y/Y (%)" = colors_gimes["primary"],
    "M/M SA (%)" = colors_gimes["accent"],
    "3M ann. SA (%)" = colors_gimes["success"],
    "6M ann. SA (%)" = colors_gimes["warning"]
  )) +
  labs(
    title = "Usporedba različitih dinamika Kompozitnog indeksa sigurnosti",
    subtitle = "Y/Y = godina na godinu | M/M SA = mjesec na mjesec sezonski prilagođeno",
    x = NULL,
    y = "Promjena (%)",
    color = NULL
  ) +
  theme(
    plot.title = element_text(face = "bold"),
    legend.position = "none",
    strip.text = element_text(face = "bold"),
    axis.text.x = element_text(angle = 45, hjust = 1)
  )
```

# Heatmapa sigurnosti po kategorijama

## Mjesečna heatmapa

Heatmapa prikazuje intenzitet različitih kategorija sigurnosti kroz vrijeme. Tamnije boje indiciraju viši intenzitet. Sezonski obrasci su jasno vidljivi za požare (ljeto) i određene vrste kriminala.

```{r heatmap}
#| label: heatmap
#| fig-cap: "Heatmapa intenziteta sigurnosnih kategorija kroz vrijeme"
#| fig-height: 10

# Prepare data for heatmap
heatmap_data <- index_data[, .(yearmonth, VCI, PCI, OCI, PAI, TAI, FRI, NDI, ESI, TRI, CYI, VDI)]

heatmap_long <- melt(heatmap_data, 
                     id.vars = "yearmonth",
                     variable.name = "indeks",
                     value.name = "vrijednost")

index_labels_full <- c(
  "VCI" = "Nasilni kriminal",
  "PCI" = "Imovinski kriminal",
  "OCI" = "Organizirani kriminal",
  "PAI" = "Uhićenja/Progon",
  "TAI" = "Prometne nesreće",
  "FRI" = "Požari",
  "NDI" = "Prirodne katastrofe",
  "ESI" = "Hitne službe",
  "TRI" = "Terorizam",
  "CYI" = "Cyber kriminal",
  "VDI" = "Žrtve/Štete"
)

heatmap_long[, indeks_label := index_labels_full[as.character(indeks)]]

ggplot(heatmap_long, aes(x = yearmonth, y = reorder(indeks_label, vrijednost), fill = vrijednost)) +
  geom_tile() +
  scale_fill_viridis_c(option = "inferno", name = "Intenzitet") +
  scale_x_date(date_breaks = "3 months", date_labels = "%b %y") +
  labs(
    title = "Heatmapa intenziteta sigurnosnih kategorija",
    subtitle = "Tamnije boje indiciraju viši intenzitet medijskog diskursa | Sezonski obrasci vidljivi za požare",
    x = NULL,
    y = NULL
  ) +
  theme(
    plot.title = element_text(face = "bold"),
    axis.text.x = element_text(angle = 45, hjust = 1, size = 8),
    axis.text.y = element_text(size = 9),
    legend.position = "right"
  )
```

# Zaključci

## Ključni nalazi

```{r summary-findings}
#| label: summary-findings

peak_month <- index_data[which.max(CSI), yearmonth]
peak_value <- index_data[which.max(CSI), CSI]

# Find dominant category
all_indices <- c("VCI", "PCI", "OCI", "PAI", "TAI", "FRI", "NDI", "ESI", "TRI", "CYI", "VDI")

category_means <- colMeans(index_data[, .SD, .SDcols = all_indices], na.rm = TRUE)
dominant_category <- names(which.max(category_means))

findings <- data.table(
  Nalaz = c(
    "Ukupno analiziranih članaka",
    "Vremenski raspon analize",
    "Broj izvora",
    "",
    "Vrh CSI indeksa",
    "Vrijednost vrha",
    "",
    "Dominantna kategorija",
    "Prosječna vrijednost",
    "",
    "Prosječni CSI",
    "Standardna devijacija CSI"
  ),
  Vrijednost = c(
    format(nrow(dt), big.mark = ","),
    paste(format(min(dt$date), "%m/%Y"), "-", format(max(dt$date), "%m/%Y")),
    as.character(length(unique(dt$FROM))),
    "",
    format(peak_month, "%B %Y"),
    round(peak_value, 1),
    "",
    index_labels_full[dominant_category],
    round(category_means[dominant_category], 1),
    "",
    round(mean(index_data$CSI, na.rm = TRUE), 1),
    round(sd(index_data$CSI, na.rm = TRUE), 1)
  )
)

kable(findings, caption = "Sažetak ključnih nalaza analize") %>%
  kable_styling(bootstrap_options = c("striped", "hover"), full_width = FALSE) %>%
  row_spec(c(4, 7, 10), background = colors_gimes["light"])
```

## Export podataka u Excel

```{r export-excel}
#| label: export-excel

wb <- createWorkbook()

# Main indices sheet
export_indices <- index_data[, .(
  Datum = yearmonth,
  Godina = year(yearmonth),
  Mjesec = month(yearmonth),
  Broj_clanaka = volume,
  CSI = round(CSI, 2),
  CSI_MA3 = round(CSI_MA3, 2),
  VCI = round(VCI, 2),
  PCI = round(PCI, 2),
  OCI = round(OCI, 2),
  PAI = round(PAI, 2),
  TAI = round(TAI, 2),
  FRI = round(FRI, 2),
  NDI = round(NDI, 2),
  ESI = round(ESI, 2),
  TRI = round(TRI, 2),
  CYI = round(CYI, 2),
  VDI = round(VDI, 2)
)]

addWorksheet(wb, "Indeksi")
writeData(wb, "Indeksi", export_indices)

header_style <- createStyle(
  textDecoration = "bold",
  fgFill = "#2C3E50",
  fontColour = "white",
  halign = "center"
)
addStyle(wb, "Indeksi", header_style, rows = 1, cols = 1:ncol(export_indices))
setColWidths(wb, "Indeksi", cols = 1:ncol(export_indices), widths = "auto")

# Semantic categories sheet
semantic_export <- monthly_semantic[, .(
  Datum = yearmonth,
  Broj_clanaka = N,
  Nasilni_kriminal = count_nasilni_kriminal,
  Imovinski_kriminal = count_imovinski_kriminal,
  Organizirani_kriminal = count_organizirani_kriminal,
  Uhicenja_pritvori = count_uhicenja_pritvori,
  Tuziteljstvo_sudstvo = count_tuziteljstvo_sudstvo,
  Prometne_nesrece = count_prometne_nesrece,
  Pozari = count_pozari,
  Prirodne_katastrofe = count_prirodne_katastrofe,
  Hitne_sluzbe = count_hitne_sluzbe,
  Terorizam = count_terorizam,
  Cyber_kriminal = count_cyber_kriminal,
  Zrtve_stete = count_zrtve_stete,
  Ukupno = count_all_semantic
)]

addWorksheet(wb, "Semanticke_kategorije")
writeData(wb, "Semanticke_kategorije", semantic_export)
addStyle(wb, "Semanticke_kategorije", header_style, rows = 1, cols = 1:ncol(semantic_export))
setColWidths(wb, "Semanticke_kategorije", cols = 1:ncol(semantic_export), widths = "auto")

# Dynamics sheet
dynamics_export <- index_data[, .(
  Datum = yearmonth,
  CSI_original = round(CSI, 2),
  CSI_SA = round(CSI_sa, 2),
  CSI_YoY = round(CSI_yoy_pct, 2),
  CSI_MoM_SA = round(CSI_mom_sa, 2),
  CSI_3M_ann = round(CSI_3m_ann, 2),
  CSI_6M_ann = round(CSI_6m_ann, 2)
)]

addWorksheet(wb, "Dinamike")
writeData(wb, "Dinamike", dynamics_export)
addStyle(wb, "Dinamike", header_style, rows = 1, cols = 1:ncol(dynamics_export))
setColWidths(wb, "Dinamike", cols = 1:ncol(dynamics_export), widths = "auto")

# Correlations sheet
cor_export <- as.data.table(cor_matrix, keep.rownames = "Indeks")

addWorksheet(wb, "Korelacije")
writeData(wb, "Korelacije", cor_export)
addStyle(wb, "Korelacije", header_style, rows = 1, cols = 1:ncol(cor_export))
setColWidths(wb, "Korelacije", cols = 1:ncol(cor_export), widths = "auto")

# Save
output_path <- here("output", "security_indices.xlsx")
dir.create(here("output"), showWarnings = FALSE, recursive = TRUE)
saveWorkbook(wb, output_path, overwrite = TRUE)

message("Excel datoteka spremljena: ", output_path)
```

---

*Izvještaj generiran: `r Sys.time()`*

*GIMES Research | Analiza medijske pokrivenosti sigurnosti i stabilnosti v1.0*
