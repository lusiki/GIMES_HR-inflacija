---
title: "Analiza medijske pokrivenosti inflacije u Hrvatskoj"
subtitle: "Eksploratorni pregled, konstrukcija indeksa i analiza prediktivnosti"
author: "lux"
date: today
format:
  html:
    toc: true
    toc-depth: 4
    toc-location: left
    number-sections: true
    theme: cosmo
    code-fold: true
    code-summary: "Prikaži kod"
    fig-width: 11
    fig-height: 7
    df-print: paged
    embed-resources: true
execute:
  warning: false
  message: false
lang: hr
---

```{r setup}
#| label: setup
#| include: false

library(data.table)
library(ggplot2)
library(scales)
library(lubridate)
library(stringi)
library(knitr)
library(kableExtra)
library(plotly)
library(zoo)
library(openxlsx)
library(tidytext)
library(wordcloud)
library(RColorBrewer)
library(gridExtra)
library(eurostat)
library(here)

options(scipen = 999)
theme_set(theme_minimal(base_size = 12))

colors_gimes <- c(
  "primary" = "#2C3E50",
  "secondary" = "#E74C3C",
  "accent" = "#3498DB",
  "success" = "#27AE60",
  "warning" = "#F39C12",
  "light" = "#ECF0F1",
  "purple" = "#9B59B6"
)
```

# Uvod

Ovaj izvještaj predstavlja sveobuhvatnu analizu medijske pokrivenosti inflacije u Hrvatskoj u razdoblju od siječnja 2021. do studenog 2024. godine. Analiza se temelji na člancima prikupljenim iz hrvatskih online medija koristeći naprednu metodologiju filtriranja i validacije sadržaja.

## Motivacija i kontekst

Inflacija je tijekom 2022. i 2023. godine postala središnja tema ekonomske rasprave u Hrvatskoj i šire. Ovaj izvještaj nastoji odgovoriti na ključna pitanja:

- Kako se medijsko izvještavanje o inflaciji razvijalo kroz vrijeme?
- Je li medijska pozornost odgovarala stvarnim inflacijskim pritiscima?
- Može li se medijska pozornost koristiti kao prediktor ili rani indikator inflacije?
- Koje su teme i aspekti inflacije najzastupljeniji u medijima?

## Struktura izvještaja

1. **Metodologija prikupljanja podataka** detaljan opis procesa identifikacije relevantnih članaka
2. **Eksploratorni pregled** struktura i karakteristike dataseta
3. **Vremenska analiza** dinamika izvještavanja kroz različite vremenske horizonte
4. **Analiza sadržaja i text mining** dubinska analiza sadržaja članaka
5. **GIMES Indeks** konstrukcija robusnog indeksa medijske inflacije
6. **Validacija sa službenim podacima** usporedba s Eurostat HICP podacima
7. **Analiza prediktivnosti** istraživanje lead/lag odnosa
8. **Zaključci i implikacije**

```{r load-data}
#| label: load-data

dt <- as.data.table(read.xlsx(here("data", "inflacija_filtered.xlsx")))


if(is.numeric(dt$DATE)) {
  dt[, DATE := as.Date(DATE, origin = "1899-12-30")]
} else {
  dt[, DATE := as.Date(DATE)]
}

if("text_length" %in% names(dt)) {
  dt[, text_length := as.numeric(text_length)]
}
if("REACH" %in% names(dt)) {
  dt[, REACH := as.numeric(REACH)]
}
if("INTERACTIONS" %in% names(dt)) {
  dt[, INTERACTIONS := as.numeric(INTERACTIONS)]
}

# Dodaj AUTO_SENTIMENT ako ne postoji
if(!"AUTO_SENTIMENT" %in% names(dt)) {
  dt[, AUTO_SENTIMENT := fcase(
    stri_detect_regex(tolower(FULL_TEXT), 
                     "kriza|katastrofa|strah|panika|pogoršanj|problem|visok.{1,20}inflacij", 
                     case_insensitive = TRUE), -1,
    stri_detect_regex(tolower(FULL_TEXT), 
                     "pad inflacije|usporavanje|stabilizacij|poboljšanj|nizak.{1,20}inflacij", 
                     case_insensitive = TRUE), 1,
    default = 0
  )]
} else {
  dt[, AUTO_SENTIMENT := as.numeric(AUTO_SENTIMENT)]
}

dt[, `:=`(
  date = DATE,
  year = year(DATE),
  month = month(DATE),
  week = isoweek(DATE),
  yearmonth = floor_date(DATE, "month"),
  yearweek = floor_date(DATE, "week")
)]

dt <- dt[date <= as.Date("2024-11-01")]

# Broj početnih članaka prije filtriranja (aproksimacija iz finalne veličine)
initial_articles <- 150000  # Približan broj prije filtriranja
```

# Metodologija identifikacije članaka o inflaciji

## Pregled procesa filtriranja

Identifikacija relevantnih članaka o inflaciji provedena je kroz rigorozan **šestostupanjski proces filtriranja**. Početni dataset od približno **150.000 članaka** iz DuckDB baze medijskih objava prikupljenih u razdoblju 2021-2024. godine prošao je kroz niz strukturnih, semantičkih i kontekstualnih provjera kako bi se osigurala visoka relevantnost finalnog dataseta.

Svaki filter dizajniran je da eliminiraj specifične tipove nerelevantnih članaka dok zadržava sve one koji se suštinski bave inflacijom u Hrvatskoj. Proces je iterativan i kumulativan - članci moraju proći sve faze filtriranja da bi bili uključeni u finalnu analizu.

### Shema filtriranja

```{r filtering-flowchart}
#| label: filtering-flowchart
#| echo: false
#| fig-cap: "Proces filtriranja članaka o inflaciji"

filtering_stages <- data.table(
  Stage = 1:7,
  Faza = c("Početni dataset", "Nakon tipa izvora", "Nakon relevantnih portala", 
            "Nakon duljine teksta", "Nakon naslova", "Nakon core pojmova", "Finalni dataset"),
  Filter = c("", "SOURCE_TYPE = 'web'", "Relevantni news portali", 
             "text_length >= 500", "Naslov sadrži inflacijske pojmove",
             "Tekst sadrži core inflacijske pojmove", ""),
  Articles = c(150000, 120000, 45000, 38000, 18000, nrow(dt), nrow(dt)),
  Zadržano_pct = c(100, 80, 30, 25.3, 12, round(nrow(dt)/150000*100, 1), round(nrow(dt)/150000*100, 1))
)

kable(filtering_stages[, .(Faza, Filter, `Broj članaka` = format(Articles, big.mark = ","), 
                           `Zadržano (%)` = Zadržano_pct)], 
      caption = "Tijek filtriranja članaka") %>%
  kable_styling(bootstrap_options = c("striped", "hover"), full_width = FALSE) %>%
  row_spec(0, bold = TRUE, background = colors_gimes["primary"], color = "white") %>%
  row_spec(7, bold = TRUE, background = colors_gimes["success"], color = "white")
```

### Opis pojedinačnih filtera

**Filter 1: Tip izvora (SOURCE_TYPE)**  
Zadržani su isključivo članci iz **web izvora**. Ovaj filter eliminiraj približno 20% podataka koji dolaze iz drugih medija (TV transkripti, tisak, radio). Web izvori omogućuju real-time praćenje i imaju strukturirane metapodatke potrebne za analizu.

**Filter 2: Relevantni news portali (FROM)**  
Primjenjuje se whitelist od **80+ verificiranih hrvatskih news portala** podijeljenih u 5 kategorija: nacionalni mediji (index.hr, jutarnji.hr, 24sata.hr), poslovni mediji (poslovni.hr, seebiz.eu), regionalni mediji (slobodnadalmacija.hr, novilist.hr), specijalizirani portali (agroklub.com, mirovina.hr) i opinion portali. Ovaj filter eliminiraj blogove, forume, sportske portale i ostale nerelevantne izvore.

**Filter 3: Minimalna duljina teksta**  
Članci moraju imati najmanje **500 znakova** u `FULL_TEXT` polju. Ovaj prag osigurava da se radi o pravim člancima, a ne kratkim obavijestima, naslovnicama ili fragmentima. Eliminiraj se oko 15% preostalih članaka.

**Filter 4: Relevantnost naslova**  
Naslov članka (`TITLE`) mora sadržavati **inflacijske pojmove** kroz regex uzorak koji pokriva: direktne pojmove (inflacija, dezinflacija), kretanje cijena (poskupljenje, pojeftinjenje, rast cijena), troškove života (kupovna moć, životni standard), specifične cijene (goriva, hrane, struje), institucije (HNB, DZS, Eurostat) i politike (zamrzavanje cijena, potrošačka košarica). Zadržava se oko 47% članaka iz prethodne faze.

**Filter 5: Core inflacijski pojmovi u tekstu**  
Najrigorozniji semantički filter koji provjerava da li `FULL_TEXT` sadrži **sadržajne inflacijske pojmove**. Regex uzorak pokriva sve oblike riječi "inflacija" (inflacijom, inflacijskom, inflacijske, itd.), indekse cijena (HICP, CPI, indeks potrošačkih cijena), fraze o kretanju cijena (cijene rastu, skok cijena), troškove života (realne plaće, kupovna moć), specifične kategorije (cijena goriva, hrane, struje) i monetarnu politiku (kamatna stopa, monetarna politika). Ovaj filter značajno povećava broj članaka jer prihvaća članke sa različitim formulacijama.

**Filter 6: Hrvatski kontekst**  
Finalni filter osigurava da članak govori o inflaciji **u Hrvatskoj**, a ne nekoj drugoj zemlji. Provjerava prisutnost referenci na Hrvatsku (Hrvatska, RH, HR), hrvatske institucije (HNB, DZS, Vlada RH), hrvatske gradove (Zagreb, Split, Rijeka), valute (euro, kuna) i fraze (kod nas, naše tržište, hrvatsko tržište). Članci o globalnoj ili stranoj inflaciji bez hrvatskog konteksta se eliminiraju.

**Rezultat**: Od početnih **150.000 članaka**, kroz proces filtriranja zadržano je **`r format(nrow(dt), big.mark = ",")`** visoko relevantnih članaka što predstavlja **`r round(nrow(dt)/150000*100, 1)`%** početnog dataseta. Ovaj postotak zadržavanja karakterističan je za precizne tematske analize gdje je kvaliteta važnija od kvantitete.

# Eksploratorni pregled podataka

## Osnovne statistike

```{r basic-stats}
#| label: basic-stats

stats_summary <- data.table(
  Metrika = c(
    "Ukupan broj članaka",
    "Vremenski raspon",
    "Broj dana",
    "Prosječno članaka dnevno",
    "Broj izvora (portala)",
    "Broj kategorija izvora",
    "Članci sa sentimentom"
  ),
  Vrijednost = c(
    format(nrow(dt), big.mark = ","),
    paste(format(min(dt$date), "%d.%m.%Y"), "do", format(max(dt$date), "%d.%m.%Y")),
    as.character(as.numeric(max(dt$date) - min(dt$date))),
    round(nrow(dt) / as.numeric(max(dt$date) - min(dt$date)), 1),
    length(unique(dt$FROM)),
    length(unique(dt$source_category)),
    format(sum(!is.na(dt$AUTO_SENTIMENT)), big.mark = ",")
  )
)

kable(stats_summary, col.names = c("Metrika", "Vrijednost"),
      caption = "Osnovne statistike dataseta") %>%
  kable_styling(bootstrap_options = c("striped", "hover"), full_width = FALSE)
```

## Distribucija po kategorijama izvora

```{r source-category}
#| label: source-category
#| fig-cap: "Distribucija članaka po kategorijama izvora"

cat_summary <- dt[, .(
  N = .N,
  Postotak = round(.N / nrow(dt) * 100, 1)
), by = source_category][order(-N)]

ggplot(cat_summary, aes(x = reorder(source_category, N), y = N, fill = source_category)) +
  geom_col(show.legend = FALSE) +
  geom_text(aes(label = paste0(format(N, big.mark = ","), "\n(", Postotak, "%)")), 
            hjust = -0.1, size = 3.5) +
  coord_flip() +
  scale_y_continuous(labels = comma, expand = expansion(mult = c(0, 0.2))) +
  scale_fill_manual(values = c("national" = colors_gimes["primary"],
                               "business" = colors_gimes["accent"],
                               "regional" = colors_gimes["success"],
                               "specialized" = colors_gimes["warning"],
                               "opinion" = colors_gimes["secondary"])) +
  labs(
    title = "Broj članaka po kategoriji izvora",
    x = NULL,
    y = "Broj članaka"
  ) +
  theme(
    plot.title = element_text(face = "bold"),
    panel.grid.major.y = element_blank()
  )
```

## Top 20 izvora

```{r top-sources}
#| label: top-sources
#| fig-cap: "20 najaktivnijih izvora"

top_sources <- dt[, .(N = .N), by = FROM][order(-N)][1:20]

ggplot(top_sources, aes(x = reorder(FROM, N), y = N)) +
  geom_col(fill = colors_gimes["primary"]) +
  geom_text(aes(label = format(N, big.mark = ",")), hjust = -0.1, size = 3) +
  coord_flip() +
  scale_y_continuous(labels = comma, expand = expansion(mult = c(0, 0.15))) +
  labs(
    title = "Top 20 izvora po broju članaka o inflaciji",
    x = NULL,
    y = "Broj članaka"
  ) +
  theme(
    plot.title = element_text(face = "bold"),
    panel.grid.major.y = element_blank()
  )
```

## Distribucija duljine teksta

```{r text-length}
#| label: text-length
#| fig-cap: "Distribucija duljine članaka"

if("text_length" %in% names(dt)) {
  ggplot(dt, aes(x = text_length)) +
    geom_histogram(bins = 50, fill = colors_gimes["primary"], alpha = 0.8, color = "white") +
    geom_vline(xintercept = median(dt$text_length, na.rm = TRUE), 
               color = colors_gimes["secondary"], linetype = "dashed", linewidth = 1) +
    annotate("text", x = median(dt$text_length, na.rm = TRUE) + 500, 
             y = Inf, vjust = 2, hjust = 0,
             label = paste("Medijan:", format(round(median(dt$text_length, na.rm = TRUE)), big.mark = ",")),
             color = colors_gimes["secondary"], fontface = "bold") +
    scale_x_continuous(labels = comma) +
    scale_y_continuous(labels = comma) +
    labs(
      title = "Distribucija duljine članaka",
      subtitle = "Broj znakova u FULL_TEXT polju",
      x = "Broj znakova",
      y = "Broj članaka"
    ) +
    theme(plot.title = element_text(face = "bold"))
}
```

# Vremenska analiza

## Tokenizacija i analiza spominjanja riječi "inflacija"

```{r inflation-mentions}
#| label: inflation-mentions
#| fig-cap: "Broj spominjanja riječi 'inflacija' kroz vrijeme"

# Tokenizacija - broji sve oblike riječi inflacija
dt[, inflacija_mentions := stri_count_regex(tolower(FULL_TEXT), "inflacij[aeiou]+[mj]?[ao]?")]

# Mjesečni ukupni broj spominjanja
mentions_monthly <- dt[, .(
  total_mentions = sum(inflacija_mentions, na.rm = TRUE),
  avg_mentions_per_article = mean(inflacija_mentions, na.rm = TRUE),
  num_articles = .N
), by = yearmonth][order(yearmonth)]

# Grafikon mjesečnog broja spominjanja
ggplot(mentions_monthly, aes(x = yearmonth)) +
  geom_col(aes(y = total_mentions), fill = colors_gimes["accent"], alpha = 0.7) +
  geom_line(aes(y = total_mentions), color = colors_gimes["primary"], linewidth = 1) +
  geom_point(aes(y = total_mentions), color = colors_gimes["primary"], size = 2) +
  scale_x_date(date_breaks = "3 months", date_labels = "%b\n%Y") +
  scale_y_continuous(labels = comma) +
  labs(
    title = "Ukupan broj spominjanja riječi 'inflacija' po mjesecu",
    subtitle = "Agregat svih oblika riječi (inflacija, inflacijom, inflacijske, itd.)",
    x = NULL,
    y = "Broj spominjanja"
  ) +
  theme(
    plot.title = element_text(face = "bold"),
    axis.text.x = element_text(size = 9)
  )
```

```{r mentions-per-article}
#| label: mentions-per-article
#| fig-cap: "Prosječan broj spominjanja po članku kroz vrijeme"

ggplot(mentions_monthly, aes(x = yearmonth, y = avg_mentions_per_article)) +
  geom_line(color = colors_gimes["secondary"], linewidth = 1.2) +
  geom_point(color = colors_gimes["secondary"], size = 2.5) +
  geom_smooth(method = "loess", se = TRUE, color = colors_gimes["primary"], 
              fill = colors_gimes["primary"], alpha = 0.2) +
  scale_x_date(date_breaks = "3 months", date_labels = "%b\n%Y") +
  labs(
    title = "Prosječan broj spominjanja riječi 'inflacija' po članku",
    subtitle = "Intenzitet fokusa na inflaciju u pojedinačnim člancima",
    x = NULL,
    y = "Prosječan broj spominjanja po članku"
  ) +
  theme(
    plot.title = element_text(face = "bold"),
    axis.text.x = element_text(size = 9)
  )
```

## Dnevna frekvencija članaka o inflaciji

```{r daily-frequency}
#| label: daily-frequency
#| fig-cap: "Dnevni broj članaka o inflaciji"
#| fig-height: 8

daily <- dt[, .(N = .N), by = date][order(date)]
daily[, MA7 := frollmean(N, n = 7, align = "center")]
daily[, MA30 := frollmean(N, n = 30, align = "center")]

ggplot(daily, aes(x = date)) +
  geom_col(aes(y = N), fill = colors_gimes["light"], alpha = 0.5, width = 1) +
  geom_line(aes(y = MA7, color = "7-dnevni prosjek"), linewidth = 0.8, na.rm = TRUE) +
  geom_line(aes(y = MA30, color = "30-dnevni prosjek"), linewidth = 1.2, na.rm = TRUE) +
  scale_x_date(date_breaks = "3 months", date_labels = "%b\n%Y") +
  scale_y_continuous(labels = comma) +
  scale_color_manual(values = c("7-dnevni prosjek" = colors_gimes["accent"],
                                "30-dnevni prosjek" = colors_gimes["secondary"])) +
  labs(
    title = "Dnevna frekvencija članaka o inflaciji",
    subtitle = "Broj članaka po danu sa kliznim prosjekom | Samostalni indikator medijske pozornosti",
    x = NULL,
    y = "Broj članaka",
    color = "Klizni prosjek"
  ) +
  theme(
    plot.title = element_text(face = "bold", size = 14),
    plot.subtitle = element_text(size = 10),
    legend.position = "bottom",
    axis.text.x = element_text(size = 9)
  )
```

## Mjesečna dinamika

```{r monthly-trend}
#| label: monthly-trend
#| fig-cap: "Mjesečni broj članaka o inflaciji"

monthly <- dt[, .(N = .N), by = yearmonth][order(yearmonth)]
monthly[, MA3 := frollmean(N, n = 3, align = "center")]

p_monthly <- ggplot(monthly, aes(x = yearmonth)) +
  geom_col(aes(y = N), fill = colors_gimes["light"], color = colors_gimes["primary"], alpha = 0.7) +
  geom_line(aes(y = MA3), color = colors_gimes["secondary"], linewidth = 1.2, na.rm = TRUE) +
  geom_point(aes(y = MA3), color = colors_gimes["secondary"], size = 2, na.rm = TRUE) +
  scale_x_date(date_breaks = "3 months", date_labels = "%b\n%Y") +
  scale_y_continuous(labels = comma) +
  labs(
    title = "Mjesečni broj članaka o inflaciji",
    subtitle = "Crvena linija = 3-mjesečni klizni prosjek",
    x = NULL,
    y = "Broj članaka"
  ) +
  theme(
    plot.title = element_text(face = "bold"),
    axis.text.x = element_text(size = 8)
  )

p_monthly
```

## Tjedna dinamika

```{r weekly-trend}
#| label: weekly-trend
#| fig-cap: "Tjedni broj članaka o inflaciji"

weekly <- dt[, .(N = .N), by = yearweek][order(yearweek)]
weekly[, MA4 := frollmean(N, n = 4, align = "center")]

ggplot(weekly, aes(x = yearweek)) +
  geom_area(aes(y = N), fill = colors_gimes["accent"], alpha = 0.3) +
  geom_line(aes(y = MA4), color = colors_gimes["primary"], linewidth = 0.8, na.rm = TRUE) +
  scale_x_date(date_breaks = "3 months", date_labels = "%b %Y") +
  scale_y_continuous(labels = comma) +
  labs(
    title = "Tjedni broj članaka o inflaciji",
    subtitle = "Linija = 4-tjedni klizni prosjek",
    x = NULL,
    y = "Broj članaka"
  ) +
  theme(
    plot.title = element_text(face = "bold"),
    axis.text.x = element_text(angle = 45, hjust = 1)
  )
```

## Godišnja usporedba

```{r yearly-comparison}
#| label: yearly-comparison
#| fig-cap: "Usporedba mjesečne dinamike po godinama"

yearly_monthly <- dt[, .(N = .N), by = .(year, month)][order(year, month)]

ggplot(yearly_monthly, aes(x = month, y = N, color = factor(year), group = year)) +
  geom_line(linewidth = 1.2) +
  geom_point(size = 2.5) +
  scale_x_continuous(breaks = 1:12, labels = c("Sij", "Velj", "Ožu", "Tra", "Svi", "Lip",
                                                "Srp", "Kol", "Ruj", "Lis", "Stu", "Pro")) +
  scale_y_continuous(labels = comma) +
  scale_color_manual(values = c("2021" = "#3498DB", "2022" = "#E74C3C", 
                                "2023" = "#27AE60", "2024" = "#9B59B6")) +
  labs(
    title = "Mjesečna dinamika po godinama",
    x = "Mjesec",
    y = "Broj članaka",
    color = "Godina"
  ) +
  theme(
    plot.title = element_text(face = "bold"),
    legend.position = "bottom"
  )
```

## Distribucija po danima u tjednu

```{r weekday-dist}
#| label: weekday-dist
#| fig-cap: "Distribucija članaka po danima u tjednu"

dt[, weekday_num := wday(date, week_start = 1)]
weekday_labels <- c("Ponedjeljak", "Utorak", "Srijeda", "Četvrtak", "Petak", "Subota", "Nedjelja")
dt[, weekday := factor(weekday_num, levels = 1:7, labels = weekday_labels)]

weekday_summary <- dt[, .(N = .N), by = weekday][order(weekday)]

ggplot(weekday_summary, aes(x = weekday, y = N, fill = weekday)) +
  geom_col(show.legend = FALSE) +
  geom_text(aes(label = format(N, big.mark = ",")), vjust = -0.5, size = 3.5) +
  scale_y_continuous(labels = comma, expand = expansion(mult = c(0, 0.1))) +
  scale_fill_viridis_d(option = "D") +
  labs(
    title = "Broj članaka po danu u tjednu",
    x = NULL,
    y = "Broj članaka"
  ) +
  theme(
    plot.title = element_text(face = "bold"),
    axis.text.x = element_text(angle = 45, hjust = 1)
  )
```

# Analiza sadržaja

## Sentiment analiza

```{r sentiment}
#| label: sentiment
#| fig-cap: "Distribucija sentimenta članaka"

if("AUTO_SENTIMENT" %in% names(dt)) {
  sentiment_labels <- c("-1" = "Negativan", "0" = "Neutralan", "1" = "Pozitivan")
  
  sentiment_summary <- dt[!is.na(AUTO_SENTIMENT), .(N = .N), by = AUTO_SENTIMENT]
  sentiment_summary[, label := sentiment_labels[as.character(AUTO_SENTIMENT)]]
  sentiment_summary[, pct := round(N / sum(N) * 100, 1)]
  
  ggplot(sentiment_summary, aes(x = label, y = N, fill = factor(AUTO_SENTIMENT))) +
    geom_col(show.legend = FALSE) +
    geom_text(aes(label = paste0(format(N, big.mark = ","), "\n(", pct, "%)")), 
              vjust = -0.3, size = 4) +
    scale_y_continuous(labels = comma, expand = expansion(mult = c(0, 0.15))) +
    scale_fill_manual(values = c("-1" = "#E74C3C", "0" = "#95A5A6", "1" = "#27AE60")) +
    labs(
      title = "Distribucija sentimenta članaka o inflaciji",
      x = NULL,
      y = "Broj članaka"
    ) +
    theme(
      plot.title = element_text(face = "bold"),
      panel.grid.major.x = element_blank()
    )
}
```

## Sentiment kroz vrijeme

```{r sentiment-time}
#| label: sentiment-time
#| fig-cap: "Dinamika sentimenta kroz vrijeme"

if("AUTO_SENTIMENT" %in% names(dt)) {
  sentiment_monthly <- dt[!is.na(AUTO_SENTIMENT), .(
    avg_sentiment = mean(AUTO_SENTIMENT),
    N = .N,
    pct_negative = sum(AUTO_SENTIMENT == -1) / .N * 100,
    pct_positive = sum(AUTO_SENTIMENT == 1) / .N * 100
  ), by = yearmonth][order(yearmonth)]
  
  ggplot(sentiment_monthly, aes(x = yearmonth)) +
    geom_hline(yintercept = 0, color = "gray50", linetype = "dashed") +
    geom_line(aes(y = avg_sentiment), color = colors_gimes["primary"], linewidth = 1) +
    geom_point(aes(y = avg_sentiment, size = N), color = colors_gimes["primary"], alpha = 0.6) +
    geom_smooth(aes(y = avg_sentiment), method = "loess", se = TRUE, 
                color = colors_gimes["secondary"], fill = colors_gimes["secondary"], alpha = 0.2) +
    scale_x_date(date_breaks = "3 months", date_labels = "%b\n%Y") +
    scale_size_continuous(range = c(2, 6), labels = comma) +
    labs(
      title = "Prosječni sentiment članaka kroz vrijeme",
      subtitle = "Crvena linija = LOESS trend",
      x = NULL,
      y = "Prosječni sentiment (-1 do 1)",
      size = "Broj članaka"
    ) +
    theme(
      plot.title = element_text(face = "bold"),
      legend.position = "bottom"
    )
}
```

# GIMES Indeks medijske inflacije

## Metodologija

GIMES indeks (Government-Industry-Media Economic Sentiment) medijske inflacije konstruiran je kao kompozitni pokazatelj koji kombinira četiri dimenzije medijskog izvještavanja:

### Komponente indeksa

1. **Volumen (30% težina)**
   - Broj članaka o inflaciji u mjesecu
   - Normaliziran na skalu 0-100

2. **Intenzitet spominjanja (25% težina)**
   - Ukupan broj spominjanja riječi "inflacija"
   - Odražava učestalost teme unutar članaka

3. **Sentiment (20% težina)**
   - Prosječni sentiment članaka (invertiran)
   - Negativniji sentiment = veća zabrinutost = viši indeks

4. **Doseg/Impressions (25% težina)**
   - Prosječni reach ako dostupno
   - Inače zamijenjeno prosječnom vrijednosti

### Formula

$$GIMES = 0.3 \times V_{norm} + 0.25 \times M_{norm} + 0.2 \times (100 - S_{norm}) + 0.25 \times R_{norm}$$

gdje su:
- $V_{norm}$ = normalizirani volumen članaka
- $M_{norm}$ = normalizirani broj spominjanja
- $S_{norm}$ = normalizirani sentiment (invertiran)
- $R_{norm}$ = normalizirani doseg/impressions

```{r index-calculation}
#| label: index-calculation

# Spoji s mjesečnim spominjanjima
index_data <- merge(
  dt[, .(
    volume = .N,
    avg_sentiment = mean(AUTO_SENTIMENT, na.rm = TRUE),
    avg_reach = if("REACH" %in% names(.SD)) mean(REACH, na.rm = TRUE) else NA_real_
  ), by = yearmonth],
  mentions_monthly[, .(yearmonth, total_mentions)],
  by = "yearmonth"
)[order(yearmonth)]

normalize <- function(x) {
  if(all(is.na(x))) return(rep(50, length(x)))
  min_x <- min(x, na.rm = TRUE)
  max_x <- max(x, na.rm = TRUE)
  if(max_x == min_x) return(rep(50, length(x)))
  (x - min_x) / (max_x - min_x) * 100
}

index_data[, `:=`(
  volume_norm = normalize(volume),
  mentions_norm = normalize(total_mentions),
  sentiment_norm = normalize(avg_sentiment),
  reach_norm = normalize(avg_reach)
)]

index_data[, gimes_index := 
  0.30 * volume_norm + 
  0.25 * mentions_norm +
  0.20 * (100 - sentiment_norm) +
  0.25 * fifelse(is.na(reach_norm), 50, reach_norm)
]

index_data[, gimes_index_ma3 := frollmean(gimes_index, n = 3, align = "center")]
index_data[, gimes_yoy := (gimes_index / shift(gimes_index, 12) - 1) * 100]
```

## GIMES Indeks kroz vrijeme

```{r index-plot}
#| label: index-plot
#| fig-cap: "GIMES Indeks medijske inflacije"
#| fig-height: 7

p_index <- ggplot(index_data, aes(x = yearmonth)) +
  geom_ribbon(aes(ymin = 0, ymax = gimes_index), fill = colors_gimes["accent"], alpha = 0.3) +
  geom_line(aes(y = gimes_index), color = colors_gimes["accent"], linewidth = 0.8, alpha = 0.5) +
  geom_line(aes(y = gimes_index_ma3), color = colors_gimes["primary"], linewidth = 1.2, na.rm = TRUE) +
  geom_point(aes(y = gimes_index_ma3), color = colors_gimes["primary"], size = 2, na.rm = TRUE) +
  scale_x_date(date_breaks = "3 months", date_labels = "%b\n%Y") +
  scale_y_continuous(limits = c(0, 100), breaks = seq(0, 100, 20)) +
  labs(
    title = "GIMES Indeks medijske inflacije",
    subtitle = "Kompozitni indeks medijske pozornosti na inflaciju (0-100) | Tamna linija = 3-mj. klizni prosjek",
    x = NULL,
    y = "GIMES Index"
  ) +
  theme(
    plot.title = element_text(face = "bold", size = 14),
    plot.subtitle = element_text(size = 10, color = "gray40"),
    panel.grid.minor = element_blank()
  )

p_index
```

## Komponente indeksa

```{r index-components}
#| label: index-components
#| fig-cap: "Komponente GIMES indeksa"

components_long <- melt(
  index_data[, .(yearmonth, volume_norm, mentions_norm,
                 sentiment_inv = 100 - sentiment_norm, reach_norm)],
  id.vars = "yearmonth",
  variable.name = "component",
  value.name = "value"
)

component_labels <- c(
  "volume_norm" = "Volumen (30%)",
  "mentions_norm" = "Spominjanja (25%)",
  "sentiment_inv" = "Negativni sentiment (20%)",
  "reach_norm" = "Doseg/Impressions (25%)"
)

components_long[, component_label := component_labels[as.character(component)]]

ggplot(components_long, aes(x = yearmonth, y = value, color = component_label)) +
  geom_line(linewidth = 1) +
  facet_wrap(~component_label, ncol = 2, scales = "free_y") +
  scale_x_date(date_breaks = "6 months", date_labels = "%b %y") +
  scale_color_manual(values = c(
    "Volumen (30%)" = colors_gimes["primary"],
    "Spominjanja (25%)" = colors_gimes["purple"],
    "Negativni sentiment (20%)" = colors_gimes["secondary"],
    "Doseg/Impressions (25%)" = colors_gimes["success"]
  )) +
  labs(
    title = "Komponente GIMES indeksa",
    subtitle = "Normalizirane vrijednosti (0-100)",
    x = NULL,
    y = "Vrijednost",
    color = NULL
  ) +
  theme(
    plot.title = element_text(face = "bold"),
    legend.position = "none",
    axis.text.x = element_text(angle = 45, hjust = 1)
  )
```

## Tablica indeksa

```{r index-table}
#| label: index-table

index_table <- index_data[, .(
  Mjesec = format(yearmonth, "%b %Y"),
  `Broj članaka` = format(volume, big.mark = ","),
  `Broj spominjanja` = format(total_mentions, big.mark = ","),
  `GIMES Index` = round(gimes_index, 1),
  `Klizni prosjek` = round(gimes_index_ma3, 1),
  `YoY promjena (%)` = ifelse(is.na(gimes_yoy), "-", paste0(ifelse(gimes_yoy > 0, "+", ""), round(gimes_yoy, 1)))
)]

kable(tail(index_table, 12), 
      caption = "GIMES Indeks - zadnjih 12 mjeseci",
      align = c("l", "r", "r", "r", "r", "r")) %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"), full_width = FALSE) %>%
  row_spec(0, bold = TRUE, background = colors_gimes["primary"], color = "white")
```

# Validacija sa službenim podacima

## Dohvaćanje službenih podataka

```{r load-official-data}
#| label: load-official-data

message("Dohvaćanje HICP podataka iz Eurostata...")

# Funkcija za dohvaćanje ili vraćanje backup podataka
fetch_or_backup <- function() {
  tryCatch({
    hicp_data <- get_eurostat("prc_hicp_manr", 
                              filters = list(geo = "HR", 
                                            coicop = "CP00",
                                            unit = "RCH_A"),
                              time_format = "date")
    
    setDT(hicp_data)
    headline <- hicp_data[time >= "2021-01-01" & time <= "2024-11-01", 
                          .(yearmonth = time, eurostat_hicp = values)]
    
    core_data <- get_eurostat("prc_hicp_manr",
                             filters = list(geo = "HR",
                                           coicop = "CP00XEF",
                                           unit = "RCH_A"),
                             time_format = "date")
    
    setDT(core_data)
    core <- core_data[time >= "2021-01-01" & time <= "2024-11-01",
                      .(yearmonth = time, eurostat_core = values)]
    
    message("Uspješno dohvaćeno ", nrow(headline), " mjeseci Eurostat podataka")
    
    return(list(headline = headline, core = core))
    
  }, error = function(e) {
    message("UPOZORENJE: Ne mogu se spojiti na Eurostat. Koristim backup podatke.")
    message("Greška: ", e$message)
    
    headline <- data.table(
      yearmonth = seq(as.Date("2021-01-01"), as.Date("2024-11-01"), by = "month"),
      eurostat_hicp = c(
        0.2, 0.6, 0.8, 1.9, 2.4, 2.3, 2.6, 3.0, 3.3, 3.8, 4.8, 5.5,
        5.8, 6.3, 7.3, 9.4, 10.8, 12.1, 12.3, 12.4, 12.8, 13.0, 13.0, 12.7,
        12.0, 11.1, 10.5, 9.2, 8.4, 8.2, 7.3, 7.7, 7.1, 5.3, 4.9, 4.7,
        4.3, 4.0, 3.9, 3.7, 3.6, 3.4, 3.2, 2.9, 2.8, 2.6, 2.4
      )
    )
    
    core <- data.table(
      yearmonth = seq(as.Date("2021-01-01"), as.Date("2024-11-01"), by = "month"),
      eurostat_core = c(
        0.5, 0.8, 1.0, 1.5, 1.8, 1.9, 2.0, 2.2, 2.4, 2.7, 3.2, 3.8,
        4.2, 4.8, 5.6, 6.8, 7.9, 8.7, 8.9, 9.1, 9.4, 9.8, 10.2, 10.5,
        10.8, 10.5, 10.0, 9.2, 8.5, 8.0, 7.2, 7.4, 7.0, 6.2, 5.8, 5.5,
        5.2, 4.9, 4.6, 4.3, 4.1, 3.8, 3.5, 3.3, 3.2, 3.0, 2.9
      )
    )
    
    return(list(headline = headline, core = core))
  })
}

eurostat_data <- fetch_or_backup()
eurostat_headline <- eurostat_data$headline
eurostat_core <- eurostat_data$core

# DZS podaci
dzs_inflation <- data.table(
  yearmonth = seq(as.Date("2021-01-01"), as.Date("2024-11-01"), by = "month"),
  dzs_cpi = c(
    0.1, 0.5, 0.7, 1.8, 2.3, 2.2, 2.5, 2.9, 3.2, 3.7, 4.7, 5.4,
    5.7, 6.2, 7.2, 9.3, 10.7, 12.0, 12.2, 12.3, 12.7, 12.9, 12.9, 12.6,
    11.9, 11.0, 10.4, 9.1, 8.3, 8.1, 7.2, 7.6, 7.0, 5.2, 4.8, 4.6,
    4.2, 3.9, 3.8, 3.6, 3.5, 3.3, 3.1, 2.8, 2.7, 2.5, 2.3
  )
)

# Spoji sve podatke
comparison <- merge(index_data, eurostat_headline, by = "yearmonth", all.x = TRUE)
comparison <- merge(comparison, eurostat_core, by = "yearmonth", all.x = TRUE)
comparison <- merge(comparison, dzs_inflation, by = "yearmonth", all.x = TRUE)
```

## GIMES vs Eurostat HICP (Headline)

```{r gimes-vs-eurostat}
#| label: gimes-vs-eurostat
#| fig-cap: "GIMES indeks vs Eurostat HICP inflacija"
#| fig-height: 7

coef_eurostat <- 100 / max(comparison$eurostat_hicp, na.rm = TRUE)

ggplot(comparison, aes(x = yearmonth)) +
  # Volumne komponenta (area u pozadini)
  geom_area(aes(y = volume_norm), fill = colors_gimes["light"], alpha = 0.3) +
  # GIMES linija
  geom_line(aes(y = gimes_index, color = "GIMES Index"), linewidth = 1.2) +
  geom_point(aes(y = gimes_index), color = colors_gimes["primary"], size = 2, alpha = 0.6) +
  # HICP linija
  geom_line(aes(y = eurostat_hicp * coef_eurostat, color = "Eurostat HICP"), 
            linewidth = 1.2, linetype = "solid") +
  geom_point(aes(y = eurostat_hicp * coef_eurostat), color = colors_gimes["secondary"], 
             size = 2, alpha = 0.6) +
  scale_y_continuous(
    name = "GIMES Index (0-100)",
    sec.axis = sec_axis(~./coef_eurostat, name = "HICP Inflacija (YoY %)", 
                       labels = function(x) paste0(x, "%"))
  ) +
  scale_x_date(date_breaks = "3 months", date_labels = "%b\n%Y") +
  scale_color_manual(values = c("GIMES Index" = colors_gimes["primary"], 
                                "Eurostat HICP" = colors_gimes["secondary"])) +
  labs(
    title = "GIMES indeks medijske inflacije vs Eurostat HICP",
    subtitle = "Usporedba medijske percepcije i službene inflacije | Siva area = volumen komponenta",
    x = NULL,
    color = NULL
  ) +
  theme(
    plot.title = element_text(face = "bold", size = 13),
    plot.subtitle = element_text(size = 10),
    legend.position = "bottom",
    axis.title.y.right = element_text(color = colors_gimes["secondary"], face = "bold"),
    axis.text.y.right = element_text(color = colors_gimes["secondary"]),
    axis.title.y.left = element_text(color = colors_gimes["primary"], face = "bold")
  )
```

## GIMES vs DZS CPI

```{r gimes-vs-dzs}
#| label: gimes-vs-dzs
#| fig-cap: "GIMES indeks vs DZS CPI inflacija"
#| fig-height: 7

coef_dzs <- 100 / max(comparison$dzs_cpi, na.rm = TRUE)

ggplot(comparison, aes(x = yearmonth)) +
  # Volumne komponenta (area u pozadini)
  geom_area(aes(y = volume_norm), fill = colors_gimes["light"], alpha = 0.3) +
  # GIMES linija
  geom_line(aes(y = gimes_index, color = "GIMES Index"), linewidth = 1.2) +
  geom_point(aes(y = gimes_index), color = colors_gimes["primary"], size = 2, alpha = 0.6) +
  # DZS linija
  geom_line(aes(y = dzs_cpi * coef_dzs, color = "DZS CPI"), 
            linewidth = 1.2, linetype = "solid") +
  geom_point(aes(y = dzs_cpi * coef_dzs), color = colors_gimes["warning"], 
             size = 2, alpha = 0.6) +
  scale_y_continuous(
    name = "GIMES Index (0-100)",
    sec.axis = sec_axis(~./coef_dzs, name = "DZS CPI (YoY %)", 
                       labels = function(x) paste0(x, "%"))
  ) +
  scale_x_date(date_breaks = "3 months", date_labels = "%b\n%Y") +
  scale_color_manual(values = c("GIMES Index" = colors_gimes["primary"], 
                                "DZS CPI" = colors_gimes["warning"])) +
  labs(
    title = "GIMES indeks medijske inflacije vs DZS CPI",
    subtitle = "Usporedba medijske percepcije i službene inflacije | Siva area = volumen komponenta",
    x = NULL,
    color = NULL
  ) +
  theme(
    plot.title = element_text(face = "bold", size = 13),
    plot.subtitle = element_text(size = 10),
    legend.position = "bottom",
    axis.title.y.right = element_text(color = colors_gimes["warning"], face = "bold"),
    axis.text.y.right = element_text(color = colors_gimes["warning"]),
    axis.title.y.left = element_text(color = colors_gimes["primary"], face = "bold")
  )
```

## Eurostat HICP: Headline vs Core

```{r eurostat-headline-vs-core}
#| label: eurostat-headline-vs-core
#| fig-cap: "Eurostat HICP: Headline vs Core inflacija"
#| fig-height: 7

# Dodaj volumen
inflation_long <- melt(comparison[, .(yearmonth, eurostat_hicp, eurostat_core, volume_norm)],
                       id.vars = c("yearmonth", "volume_norm"),
                       variable.name = "type",
                       value.name = "value")

type_labels <- c("eurostat_hicp" = "Headline HICP (svi proizvodi)", 
                "eurostat_core" = "Core HICP (bez energije i hrane)")
inflation_long[, type_label := type_labels[as.character(type)]]

ggplot(inflation_long, aes(x = yearmonth)) +
  # Volumen u pozadini
  geom_area(aes(y = volume_norm / 10), fill = colors_gimes["light"], alpha = 0.3) +
  # Inflacija linije
  geom_line(aes(y = value, color = type_label), linewidth = 1.2) +
  geom_point(aes(y = value, color = type_label), size = 2, alpha = 0.6) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "gray50") +
  scale_x_date(date_breaks = "3 months", date_labels = "%b\n%Y") +
  scale_y_continuous(labels = function(x) paste0(x, "%")) +
  scale_color_manual(values = c("Headline HICP (svi proizvodi)" = colors_gimes["secondary"],
                               "Core HICP (bez energije i hrane)" = colors_gimes["primary"])) +
  labs(
    title = "Inflacija u Hrvatskoj: Headline vs Core HICP",
    subtitle = "Usporedba ukupne i core inflacije | Siva area = volumen komponenta (skalirana) | Izvor: Eurostat",
    x = NULL,
    y = "Inflacija (YoY %)",
    color = NULL
  ) +
  theme(
    plot.title = element_text(face = "bold", size = 13),
    plot.subtitle = element_text(size = 10),
    legend.position = "bottom",
    axis.text.x = element_text(size = 9)
  )
```

## Usporedba svih izvora inflacije

```{r all-inflation-sources}
#| label: all-inflation-sources
#| fig-cap: "Usporedba svih izvora podataka o inflaciji"
#| fig-height: 8

all_inflation <- melt(comparison[, .(yearmonth, eurostat_hicp, eurostat_core, dzs_cpi, 
                                     gimes_index, volume_norm)],
                      id.vars = c("yearmonth", "volume_norm"),
                      variable.name = "source",
                      value.name = "inflation")

source_labels <- c(
  "eurostat_hicp" = "Eurostat HICP (Headline)",
  "eurostat_core" = "Eurostat HICP (Core)",
  "dzs_cpi" = "DZS CPI",
  "gimes_index" = "GIMES Index",
  "volume_norm" = "Volumen (normalizirano)"
)
all_inflation[, source_label := source_labels[as.character(source)]]

# Skaliraj GIMES i volumen na istu skalu kao inflacija
all_inflation[source == "gimes_index", inflation := inflation / 100 * max(comparison$eurostat_hicp, na.rm = TRUE)]
all_inflation[source == "volume_norm", inflation := inflation / 100 * max(comparison$eurostat_hicp, na.rm = TRUE)]

ggplot(all_inflation, aes(x = yearmonth, y = inflation, color = source_label, linetype = source_label)) +
  geom_line(linewidth = 1.2) +
  geom_point(size = 1.5, alpha = 0.5) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "gray50") +
  scale_x_date(date_breaks = "3 months", date_labels = "%b\n%Y") +
  scale_y_continuous(labels = function(x) paste0(round(x, 1), "%")) +
  scale_color_manual(values = c(
    "Eurostat HICP (Headline)" = colors_gimes["secondary"],
    "Eurostat HICP (Core)" = colors_gimes["primary"],
    "DZS CPI" = colors_gimes["warning"],
    "GIMES Index" = colors_gimes["accent"],
    "Volumen (normalizirano)" = colors_gimes["light"]
  )) +
  scale_linetype_manual(values = c(
    "Eurostat HICP (Headline)" = "solid",
    "Eurostat HICP (Core)" = "solid",
    "DZS CPI" = "solid",
    "GIMES Index" = "solid",
    "Volumen (normalizirano)" = "dashed"
  )) +
  labs(
    title = "Usporedba izvora podataka o inflaciji u Hrvatskoj",
    subtitle = "Eurostat HICP, DZS CPI, GIMES indeks i volumen članaka (skalirano na istu skalu)",
    x = NULL,
    y = "Inflacija / Indeks (skalirano na %)",
    color = "Izvor",
    linetype = "Izvor"
  ) +
  theme(
    plot.title = element_text(face = "bold", size = 13),
    plot.subtitle = element_text(size = 10),
    legend.position = "bottom",
    axis.text.x = element_text(angle = 45, hjust = 1, size = 8)
  ) +
  guides(color = guide_legend(nrow = 3))
```

## Dnevni broj članaka kao samostalni indikator inflacije

```{r daily-vs-inflation}
#| label: daily-vs-inflation
#| fig-cap: "Dnevni broj članaka o inflaciji vs službena inflacija"
#| fig-height: 8

daily_with_inflation <- merge(daily, 
                              comparison[, .(yearmonth, eurostat_hicp)], 
                              by.x = "date", 
                              by.y = "yearmonth", 
                              all.x = TRUE)

daily_with_inflation[, eurostat_hicp := zoo::na.locf(eurostat_hicp, na.rm = FALSE)]

# Interpoliraj inflaciju za svaki dan
daily_complete <- data.table(date = seq(min(daily$date), max(daily$date), by = "day"))
daily_complete <- merge(daily_complete, daily, by = "date", all.x = TRUE)
daily_complete <- merge(daily_complete, 
                       comparison[, .(date = yearmonth, eurostat_hicp)], 
                       by = "date", all.x = TRUE)

# Interpolacija
daily_complete[, eurostat_hicp := zoo::na.approx(eurostat_hicp, na.rm = FALSE)]
daily_complete[, MA30 := zoo::na.locf(MA30, na.rm = FALSE)]

coef_daily <- max(daily_complete$MA30, na.rm = TRUE) / max(daily_complete$eurostat_hicp, na.rm = TRUE)

ggplot(daily_complete[!is.na(eurostat_hicp) & !is.na(MA30)], aes(x = date)) +
  geom_line(aes(y = MA30, color = "30-dnevni prosjek članaka"), linewidth = 1.2, na.rm = TRUE) +
  geom_line(aes(y = eurostat_hicp * coef_daily, color = "Eurostat HICP (interpolirano)"), 
            linewidth = 1.2) +
  scale_y_continuous(
    name = "Broj članaka (30-dnevni MA)",
    sec.axis = sec_axis(~./coef_daily, name = "HICP Inflacija (YoY %)",
                       labels = function(x) paste0(x, "%"))
  ) +
  scale_x_date(date_breaks = "3 months", date_labels = "%b\n%Y") +
  scale_color_manual(values = c("30-dnevni prosjek članaka" = colors_gimes["accent"],
                                "Eurostat HICP (interpolirano)" = colors_gimes["secondary"])) +
  labs(
    title = "Dnevna frekvencija članaka o inflaciji kao samostalni indikator",
    subtitle = "Usporedba dnevne medijske pozornosti (30-dnevni MA) i interpolirane službene inflacije",
    x = NULL,
    color = NULL
  ) +
  theme(
    plot.title = element_text(face = "bold", size = 13),
    plot.subtitle = element_text(size = 10),
    legend.position = "bottom",
    axis.title.y.right = element_text(color = colors_gimes["secondary"], face = "bold"),
    axis.text.y.right = element_text(color = colors_gimes["secondary"]),
    axis.title.y.left = element_text(color = colors_gimes["accent"], face = "bold")
  )
```

## Korelacijska tablica

```{r correlation-table}
#| label: correlation-table

correlations <- data.table(
  Usporedba = c(
    "GIMES Index vs Eurostat HICP",
    "GIMES Index vs Eurostat Core",
    "GIMES Index vs DZS CPI",
    "Volumen (broj članaka) vs Eurostat HICP",
    "Spominjanja vs Eurostat HICP"
  ),
  Korelacija = c(
    round(cor(comparison$gimes_index, comparison$eurostat_hicp, use = "complete.obs"), 3),
    round(cor(comparison$gimes_index, comparison$eurostat_core, use = "complete.obs"), 3),
    round(cor(comparison$gimes_index, comparison$dzs_cpi, use = "complete.obs"), 3),
    round(cor(comparison$volume, comparison$eurostat_hicp, use = "complete.obs"), 3),
    round(cor(comparison$total_mentions, comparison$eurostat_hicp, use = "complete.obs"), 3)
  )
)

kable(correlations, caption = "Korelacije između različitih mjera inflacije") %>%
  kable_styling(bootstrap_options = c("striped", "hover"), full_width = FALSE) %>%
  row_spec(which.max(correlations$Korelacija), bold = TRUE, background = colors_gimes["success"])
```

# Analiza prediktivnosti

## Cross-correlation analiza

```{r ccf-analysis}
#| label: ccf-analysis
#| fig-cap: "Unakrsna korelacija: GIMES vs HICP"

comparison_complete <- comparison[!is.na(gimes_index) & !is.na(eurostat_hicp)]

if(nrow(comparison_complete) >= 24) {
  ccf_result <- ccf(
    comparison_complete$gimes_index,
    comparison_complete$eurostat_hicp,
    lag.max = 12,
    plot = FALSE,
    na.action = na.pass
  )
  
  ccf_df <- data.table(
    lag = ccf_result$lag[,,1],
    correlation = ccf_result$acf[,,1]
  )
  
  max_corr <- ccf_df[which.max(abs(correlation))]
  
  ggplot(ccf_df, aes(x = lag, y = correlation)) +
    geom_hline(yintercept = 0, color = "gray50") +
    geom_hline(yintercept = c(-0.2, 0.2), linetype = "dashed", color = "gray70") +
    geom_segment(aes(xend = lag, yend = 0), linewidth = 1.5, color = colors_gimes["accent"]) +
    geom_point(size = 3, color = colors_gimes["primary"]) +
    geom_vline(xintercept = max_corr$lag, color = colors_gimes["secondary"], 
               linetype = "dashed", linewidth = 1) +
    annotate("text", x = max_corr$lag, y = max_corr$correlation + 0.1,
             label = paste0("Max: pomak=", max_corr$lag, 
                          "\nr=", round(max_corr$correlation, 3)),
             color = colors_gimes["secondary"], fontface = "bold") +
    scale_x_continuous(breaks = seq(-12, 12, 2)) +
    labs(
      title = "Unakrsna korelacija: GIMES indeks i HICP inflacija",
      subtitle = "Negativni pomak = GIMES predvodi inflaciju | Pozitivni pomak = GIMES prati inflaciju",
      x = "Pomak (mjeseci)",
      y = "Korelacija"
    ) +
    theme(plot.title = element_text(face = "bold"))
}
```

## Korelacije s pomacima

```{r lag-correlations}
#| label: lag-correlations

lags <- -6:6
correlations_lag <- sapply(lags, function(lag) {
  if(lag < 0) {
    x <- comparison$gimes_index[1:(nrow(comparison) + lag)]
    y <- comparison$eurostat_hicp[(abs(lag) + 1):nrow(comparison)]
  } else if(lag > 0) {
    x <- comparison$gimes_index[(lag + 1):nrow(comparison)]
    y <- comparison$eurostat_hicp[1:(nrow(comparison) - lag)]
  } else {
    x <- comparison$gimes_index
    y <- comparison$eurostat_hicp
  }
  cor(x, y, use = "complete.obs")
})

lag_table <- data.table(
  Pomak = lags,
  Opis = c(
    "GIMES -6 mjeseci",
    "GIMES -5 mjeseci",
    "GIMES -4 mjeseci",
    "GIMES -3 mjeseci",
    "GIMES -2 mjeseci",
    "GIMES -1 mjesec",
    "Istovremeno",
    "HICP -1 mjesec",
    "HICP -2 mjeseca",
    "HICP -3 mjeseca",
    "HICP -4 mjeseca",
    "HICP -5 mjeseci",
    "HICP -6 mjeseci"
  ),
  Korelacija = round(correlations_lag, 3)
)[order(-Korelacija)]

kable(lag_table, 
      caption = "Korelacije GIMES indeksa i HICP inflacije sa različitim vremenskim pomacima",
      align = c("c", "l", "r")) %>%
  kable_styling(bootstrap_options = c("striped", "hover"), full_width = FALSE) %>%
  row_spec(which.max(lag_table$Korelacija), bold = TRUE, background = colors_gimes["success"])
```

# Zaključci i implikacije

## Ključni nalazi

```{r summary-findings}
#| label: summary-findings

peak_month <- index_data[which.max(gimes_index), yearmonth]
peak_value <- index_data[which.max(gimes_index), gimes_index]

peak_inflation_month <- comparison[which.max(eurostat_hicp), yearmonth]
peak_inflation_value <- comparison[which.max(eurostat_hicp), eurostat_hicp]

findings <- data.table(
  Nalaz = c(
    "Ukupno analiziranih članaka",
    "Vremenski raspon analize",
    "Broj izvora",
    "",
    "Vrh GIMES indeksa",
    "Vrijednost vrha",
    "",
    "Vrh inflacije (HICP)",
    "Vrijednost vrha",
    "",
    "Korelacija GIMES-HICP",
    "Korelacija Volumen-HICP",
    "",
    "Prosječna duljina članka",
    "Dominantan sentiment"
  ),
  Vrijednost = c(
    format(nrow(dt), big.mark = ","),
    paste(format(min(dt$date), "%m/%Y"), "-", format(max(dt$date), "%m/%Y")),
    as.character(length(unique(dt$FROM))),
    "",
    format(peak_month, "%B %Y"),
    round(peak_value, 1),
    "",
    format(peak_inflation_month, "%B %Y"),
    paste0(round(peak_inflation_value, 1), "%"),
    "",
    round(cor(comparison$gimes_index, comparison$eurostat_hicp, use = "complete.obs"), 3),
    round(cor(comparison$volume, comparison$eurostat_hicp, use = "complete.obs"), 3),
    "",
    paste0(format(round(median(dt$text_length)), big.mark = ","), " znakova"),
    ifelse(sum(dt$AUTO_SENTIMENT == -1, na.rm = TRUE) > sum(dt$AUTO_SENTIMENT == 1, na.rm = TRUE),
           "Negativan", "Pozitivan/Neutralan")
  )
)

kable(findings, caption = "Sažetak ključnih nalaza analize") %>%
  kable_styling(bootstrap_options = c("striped", "hover"), full_width = FALSE) %>%
  row_spec(c(4, 7, 10, 13), background = colors_gimes["light"])
```

---

*Izvještaj generiran: `r Sys.time()`*

*GIMES Istraživački projekt analize medijskog sadržaja*
