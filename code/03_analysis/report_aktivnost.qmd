---
title: "Semantički indeks gospodarske aktivnosti"
subtitle: "Mjerenje ekonomske aktivnosti kroz analizu medijskog diskursa"
author: "GIMES Research"
date: today
format:
  html:
    toc: true
    toc-depth: 4
    toc-location: left
    number-sections: true
    theme: cosmo
    code-fold: true
    code-summary: "Prikaži kod"
    fig-width: 11
    fig-height: 7
    df-print: paged
    embed-resources: true
execute:
  warning: false
  message: false
lang: hr
---

```{r setup}
#| label: setup
#| include: false

library(data.table)
library(ggplot2)
library(scales)
library(lubridate)
library(stringi)
library(knitr)
library(kableExtra)
library(zoo)
library(openxlsx)
library(here)
library(corrplot)
library(patchwork)
library(viridis)

options(scipen = 999)
theme_set(theme_minimal(base_size = 12))

pal <- list(
  dark = "#1a1a2e",
  primary = "#16213e",
  accent = "#0f3460",
  highlight = "#e94560",
  warm = "#f39c12",
  cool = "#3498db",
  success = "#27ae60",
  muted = "#7f8c8d",
  light = "#ecf0f1",
  purple = "#9b59b6",
  teal = "#1abc9c"
)
```

# Uvod

Ovaj dokument konstruira semantičke indekse gospodarske aktivnosti temeljene na analizi medijskog diskursa. 

```{r load-data}
#| label: load-data

dt <- as.data.table(read.xlsx(here("data", "activity_filtered.xlsx")))

if (is.numeric(dt$DATE)) {
  dt[, DATE := as.Date(DATE, origin = "1899-12-30")]
} else {
  dt[, DATE := as.Date(DATE)]
}

if ("text_length" %in% names(dt)) dt[, text_length := as.numeric(text_length)]
if ("REACH" %in% names(dt)) dt[, REACH := as.numeric(REACH)]

dt[, `:=`(
  date = DATE,
  year = year(DATE),
  month = month(DATE),
  quarter = quarter(DATE),
  yearmonth = floor_date(DATE, "month"),
  yearquarter = floor_date(DATE, "quarter")
)]

date_min <- min(dt$date, na.rm = TRUE)
date_max <- max(dt$date, na.rm = TRUE)

cat("Učitano", nrow(dt), "članaka\n")
cat("Vremenski raspon:", as.character(date_min), "do", as.character(date_max), "\n")
```

# Eksploratorni pregled

```{r basic-stats}
#| label: basic-stats

stats_summary <- data.table(

  Metrika = c(
    "Ukupan broj članaka",
    "Vremenski raspon",
    "Broj dana",
    "Prosječno članaka dnevno",
    "Broj izvora",
    "Medijan duljine članka"
  ),
  Vrijednost = c(
    format(nrow(dt), big.mark = ","),
    paste(format(date_min, "%d.%m.%Y"), "do", format(date_max, "%d.%m.%Y")),
    as.character(as.numeric(date_max - date_min)),
    round(nrow(dt) / as.numeric(date_max - date_min), 2),
    length(unique(dt$FROM)),
    format(median(dt$text_length, na.rm = TRUE), big.mark = ",")
  )
)

kable(stats_summary, caption = "Osnovne statistike dataseta") %>%
  kable_styling(bootstrap_options = c("striped", "hover"), full_width = FALSE)
```

```{r source-distribution}
#| label: source-distribution
#| fig-cap: "Top 20 izvora po broju članaka"

top_sources <- dt[, .(N = .N), by = FROM][order(-N)][1:20]

ggplot(top_sources, aes(x = reorder(FROM, N), y = N)) +
  geom_col(fill = pal$primary, alpha = 0.8) +
  geom_text(aes(label = format(N, big.mark = ",")), hjust = -0.1, size = 3) +
  coord_flip() +
  scale_y_continuous(expand = expansion(mult = c(0, 0.15))) +
  labs(title = "Top 20 izvora po broju članaka", x = NULL, y = "Broj članaka") +
  theme(plot.title = element_text(face = "bold"))
```

```{r time-distribution}
#| label: time-distribution
#| fig-cap: "Mjesečni broj članaka"
#| fig-height: 6

monthly_count <- dt[, .(N = .N), by = yearmonth][order(yearmonth)]
monthly_count[, MA3 := frollmean(N, n = 3, align = "center")]

ggplot(monthly_count, aes(x = yearmonth)) +
  geom_col(aes(y = N), fill = pal$light, alpha = 0.7) +
  geom_line(aes(y = MA3), color = pal$highlight, linewidth = 1.2, na.rm = TRUE) +
  scale_x_date(date_breaks = "3 months", date_labels = "%b\n%Y") +
  labs(
    title = "Mjesečni broj članaka o gospodarskoj aktivnosti",
    subtitle = "Crvena linija = 3 mjesečni klizni prosjek",
    x = NULL, y = "Broj članaka"
  ) +
  theme(plot.title = element_text(face = "bold"))
```

# Semantička taksonomija

## Hijerarhijska struktura pojmova

```{r semantic-taxonomy}
#| label: semantic-taxonomy

activity_taxonomy <- list(
  
  # === 1. BDP I AGREGATNA AKTIVNOST ===
  bdp_agregat = list(
    bdp_direktno = c(
      "\\bBDP[aeu]?\\b", "bruto doma[cć][ie]g? proizvod[aeu]?",
      "gross domestic product", "\\bGDP\\b"
    ),
    bdp_dinamika = c(
      "rast.{0,10}BDP", "pad.{0,10}BDP", "BDP.{0,10}rast", "BDP.{0,10}pad",
      "rast.{0,10}gospodar", "pad.{0,10}gospodar",
      "ekonomsk[aeiou]+ rast", "gospodars[aeikou]+ rast",
      "negativan.{0,5}rast", "pozitivan.{0,5}rast"
    ),
    recesija_ekspanzija = c(
      "recesij[aeiou]?", "stagnacij[aeiou]?", "kontrakcij[aeiou]?",
      "ekspanzij[aeiou]?", "oporavak.{0,10}gospodar", "gospodar.{0,10}oporavak",
      "usporavanj[aeu]?.{0,10}gospodar", "ubrzanj[aeu]?.{0,10}gospodar"
    ),
    kvartalni = c(
      "kvartaln[aeiou]+.{0,10}(rast|pad|BDP|podaci)",
      "prvi.{0,5}kvartal", "drugi.{0,5}kvartal",
      "tre[cć]i.{0,5}kvartal", "[cč]etvrti.{0,5}kvartal",
      "Q[1-4]", "sezonski.{0,10}prilag"
    )
  ),
  
  # === 2. INDUSTRIJSKA PROIZVODNJA ===
  industrija = list(
    proizvodnja_opce = c(
      "industrijska?.{0,10}proizvodnj[aeiou]?",
      "proizvodni?.{0,10}sektor", "proizvodni?.{0,10}aktivnost",
      "tvornic[aeiou]?", "pogon[aeiou]?"
    ),
    preradivacka = c(
      "prera[dđ]iva[cč]k[aeiou]+.{0,10}industrij[aeiou]?",
      "prera[dđ]iva[cč]k[aeiou]+.{0,10}sektor",
      "manufacturin[g]?"
    ),
    energetika = c(
      "energetsk[aeiou]+.{0,10}sektor", "energetik[aeiou]?",
      "proizvodnj[aeiou]?.{0,10}energij", "elektran[aeiou]?",
      "\\bHEP\\b", "\\bINA\\b"
    ),
    kapaciteti = c(
      "iskori[sš]tenost.{0,10}kapacitet",
      "proizvodni.{0,10}kapacitet",
      "industrijsk[aeiou]+.{0,10}kapacitet"
    )
  ),
  
  # === 3. GRAĐEVINARSTVO ===
  gradevinarstvo = list(
    sektor = c(
      "gra[dđ]evinarstv[aou]?", "gra[dđ]evins[aeikou]+.{0,10}sektor",
      "gra[dđ]evins[aeikou]+.{0,10}aktivnost",
      "gra[dđ]evins[aeikou]+.{0,10}radov[aeiou]?"
    ),
    projekti = c(
      "gradnj[aeiou]?", "izgradnj[aeiou]?",
      "infrastruktur[aeiou]?", "projekat", "projekt[aeiou]?"
    ),
    nekretnine = c(
      "nekretnin[aeiou]?", "stanov[aeiou]?", "stambeni?.{0,10}gradnj",
      "tr[zž]i[sš]t[aeu]?.{0,10}nekretnin"
    ),
    dozvole = c(
      "gra[dđ]evins[aeikou]+.{0,10}dozvol[aeiou]?",
      "izdane.{0,10}dozvol", "broj.{0,10}dozvol"
    )
  ),
  
  # === 4. TURIZAM ===
  turizam = list(
    promet = c(
      "turisti[cč]k[aeiou]+.{0,10}promet",
      "turisti[cč]k[aeiou]+.{0,10}prihod[aeiou]?",
      "turisti[cč]k[aeiou]+.{0,10}sezon[aeiou]?"
    ),
    dolasci_nocenja = c(
      "dolaz[aeikou]+.{0,10}turist", "turist.{0,10}dolaz",
      "no[cć]enj[aeiou]?", "broj.{0,10}turist[aeiou]?"
    ),
    smjestaj = c(
      "smje[sš]tajn[aeiou]+.{0,10}kapacitet",
      "hotel[aeiou]?", "kampov[aeiou]?",
      "popunjenost.{0,10}smje[sš]taj"
    )
  ),
  
  # === 5. TRGOVINA ===
  trgovina = list(
    vanjska = c(
      "vanjsk[aeiou]+.{0,10}trgovin[aeiou]?",
      "trgovinsk[aeiou]+.{0,10}bilanc[aeiou]?",
      "robn[aeiou]+.{0,10}razmjen[aeiou]?"
    ),
    izvoz = c(
      "izvoz[aeiou]?", "eksport[aeiou]?",
      "rast.{0,10}izvoz", "pad.{0,10}izvoz",
      "izvozn[aeikou]+.{0,10}aktivnost"
    ),
    uvoz = c(
      "uvoz[aeiou]?", "import[aeiou]?",
      "rast.{0,10}uvoz", "pad.{0,10}uvoz"
    ),
    maloprodaja = c(
      "maloprodaj[aeiou]?", "maloprodajn[aeiou]+.{0,10}promet",
      "promet.{0,10}trgovin", "trgovin[aeiou]+.{0,10}promet"
    )
  ),
  
  # === 6. INVESTICIJE ===
  investicije = list(
    opce = c(
      "investicij[aeiou]?", "ulaganj[aeiou]?",
      "kapitalna?.{0,10}ulaganj", "bruto.{0,10}investicij"
    ),
    strane = c(
      "stran[aeiou]+.{0,10}investicij", "stran[aeiou]+.{0,10}ulaganj",
      "\\bFDI\\b", "inozemn[aeiou]+.{0,10}ulaganj",
      "privla[cč]enj[aeu]?.{0,10}investicij"
    ),
    javne = c(
      "javn[aeiou]+.{0,10}investicij", "dr[zž]avn[aeiou]+.{0,10}ulaganj",
      "eu.{0,5}fondov[aeiou]?", "europsk[aeiou]+.{0,10}fondov"
    )
  ),
  
  # === 7. TRŽIŠTE RADA ===
  trziste_rada = list(
    zaposlenost = c(
      "zaposlenost[aeiou]?", "zaposlen[aeiou]+",
      "broj.{0,10}zaposlen", "rast.{0,10}zaposlen",
      "nova?.{0,10}radna?.{0,10}mjesta?"
    ),
    nezaposlenost = c(
      "nezaposlenost[aeiou]?", "nezaposlen[aeiou]+",
      "stopa?.{0,10}nezaposlen", "\\bHZZ\\b",
      "evidencij[aeiou]+.{0,10}nezaposlen"
    ),
    place = c(
      "pla[cć][aeiou]?", "prosje[cč]n[aeiou]+.{0,10}pla[cć]",
      "rast.{0,10}pla[cć]", "neto.{0,10}pla[cć]", "bruto.{0,10}pla[cć]"
    )
  ),
  
  # === 8. POSLOVNI SENTIMENT ===
  sentiment_poslovni = list(
    povjerenje = c(
      "poslovn[aeiou]+.{0,10}povjerenj[aeiou]?",
      "indeks.{0,10}povjerenj", "poslovn[aeiou]+.{0,10}klim[aeiou]?",
      "poslovn[aeiou]+.{0,10}o[cč]ekivanj"
    ),
    optimizam_pesimizam = c(
      "poslovn[aeiou]+.{0,10}optimiz", "poslovn[aeiou]+.{0,10}pesimiz",
      "pozitivn[aeiou]+.{0,10}o[cč]ekivanj", "negativn[aeiou]+.{0,10}o[cč]ekivanj"
    ),
    ankete = c(
      "anket[aeiou]+.{0,10}(poduze[cć]|menad[zž]er|direktora?)",
      "\\bPMI\\b", "purchasing.{0,5}manager"
    )
  ),
  
  # === 9. POTROŠNJA ===
  potrosnja = list(
    osobna = c(
      "osobn[aeiou]+.{0,10}potro[sš]nj[aeiou]?",
      "potro[sš]a[cč]k[aeiou]+.{0,10}potro[sš]nj",
      "finalna?.{0,10}potro[sš]nj"
    ),
    potrosaci = c(
      "potro[sš]a[cč][aeiou]?", "kupac", "kupci",
      "potro[sš]a[cč]k[aeiou]+.{0,10}povjerenj",
      "potro[sš]a[cč]k[aeiou]+.{0,10}sentiment"
    ),
    stednja = c(
      "[sš]tednj[aeiou]?", "deponiran[aeiou]?",
      "odr[zž]iv[aeiou]+.{0,10}potro[sš]nj"
    )
  ),
  
  # === 10. FINANCIJSKI SEKTOR ===
  financije = list(
    bankarstvo = c(
      "bank[aeiou]?", "bankars[aeikou]+.{0,10}sektor",
      "kredit[aeiou]?", "kreditiranj[aeu]?",
      "\\bPBZ\\b", "\\bZABA\\b", "Zagreba[cč]ka.{0,5}banka"
    ),
    trziste_kapitala = c(
      "burz[aeiou]?", "\\bZSE\\b", "\\bCROBEX\\b",
      "dionice?", "tr[zž]i[sš]t[aeu]?.{0,10}kapital"
    ),
    likvidnost = c(
      "likvidnost[aeiou]?", "solventnost[aeiou]?",
      "nov[cč]an[aeiou]+.{0,10}tok"
    )
  ),
  
  # === 11. INSTITUCIONALNI OKVIR ===
  institucije = list(
    statistika = c(
      "\\bDZS\\b", "Dr[zž]avn[io]?.{0,10}zavod.{0,10}statistik",
      "\\bEurostat\\b", "statisti[cč]k[aeiou]+.{0,10}podaci"
    ),
    centralna_banka = c(
      "\\bHNB\\b", "Hrvatska?.{0,10}narodna?.{0,10}banka",
      "\\bECB\\b", "guverner"
    ),
    komore = c(
      "\\bHGK\\b", "Hrvatska?.{0,10}gospodarska?.{0,10}komora",
      "\\bHUP\\b", "udruga?.{0,10}poslodavac"
    ),
    vlada = c(
      "Vlad[aeiou]?.{0,10}(RH|Republike|Hrvatski)",
      "ministarstvo?.{0,10}gospodar",
      "ministarstvo?.{0,10}financij"
    )
  ),
  
  # === 12. SEKTORSKI FOKUS ===
  sektori = list(
    it_tehnologija = c(
      "\\bIT\\b.{0,10}sektor", "tehnolo[sš]k[aeiou]+.{0,10}sektor",
      "digitalizacij[aeiou]?", "startup", "inovacij[aeiou]?"
    ),
    poljoprivreda = c(
      "poljoprivred[aeiou]?", "agrarn[aeiou]+.{0,10}sektor",
      "[zž]etv[aeiou]?", "urod", "prinos"
    ),
    promet_logistika = c(
      "prometn[aeiou]+.{0,10}sektor", "logistik[aeiou]?",
      "luka", "zra[cč]n[aeiou]+.{0,10}promet", "teretni?.{0,10}promet"
    )
  )
)

flatten_taxonomy <- function(taxonomy) {
  result <- list()
  for (macro in names(taxonomy)) {
    for (meso in names(taxonomy[[macro]])) {
      key <- paste0(macro, "_", meso)
      result[[key]] <- taxonomy[[macro]][[meso]]
    }
  }
  result
}

flat_terms <- flatten_taxonomy(activity_taxonomy)

tax_summary <- rbindlist(lapply(names(activity_taxonomy), function(macro) {
  rbindlist(lapply(names(activity_taxonomy[[macro]]), function(meso) {
    data.table(
      Makro_kategorija = macro,
      Meso_kategorija = meso,
      Broj_pojmova = length(activity_taxonomy[[macro]][[meso]])
    )
  }))
}))

kable(tax_summary, caption = "Struktura semantičke taksonomije") %>%
  kable_styling(bootstrap_options = c("striped", "hover"), full_width = FALSE) %>%
  collapse_rows(columns = 1, valign = "top")
```

## Sentiment i neizvjesnost leksikoni

```{r sentiment-uncertainty-lexicons}
#| label: sentiment-uncertainty-lexicons

# Ekonomski sentiment leksikon (pozitivno/negativno)
sentiment_lexicon <- list(
  positive = c(
    "rast", "porast", "povećanje", "poboljšanje", "oporavak",
    "ekspanzija", "uzlet", "procvat", "napredak", "uspjeh",
    "dobit", "profit", "prihod", "investicija", "ulaganje",
    "zapošljavanje", "nova radna mjesta", "optimizam", "povjerenje",
    "stabilnost", "snažan", "jak", "rekord", "povijesni maksimum",
    "premašiti", "nadmašiti", "bolji nego", "iznad očekivanja"
  ),
  negative = c(
    "pad", "smanjenje", "gubitak", "kriza", "recesija",
    "stagnacija", "usporavanje", "kontrakcija", "propad", "kolaps",
    "bankrot", "stečaj", "otpuštanje", "nezaposlenost", "deficit",
    "dug", "zaduženje", "inflacija", "poskupljenje", "pesimizam",
    "nesigurnost", "rizik", "slab", "loš", "negativan",
    "ispod očekivanja", "lošije nego", "problem", "poteškoće"
  )
)

# Ekonomska neizvjesnost leksikon
uncertainty_lexicon <- c(
  "neizvjesn", "nesigurn", "rizik", "volatil", "nepredvidiv",
  "možda", "eventualno", "potencijalno", "vjerojatno", "moguće",
  "ako", "ukoliko", "ovisno", "zavisi", "nepoznat",
  "nejasno", "neodređeno", "upitno", "dvojbeno", "spekulacij",
  "strah", "zabrinutost", "oprez", "pažljiv", "oklijevanje",
  "čekanje", "odgoda", "zastoj", "blokada", "pregovori",
  "preispitivanje", "revizija", "korekcija"
)

# Forward looking leksikon
forward_lexicon <- c(
  "očekuje se", "predviđa se", "prognoza", "projekcija", "plan",
  "namjera", "strategija", "budući", "sljedeći", "nadolazeći",
  "će", "hoće", "planira", "namjerava", "očekivanja",
  "perspektiva", "izgled", "trend", "smjer", "kretanje",
  "procjena", "scenarij", "mogućnost", "potencijal"
)

# Intenzitet leksikon
intensity_lexicon <- list(
  high = c(
    "značajno", "znatno", "drastično", "snažno", "jako",
    "enormno", "golemo", "masivno", "eksplozivno", "rekordno",
    "povijesno", "bez presedana", "nikad viđeno", "izvanredno"
  ),
  moderate = c(
    "umjereno", "blago", "postupno", "lagano", "stabilno",
    "konstantno", "ravnomjerno", "očekivano", "prosječno"
  ),
  low = c(
    "minimalno", "neznatno", "marginalno", "simbolično",
    "jedva", "tek", "samo", "neznačajno"
  )
)

cat("Definirano", length(sentiment_lexicon$positive), "pozitivnih i", 
    length(sentiment_lexicon$negative), "negativnih sentiment pojmova\n")
cat("Definirano", length(uncertainty_lexicon), "neizvjesnost pojmova\n")
cat("Definirano", length(forward_lexicon), "forward looking pojmova\n")
```

## Brojanje pojmova

```{r count-terms}
#| label: count-terms

count_patterns <- function(text, patterns) {
  if (is.na(text) || text == "") return(0)
  text_lower <- tolower(text)
  sum(sapply(patterns, function(p) {
    tryCatch(stri_count_regex(text_lower, p), error = function(e) 0)
  }))
}

# Broji sve kategorije iz taksonomije
for (cat_name in names(flat_terms)) {
  col_name <- paste0("sem_", cat_name)
  dt[, (col_name) := sapply(FULL_TEXT, count_patterns, patterns = flat_terms[[cat_name]])]
}

# Agregatne mjere po makro kategorijama
macro_categories <- unique(tax_summary$Makro_kategorija)

for (macro in macro_categories) {
  meso_cats <- tax_summary[Makro_kategorija == macro, Meso_kategorija]
  col_names <- paste0("sem_", macro, "_", meso_cats)
  existing_cols <- col_names[col_names %in% names(dt)]
  if (length(existing_cols) > 0) {
    dt[, paste0("macro_", macro) := rowSums(.SD, na.rm = TRUE), .SDcols = existing_cols]
  }
}

# Sentiment scoring
dt[, sent_positive := sapply(FULL_TEXT, count_patterns, patterns = sentiment_lexicon$positive)]
dt[, sent_negative := sapply(FULL_TEXT, count_patterns, patterns = sentiment_lexicon$negative)]
dt[, sent_net := sent_positive - sent_negative]
dt[, sent_ratio := fifelse(sent_positive + sent_negative > 0,
                           (sent_positive - sent_negative) / (sent_positive + sent_negative), 0)]

# Uncertainty scoring
dt[, uncertainty := sapply(FULL_TEXT, count_patterns, patterns = uncertainty_lexicon)]

# Forward looking scoring
dt[, forward_looking := sapply(FULL_TEXT, count_patterns, patterns = forward_lexicon)]

# Intensity scoring
dt[, intensity_high := sapply(FULL_TEXT, count_patterns, patterns = intensity_lexicon$high)]
dt[, intensity_low := sapply(FULL_TEXT, count_patterns, patterns = intensity_lexicon$low)]
dt[, intensity_net := intensity_high - intensity_low]

# Ukupni semantički score
sem_cols <- names(dt)[grepl("^sem_", names(dt))]
dt[, semantic_total := rowSums(.SD, na.rm = TRUE), .SDcols = sem_cols]

cat("Izračunato", length(sem_cols), "semantičkih varijabli\n")
```

# Konstrukcija indeksa

## Mjesečna agregacija

```{r monthly-aggregation}
#| label: monthly-aggregation

macro_cols <- names(dt)[grepl("^macro_", names(dt))]
sem_cols_all <- c(sem_cols, macro_cols, "semantic_total",
                  "sent_positive", "sent_negative", "sent_net", "sent_ratio",
                  "uncertainty", "forward_looking",
                  "intensity_high", "intensity_low", "intensity_net")

monthly <- dt[, c(
  .(N = .N,
    total_words = sum(text_length, na.rm = TRUE),
    avg_length = mean(text_length, na.rm = TRUE),
    unique_sources = uniqueN(FROM)),
  lapply(.SD, sum, na.rm = TRUE),
  lapply(.SD, mean, na.rm = TRUE) |> setNames(paste0(names(.SD), "_avg"))
), by = yearmonth, .SDcols = sem_cols_all][order(yearmonth)]

# Izračunaj dodatne mjere
monthly[, articles_per_source := N / unique_sources]
monthly[, coverage_breadth := uniqueN(names(flat_terms)[sapply(names(flat_terms), function(x) {
  sum(dt[yearmonth == .BY$yearmonth, get(paste0("sem_", x))], na.rm = TRUE) > 0
})]), by = yearmonth]

cat("Agregirano", nrow(monthly), "mjeseci podataka\n")
```

## TF IDF ponderiranje

```{r tfidf-weights}
#| label: tfidf-weights

# Izračunaj IDF za svaku kategoriju (koliko je diskriminativna)
# IDF = log(N / df) gdje je df broj mjeseci s barem jednim pojavljivanjem

calc_idf <- function(monthly_data, col_name) {
  N <- nrow(monthly_data)
  df <- sum(monthly_data[[col_name]] > 0, na.rm = TRUE)
  if (df == 0) return(0)
  log(N / df)
}

idf_weights <- sapply(macro_cols, function(col) calc_idf(monthly, col))
idf_weights <- idf_weights / max(idf_weights, na.rm = TRUE)  # normaliziraj na 0-1

# TF-IDF ponderirani score za svaki mjesec
for (col in macro_cols) {
  tfidf_col <- paste0(col, "_tfidf")
  # TF = raw count / total words (normalizirano)
  monthly[, (tfidf_col) := (get(col) / total_words) * idf_weights[col] * 1000]
}

tfidf_cols <- paste0(macro_cols, "_tfidf")

idf_table <- data.table(
  Kategorija = gsub("macro_", "", macro_cols),
  IDF_weight = round(idf_weights, 3)
)[order(-IDF_weight)]

kable(idf_table, caption = "IDF težine po kategorijama (veća = diskriminativnija)") %>%
  kable_styling(bootstrap_options = c("striped", "hover"), full_width = FALSE)
```

## Definicija indeksa

```{r construct-indices}
#| label: construct-indices

normalize_01 <- function(x) {
  if (all(is.na(x))) return(rep(0.5, length(x)))
  rng <- range(x, na.rm = TRUE)
  if (rng[1] == rng[2]) return(rep(0.5, length(x)))
  (x - rng[1]) / (rng[2] - rng[1])
}

standardize <- function(x) {
  if (all(is.na(x))) return(rep(0, length(x)))
  (x - mean(x, na.rm = TRUE)) / sd(x, na.rm = TRUE)
}

# === INDEKS 1: Volume Activity Index (VAI) ===
# Jednostavan agregatni indeks temeljen na ukupnom broju pojmova normaliziran po broju članaka
monthly[, VAI := normalize_01(semantic_total / N) * 100]

# === INDEKS 2: TF-IDF Weighted Index (TWI) ===
# Koristi TF-IDF ponderiranje za naglašavanje diskriminativnih kategorija
monthly[, TWI := normalize_01(rowSums(.SD, na.rm = TRUE)) * 100, .SDcols = tfidf_cols]

# === INDEKS 3: Sectoral Composite Index (SCI) ===
# Kombinira ključne realne sektore
key_sectors <- c("macro_industrija", "macro_gradevinarstvo", "macro_trgovina", "macro_turizam")
key_sectors <- key_sectors[key_sectors %in% names(monthly)]
if (length(key_sectors) > 0) {
  monthly[, SCI := normalize_01(rowMeans(.SD, na.rm = TRUE)) * 100, .SDcols = key_sectors]
}

# === INDEKS 4: Sentiment Adjusted Index (SAI) ===
# Kombinira volume s net sentimentom
monthly[, SAI := normalize_01(semantic_total / N * (1 + sent_ratio_avg)) * 100]

# === INDEKS 5: Uncertainty Index (UCI) ===
# Mjeri razinu ekonomske neizvjesnosti u medijima
monthly[, UCI := normalize_01(uncertainty / N) * 100]

# === INDEKS 6: Forward Looking Index (FLI) ===
# Mjeri koliko su mediji orijentirani na budućnost
monthly[, FLI := normalize_01(forward_looking / N) * 100]

# === INDEKS 7: Principal Component Index (PCI) ===
# PCA na standardiziranim makro kategorijama
pca_data <- monthly[, .SD, .SDcols = macro_cols]
pca_data_complete <- pca_data[complete.cases(pca_data)]

if (nrow(pca_data_complete) > 10 && ncol(pca_data_complete) > 2) {
  pca_data_scaled <- scale(pca_data_complete)
  pca_result <- prcomp(pca_data_scaled, scale. = FALSE)
  
  # Variance explained
  var_explained <- summary(pca_result)$importance[2, 1:min(5, ncol(pca_result$rotation))]
  
  # PC1 scores za cijeli dataset
  pca_matrix <- as.matrix(pca_data)
  pca_matrix[is.na(pca_matrix)] <- 0
  pca_matrix_scaled <- scale(pca_matrix)
  pc1_scores <- as.numeric(pca_matrix_scaled %*% pca_result$rotation[, 1])
  
  monthly[, PCI := normalize_01(pc1_scores) * 100]
  
  cat("PCA: PC1 objašnjava", round(var_explained[1] * 100, 1), "% varijance\n")
} else {
  monthly[, PCI := VAI]
}

# Klizni prosjeci
index_cols <- c("VAI", "TWI", "SCI", "SAI", "UCI", "FLI", "PCI")
for (idx in index_cols) {
  if (idx %in% names(monthly)) {
    monthly[, paste0(idx, "_MA3") := frollmean(get(idx), n = 3, align = "center")]
  }
}

cat("Konstruirano 7 indeksa\n")
```

## Opis indeksa

```{r index-descriptions}
#| label: index-descriptions

index_desc <- data.table(
  Indeks = c("VAI", "TWI", "SCI", "SAI", "UCI", "FLI", "PCI"),
  Naziv = c(
    "Volume Activity Index",
    "TF-IDF Weighted Index",
    "Sectoral Composite Index",
    "Sentiment Adjusted Index",
    "Uncertainty Index",
    "Forward Looking Index",
    "Principal Component Index"
  ),
  Opis = c(
    "Ukupan broj ekonomskih pojmova normaliziran po broju članaka",
    "TF-IDF ponderirani score koji naglašava diskriminativne kategorije",
    "Prosjek ključnih realnih sektora (industrija, građevinarstvo, trgovina, turizam)",
    "Volume indeks prilagođen za net sentiment (pozitivan/negativan ton)",
    "Mjera ekonomske neizvjesnosti u medijskom diskursu",
    "Mjera forward looking orijentacije (očekivanja, prognoze, planovi)",
    "Prva glavna komponenta svih makro kategorija"
  )
)

kable(index_desc, caption = "Pregled konstruiranih indeksa") %>%
  kable_styling(bootstrap_options = c("striped", "hover"), full_width = FALSE)
```

# Vizualizacija indeksa

## Glavni indeksi

```{r main-indices-plot}
#| label: main-indices-plot
#| fig-cap: "Glavni semantički indeksi gospodarske aktivnosti"
#| fig-height: 10

p1 <- ggplot(monthly, aes(x = yearmonth)) +
  geom_line(aes(y = VAI, color = "VAI"), linewidth = 1) +
  geom_line(aes(y = TWI, color = "TWI"), linewidth = 1) +
  geom_line(aes(y = SCI, color = "SCI"), linewidth = 1) +
  scale_color_manual(values = c("VAI" = pal$cool, "TWI" = pal$warm, "SCI" = pal$success)) +
  scale_x_date(date_breaks = "3 months", date_labels = "%b\n%Y") +
  labs(title = "Volume i sektorski indeksi", x = NULL, y = "Indeks (0-100)", color = NULL) +
  theme(legend.position = "bottom")

p2 <- ggplot(monthly, aes(x = yearmonth)) +
  geom_ribbon(aes(ymin = 50, ymax = SAI), fill = pal$success, alpha = 0.3) +
  geom_line(aes(y = SAI), color = pal$primary, linewidth = 1) +
  geom_hline(yintercept = 50, linetype = "dashed", color = pal$muted) +
  scale_x_date(date_breaks = "3 months", date_labels = "%b\n%Y") +
  labs(title = "Sentiment Adjusted Index (SAI)", subtitle = "Iznad 50 = pozitivan sentiment prevladava",
       x = NULL, y = "Indeks (0-100)")

p3 <- ggplot(monthly, aes(x = yearmonth)) +
  geom_area(aes(y = UCI), fill = pal$highlight, alpha = 0.5) +
  geom_line(aes(y = UCI), color = pal$highlight, linewidth = 1) +
  scale_x_date(date_breaks = "3 months", date_labels = "%b\n%Y") +
  labs(title = "Uncertainty Index (UCI)", x = NULL, y = "Indeks (0-100)")

p1 / p2 / p3
```

## Forward Looking vs Uncertainty

```{r fli-uci-plot}
#| label: fli-uci-plot
#| fig-cap: "Forward Looking Index vs Uncertainty Index"
#| fig-height: 6

ggplot(monthly, aes(x = yearmonth)) +
  geom_line(aes(y = FLI, color = "Forward Looking"), linewidth = 1) +
  geom_line(aes(y = UCI, color = "Uncertainty"), linewidth = 1) +
  scale_color_manual(values = c("Forward Looking" = pal$success, "Uncertainty" = pal$highlight)) +
  scale_x_date(date_breaks = "3 months", date_labels = "%b\n%Y") +
  labs(
    title = "Forward Looking vs Uncertainty",
    subtitle = "Odnos između orijentacije na budućnost i neizvjesnosti",
    x = NULL, y = "Indeks (0-100)", color = NULL
  ) +
  theme(legend.position = "bottom")
```

## Principal Component Index

```{r pci-plot}
#| label: pci-plot
#| fig-cap: "Principal Component Index s kliznim prosjekom"
#| fig-height: 6

ggplot(monthly, aes(x = yearmonth)) +
  geom_col(aes(y = PCI), fill = pal$light, alpha = 0.7) +
  geom_line(aes(y = PCI_MA3), color = pal$primary, linewidth = 1.2, na.rm = TRUE) +
  scale_x_date(date_breaks = "3 months", date_labels = "%b\n%Y") +
  labs(
    title = "Principal Component Index (PCI)",
    subtitle = "Tamna linija = 3 mjesečni klizni prosjek",
    x = NULL, y = "Indeks (0-100)"
  )
```

# Sektorska analiza

## Dinamika po sektorima

```{r sector-dynamics}
#| label: sector-dynamics
#| fig-cap: "Dinamika sektora kroz vrijeme"
#| fig-height: 14

key_macro <- c("macro_bdp_agregat", "macro_industrija", "macro_gradevinarstvo",
               "macro_turizam", "macro_trgovina", "macro_investicije",
               "macro_trziste_rada", "macro_sentiment_poslovni")
key_macro <- key_macro[key_macro %in% names(monthly)]

sector_long <- melt(
  monthly[, c("yearmonth", key_macro), with = FALSE],
  id.vars = "yearmonth",
  variable.name = "sektor",
  value.name = "vrijednost"
)

sector_long[, sektor := gsub("macro_", "", sektor)]
sector_long[, vrijednost_norm := normalize_01(vrijednost) * 100, by = sektor]

ggplot(sector_long, aes(x = yearmonth, y = vrijednost_norm)) +
  geom_area(fill = pal$accent, alpha = 0.3) +
  geom_line(color = pal$primary, linewidth = 0.8) +
  geom_smooth(method = "loess", se = FALSE, color = pal$highlight, linewidth = 1, span = 0.3) +
  facet_wrap(~sektor, ncol = 2, scales = "free_y") +
  scale_x_date(date_breaks = "6 months", date_labels = "%b %y") +
  labs(
    title = "Dinamika semantičkih sektora kroz vrijeme",
    subtitle = "Normalizirane vrijednosti s LOESS trendom",
    x = NULL, y = "Indeks (0-100)"
  ) +
  theme(
    strip.text = element_text(face = "bold"),
    axis.text.x = element_text(angle = 45, hjust = 1)
  )
```

## Heatmapa sektorske aktivnosti

```{r sector-heatmap}
#| label: sector-heatmap
#| fig-cap: "Heatmapa sektorske aktivnosti"
#| fig-height: 8

heatmap_data <- sector_long[, .(yearmonth, sektor, vrijednost_norm)]

ggplot(heatmap_data, aes(x = yearmonth, y = sektor, fill = vrijednost_norm)) +
  geom_tile() +
  scale_fill_viridis_c(option = "plasma") +
  scale_x_date(date_breaks = "3 months", date_labels = "%b %y") +
  labs(
    title = "Heatmapa sektorske medijske aktivnosti",
    x = NULL, y = NULL, fill = "Intenzitet\n(0-100)"
  ) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

## Korelacijska struktura

```{r correlation-matrix}
#| label: correlation-matrix
#| fig-cap: "Korelacijska matrica sektora i indeksa"
#| fig-height: 10

cor_vars <- c(macro_cols, "VAI", "TWI", "SCI", "SAI", "UCI", "FLI", "PCI")
cor_vars <- cor_vars[cor_vars %in% names(monthly)]

cor_data <- monthly[, .SD, .SDcols = cor_vars]
cor_matrix <- cor(cor_data, use = "pairwise.complete.obs")

rownames(cor_matrix) <- gsub("macro_", "", rownames(cor_matrix))
colnames(cor_matrix) <- gsub("macro_", "", colnames(cor_matrix))

corrplot(cor_matrix,
         method = "color",
         type = "upper",
         order = "hclust",
         tl.col = "black",
         tl.srt = 45,
         tl.cex = 0.7,
         addCoef.col = "black",
         number.cex = 0.5,
         col = colorRampPalette(c(pal$cool, "white", pal$highlight))(100),
         title = "Korelacijska matrica",
         mar = c(0, 0, 2, 0))
```

# Sentiment analiza

## Sentiment komponente

```{r sentiment-components}
#| label: sentiment-components
#| fig-cap: "Sentiment komponente kroz vrijeme"
#| fig-height: 10

p_sent1 <- ggplot(monthly, aes(x = yearmonth)) +
  geom_col(aes(y = sent_positive_avg), fill = pal$success, alpha = 0.7) +
  geom_col(aes(y = -sent_negative_avg), fill = pal$highlight, alpha = 0.7) +
  geom_hline(yintercept = 0, color = "black") +
  scale_x_date(date_breaks = "3 months", date_labels = "%b\n%Y") +
  labs(title = "Pozitivni (gore) vs Negativni (dolje) sentiment po članku",
       x = NULL, y = "Prosječan broj pojmova")

p_sent2 <- ggplot(monthly, aes(x = yearmonth, y = sent_ratio_avg)) +
  geom_hline(yintercept = 0, linetype = "dashed", color = pal$muted) +
  geom_area(aes(fill = sent_ratio_avg > 0), alpha = 0.5) +
  geom_line(color = pal$primary, linewidth = 1) +
  scale_fill_manual(values = c("TRUE" = pal$success, "FALSE" = pal$highlight), guide = "none") +
  scale_x_date(date_breaks = "3 months", date_labels = "%b\n%Y") +
  labs(title = "Net sentiment ratio", subtitle = "(pozitivno - negativno) / (pozitivno + negativno)",
       x = NULL, y = "Ratio (-1 do 1)")

p_sent3 <- ggplot(monthly, aes(x = yearmonth)) +
  geom_line(aes(y = intensity_high / N * 100, color = "Visoki intenzitet"), linewidth = 1) +
  geom_line(aes(y = intensity_low / N * 100, color = "Niski intenzitet"), linewidth = 1) +
  scale_color_manual(values = c("Visoki intenzitet" = pal$highlight, "Niski intenzitet" = pal$cool)) +
  scale_x_date(date_breaks = "3 months", date_labels = "%b\n%Y") +
  labs(title = "Intenzitet jezika", x = NULL, y = "Pojmova na 100 članaka", color = NULL) +
  theme(legend.position = "bottom")

p_sent1 / p_sent2 / p_sent3
```

## Uncertainty vs Sentiment scatter

```{r uncertainty-sentiment-scatter}
#| label: uncertainty-sentiment-scatter
#| fig-cap: "Odnos neizvjesnosti i sentimenta"
#| fig-height: 6

ggplot(monthly, aes(x = UCI, y = SAI)) +
  geom_point(aes(size = N, color = yearmonth), alpha = 0.7) +
  geom_smooth(method = "lm", se = TRUE, color = pal$primary) +
  scale_color_viridis_c(option = "viridis", labels = function(x) format(as.Date(x, origin = "1970-01-01"), "%b %Y")) +
  labs(
    title = "Neizvjesnost vs Sentiment",
    x = "Uncertainty Index", y = "Sentiment Adjusted Index",
    size = "Broj članaka", color = "Mjesec"
  ) +
  theme(legend.position = "right")
```

# Volatilnost i momentum

```{r volatility-momentum}
#| label: volatility-momentum
#| fig-cap: "Volatilnost i momentum indeksa"
#| fig-height: 12

# Volatilnost = rolling SD
monthly[, VAI_vol := frollapply(VAI, n = 3, FUN = sd, align = "right")]
monthly[, SCI_vol := frollapply(SCI, n = 3, FUN = sd, align = "right")]

# Momentum = M/M promjena
monthly[, VAI_mom := VAI - shift(VAI, 1)]
monthly[, SCI_mom := SCI - shift(SCI, 1)]

# 3M momentum
monthly[, VAI_mom3 := VAI - shift(VAI, 3)]

p_vol <- ggplot(monthly[!is.na(VAI_vol)], aes(x = yearmonth)) +
  geom_area(aes(y = VAI_vol), fill = pal$cool, alpha = 0.5) +
  geom_line(aes(y = VAI_vol), color = pal$primary, linewidth = 1) +
  scale_x_date(date_breaks = "3 months", date_labels = "%b\n%Y") +
  labs(title = "VAI volatilnost (3M rolling SD)", x = NULL, y = "Standardna devijacija")

p_mom <- ggplot(monthly[!is.na(VAI_mom)], aes(x = yearmonth)) +
  geom_hline(yintercept = 0, linetype = "dashed", color = pal$muted) +
  geom_col(aes(y = VAI_mom, fill = VAI_mom > 0), alpha = 0.7) +
  scale_fill_manual(values = c("TRUE" = pal$success, "FALSE" = pal$highlight), guide = "none") +
  scale_x_date(date_breaks = "3 months", date_labels = "%b\n%Y") +
  labs(title = "VAI momentum (M/M promjena)", x = NULL, y = "Promjena")

p_mom3 <- ggplot(monthly[!is.na(VAI_mom3)], aes(x = yearmonth)) +
  geom_hline(yintercept = 0, linetype = "dashed", color = pal$muted) +
  geom_area(aes(y = VAI_mom3, fill = VAI_mom3 > 0), alpha = 0.5) +
  geom_line(aes(y = VAI_mom3), color = pal$primary, linewidth = 1) +
  scale_fill_manual(values = c("TRUE" = pal$success, "FALSE" = pal$highlight), guide = "none") +
  scale_x_date(date_breaks = "3 months", date_labels = "%b\n%Y") +
  labs(title = "VAI 3 mjesečni momentum", x = NULL, y = "Promjena")

p_combined <- ggplot(monthly, aes(x = yearmonth)) +
  geom_line(aes(y = scale(VAI)[,1], color = "VAI (std)"), linewidth = 1) +
  geom_line(aes(y = scale(UCI)[,1], color = "UCI (std)"), linewidth = 1) +
  geom_line(aes(y = scale(FLI)[,1], color = "FLI (std)"), linewidth = 1) +
  scale_color_manual(values = c("VAI (std)" = pal$cool, "UCI (std)" = pal$highlight, "FLI (std)" = pal$success)) +
  scale_x_date(date_breaks = "3 months", date_labels = "%b\n%Y") +
  labs(title = "Standardizirani indeksi", x = NULL, y = "Z-score", color = NULL) +
  theme(legend.position = "bottom")

p_vol / p_mom / p_mom3 / p_combined
```

# Topic concentration

```{r topic-concentration}
#| label: topic-concentration
#| fig-cap: "Koncentracija tema"
#| fig-height: 8

# Herfindahl indeks koncentracije po mjesecu
calc_hhi <- function(values) {
  values <- values[values > 0]
  if (length(values) == 0) return(0)
  shares <- values / sum(values)
  sum(shares^2)
}

monthly[, topic_hhi := apply(.SD, 1, calc_hhi), .SDcols = macro_cols]
monthly[, topic_count := rowSums(.SD > 0), .SDcols = macro_cols]

p_hhi <- ggplot(monthly, aes(x = yearmonth, y = topic_hhi)) +
  geom_line(color = pal$primary, linewidth = 1) +
  geom_smooth(method = "loess", se = TRUE, color = pal$highlight, span = 0.3) +
  scale_x_date(date_breaks = "3 months", date_labels = "%b\n%Y") +
  labs(
    title = "Herfindahl indeks koncentracije tema",
    subtitle = "Viši = fokusiranije na manje tema | Niži = disperziranije",
    x = NULL, y = "HHI"
  )

p_count <- ggplot(monthly, aes(x = yearmonth, y = topic_count)) +
  geom_col(fill = pal$accent, alpha = 0.7) +
  scale_x_date(date_breaks = "3 months", date_labels = "%b\n%Y") +
  labs(title = "Broj aktivnih tema po mjesecu", x = NULL, y = "Broj tema s pojavljivanjem")

p_hhi / p_count
```

# Korelacije između indeksa

```{r index-correlations}
#| label: index-correlations

index_cols_final <- c("VAI", "TWI", "SCI", "SAI", "UCI", "FLI", "PCI")
index_cols_final <- index_cols_final[index_cols_final %in% names(monthly)]

index_cor <- cor(monthly[, .SD, .SDcols = index_cols_final], use = "pairwise.complete.obs")

kable(round(index_cor, 3), caption = "Korelacijska matrica indeksa") %>%
  kable_styling(bootstrap_options = c("striped", "hover"), full_width = FALSE)
```

# Export

```{r export-excel}
#| label: export-excel

wb <- createWorkbook()

# Sheet 1: Glavni indeksi
addWorksheet(wb, "Indeksi")
export_indices <- monthly[, .(
  Datum = yearmonth,
  Broj_clanaka = N,
  VAI, TWI, SCI, SAI, UCI, FLI, PCI,
  VAI_MA3, TWI_MA3, SCI_MA3
)]
writeData(wb, "Indeksi", export_indices)

# Sheet 2: Sektori
addWorksheet(wb, "Sektori")
export_sectors <- monthly[, c("yearmonth", macro_cols), with = FALSE]
names(export_sectors) <- c("Datum", gsub("macro_", "", macro_cols))
writeData(wb, "Sektori", export_sectors)

# Sheet 3: Sentiment
addWorksheet(wb, "Sentiment")
export_sentiment <- monthly[, .(
  Datum = yearmonth,
  Pozitivan = sent_positive,
  Negativan = sent_negative,
  Net = sent_net,
  Ratio = sent_ratio_avg,
  Neizvjesnost = uncertainty,
  Forward_looking = forward_looking,
  Intenzitet_visoki = intensity_high,
  Intenzitet_niski = intensity_low
)]
writeData(wb, "Sentiment", export_sentiment)

# Sheet 4: Volatilnost
addWorksheet(wb, "Volatilnost")
export_vol <- monthly[, .(
  Datum = yearmonth,
  VAI_volatilnost = VAI_vol,
  VAI_momentum = VAI_mom,
  VAI_momentum_3M = VAI_mom3,
  Topic_HHI = topic_hhi
)]
writeData(wb, "Volatilnost", export_vol)

# Stilovi
header_style <- createStyle(
  textDecoration = "bold",
  fgFill = "#1a1a2e",
  fontColour = "white",
  halign = "center"
)

for (sheet in names(wb)) {
  sheet_data <- switch(sheet,
    "Indeksi" = export_indices,
    "Sektori" = export_sectors,
    "Sentiment" = export_sentiment,
    "Volatilnost" = export_vol
  )
  ncols <- ncol(sheet_data)
  addStyle(wb, sheet, header_style, rows = 1, cols = 1:ncols, gridExpand = TRUE)
  setColWidths(wb, sheet, cols = 1:ncols, widths = "auto")
}

output_path <- here("output", "semantic_activity_indices.xlsx")
dir.create(here("output"), showWarnings = FALSE, recursive = TRUE)
saveWorkbook(wb, output_path, overwrite = TRUE)
cat("Excel exportiran:", output_path, "\n")
```

# Sažetak

```{r summary}
#| label: summary

summary_table <- data.table(
  Metrika = c(
    "Broj analiziranih članaka",
    "Vremenski raspon",
    "Broj semantičkih kategorija",
    "Broj makro sektora",
    "Broj konstruiranih indeksa",
    "Prosječni VAI",
    "Prosječni sentiment ratio",
    "Prosječni UCI"
  ),
  Vrijednost = c(
    format(nrow(dt), big.mark = ","),
    paste(format(date_min, "%m/%Y"), "-", format(date_max, "%m/%Y")),
    length(sem_cols),
    length(macro_cols),
    length(index_cols_final),
    round(mean(monthly$VAI, na.rm = TRUE), 1),
    round(mean(monthly$sent_ratio_avg, na.rm = TRUE), 3),
    round(mean(monthly$UCI, na.rm = TRUE), 1)
  )
)

kable(summary_table, caption = "Sažetak analize") %>%
  kable_styling(bootstrap_options = c("striped", "hover"), full_width = FALSE)
```

---

*Izvještaj generiran: `r Sys.time()`*

*GIMES Research | Semantički indeks gospodarske aktivnosti v2.0*
