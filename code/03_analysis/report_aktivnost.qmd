---
title: "Semantički indeksi gospodarske aktivnosti"
subtitle: "Mjerenje ekonomske aktivnosti kroz analizu medijskog diskursa"
author: "GIMES Research"
date: today
format:
  html:
    toc: true
    toc-depth: 4
    toc-location: left
    number-sections: true
    theme: cosmo
    code-fold: true
    code-summary: "Prikaži kod"
    fig-width: 11
    fig-height: 7
    df-print: paged
    embed-resources: true
execute:
  warning: false
  message: false
  echo: false
lang: hr
---

```{r setup}
#| label: setup
#| include: false

# Core data manipulation
library(data.table)
library(lubridate)
library(stringi)

# Visualization
library(ggplot2)
library(scales)
library(plotly)
library(corrplot)
library(patchwork)
library(viridis)

# Tables and output
library(knitr)
library(kableExtra)
library(openxlsx)

# Time series
library(zoo)

# Project management
library(here)

colors_gimes <- c(
  "primary"   = "#2C3E50",
  "secondary" = "#E74C3C",
  "accent"    = "#3498DB",
  "success"   = "#27AE60",
  "warning"   = "#F39C12",
  "danger"    = "#C0392B",
  "light"     = "#ECF0F1",
  "purple"    = "#9B59B6",
  "teal"      = "#1ABC9C",
  "muted"     = "#7F8C8D"
)

options(scipen = 999)

theme_gimes <- function() {
  theme_minimal(base_size = 12) +
    theme(
      plot.title = element_text(face = "bold", size = 14, color = colors_gimes["primary"]),
      plot.subtitle = element_text(size = 10, color = "gray40"),
      panel.grid.minor = element_blank(),
      legend.position = "bottom",
      axis.text = element_text(size = 9),
      strip.text = element_text(face = "bold", size = 10)
    )
}

theme_set(theme_gimes())
```

# Uvod

Ovaj dokument konstruira semantičke indekse gospodarske aktivnosti temeljene na analizi medijskog diskursa. Primjenom leksičke analize na korpus novinskih članaka kvantificiraju se različiti aspekti ekonomske aktivnosti percipirani kroz medijski prostor.

## Motivacija i kontekst

Medijski diskurs predstavlja važan izvor informacija o percepciji gospodarskih kretanja u realnom vremenu. Tradicionalni ekonomski pokazatelji poput BDP rasta ili industrijske proizvodnje objavljuju se s vremenskim odmakom, dok medijsko izvještavanje pruža uvid u trenutnu percepciju ekonomske situacije. Ovim izvještajem se nastoji odgovoriti na ključna pitanja:

1. Kako kvantificirati intenzitet medijskog pokrivanja ekonomskih tema?
2. Kako pratiti dinamiku pojedinih sektora gospodarstva kroz medijski diskurs?
3. Kako mjeriti sentiment i neizvjesnost u ekonomskom izvještavanju?
4. Kako konstruirati kompozitne indekse koji sintetiziraju višestruke dimenzije ekonomske aktivnosti?

## Struktura izvještaja

U izvještaju se obrađuju sljedeće teme: metodologija identifikacije članaka, eksploratorni pregled podataka, semantička taksonomija pojmova, konstrukcija i vizualizacija indeksa, sektorska analiza, sentiment analiza, volatilnost i momentum te koncentracija tema.

```{r load-data}
#| label: load-data

#dt <- as.data.table(read.xlsx(here("data", "activity_filtered.xlsx")))
dt <- as.data.table(read.xlsx("C:/Users/lsikic/Desktop/activity_filtered.xlsx"))

# Date conversion
if (is.numeric(dt$DATE)) {
  dt[, DATE := as.Date(DATE, origin = "1899-12-30")]
} else {
  dt[, DATE := as.Date(DATE)]
}

# Numeric conversions
if ("text_length" %in% names(dt)) dt[, text_length := as.numeric(text_length)]
if ("REACH" %in% names(dt)) dt[, REACH := as.numeric(REACH)]
if ("INTERACTIONS" %in% names(dt)) dt[, INTERACTIONS := as.numeric(INTERACTIONS)]

# Time variables
dt[, `:=`(
  date = DATE,
  year = year(DATE),
  month = month(DATE),
  week = isoweek(DATE),
  quarter = quarter(DATE),
  yearmonth = floor_date(DATE, "month"),
  yearweek = floor_date(DATE, "week"),
  yearquarter = floor_date(DATE, "quarter")
)]

# Store date range
date_min <- min(dt$date, na.rm = TRUE)
date_max <- max(dt$date, na.rm = TRUE)

cat("Učitano", format(nrow(dt), big.mark = ","), "članaka\n")
cat("Vremenski raspon:", format(date_min, "%d.%m.%Y"), "do", format(date_max, "%d.%m.%Y"), "\n")
```

# Metodologija identifikacije članaka

## Pregled procesa filtriranja

Identifikacija relevantnih članaka se provodi kroz sedmostupanjski proces filtriranja koji osigurava visoku preciznost i relevantnost rezultata.

::: {.callout-note collapse="true" title="Detaljna metodologija filtriranja"}

**Filter 1: Tip izvora**
Odabir članaka iz news portala, isključujući društvene mreže, forume i blogove.

**Filter 2: Relevantni news portali**
Ograničenje na verificirane hrvatske medijske izvore s redovitim ekonomskim izvještavanjem.

**Filter 3: Minimalna duljina teksta**
Članci s manje od 200 znakova se isključuju kao potencijalno irelevantni ili nekompletni.

**Filter 4: Naslov članka**
Provjera prisutnosti ekonomski relevantnih pojmova u naslovu članka.

**Filter 5: Core pojmovi**
Detekcija ključnih ekonomskih termina u tijelu teksta korištenjem regex uzoraka.

**Filter 6: Isključivanje irelevantnog sadržaja**
Eliminacija članaka koji sadrže isključivo sportske, zabavne ili lifestyle teme bez ekonomske komponente.

**Filter 7: Hrvatski kontekst**
Zadržavanje članaka s jasnom referencom na hrvatsko gospodarstvo ili relevantne domaće aktere.

:::

# Eksploratorni pregled podataka

## Osnovne statistike

```{r basic-stats}
#| label: basic-stats

stats_summary <- data.table(
  Metrika = c(
    "Ukupan broj članaka",
    "Vremenski raspon",
    "Broj dana",
    "Prosječno članaka dnevno",
    "Broj izvora",
    "Medijan duljine članka"
  ),
  Vrijednost = c(
    format(nrow(dt), big.mark = ","),
    paste(format(date_min, "%d.%m.%Y"), "do", format(date_max, "%d.%m.%Y")),
    as.character(as.numeric(date_max - date_min)),
    round(nrow(dt) / as.numeric(date_max - date_min), 2),
    length(unique(dt$FROM)),
    format(median(dt$text_length, na.rm = TRUE), big.mark = ",")
  )
)

kable(stats_summary, caption = "Osnovne statistike dataseta") %>%
  kable_styling(bootstrap_options = c("striped", "hover"), full_width = FALSE)
```

## Top izvora

```{r source-distribution}
#| label: source-distribution
#| fig-cap: "Top 20 izvora po broju članaka"

top_sources <- dt[, .(N = .N), by = FROM][order(-N)][1:20]

ggplot(top_sources, aes(x = reorder(FROM, N), y = N)) +
  geom_col(fill = colors_gimes["primary"], alpha = 0.8) +
  geom_text(aes(label = format(N, big.mark = ",")), hjust = -0.1, size = 3) +
  coord_flip() +
  scale_y_continuous(expand = expansion(mult = c(0, 0.15))) +
  labs(title = "Top 20 izvora po broju članaka", x = NULL, y = "Broj članaka")
```

## Distribucija kroz vrijeme

```{r time-distribution}
#| label: time-distribution
#| fig-cap: "Mjesečni broj članaka"
#| fig-height: 6

monthly_count <- dt[, .(N = .N), by = yearmonth][order(yearmonth)]
monthly_count[, MA3 := frollmean(N, n = 3, align = "center")]

ggplot(monthly_count, aes(x = yearmonth)) +
  geom_col(aes(y = N), fill = colors_gimes["light"], alpha = 0.7) +
  geom_line(aes(y = MA3), color = colors_gimes["secondary"], linewidth = 1.2, na.rm = TRUE) +
  scale_x_date(date_breaks = "3 months", date_labels = "%b\n%Y") +
  labs(
    title = "Mjesečni broj članaka o gospodarskoj aktivnosti",
    subtitle = "Crvena linija = 3 mjesečni klizni prosjek",
    x = NULL, y = "Broj članaka"
  )
```

# Semantička taksonomija

## Hijerarhijska struktura pojmova

```{r semantic-taxonomy}
#| label: semantic-taxonomy

activity_taxonomy <- list(
  
  # === 1. BDP I AGREGATNA AKTIVNOST ===
  bdp_agregat = list(
    bdp_direktno = c(
      "\\bBDP[aeu]?\\b", "bruto doma[cć][ie]g? proizvod[aeu]?",
      "gross domestic product", "\\bGDP\\b"
    ),
    bdp_dinamika = c(
      "rast.{0,10}BDP", "pad.{0,10}BDP", "BDP.{0,10}rast", "BDP.{0,10}pad",
      "rast.{0,10}gospodar", "pad.{0,10}gospodar",
      "ekonomsk[aeiou]+ rast", "gospodars[aeikou]+ rast",
      "negativan.{0,5}rast", "pozitivan.{0,5}rast"
    ),
    recesija_ekspanzija = c(
      "recesij[aeiou]?", "stagnacij[aeiou]?", "kontrakcij[aeiou]?",
      "ekspanzij[aeiou]?", "oporavak.{0,10}gospodar", "gospodar.{0,10}oporavak",
      "usporavanj[aeu]?.{0,10}gospodar", "ubrzanj[aeu]?.{0,10}gospodar"
    ),
    kvartalni = c(
      "kvartaln[aeiou]+.{0,10}(rast|pad|BDP|podaci)",
      "prvi.{0,5}kvartal", "drugi.{0,5}kvartal",
      "tre[cć]i.{0,5}kvartal", "[cč]etvrti.{0,5}kvartal",
      "Q[1-4]", "sezonski.{0,10}prilag"
    )
  ),
  
  # === 2. INDUSTRIJSKA PROIZVODNJA ===
  industrija = list(
    proizvodnja_opce = c(
      "industrijska?.{0,10}proizvodnj[aeiou]?",
      "proizvodni?.{0,10}sektor", "proizvodni?.{0,10}aktivnost",
      "tvornic[aeiou]?", "pogon[aeiou]?"
    ),
    preradivacka = c(
      "prera[dđ]iva[cč]k[aeiou]+.{0,10}industrij[aeiou]?",
      "prera[dđ]iva[cč]k[aeiou]+.{0,10}sektor",
      "manufacturin[g]?"
    ),
    energetika = c(
      "energetsk[aeiou]+.{0,10}sektor", "energetik[aeiou]?",
      "proizvodnj[aeiou]?.{0,10}energij", "elektran[aeiou]?",
      "\\bHEP\\b", "\\bINA\\b"
    ),
    kapaciteti = c(
      "iskori[sš]tenost.{0,10}kapacitet",
      "proizvodni.{0,10}kapacitet",
      "industrijsk[aeiou]+.{0,10}kapacitet"
    )
  ),
  
  # === 3. GRAĐEVINARSTVO ===
  gradevinarstvo = list(
    sektor = c(
      "gra[dđ]evinarstv[aou]?", "gra[dđ]evins[aeikou]+.{0,10}sektor",
      "gra[dđ]evins[aeikou]+.{0,10}aktivnost",
      "gra[dđ]evins[aeikou]+.{0,10}radov[aeiou]?"
    ),
    projekti = c(
      "gradnj[aeiou]?", "izgradnj[aeiou]?",
      "infrastruktur[aeiou]?", "projekat", "projekt[aeiou]?"
    ),
    nekretnine = c(
      "nekretnin[aeiou]?", "stanov[aeiou]?", "stambeni?.{0,10}gradnj",
      "tr[zž]i[sš]t[aeu]?.{0,10}nekretnin"
    ),
    dozvole = c(
      "gra[dđ]evins[aeikou]+.{0,10}dozvol[aeiou]?",
      "izdane.{0,10}dozvol", "broj.{0,10}dozvol"
    )
  ),
  
  # === 4. TURIZAM ===
  turizam = list(
    promet = c(
      "turisti[cč]k[aeiou]+.{0,10}promet",
      "turisti[cč]k[aeiou]+.{0,10}prihod[aeiou]?",
      "turisti[cč]k[aeiou]+.{0,10}sezon[aeiou]?"
    ),
    dolasci_nocenja = c(
      "dolaz[aeikou]+.{0,10}turist", "turist.{0,10}dolaz",
      "no[cć]enj[aeiou]?", "broj.{0,10}turist[aeiou]?"
    ),
    smjestaj = c(
      "smje[sš]tajn[aeiou]+.{0,10}kapacitet",
      "hotel[aeiou]?", "kampov[aeiou]?",
      "popunjenost.{0,10}smje[sš]taj"
    )
  ),
  
  # === 5. TRGOVINA ===
  trgovina = list(
    vanjska = c(
      "vanjsk[aeiou]+.{0,10}trgovin[aeiou]?",
      "trgovinsk[aeiou]+.{0,10}bilanc[aeiou]?",
      "robn[aeiou]+.{0,10}razmjen[aeiou]?"
    ),
    izvoz = c(
      "izvoz[aeiou]?", "eksport[aeiou]?",
      "rast.{0,10}izvoz", "pad.{0,10}izvoz",
      "izvozn[aeikou]+.{0,10}aktivnost"
    ),
    uvoz = c(
      "uvoz[aeiou]?", "import[aeiou]?",
      "rast.{0,10}uvoz", "pad.{0,10}uvoz"
    ),
    maloprodaja = c(
      "maloprodaj[aeiou]?", "maloprodajn[aeiou]+.{0,10}promet",
      "promet.{0,10}trgovin", "trgovin[aeiou]+.{0,10}promet"
    )
  ),
  
  # === 6. INVESTICIJE ===
  investicije = list(
    opce = c(
      "investicij[aeiou]?", "ulaganj[aeiou]?",
      "kapitalna?.{0,10}ulaganj", "bruto.{0,10}investicij"
    ),
    strane = c(
      "stran[aeiou]+.{0,10}investicij", "stran[aeiou]+.{0,10}ulaganj",
      "\\bFDI\\b", "inozemn[aeiou]+.{0,10}ulaganj",
      "privla[cč]enj[aeu]?.{0,10}investicij"
    ),
    javne = c(
      "javn[aeiou]+.{0,10}investicij", "dr[zž]avn[aeiou]+.{0,10}ulaganj",
      "eu.{0,5}fondov[aeiou]?", "europsk[aeiou]+.{0,10}fondov"
    )
  ),
  
  # === 7. TRŽIŠTE RADA ===
  trziste_rada = list(
    zaposlenost = c(
      "zaposlenost[aeiou]?", "zaposlen[aeiou]+",
      "broj.{0,10}zaposlen", "rast.{0,10}zaposlen",
      "nova?.{0,10}radna?.{0,10}mjesta?"
    ),
    nezaposlenost = c(
      "nezaposlenost[aeiou]?", "nezaposlen[aeiou]+",
      "stopa?.{0,10}nezaposlen", "\\bHZZ\\b",
      "evidencij[aeiou]+.{0,10}nezaposlen"
    ),
    place = c(
      "pla[cć][aeiou]?", "prosje[cč]n[aeiou]+.{0,10}pla[cć]",
      "rast.{0,10}pla[cć]", "neto.{0,10}pla[cć]", "bruto.{0,10}pla[cć]"
    )
  ),
  
  # === 8. POSLOVNI SENTIMENT ===
  sentiment_poslovni = list(
    povjerenje = c(
      "poslovn[aeiou]+.{0,10}povjerenj[aeiou]?",
      "indeks.{0,10}povjerenj", "poslovn[aeiou]+.{0,10}klim[aeiou]?",
      "poslovn[aeiou]+.{0,10}o[cč]ekivanj"
    ),
    optimizam_pesimizam = c(
      "poslovn[aeiou]+.{0,10}optimiz", "poslovn[aeiou]+.{0,10}pesimiz",
      "pozitivn[aeiou]+.{0,10}o[cč]ekivanj", "negativn[aeiou]+.{0,10}o[cč]ekivanj"
    ),
    ankete = c(
      "anket[aeiou]+.{0,10}(poduze[cć]|menad[zž]er|direktora?)",
      "\\bPMI\\b", "purchasing.{0,5}manager"
    )
  ),
  
  # === 9. POTROŠNJA ===
  potrosnja = list(
    osobna = c(
      "osobn[aeiou]+.{0,10}potro[sš]nj[aeiou]?",
      "potro[sš]a[cč]k[aeiou]+.{0,10}potro[sš]nj",
      "finalna?.{0,10}potro[sš]nj"
    ),
    potrosaci = c(
      "potro[sš]a[cč][aeiou]?", "kupac", "kupci",
      "potro[sš]a[cč]k[aeiou]+.{0,10}povjerenj",
      "potro[sš]a[cč]k[aeiou]+.{0,10}sentiment"
    ),
    stednja = c(
      "[sš]tednj[aeiou]?", "deponiran[aeiou]?",
      "odr[zž]iv[aeiou]+.{0,10}potro[sš]nj"
    )
  ),
  
  # === 10. FINANCIJSKI SEKTOR ===
  financije = list(
    bankarstvo = c(
      "bank[aeiou]?", "bankars[aeikou]+.{0,10}sektor",
      "kredit[aeiou]?", "kreditiranj[aeu]?",
      "\\bPBZ\\b", "\\bZABA\\b", "Zagreba[cč]ka.{0,5}banka"
    ),
    trziste_kapitala = c(
      "burz[aeiou]?", "\\bZSE\\b", "\\bCROBEX\\b",
      "dionice?", "tr[zž]i[sš]t[aeu]?.{0,10}kapital"
    ),
    likvidnost = c(
      "likvidnost[aeiou]?", "solventnost[aeiou]?",
      "nov[cč]an[aeiou]+.{0,10}tok"
    )
  ),
  
  # === 11. INSTITUCIONALNI OKVIR ===
  institucije = list(
    statistika = c(
      "\\bDZS\\b", "Dr[zž]avn[io]?.{0,10}zavod.{0,10}statistik",
      "\\bEurostat\\b", "statisti[cč]k[aeiou]+.{0,10}podaci"
    ),
    centralna_banka = c(
      "\\bHNB\\b", "Hrvatska?.{0,10}narodna?.{0,10}banka",
      "\\bECB\\b", "guverner"
    ),
    komore = c(
      "\\bHGK\\b", "Hrvatska?.{0,10}gospodarska?.{0,10}komora",
      "\\bHUP\\b", "udruga?.{0,10}poslodavac"
    ),
    vlada = c(
      "Vlad[aeiou]?.{0,10}(RH|Republike|Hrvatski)",
      "ministarstvo?.{0,10}gospodar",
      "ministarstvo?.{0,10}financij"
    )
  ),
  
  # === 12. SEKTORSKI FOKUS ===
  sektori = list(
    it_tehnologija = c(
      "\\bIT\\b.{0,10}sektor", "tehnolo[sš]k[aeiou]+.{0,10}sektor",
      "digitalizacij[aeiou]?", "startup", "inovacij[aeiou]?"
    ),
    poljoprivreda = c(
      "poljoprivred[aeiou]?", "agrarn[aeiou]+.{0,10}sektor",
      "[zž]etv[aeiou]?", "urod", "prinos"
    ),
    promet_logistika = c(
      "prometn[aeiou]+.{0,10}sektor", "logistik[aeiou]?",
      "luka", "zra[cč]n[aeiou]+.{0,10}promet", "teretni?.{0,10}promet"
    )
  )
)

flatten_taxonomy <- function(taxonomy) {
  result <- list()
  for (macro in names(taxonomy)) {
    for (meso in names(taxonomy[[macro]])) {
      key <- paste0(macro, "_", meso)
      result[[key]] <- taxonomy[[macro]][[meso]]
    }
  }
  result
}

flat_terms <- flatten_taxonomy(activity_taxonomy)

tax_summary <- rbindlist(lapply(names(activity_taxonomy), function(macro) {
  rbindlist(lapply(names(activity_taxonomy[[macro]]), function(meso) {
    data.table(
      Makro_kategorija = macro,
      Meso_kategorija = meso,
      Broj_pojmova = length(activity_taxonomy[[macro]][[meso]])
    )
  }))
}))
```

::: {.callout-note collapse="true"}
## Kliknite za prikaz tablice strukture semantičke taksonomije

```{r taxonomy-table}
#| label: taxonomy-table

kable(tax_summary, caption = "Struktura semantičke taksonomije") %>%
  kable_styling(bootstrap_options = c("striped", "hover"), full_width = FALSE) %>%
  collapse_rows(columns = 1, valign = "top")
```

:::

## Sentiment i neizvjesnost leksikoni

```{r sentiment-uncertainty-lexicons}
#| label: sentiment-uncertainty-lexicons

sentiment_lexicon <- list(
  positive = c(
    "rast", "porast", "poveć", "poboljš", "oporav",
    "ekspanzi", "uzlet", "procvat", "napred", "uspje",
    "dobit", "profit", "prihod", "investici", "ulagan",
    "zapošljav", "nova radna mjesta", "optimiz", "povjerenj",
    "stabili", "snažn", "jak", "rekord", "povijesni maksimum",
    "premaši", "nadmaši", "bolji nego", "iznad očekivanja"
  ),
  negative = c(
    "pad", "smanj", "gubit", "kriz", "recesi",
    "stagnaci", "usporav", "kontrakci", "propad", "kolaps",
    "bankrot", "stečaj", "otpušt", "nezaposl", "deficit",
    "dug", "zadužen", "inflaci", "poskuplj", "pesimiz",
    "nesigurn", "rizik", "slab", "loš", "negativ",
    "ispod očekivanja", "lošije nego", "problem", "poteškoć"
  )
)

uncertainty_lexicon <- c(
  "neizvjesn", "nesigurn", "rizik", "volatil", "nepredvid",
  "možda", "eventualno", "potencijalno", "vjerojatno", "moguć",
  "ako", "ukoliko", "ovisno", "zavisi", "nepoznat",
  "nejasn", "neodređen", "upitn", "dvojben", "spekulaci",
  "strah", "zabrinut", "oprez", "pažljiv", "oklijevan",
  "čekanj", "odgod", "zastoj", "blokad", "pregovor",
  "preispitivan", "revizi", "korekci"
)

forward_lexicon <- c(
  "očekuje se", "predviđa se", "prognoz", "projekci", "plan",
  "namjer", "strategi", "buduć", "sljedeć", "nadolazec",
  "će", "hoće", "planira", "namjerav", "očekivan",
  "perspektiv", "izgled", "trend", "smjer", "kretan",
  "procjen", "scenari", "mogućnost", "potencijal"
)

intensity_lexicon <- list(
  high = c(
    "značajn", "znatn", "drastičn", "snažn", "jak",
    "enorm", "golem", "masivn", "eksplozivn", "rekordn",
    "povijesn", "bez presedana", "nikad viđen", "izvanredn"
  ),
  moderate = c(
    "umjeren", "blag", "postupn", "lagan", "stabiln",
    "konstantn", "ravnomjern", "očekivan", "prosječn"
  ),
  low = c(
    "minimaln", "neznatn", "marginaln", "simboličn",
    "jedva", "tek", "samo", "neznačajn"
  )
)

cat("Definirano", length(sentiment_lexicon$positive), "pozitivnih i", 
    length(sentiment_lexicon$negative), "negativnih sentiment korijena\n")
cat("Definirano", length(uncertainty_lexicon), "neizvjesnost korijena\n")
cat("Definirano", length(forward_lexicon), "forward looking korijena\n")
```

## Brojanje pojmova

```{r count-terms}
#| label: count-terms

count_patterns <- function(text, patterns) {
  if (is.na(text) || text == "") return(0)
  text_lower <- tolower(text)
  sum(sapply(patterns, function(p) {
    tryCatch(stri_count_regex(text_lower, p), error = function(e) 0)
  }))
}

for (cat_name in names(flat_terms)) {
  col_name <- paste0("sem_", cat_name)
  dt[, (col_name) := sapply(FULL_TEXT, count_patterns, patterns = flat_terms[[cat_name]])]
}

macro_categories <- unique(tax_summary$Makro_kategorija)

for (macro in macro_categories) {
  meso_cats <- tax_summary[Makro_kategorija == macro, Meso_kategorija]
  col_names <- paste0("sem_", macro, "_", meso_cats)
  existing_cols <- col_names[col_names %in% names(dt)]
  if (length(existing_cols) > 0) {
    dt[, paste0("macro_", macro) := rowSums(.SD, na.rm = TRUE), .SDcols = existing_cols]
  }
}

dt[, sent_positive := sapply(FULL_TEXT, count_patterns, patterns = sentiment_lexicon$positive)]
dt[, sent_negative := sapply(FULL_TEXT, count_patterns, patterns = sentiment_lexicon$negative)]
dt[, sent_net := sent_positive - sent_negative]
dt[, sent_ratio := fifelse(sent_positive + sent_negative > 0,
                           (sent_positive - sent_negative) / (sent_positive + sent_negative), 0)]

dt[, uncertainty := sapply(FULL_TEXT, count_patterns, patterns = uncertainty_lexicon)]
dt[, forward_looking := sapply(FULL_TEXT, count_patterns, patterns = forward_lexicon)]

dt[, intensity_high := sapply(FULL_TEXT, count_patterns, patterns = intensity_lexicon$high)]
dt[, intensity_low := sapply(FULL_TEXT, count_patterns, patterns = intensity_lexicon$low)]
dt[, intensity_net := intensity_high - intensity_low]

sem_cols <- names(dt)[grepl("^sem_", names(dt))]
dt[, semantic_total := rowSums(.SD, na.rm = TRUE), .SDcols = sem_cols]

cat("Izračunato", length(sem_cols), "semantičkih varijabli\n")
```

# Konstrukcija indeksa

## Mjesečna agregacija

```{r monthly-aggregation}
#| label: monthly-aggregation

macro_cols <- names(dt)[grepl("^macro_", names(dt))]
sem_cols_all <- c(sem_cols, macro_cols, "semantic_total",
                  "sent_positive", "sent_negative", "sent_net", "sent_ratio",
                  "uncertainty", "forward_looking",
                  "intensity_high", "intensity_low", "intensity_net")

monthly <- dt[, c(
  .(N = .N,
    total_words = sum(text_length, na.rm = TRUE),
    avg_length = mean(text_length, na.rm = TRUE),
    unique_sources = uniqueN(FROM)),
  lapply(.SD, sum, na.rm = TRUE),
  lapply(.SD, mean, na.rm = TRUE) |> setNames(paste0(names(.SD), "_avg"))
), by = yearmonth, .SDcols = sem_cols_all][order(yearmonth)]

monthly[, articles_per_source := N / unique_sources]
monthly[, coverage_breadth := uniqueN(names(flat_terms)[sapply(names(flat_terms), function(x) {
  sum(dt[yearmonth == .BY$yearmonth, get(paste0("sem_", x))], na.rm = TRUE) > 0
})]), by = yearmonth]

cat("Agregirano", nrow(monthly), "mjeseci podataka\n")
```

## Sektorski indeksi

Sektorski indeksi kvantificiraju intenzitet medijskog pokrivanja pojedinih segmenata gospodarstva. Za svaki članak se provodi automatsko pretraživanje teksta korištenjem regex uzoraka iz semantičke taksonomije. Mjesečni sektorski indeks za sektor s u mjesecu t računa se kao suma detektiranih pojmova svih članaka u tom mjesecu, omogućujući praćenje apsolutne razine medijske pažnje kroz vrijeme. Indeks industrije agregira pojmove proizvodne aktivnosti i energetike. Indeks građevinarstva prati infrastrukturne projekte i tržište nekretnina. Turistički indeks mjeri izvještavanje o dolascima i smještajnim kapacitetima. Trgovinski indeks obuhvaća vanjskotrgovinsku razmjenu i maloprodajni promet.

::: {.callout-note collapse="true"}
## Detaljna metodologija sektorskih indeksa

**Proces ekstrakcije značajki:**

1. Pretprocesiranje teksta: Konverzija u mala slova primjenjuje se na cjelokupni tekst članka.

2. Pattern matching: Za svaki uzorak iz sektorskog leksikona izvršava se regex pretraga korištenjem funkcije `stri_count_regex()`.

3. Agregatni sektorski score: Svi meso kategorijski bodovi unutar jedne makro kategorije sumiraju se u jedinstveni makro sektorski indeks.

4. Vremenska agregacija: Dnevni podaci agregiraju se na mjesečnu razinu korištenjem funkcije `floor_date()`.

**Normalizacija:**

Sirovi mjesečni sektorski bodovi mogu se normalizirati po broju članaka kako bi se dobila prosječna sektorska gustoća, ili se mogu zadržati u apsolutnom obliku za praćenje ukupne medijske pažnje.

:::

```{r construct-indices}
#| label: construct-indices

normalize_01 <- function(x) {
  if (all(is.na(x))) return(rep(0.5, length(x)))
  rng <- range(x, na.rm = TRUE)
  if (rng[1] == rng[2]) return(rep(0.5, length(x)))
  (x - rng[1]) / (rng[2] - rng[1])
}

standardize <- function(x) {
  if (all(is.na(x))) return(rep(0, length(x)))
  (x - mean(x, na.rm = TRUE)) / sd(x, na.rm = TRUE)
}
```

### Volume Activity Index (VAI)

VAI predstavlja temeljnu mjeru ukupne zastupljenosti ekonomskog sadržaja u medijskom prostoru. Za svaki članak se zbrajaju sva pojavljivanja ekonomskih pojmova iz semantičke taksonomije korištenjem korijenskih oblika za detekciju morfoloških varijanti. Agregatni broj se normalizira brojem članaka u promatranom mjesecu čime se dobiva prosječna gustoća ekonomskih pojmova. Min max normalizacija skalira rezultate na raspon 0 do 100 gdje minimalna vrijednost postaje 0 a maksimalna 100. Viša vrijednost VAI indicira intenzivnije medijsko pokrivanje ekonomskih tema.

::: {.callout-note collapse="true"}
## Detaljna metodologija VAI indeksa

**Formalna definicija:**

$$VAI_t = \frac{x_t - x_{min}}{x_{max} - x_{min}} \times 100$$

gdje je $x_t = \frac{\sum_{i \in M_t} semantic\_total_i}{N_t}$

**Interpretacija:**

VAI od 100 označava mjesec s najvišom zabilježenom gustoćom ekonomskih pojmova unutar analiziranog razdoblja. VAI od 0 označava mjesec s najnižom gustoćom. Srednja vrijednost oko 50 sugerira prosječnu razinu medijske pažnje relativno na promatrano razdoblje.

:::

### Sectoral Composite Index (SCI)

SCI sintetizira dinamiku četiri ključna realna sektora gospodarstva u jedinstvenu kompozitnu mjeru. Za svaki mjesec se izračunava jednostavni aritmetički prosjek normaliziranih vrijednosti indeksa industrije, građevinarstva, trgovine i turizma. Jednaka ponderiranost svih komponenti izbjegava dominaciju pojedinačnog sektora. Rezultirajuća vrijednost se skalira na raspon 0 do 100 primjenom min max normalizacije. SCI pruža sažetu sliku ukupne aktivnosti realnog sektora prema percepciji medija.

::: {.callout-note collapse="true"}
## Detaljna metodologija SCI indeksa

**Komponente:**

1. **Industrija (macro_industrija)**: Proizvodna aktivnost, prerađivačka industrija, energetika
2. **Građevinarstvo (macro_gradevinarstvo)**: Građevinski radovi, infrastruktura, nekretnine
3. **Trgovina (macro_trgovina)**: Vanjska trgovina, izvoz, uvoz, maloprodaja
4. **Turizam (macro_turizam)**: Turistički promet, dolasci, noćenja, smještaj

**Formula:**

$$SCI_t = normalize_{01}\left(\frac{1}{4}\sum_{s \in S} macro_{s,t}\right) \times 100$$

:::

### Sentiment Adjusted Index (SAI)

SAI nadograđuje osnovnu volume mjeru integracijom tonaliteta medijskog izvještavanja. Polazna točka je gustoća ekonomskih pojmova identična VAI indeksu. Ta vrijednost se modulira faktorom koji ovisi o omjeru pozitivnih i negativnih sentiment riječi identificiranih korijenskim pretraživanjem. Sentiment ratio izračunava se kao razlika broja pozitivnih i negativnih pojmova podijeljena njihovim zbrojem što daje vrijednost u rasponu minus jedan do plus jedan. Volume metrika se množi s faktorom (1 + sentiment_ratio) čime se povećava za pozitivan odnosno smanjuje za negativan sentiment.

::: {.callout-note collapse="true"}
## Detaljna metodologija SAI indeksa

**Stupanj 1 — Ekstrakcija sentimenta:**

$$SR_i = \frac{P_i - N_i}{P_i + N_i}$$

gdje $P_i$ i $N_i$ označavaju broj pozitivnih odnosno negativnih pojmova u članku $i$.

**Stupanj 2 — Integracija s volume metrikom:**

$$SAI_t = normalize_{01}\left(\frac{semantic\_total_t}{N_t} \times (1 + \overline{SR_t})\right) \times 100$$

**Interpretacija:**

SAI iznad 50 sugerira da kombinacija volumena i sentimenta prelazi prosjek promatranog razdoblja.

:::

### Uncertainty Index (UCI)

UCI kvantificira razinu ekonomske neizvjesnosti percipirane kroz medijski diskurs. Konstrukcija se temelji na prebrojavanju pojavljivanja korijena riječi koje signaliziraju neizvjesnost kao što su neizvjesn, nesigurn, rizik, volatil, nepredvid, možda, vjerojatno i slično. Suma tih pojavljivanja normalizira se brojem članaka kako bi se dobila prosječna mjesečna frekvencija pojmova neizvjesnosti. Rezultat se skalira na raspon 0 do 100 standardnom normalizacijom. Povišene vrijednosti UCI indeksa indiciraju razdoblja percipirane povećane neizvjesnosti u ekonomskom okruženju.

::: {.callout-note collapse="true"}
## Detaljna metodologija UCI indeksa

**Leksikon neizvjesnosti obuhvaća 33 korijena riječi:**

1. **Direktni izrazi neizvjesnosti**: neizvjesn, nesigurn, nepredvid, nepoznat, nejasn, neodređen
2. **Izrazi rizika**: rizik, volatil, oprez, strah, zabrinut
3. **Modalni izrazi**: možda, eventualno, potencijalno, vjerojatno, moguć
4. **Kondicionalnost**: ako, ukoliko, ovisno, zavisi
5. **Procesni zastoji**: čekanj, odgod, zastoj, blokad, oklijevan
6. **Revizijski izrazi**: preispitivan, revizi, korekci

**Formula:**

$$UCI_t = normalize_{01}\left(\frac{\sum_{i \in M_t} uncertainty_i}{N_t}\right) \times 100$$

:::

### Forward Looking Index (FLI)

FLI mjeri stupanj orijentiranosti medijskog sadržaja prema budućim ekonomskim kretanjima. Indeks se konstruira prebrojavanjem korijena riječi koje impliciraju očekivanja, prognoze i planove uključujući očekuje se, predviđa se, prognoz, projekci, plan, strategi, buduć, perspektiv, trend i slične. Mjesečna suma pojavljivanja normalizira se brojem članaka i skalira na 0 do 100. Viši FLI sugerira da medijski diskurs stavlja naglasak na anticipaciju budućih događaja i trendova.

::: {.callout-note collapse="true"}
## Detaljna metodologija FLI indeksa

**Leksikon sadrži 24 korijena riječi:**

1. **Eksplicitne prognoze**: očekuje se, predviđa se, prognoz, projekci, procjen
2. **Planiranje**: plan, namjer, strategi
3. **Temporalni markeri**: buduć, sljedeć, nadolazec
4. **Futur glagoli**: će, hoće, planira, namjerav
5. **Perspektiva**: perspektiv, izgled, trend, smjer, scenari

**Komplementarnost s UCI:**

Visok UCI uz visok FLI sugerira neizvjesnost popraćenu aktivnim promišljanjem o budućnosti. Visok UCI uz nizak FLI može indicirati paralizu odlučivanja uslijed neizvjesnosti.

:::

### Principal Component Index (PCI)

PCI primjenjuje analizu glavnih komponenti za ekstrakciju latentnog faktora koji objašnjava zajedničko kretanje svih sektorskih indeksa. Svi makro sektorski indeksi se prvo standardiziraju na srednju vrijednost nula i standardnu devijaciju jedan. PCA dekompozicija kovarijacijske matrice ekstrahira prvu glavnu komponentu (PC1) kao linearnu kombinaciju koja maksimizira objašnjenu varijancu. PC1 bodovi za svaki mjesec normaliziraju se na raspon 0 do 100. PCI reprezentira dominantni zajednički faktor koji pokreće kretanje svih sektorskih indeksa.

::: {.callout-note collapse="true"}
## Detaljna metodologija PCI indeksa

**Matematička formulacija:**

Za matricu standardiziranih sektorskih indeksa $\mathbf{X}$ dimenzija $T \times K$, PCA pronalazi ortogonalnu dekompoziciju:

$$\mathbf{X} = \mathbf{U} \mathbf{D} \mathbf{V}^T$$

Prva glavna komponenta:

$$PC1_t = \sum_{k=1}^{K} v_{1k} \cdot x_{k,t}$$

**Prednosti PCI pristupa:**

1. Statistički optimalna agregacija bez arbitrarnih pondera
2. Robusnost na multikolinearnost među sektorima
3. Jasna interpretacija kao latentni faktor ekonomske aktivnosti

:::

```{r construct-indices-2}
#| label: construct-indices-2

# === INDEKS 1: Volume Activity Index (VAI) ===
monthly[, VAI := normalize_01(semantic_total / N) * 100]

# === INDEKS 2: Sectoral Composite Index (SCI) ===
key_sectors <- c("macro_industrija", "macro_gradevinarstvo", "macro_trgovina", "macro_turizam")
key_sectors <- key_sectors[key_sectors %in% names(monthly)]
if (length(key_sectors) > 0) {
  monthly[, SCI := normalize_01(rowMeans(.SD, na.rm = TRUE)) * 100, .SDcols = key_sectors]
}

# === INDEKS 3: Sentiment Adjusted Index (SAI) ===
monthly[, SAI := normalize_01(semantic_total / N * (1 + sent_ratio_avg)) * 100]

# === INDEKS 4: Uncertainty Index (UCI) ===
monthly[, UCI := normalize_01(uncertainty / N) * 100]

# === INDEKS 5: Forward Looking Index (FLI) ===
monthly[, FLI := normalize_01(forward_looking / N) * 100]

# === INDEKS 6: Principal Component Index (PCI) ===
pca_data <- monthly[, .SD, .SDcols = macro_cols]
pca_data_complete <- pca_data[complete.cases(pca_data)]

if (nrow(pca_data_complete) > 10 && ncol(pca_data_complete) > 2) {
  pca_data_scaled <- scale(pca_data_complete)
  pca_result <- prcomp(pca_data_scaled, scale. = FALSE)
  
  var_explained <- summary(pca_result)$importance[2, 1:min(5, ncol(pca_result$rotation))]
  
  pca_matrix <- as.matrix(pca_data)
  pca_matrix[is.na(pca_matrix)] <- 0
  pca_matrix_scaled <- scale(pca_matrix)
  pc1_scores <- as.numeric(pca_matrix_scaled %*% pca_result$rotation[, 1])
  
  monthly[, PCI := normalize_01(pc1_scores) * 100]
  
  cat("PCA: PC1 objašnjava", round(var_explained[1] * 100, 1), "% varijance\n")
} else {
  monthly[, PCI := VAI]
}

# Klizni prosjeci
index_cols <- c("VAI", "SCI", "SAI", "UCI", "FLI", "PCI")
for (idx in index_cols) {
  if (idx %in% names(monthly)) {
    monthly[, paste0(idx, "_MA3") := frollmean(get(idx), n = 3, align = "center")]
  }
}

cat("Konstruirano 6 indeksa\n")
```

## Opis indeksa

```{r index-descriptions}
#| label: index-descriptions

index_desc <- data.table(
  Indeks = c("VAI", "SCI", "SAI", "UCI", "FLI", "PCI"),
  Naziv = c(
    "Volume Activity Index",
    "Sectoral Composite Index",
    "Sentiment Adjusted Index",
    "Uncertainty Index",
    "Forward Looking Index",
    "Principal Component Index"
  ),
  Opis = c(
    "Ukupan broj ekonomskih pojmova normaliziran po broju članaka",
    "Prosjek ključnih realnih sektora (industrija, građevinarstvo, trgovina, turizam)",
    "Volume indeks prilagođen za net sentiment (pozitivan/negativan ton)",
    "Mjera ekonomske neizvjesnosti u medijskom diskursu",
    "Mjera forward looking orijentacije (očekivanja, prognoze, planovi)",
    "Prva glavna komponenta svih makro kategorija"
  )
)

kable(index_desc, caption = "Pregled konstruiranih indeksa") %>%
  kable_styling(bootstrap_options = c("striped", "hover"), full_width = FALSE)
```

# Vizualizacija indeksa

## Glavni indeksi

```{r main-indices-plot}
#| label: main-indices-plot
#| fig-cap: "Glavni semantički indeksi gospodarske aktivnosti"
#| fig-height: 10

p1 <- ggplot(monthly, aes(x = yearmonth)) +
  geom_line(aes(y = VAI, color = "VAI"), linewidth = 1) +
  geom_line(aes(y = SCI, color = "SCI"), linewidth = 1) +
  scale_color_manual(values = c("VAI" = colors_gimes["accent"], "SCI" = colors_gimes["success"])) +
  scale_x_date(date_breaks = "3 months", date_labels = "%b\n%Y") +
  labs(title = "Volume Activity Index (VAI) i Sectoral Composite Index (SCI)", 
       x = NULL, y = "Indeks (0-100)", color = NULL) +
  theme(legend.position = "bottom")

p2 <- ggplot(monthly, aes(x = yearmonth)) +
  geom_ribbon(aes(ymin = 50, ymax = SAI), fill = colors_gimes["success"], alpha = 0.3) +
  geom_line(aes(y = SAI), color = colors_gimes["primary"], linewidth = 1) +
  geom_hline(yintercept = 50, linetype = "dashed", color = colors_gimes["muted"]) +
  scale_x_date(date_breaks = "3 months", date_labels = "%b\n%Y") +
  labs(title = "Sentiment Adjusted Index (SAI)", 
       subtitle = "Iznad 50 = pozitivan sentiment prevladava",
       x = NULL, y = "Indeks (0-100)")

p3 <- ggplot(monthly, aes(x = yearmonth)) +
  geom_area(aes(y = UCI), fill = colors_gimes["secondary"], alpha = 0.5) +
  geom_line(aes(y = UCI), color = colors_gimes["secondary"], linewidth = 1) +
  scale_x_date(date_breaks = "3 months", date_labels = "%b\n%Y") +
  labs(title = "Uncertainty Index (UCI)", x = NULL, y = "Indeks (0-100)")

p1 / p2 / p3
```

## Forward Looking Index (FLI) vs Uncertainty Index (UCI)

```{r fli-uci-plot}
#| label: fli-uci-plot
#| fig-cap: "Forward Looking Index vs Uncertainty Index"
#| fig-height: 6

ggplot(monthly, aes(x = yearmonth)) +
  geom_line(aes(y = FLI, color = "FLI"), linewidth = 1) +
  geom_line(aes(y = UCI, color = "UCI"), linewidth = 1) +
  scale_color_manual(values = c("FLI" = colors_gimes["success"], "UCI" = colors_gimes["secondary"])) +
  scale_x_date(date_breaks = "3 months", date_labels = "%b\n%Y") +
  labs(
    title = "Forward Looking Index (FLI) vs Uncertainty Index (UCI)",
    subtitle = "Odnos između orijentacije na budućnost i neizvjesnosti",
    x = NULL, y = "Indeks (0-100)", color = NULL
  ) +
  theme(legend.position = "bottom")
```

## Principal Component Index (PCI)

```{r pci-plot}
#| label: pci-plot
#| fig-cap: "Principal Component Index s kliznim prosjekom"
#| fig-height: 6

ggplot(monthly, aes(x = yearmonth)) +
  geom_col(aes(y = PCI), fill = colors_gimes["light"], alpha = 0.7) +
  geom_line(aes(y = PCI_MA3), color = colors_gimes["primary"], linewidth = 1.2, na.rm = TRUE) +
  scale_x_date(date_breaks = "3 months", date_labels = "%b\n%Y") +
  labs(
    title = "Principal Component Index (PCI)",
    subtitle = "Tamna linija = 3 mjesečni klizni prosjek",
    x = NULL, y = "Indeks (0-100)"
  )
```

# Sektorska analiza

## Dinamika po sektorima

```{r sector-dynamics}
#| label: sector-dynamics
#| fig-cap: "Dinamika sektora kroz vrijeme"
#| fig-height: 14

key_macro <- c("macro_bdp_agregat", "macro_industrija", "macro_gradevinarstvo",
               "macro_turizam", "macro_trgovina", "macro_investicije",
               "macro_trziste_rada", "macro_sentiment_poslovni")
key_macro <- key_macro[key_macro %in% names(monthly)]

sector_long <- melt(
  monthly[, c("yearmonth", key_macro), with = FALSE],
  id.vars = "yearmonth",
  variable.name = "sektor",
  value.name = "vrijednost"
)

sector_long[, sektor := gsub("macro_", "", sektor)]
sector_long[, vrijednost_norm := normalize_01(vrijednost) * 100, by = sektor]

ggplot(sector_long, aes(x = yearmonth, y = vrijednost_norm)) +
  geom_area(fill = colors_gimes["accent"], alpha = 0.3) +
  geom_line(color = colors_gimes["primary"], linewidth = 0.8) +
  geom_smooth(method = "loess", se = FALSE, color = colors_gimes["secondary"], linewidth = 1, span = 0.3) +
  facet_wrap(~sektor, ncol = 2, scales = "free_y") +
  scale_x_date(date_breaks = "6 months", date_labels = "%b %y") +
  labs(
    title = "Dinamika semantičkih sektora kroz vrijeme",
    subtitle = "Normalizirane vrijednosti s LOESS trendom",
    x = NULL, y = "Indeks (0-100)"
  ) +
  theme(
    strip.text = element_text(face = "bold"),
    axis.text.x = element_text(angle = 45, hjust = 1)
  )
```

## Heatmapa sektorske aktivnosti

```{r sector-heatmap}
#| label: sector-heatmap
#| fig-cap: "Heatmapa sektorske aktivnosti"
#| fig-height: 8

heatmap_data <- sector_long[, .(yearmonth, sektor, vrijednost_norm)]

ggplot(heatmap_data, aes(x = yearmonth, y = sektor, fill = vrijednost_norm)) +
  geom_tile() +
  scale_fill_viridis_c(option = "plasma") +
  scale_x_date(date_breaks = "3 months", date_labels = "%b %y") +
  labs(
    title = "Heatmapa sektorske medijske aktivnosti",
    x = NULL, y = NULL, fill = "Intenzitet\n(0-100)"
  ) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

## Korelacijska struktura

```{r correlation-matrix}
#| label: correlation-matrix
#| fig-cap: "Korelacijska matrica sektora i indeksa"
#| fig-height: 10

index_cols_final <- c("VAI", "SCI", "SAI", "UCI", "FLI", "PCI")
index_cols_final <- index_cols_final[index_cols_final %in% names(monthly)]

cor_vars <- c(macro_cols, index_cols_final)
cor_vars <- cor_vars[cor_vars %in% names(monthly)]

cor_data <- monthly[, .SD, .SDcols = cor_vars]
cor_matrix <- cor(cor_data, use = "pairwise.complete.obs")

rownames(cor_matrix) <- gsub("macro_", "", rownames(cor_matrix))
colnames(cor_matrix) <- gsub("macro_", "", colnames(cor_matrix))

corrplot(cor_matrix,
         method = "color",
         type = "upper",
         order = "hclust",
         tl.col = "black",
         tl.srt = 45,
         tl.cex = 0.7,
         addCoef.col = "black",
         number.cex = 0.5,
         col = colorRampPalette(c(colors_gimes["accent"], "white", colors_gimes["secondary"]))(100),
         title = "Korelacijska matrica sektora i indeksa",
         mar = c(0, 0, 2, 0))
```

# Sentiment analiza

## Sentiment komponente

```{r sentiment-components}
#| label: sentiment-components
#| fig-cap: "Sentiment komponente kroz vrijeme"
#| fig-height: 10

p_sent1 <- ggplot(monthly, aes(x = yearmonth)) +
  geom_col(aes(y = sent_positive_avg), fill = colors_gimes["success"], alpha = 0.7) +
  geom_col(aes(y = -sent_negative_avg), fill = colors_gimes["secondary"], alpha = 0.7) +
  geom_hline(yintercept = 0, color = "black") +
  scale_x_date(date_breaks = "3 months", date_labels = "%b\n%Y") +
  labs(title = "Pozitivni (gore) vs Negativni (dolje) sentiment po članku",
       x = NULL, y = "Prosječan broj pojmova")

p_sent2 <- ggplot(monthly, aes(x = yearmonth, y = sent_ratio_avg)) +
  geom_hline(yintercept = 0, linetype = "dashed", color = colors_gimes["muted"]) +
  geom_area(aes(fill = sent_ratio_avg > 0), alpha = 0.5) +
  geom_line(color = colors_gimes["primary"], linewidth = 1) +
  scale_fill_manual(values = c("TRUE" = colors_gimes["success"], "FALSE" = colors_gimes["secondary"]), guide = "none") +
  scale_x_date(date_breaks = "3 months", date_labels = "%b\n%Y") +
  labs(title = "Net sentiment ratio", 
       subtitle = "(pozitivno — negativno) / (pozitivno + negativno)",
       x = NULL, y = "Ratio (—1 do 1)")

p_sent3 <- ggplot(monthly, aes(x = yearmonth)) +
  geom_line(aes(y = intensity_high / N * 100, color = "Visoki intenzitet"), linewidth = 1) +
  geom_line(aes(y = intensity_low / N * 100, color = "Niski intenzitet"), linewidth = 1) +
  scale_color_manual(values = c("Visoki intenzitet" = colors_gimes["secondary"], 
                                 "Niski intenzitet" = colors_gimes["accent"])) +
  scale_x_date(date_breaks = "3 months", date_labels = "%b\n%Y") +
  labs(title = "Intenzitet jezika", x = NULL, y = "Pojmova na 100 članaka", color = NULL) +
  theme(legend.position = "bottom")

p_sent1 / p_sent2 / p_sent3
```

# Volatilnost i momentum

## Konstrukcija volatilnosti i momentuma

Volatilnost se računa kao rolling standardna devijacija s prozorom od tri mjeseca uzimajući vrijednosti tekućeg i dva prethodna mjeseca. Momentum se definira kao razlika između tekuće vrijednosti i vrijednosti s vremenskim pomakom, gdje mjesečni momentum koristi lag 1 a tromjesečni momentum lag 3. Kombinacija volatilnosti i momentuma omogućuje karakterizaciju četiri režima: stabilno mirovanje (nizak momentum i niska volatilnost), stabilan trend (visok momentum i niska volatilnost), turbulentna stagnacija (nizak momentum i visoka volatilnost), te turbulentna tranzicija (visok momentum i visoka volatilnost).

::: {.callout-note collapse="true"}
## Detaljna metodologija volatilnosti i momentuma

**Volatilnost (Rolling Standard Deviation):**

$$\sigma_t = \sqrt{\frac{1}{w-1} \sum_{j=0}^{w-1} (X_{t-j} - \bar{X}_{t,w})^2}$$

gdje $\bar{X}_{t,w} = \frac{1}{w} \sum_{j=0}^{w-1} X_{t-j}$

**Momentum (Rate of Change):**

Mjesečni: $Mom_{t,1} = X_t - X_{t-1}$

Tromjesečni: $Mom_{t,3} = X_t - X_{t-3}$

:::

```{r volatility-momentum}
#| label: volatility-momentum
#| fig-cap: "Volatilnost i momentum indeksa"
#| fig-height: 12

monthly[, VAI_vol := frollapply(VAI, n = 3, FUN = sd, align = "right")]
monthly[, SCI_vol := frollapply(SCI, n = 3, FUN = sd, align = "right")]

monthly[, VAI_mom := VAI - shift(VAI, 1)]
monthly[, SCI_mom := SCI - shift(SCI, 1)]

monthly[, VAI_mom3 := VAI - shift(VAI, 3)]

p_vol <- ggplot(monthly[!is.na(VAI_vol)], aes(x = yearmonth)) +
  geom_area(aes(y = VAI_vol), fill = colors_gimes["accent"], alpha = 0.5) +
  geom_line(aes(y = VAI_vol), color = colors_gimes["primary"], linewidth = 1) +
  scale_x_date(date_breaks = "3 months", date_labels = "%b\n%Y") +
  labs(title = "VAI volatilnost (3M rolling SD)", x = NULL, y = "Standardna devijacija")

p_mom <- ggplot(monthly[!is.na(VAI_mom)], aes(x = yearmonth)) +
  geom_hline(yintercept = 0, linetype = "dashed", color = colors_gimes["muted"]) +
  geom_col(aes(y = VAI_mom, fill = VAI_mom > 0), alpha = 0.7) +
  scale_fill_manual(values = c("TRUE" = colors_gimes["success"], "FALSE" = colors_gimes["secondary"]), guide = "none") +
  scale_x_date(date_breaks = "3 months", date_labels = "%b\n%Y") +
  labs(title = "VAI momentum (M/M promjena)", x = NULL, y = "Promjena")

p_mom3 <- ggplot(monthly[!is.na(VAI_mom3)], aes(x = yearmonth)) +
  geom_hline(yintercept = 0, linetype = "dashed", color = colors_gimes["muted"]) +
  geom_area(aes(y = VAI_mom3, fill = VAI_mom3 > 0), alpha = 0.5) +
  geom_line(aes(y = VAI_mom3), color = colors_gimes["primary"], linewidth = 1) +
  scale_fill_manual(values = c("TRUE" = colors_gimes["success"], "FALSE" = colors_gimes["secondary"]), guide = "none") +
  scale_x_date(date_breaks = "3 months", date_labels = "%b\n%Y") +
  labs(title = "VAI 3 mjesečni momentum", x = NULL, y = "Promjena")

p_combined <- ggplot(monthly, aes(x = yearmonth)) +
  geom_line(aes(y = scale(VAI)[,1], color = "VAI (std)"), linewidth = 1) +
  geom_line(aes(y = scale(UCI)[,1], color = "UCI (std)"), linewidth = 1) +
  geom_line(aes(y = scale(FLI)[,1], color = "FLI (std)"), linewidth = 1) +
  scale_color_manual(values = c("VAI (std)" = colors_gimes["accent"], 
                                 "UCI (std)" = colors_gimes["secondary"], 
                                 "FLI (std)" = colors_gimes["success"])) +
  scale_x_date(date_breaks = "3 months", date_labels = "%b\n%Y") +
  labs(title = "Standardizirani indeksi (VAI, UCI, FLI)", x = NULL, y = "Z score", color = NULL) +
  theme(legend.position = "bottom")

p_vol / p_mom / p_mom3 / p_combined
```

# Koncentracija tema

## Konstrukcija mjera koncentracije

Herfindahl Hirschman indeks (HHI) računa se kao suma kvadrata udjela svake makro kategorije u ukupnom broju detektiranih pojmova. Udjeli se dobivaju dijeljenjem broja pojmova pojedine kategorije s ukupnim brojem pojmova svih kategorija u danom mjesecu. HHI vrijednosti bliže jedinici indiciraju visoku koncentraciju na manji broj tema dok vrijednosti bliže nuli sugeriraju disperziranu distribuciju. Za 12 makro kategorija minimalni HHI iznosi približno 0.083 što odgovara savršeno jednakoj distribuciji.

::: {.callout-note collapse="true"}
## Detaljna metodologija koncentracije tema

**Herfindahl Hirschman Index (HHI):**

$$HHI_t = \sum_{k=1}^{K} s_{k,t}^2$$

gdje $s_{k,t} = \frac{n_{k,t}}{\sum_{j=1}^{K} n_{j,t}}$

**Interpretacija:**

HHI > 0.25: Visoka koncentracija, dominacija malog broja tema

HHI 0.15 — 0.25: Umjerena koncentracija

HHI < 0.15: Niska koncentracija, diverzificirano pokrivanje

:::

```{r topic-concentration}
#| label: topic-concentration
#| fig-cap: "Koncentracija tema"
#| fig-height: 8

calc_hhi <- function(values) {
  values <- values[values > 0]
  if (length(values) == 0) return(0)
  shares <- values / sum(values)
  sum(shares^2)
}

monthly[, topic_hhi := apply(.SD, 1, calc_hhi), .SDcols = macro_cols]
monthly[, topic_count := rowSums(.SD > 0), .SDcols = macro_cols]

p_hhi <- ggplot(monthly, aes(x = yearmonth, y = topic_hhi)) +
  geom_line(color = colors_gimes["primary"], linewidth = 1) +
  geom_smooth(method = "loess", se = TRUE, color = colors_gimes["secondary"], span = 0.3) +
  scale_x_date(date_breaks = "3 months", date_labels = "%b\n%Y") +
  labs(
    title = "Herfindahl Hirschman Index (HHI) koncentracije tema",
    subtitle = "Viši = fokusiranije na manje tema | Niži = disperziranije",
    x = NULL, y = "HHI"
  )

p_count <- ggplot(monthly, aes(x = yearmonth, y = topic_count)) +
  geom_col(fill = colors_gimes["accent"], alpha = 0.7) +
  scale_x_date(date_breaks = "3 months", date_labels = "%b\n%Y") +
  labs(title = "Broj aktivnih tema po mjesecu", x = NULL, y = "Broj tema s pojavljivanjem")

p_hhi / p_count
```

# Korelacije između indeksa

```{r index-correlations}
#| label: index-correlations

index_only_cor <- cor(monthly[, .SD, .SDcols = index_cols_final], use = "pairwise.complete.obs")

kable(round(index_only_cor, 3), caption = "Korelacijska matrica indeksa") %>%
  kable_styling(bootstrap_options = c("striped", "hover"), full_width = FALSE)
```

# Export

```{r export-excel}
#| label: export-excel

wb <- createWorkbook()

addWorksheet(wb, "Indeksi")
export_indices <- monthly[, .(
  Datum = yearmonth,
  Broj_clanaka = N,
  VAI, SCI, SAI, UCI, FLI, PCI,
  VAI_MA3, SCI_MA3
)]
writeData(wb, "Indeksi", export_indices)

addWorksheet(wb, "Semanticke_kategorije")
export_sectors <- monthly[, c("yearmonth", macro_cols), with = FALSE]
names(export_sectors) <- c("Datum", gsub("macro_", "", macro_cols))
writeData(wb, "Semanticke_kategorije", export_sectors)

addWorksheet(wb, "Dinamike")
export_sentiment <- monthly[, .(
  Datum = yearmonth,
  Pozitivan = sent_positive,
  Negativan = sent_negative,
  Net = sent_net,
  Ratio = sent_ratio_avg,
  Neizvjesnost = uncertainty,
  Forward_looking = forward_looking,
  Intenzitet_visoki = intensity_high,
  Intenzitet_niski = intensity_low
)]
writeData(wb, "Dinamike", export_sentiment)

addWorksheet(wb, "Korelacije")
export_vol <- monthly[, .(
  Datum = yearmonth,
  VAI_volatilnost = VAI_vol,
  VAI_momentum = VAI_mom,
  VAI_momentum_3M = VAI_mom3,
  Topic_HHI = topic_hhi
)]
writeData(wb, "Korelacije", export_vol)

header_style <- createStyle(
  textDecoration = "bold",
  fgFill = "#2C3E50",
  fontColour = "white",
  halign = "center"
)

for (sheet in names(wb)) {
  sheet_data <- switch(sheet,
    "Indeksi" = export_indices,
    "Semanticke_kategorije" = export_sectors,
    "Dinamike" = export_sentiment,
    "Korelacije" = export_vol
  )
  ncols <- ncol(sheet_data)
  addStyle(wb, sheet, header_style, rows = 1, cols = 1:ncols, gridExpand = TRUE)
  setColWidths(wb, sheet, cols = 1:ncols, widths = "auto")
}

output_path <- here("output", "gimes_activity_indices.xlsx")
dir.create(here("output"), showWarnings = FALSE, recursive = TRUE)
saveWorkbook(wb, output_path, overwrite = TRUE)

message("Excel datoteka spremljena: ", output_path)
```

# Sažetak

```{r summary}
#| label: summary

summary_table <- data.table(
  Metrika = c(
    "Broj analiziranih članaka",
    "Vremenski raspon",
    "Broj semantičkih kategorija",
    "Broj makro sektora",
    "Broj konstruiranih indeksa",
    "Prosječni VAI",
    "Prosječni sentiment ratio",
    "Prosječni UCI"
  ),
  Vrijednost = c(
    format(nrow(dt), big.mark = ","),
    paste(format(date_min, "%m/%Y"), "—", format(date_max, "%m/%Y")),
    length(sem_cols),
    length(macro_cols),
    length(index_cols_final),
    round(mean(monthly$VAI, na.rm = TRUE), 1),
    round(mean(monthly$sent_ratio_avg, na.rm = TRUE), 3),
    round(mean(monthly$UCI, na.rm = TRUE), 1)
  )
)

kable(summary_table, caption = "Sažetak analize") %>%
  kable_styling(bootstrap_options = c("striped", "hover"), full_width = FALSE)
```

---

*Izvještaj generiran: `r Sys.time()`*

*GIMES Research | Semantički indeks gospodarske aktivnosti v2.0*
