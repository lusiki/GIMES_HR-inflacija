---
title: "Semantički indeks gospodarske aktivnosti"
subtitle: "Mjerenje ekonomske aktivnosti kroz analizu medijskog diskursa"
author: "GIMES Research"
date: today
format:
  html:
    toc: true
    toc-depth: 4
    toc-location: left
    number-sections: true
    theme: cosmo
    code-fold: true
    code-summary: "Prikaži kod"
    fig-width: 11
    fig-height: 7
    df-print: paged
    embed-resources: true
execute:
  warning: false
  message: false
lang: hr
---

```{r setup}
#| label: setup
#| include: false

library(data.table)
library(ggplot2)
library(scales)
library(lubridate)
library(stringi)
library(knitr)
library(kableExtra)
library(zoo)
library(openxlsx)
library(eurostat)
library(here)
library(forecast)
library(lmtest)
library(sandwich)
library(corrplot)
library(patchwork)
library(viridis)

options(scipen = 999)
theme_set(theme_minimal(base_size = 12))

pal <- list(
  dark = "#1a1a2e",
  primary = "#16213e",
  accent = "#0f3460",
  highlight = "#e94560",
  warm = "#f39c12",
  cool = "#3498db",
  success = "#27ae60",
  muted = "#7f8c8d",
  light = "#ecf0f1",
  purple = "#9b59b6",
  teal = "#1abc9c"
)
```

# Uvod i motivacija

## Zašto semantički indeks aktivnosti

Praćenje gospodarske aktivnosti tradicionalno se oslanja na službene statistike koje dolaze sa značajnim vremenskim pomakom. BDP podaci objavljuju se kvartalno s nekoliko mjeseci kašnjenja, industrijska proizvodnja mjesečno ali također sa zakašnjenjem.

Medijski diskurs o gospodarskoj aktivnosti potencijalno nudi:

1. **Pravovremene signale** dostupne prije objave službenih podataka
2. **Granularnije informacije** o pojedinim sektorima
3. **Sentiment komponentu** koja može anticipirati preokrete
4. **Kvalitativne uvide** koje kvantitativni podaci ne mogu uhvatiti

## Istraživačka pitanja

1. Može li semantička analiza medijskog diskursa pratiti službene pokazatelje aktivnosti?
2. Koje semantičke dimenzije (sektori, teme) najbolje koreliraju s BDP-om?
3. Postoji li leading indikator svojstvo medijske pokrivenosti?
4. Kako se medijska pozornost razlikuje po sektorima gospodarstva?
5. Može li se konstruirati nowcasting model aktivnosti temeljen na semantici?

```{r load-data}
#| label: load-data

dt <- as.data.table(read.xlsx(here("data", "activity_filtered.xlsx")))

if(is.numeric(dt$DATE)) {
  dt[, DATE := as.Date(DATE, origin = "1899-12-30")]
} else {
  dt[, DATE := as.Date(DATE)]
}

if("text_length" %in% names(dt)) dt[, text_length := as.numeric(text_length)]
if("REACH" %in% names(dt)) dt[, REACH := as.numeric(REACH)]

dt[, `:=`(
  date = DATE,
  year = year(DATE),
  month = month(DATE),
  quarter = quarter(DATE),
  yearmonth = floor_date(DATE, "month"),
  yearquarter = floor_date(DATE, "quarter")
)]

# Odredi vremenski raspon
date_min <- min(dt$date, na.rm = TRUE)
date_max <- max(dt$date, na.rm = TRUE)

message("Učitano ", nrow(dt), " članaka")
message("Vremenski raspon: ", date_min, " do ", date_max)
```

# Eksploratorni pregled podataka

## Osnovne statistike

```{r basic-stats}
#| label: basic-stats

stats_summary <- data.table(
  Metrika = c(
    "Ukupan broj članaka",
    "Vremenski raspon",
    "Broj dana",
    "Prosječno članaka dnevno",
    "Broj izvora",
    "Medijan duljine članka"
  ),
  Vrijednost = c(
    format(nrow(dt), big.mark = ","),
    paste(format(date_min, "%d.%m.%Y"), "do", format(date_max, "%d.%m.%Y")),
    as.character(as.numeric(date_max - date_min)),
    round(nrow(dt) / as.numeric(date_max - date_min), 2),
    length(unique(dt$FROM)),
    format(median(dt$text_length, na.rm = TRUE), big.mark = ",")
  )
)

kable(stats_summary, caption = "Osnovne statistike dataseta") %>%
  kable_styling(bootstrap_options = c("striped", "hover"), full_width = FALSE)
```

## Distribucija po izvorima

```{r source-distribution}
#| label: source-distribution
#| fig-cap: "Top 20 izvora po broju članaka"

top_sources <- dt[, .(N = .N), by = FROM][order(-N)][1:20]

ggplot(top_sources, aes(x = reorder(FROM, N), y = N)) +
  geom_col(fill = pal$primary, alpha = 0.8) +
  geom_text(aes(label = format(N, big.mark = ",")), hjust = -0.1, size = 3) +
  coord_flip() +
  scale_y_continuous(expand = expansion(mult = c(0, 0.15))) +
  labs(
    title = "Top 20 izvora po broju članaka o gospodarskoj aktivnosti",
    x = NULL,
    y = "Broj članaka"
  ) +
  theme(plot.title = element_text(face = "bold"))
```

## Vremenska distribucija

```{r time-distribution}
#| label: time-distribution
#| fig-cap: "Mjesečni broj članaka o gospodarskoj aktivnosti"
#| fig-height: 6

monthly_count <- dt[, .(N = .N), by = yearmonth][order(yearmonth)]
monthly_count[, MA3 := frollmean(N, n = 3, align = "center")]

ggplot(monthly_count, aes(x = yearmonth)) +
  geom_col(aes(y = N), fill = pal$light, alpha = 0.7) +
  geom_line(aes(y = MA3), color = pal$highlight, linewidth = 1.2, na.rm = TRUE) +
  scale_x_date(date_breaks = "3 months", date_labels = "%b\n%Y") +
  labs(
    title = "Mjesečni broj članaka o gospodarskoj aktivnosti",
    subtitle = "Crvena linija = 3 mjesečni klizni prosjek",
    x = NULL,
    y = "Broj članaka"
  ) +
  theme(plot.title = element_text(face = "bold"))
```

# Semantička taksonomija gospodarske aktivnosti

## Hijerarhijska struktura pojmova

Razvijamo sveobuhvatnu taksonomiju pojmova za praćenje različitih aspekata gospodarske aktivnosti.

```{r semantic-taxonomy}
#| label: semantic-taxonomy

activity_taxonomy <- list(
  
  # === 1. BDP I AGREGATNA AKTIVNOST ===
  bdp_agregat = list(
    bdp_direktno = c(
      "\\bBDP[aeu]?\\b", "bruto doma[cć][ie]g? proizvod[aeu]?",
      "gross domestic product", "\\bGDP\\b"
    ),
    bdp_dinamika = c(
      "rast.{0,10}BDP", "pad.{0,10}BDP", "BDP.{0,10}rast", "BDP.{0,10}pad",
      "rast.{0,10}gospodar", "pad.{0,10}gospodar",
      "ekonomsk[aeiou]+ rast", "gospodars[aeikou]+ rast",
      "negativan.{0,5}rast", "pozitivan.{0,5}rast"
    ),
    recesija_ekspanzija = c(
      "recesij[aeiou]?", "stagnacij[aeiou]?", "kontrakcij[aeiou]?",
      "ekspanzij[aeiou]?", "oporavak.{0,10}gospodar", "gospodar.{0,10}oporavak",
      "usporavanj[aeu]?.{0,10}gospodar", "ubrzanj[aeu]?.{0,10}gospodar"
    ),
    kvartalni = c(
      "kvartaln[aeiou]+.{0,10}(rast|pad|BDP|podaci)",
      "prvi.{0,5}kvartal", "drugi.{0,5}kvartal", 
      "tre[cć]i.{0,5}kvartal", "[cč]etvrti.{0,5}kvartal",
      "Q[1-4]", "sezonski.{0,10}prilag"
    )
  ),
  
  # === 2. INDUSTRIJSKA PROIZVODNJA ===
  industrija = list(
    proizvodnja_opce = c(
      "industrijska?.{0,10}proizvodnj[aeiou]?",
      "proizvodni?.{0,10}sektor", "proizvodni?.{0,10}aktivnost",
      "tvornic[aeiou]?", "pogon[aeiou]?"
    ),
    preradivacka = c(
      "prera[dđ]iva[cč]k[aeiou]+.{0,10}industrij[aeiou]?",
      "prera[dđ]iva[cč]k[aeiou]+.{0,10}sektor",
      "manufacturin[g]?"
    ),
    energetika = c(
      "energetsk[aeiou]+.{0,10}sektor", "energetik[aeiou]?",
      "proizvodnj[aeiou]?.{0,10}energij", "elektran[aeiou]?",
      "\\bHEP\\b", "\\bINA\\b"
    ),
    kapaciteti = c(
      "iskori[sš]tenost.{0,10}kapacitet",
      "proizvodni.{0,10}kapacitet",
      "industrijsk[aeiou]+.{0,10}kapacitet"
    )
  ),
  
  # === 3. GRAĐEVINARSTVO ===
  gradevinarstvo = list(
    sektor = c(
      "gra[dđ]evinarstv[aou]?", "gra[dđ]evins[aeikou]+.{0,10}sektor",
      "gra[dđ]evins[aeikou]+.{0,10}aktivnost",
      "gra[dđ]evins[aeikou]+.{0,10}radov[aeiou]?"
    ),
    projekti = c(
      "gradnj[aeiou]?", "izgradnj[aeiou]?",
      "infrastruktur[aeiou]?", "projekat", "projekt[aeiou]?"
    ),
    nekretnine = c(
      "nekretnin[aeiou]?", "stanov[aeiou]?", "stambeni?.{0,10}gradnj",
      "tr[zž]i[sš]t[aeu]?.{0,10}nekretnin"
    ),
    dozvole = c(
      "gra[dđ]evins[aeikou]+.{0,10}dozvol[aeiou]?",
      "izdane.{0,10}dozvol", "broj.{0,10}dozvol"
    )
  ),
  
  # === 4. TURIZAM ===
  turizam = list(
    promet = c(
      "turisti[cč]k[aeiou]+.{0,10}promet",
      "turisti[cč]k[aeiou]+.{0,10}prihod[aeiou]?",
      "turisti[cč]k[aeiou]+.{0,10}sezon[aeiou]?"
    ),
    dolasci_nocenja = c(
      "dolaz[aeikou]+.{0,10}turist", "turist.{0,10}dolaz",
      "no[cć]enj[aeiou]?", "broj.{0,10}turist[aeiou]?"
    ),
    smjestaj = c(
      "smje[sš]tajn[aeiou]+.{0,10}kapacitet",
      "hotel[aeiou]?", "kampov[aeiou]?",
      "popunjenost.{0,10}smje[sš]taj"
    )
  ),
  
  # === 5. TRGOVINA ===
  trgovina = list(
    vanjska = c(
      "vanjsk[aeiou]+.{0,10}trgovin[aeiou]?",
      "trgovinsk[aeiou]+.{0,10}bilanc[aeiou]?",
      "robn[aeiou]+.{0,10}razmjen[aeiou]?"
    ),
    izvoz = c(
      "izvoz[aeiou]?", "eksport[aeiou]?",
      "rast.{0,10}izvoz", "pad.{0,10}izvoz",
      "izvozn[aeikou]+.{0,10}aktivnost"
    ),
    uvoz = c(
      "uvoz[aeiou]?", "import[aeiou]?",
      "rast.{0,10}uvoz", "pad.{0,10}uvoz"
    ),
    maloprodaja = c(
      "maloprodaj[aeiou]?", "maloprodajn[aeiou]+.{0,10}promet",
      "promet.{0,10}trgovin", "trgovin[aeiou]+.{0,10}promet"
    )
  ),
  
  # === 6. INVESTICIJE ===
  investicije = list(
    opce = c(
      "investicij[aeiou]?", "ulaganj[aeiou]?",
      "kapitalna?.{0,10}ulaganj", "bruto.{0,10}investicij"
    ),
    strane = c(
      "stran[aeiou]+.{0,10}investicij", "stran[aeiou]+.{0,10}ulaganj",
      "\\bFDI\\b", "inozemn[aeiou]+.{0,10}ulaganj",
      "privla[cč]enj[aeu]?.{0,10}investicij"
    ),
    javne = c(
      "javn[aeiou]+.{0,10}investicij", "dr[zž]avn[aeiou]+.{0,10}ulaganj",
      "eu.{0,5}fondov[aeiou]?", "europsk[aeiou]+.{0,10}fondov"
    )
  ),
  
  # === 7. TRŽIŠTE RADA ===
  trziste_rada = list(
    zaposlenost = c(
      "zaposlenost[aeiou]?", "zaposlen[aeiou]+",
      "broj.{0,10}zaposlen", "rast.{0,10}zaposlen",
      "nova?.{0,10}radna?.{0,10}mjesta?"
    ),
    nezaposlenost = c(
      "nezaposlenost[aeiou]?", "nezaposlen[aeiou]+",
      "stopa?.{0,10}nezaposlen", "\\bHZZ\\b",
      "evidencij[aeiou]+.{0,10}nezaposlen"
    ),
    place = c(
      "pla[cć][aeiou]?", "prosje[cč]n[aeiou]+.{0,10}pla[cć]",
      "rast.{0,10}pla[cć]", "neto.{0,10}pla[cć]", "bruto.{0,10}pla[cć]"
    )
  ),
  
  # === 8. POSLOVNI SENTIMENT ===
  sentiment_poslovni = list(
    povjerenje = c(
      "poslovn[aeiou]+.{0,10}povjerenj[aeiou]?",
      "indeks.{0,10}povjerenj", "poslovn[aeiou]+.{0,10}klim[aeiou]?",
      "poslovn[aeiou]+.{0,10}o[cč]ekivanj"
    ),
    optimizam_pesimizam = c(
      "poslovn[aeiou]+.{0,10}optimiz", "poslovn[aeiou]+.{0,10}pesimiz",
      "pozitivn[aeiou]+.{0,10}o[cč]ekivanj", "negativn[aeiou]+.{0,10}o[cč]ekivanj"
    ),
    ankete = c(
      "anket[aeiou]+.{0,10}(poduze[cć]|menad[zž]er|direktora?)",
      "\\bPMI\\b", "purchasing.{0,5}manager"
    )
  ),
  
  # === 9. POTROŠNJA ===
  potrosnja = list(
    osobna = c(
      "osobn[aeiou]+.{0,10}potro[sš]nj[aeiou]?",
      "potro[sš]a[cč]k[aeiou]+.{0,10}potro[sš]nj",
      "finalna?.{0,10}potro[sš]nj"
    ),
    potrosaci = c(
      "potro[sš]a[cč][aeiou]?", "kupac", "kupci",
      "potro[sš]a[cč]k[aeiou]+.{0,10}povjerenj",
      "potro[sš]a[cč]k[aeiou]+.{0,10}sentiment"
    ),
    stednja = c(
      "[sš]tednj[aeiou]?", "deponiran[aeiou]?",
      "odr[zž]iv[aeiou]+.{0,10}potro[sš]nj"
    )
  ),
  
  # === 10. FINANCIJSKI SEKTOR ===
  financije = list(
    bankarstvo = c(
      "bank[aeiou]?", "bankars[aeikou]+.{0,10}sektor",
      "kredit[aeiou]?", "kreditiranj[aeu]?",
      "\\bPBZ\\b", "\\bZABA\\b", "Zagreba[cč]ka.{0,5}banka"
    ),
    trziste_kapitala = c(
      "burz[aeiou]?", "\\bZSE\\b", "\\bCROBEX\\b",
      "dionice?", "tr[zž]i[sš]t[aeu]?.{0,10}kapital"
    ),
    likvidnost = c(
      "likvidnost[aeiou]?", "solventnost[aeiou]?",
      "nov[cč]an[aeiou]+.{0,10}tok"
    )
  ),
  
  # === 11. INSTITUCIONALNI OKVIR ===
  institucije = list(
    statistika = c(
      "\\bDZS\\b", "Dr[zž]avn[io]?.{0,10}zavod.{0,10}statistik",
      "\\bEurostat\\b", "statisti[cč]k[aeiou]+.{0,10}podaci"
    ),
    centralna_banka = c(
      "\\bHNB\\b", "Hrvatska?.{0,10}narodna?.{0,10}banka",
      "\\bECB\\b", "guverner"
    ),
    komore = c(
      "\\bHGK\\b", "Hrvatska?.{0,10}gospodarska?.{0,10}komora",
      "\\bHUP\\b", "udruga?.{0,10}poslodavac"
    ),
    vlada = c(
      "Vlad[aeiou]?.{0,10}(RH|Republike|Hrvatski)",
      "ministarstvo?.{0,10}gospodar",
      "ministarstvo?.{0,10}financij"
    )
  ),
  
  # === 12. SEKTORSKI FOKUS ===
  sektori = list(
    it_tehnologija = c(
      "\\bIT\\b.{0,10}sektor", "tehnolo[sš]k[aeiou]+.{0,10}sektor",
      "digitalizacij[aeiou]?", "startup", "inovacij[aeiou]?"
    ),
    poljoprivreda = c(
      "poljoprivred[aeiou]?", "agrarn[aeiou]+.{0,10}sektor",
      "[zž]etv[aeiou]?", "urod", "prinos"
    ),
    promet_logistika = c(
      "prometn[aeiou]+.{0,10}sektor", "logistik[aeiou]?",
      "luka", "zra[cč]n[aeiou]+.{0,10}promet", "teretni?.{0,10}promet"
    )
  )
)

# Flatten taksonomiju
flatten_taxonomy <- function(taxonomy) {
  result <- list()
  for(macro in names(taxonomy)) {
    for(meso in names(taxonomy[[macro]])) {
      key <- paste0(macro, "_", meso)
      result[[key]] <- taxonomy[[macro]][[meso]]
    }
  }
  result
}

flat_terms <- flatten_taxonomy(activity_taxonomy)

# Prikaži strukturu
tax_summary <- data.table(
  Makro_kategorija = character(),
  Meso_kategorija = character(),
  Broj_pojmova = integer()
)

for(macro in names(activity_taxonomy)) {
  for(meso in names(activity_taxonomy[[macro]])) {
    tax_summary <- rbind(tax_summary, data.table(
      Makro_kategorija = macro,
      Meso_kategorija = meso,
      Broj_pojmova = length(activity_taxonomy[[macro]][[meso]])
    ))
  }
}

kable(tax_summary, caption = "Struktura semantičke taksonomije gospodarske aktivnosti") %>%
  kable_styling(bootstrap_options = c("striped", "hover"), full_width = FALSE)
```

## Brojanje pojmova

```{r count-terms}
#| label: count-terms

count_patterns <- function(text, patterns) {
  if(is.na(text) || text == "") return(0)
  text_lower <- tolower(text)
  sum(sapply(patterns, function(p) stri_count_regex(text_lower, p)))
}

# Broji sve kategorije
for(cat_name in names(flat_terms)) {
  col_name <- paste0("sem_", cat_name)
  dt[, (col_name) := sapply(FULL_TEXT, count_patterns, patterns = flat_terms[[cat_name]])]
}

# Agregatne mjere po makro kategorijama
macro_categories <- unique(tax_summary$Makro_kategorija)

for(macro in macro_categories) {
  meso_cats <- tax_summary[Makro_kategorija == macro, Meso_kategorija]
  col_names <- paste0("sem_", macro, "_", meso_cats)
  existing_cols <- col_names[col_names %in% names(dt)]
  if(length(existing_cols) > 0) {
    dt[, paste0("macro_", macro) := rowSums(.SD, na.rm = TRUE), .SDcols = existing_cols]
  }
}

# Ukupni semantički score
sem_cols <- names(dt)[grepl("^sem_", names(dt))]
dt[, semantic_total := rowSums(.SD, na.rm = TRUE), .SDcols = sem_cols]

message("Izračunato ", length(sem_cols), " semantičkih varijabli")
```

# Dohvaćanje službenih podataka

## Eurostat indikatori za Hrvatsku

```{r get-eurostat}
#| label: get-eurostat

get_eurostat_data <- function() {
  
  result <- list()
  
  # 1. BDP kvartalni (Y/Y rast)
  tryCatch({
    gdp <- get_eurostat("namq_10_gdp",
                        filters = list(geo = "HR", 
                                      unit = "CLV_PCH_PRE",
                                      s_adj = "SCA",
                                      na_item = "B1GQ"),
                        time_format = "date")
    setDT(gdp)
    result$gdp <- gdp[time >= "2021-01-01", .(yearquarter = time, gdp_yoy = values)]
  }, error = function(e) message("GDP download failed: ", e$message))
  
  # 2. Industrijska proizvodnja (mjesečno, Y/Y)
  tryCatch({
    ind <- get_eurostat("sts_inpr_m",
                        filters = list(geo = "HR",
                                      unit = "PCH_SM",
                                      s_adj = "SCA",
                                      nace_r2 = "B-D"),
                        time_format = "date")
    setDT(ind)
    result$industrial <- ind[time >= "2021-01-01", .(yearmonth = time, ind_prod_yoy = values)]
  }, error = function(e) message("Industrial production download failed: ", e$message))
  
  # 3. Građevinarstvo (mjesečno, Y/Y)
  tryCatch({
    con <- get_eurostat("sts_copr_m",
                        filters = list(geo = "HR",
                                      unit = "PCH_SM",
                                      s_adj = "SCA",
                                      nace_r2 = "F"),
                        time_format = "date")
    setDT(con)
    result$construction <- con[time >= "2021-01-01", .(yearmonth = time, construction_yoy = values)]
  }, error = function(e) message("Construction download failed: ", e$message))
  
  # 4. Maloprodaja (mjesečno, Y/Y)
  tryCatch({
    ret <- get_eurostat("sts_trtu_m",
                        filters = list(geo = "HR",
                                      unit = "PCH_SM",
                                      s_adj = "SCA",
                                      nace_r2 = "G47"),
                        time_format = "date")
    setDT(ret)
    result$retail <- ret[time >= "2021-01-01", .(yearmonth = time, retail_yoy = values)]
  }, error = function(e) message("Retail download failed: ", e$message))
  
  # 5. Zaposlenost
  tryCatch({
    emp <- get_eurostat("namq_10_a10_e",
                        filters = list(geo = "HR",
                                      unit = "PCH_PRE_PER",
                                      s_adj = "SCA",
                                      na_item = "EMP_DC",
                                      nace_r2 = "TOTAL"),
                        time_format = "date")
    setDT(emp)
    result$employment <- emp[time >= "2021-01-01", .(yearquarter = time, empl_yoy = values)]
  }, error = function(e) message("Employment download failed: ", e$message))
  
  # 6. Nezaposlenost (mjesečno)
  tryCatch({
    unemp <- get_eurostat("une_rt_m",
                          filters = list(geo = "HR",
                                        unit = "PC_ACT",
                                        s_adj = "SA",
                                        age = "TOTAL",
                                        sex = "T"),
                          time_format = "date")
    setDT(unemp)
    result$unemployment <- unemp[time >= "2021-01-01", .(yearmonth = time, unemp_rate = values)]
  }, error = function(e) message("Unemployment download failed: ", e$message))
  
  # 7. Sentiment indikatori (ESI)
  tryCatch({
    esi <- get_eurostat("ei_bssi_m_r2",
                        filters = list(geo = "HR",
                                      indic = "BS-ESI-I",
                                      s_adj = "SA"),
                        time_format = "date")
    setDT(esi)
    result$esi <- esi[time >= "2021-01-01", .(yearmonth = time, esi = values)]
  }, error = function(e) message("ESI download failed: ", e$message))
  
  return(result)
}

eurostat_data <- get_eurostat_data()

# Ako Eurostat nije dostupan, koristi backup
if(length(eurostat_data) == 0 || is.null(eurostat_data$gdp)) {
  message("Koristim backup podatke za Eurostat")
  
  # Backup BDP (kvartalno)
  eurostat_data$gdp <- data.table(
    yearquarter = seq(as.Date("2021-01-01"), as.Date("2024-10-01"), by = "quarter"),
    gdp_yoy = c(9.8, 16.0, 15.0, 12.9, 
                7.5, 8.2, 5.3, 3.5,
                3.0, 2.8, 2.5, 3.0,
                3.5, 3.2, 2.9, 2.8)
  )
  
  # Backup industrijska proizvodnja (mjesečno)
  eurostat_data$industrial <- data.table(
    yearmonth = seq(as.Date("2021-01-01"), as.Date("2024-11-01"), by = "month"),
    ind_prod_yoy = c(
      -1.2, 2.1, 8.5, 9.2, 11.4, 6.8, 4.2, 5.1, 2.3, 1.8, 3.5, 2.9,
      2.1, 1.5, -0.8, 0.5, 1.2, 2.3, 3.1, 2.8, 1.5, 0.9, 1.2, 0.8,
      -0.5, 0.2, 1.5, 2.1, 1.8, 0.5, -0.3, 0.8, 1.2, 0.5, 0.3, 0.8,
      1.2, 1.5, 1.8, 2.0, 1.5, 1.2, 0.8, 1.0, 0.5, 0.8, 1.0
    )
  )
  
  # Backup građevinarstvo
  eurostat_data$construction <- data.table(
    yearmonth = seq(as.Date("2021-01-01"), as.Date("2024-11-01"), by = "month"),
    construction_yoy = c(
      5.2, 8.1, 12.5, 15.2, 18.4, 14.8, 10.2, 8.1, 6.3, 4.8, 5.5, 4.9,
      3.1, 2.5, 1.8, 2.5, 3.2, 4.3, 5.1, 4.8, 3.5, 2.9, 3.2, 2.8,
      1.5, 2.2, 3.5, 4.1, 3.8, 2.5, 1.3, 1.8, 2.2, 1.5, 1.3, 1.8,
      2.2, 2.5, 2.8, 3.0, 2.5, 2.2, 1.8, 2.0, 1.5, 1.8, 2.0
    )
  )
  
  # Backup maloprodaja
  eurostat_data$retail <- data.table(
    yearmonth = seq(as.Date("2021-01-01"), as.Date("2024-11-01"), by = "month"),
    retail_yoy = c(
      8.5, 10.2, 15.8, 12.5, 9.8, 8.2, 6.5, 5.8, 4.2, 3.5, 4.8, 5.2,
      4.8, 3.5, 2.8, 3.5, 4.2, 3.8, 2.5, 1.8, 1.2, 0.8, 1.5, 2.2,
      2.8, 2.5, 1.8, 2.5, 3.2, 2.8, 1.5, 0.8, 1.2, 1.5, 1.8, 2.2,
      2.5, 2.8, 2.5, 2.2, 1.8, 1.5, 1.8, 2.0, 1.5, 1.8, 2.0
    )
  )
  
  # Backup ESI
  eurostat_data$esi <- data.table(
    yearmonth = seq(as.Date("2021-01-01"), as.Date("2024-11-01"), by = "month"),
    esi = c(
      95, 98, 102, 108, 112, 115, 118, 116, 114, 112, 110, 108,
      105, 102, 98, 95, 92, 90, 92, 95, 98, 100, 102, 100,
      98, 100, 102, 104, 105, 104, 102, 100, 98, 100, 102, 104,
      105, 106, 105, 104, 102, 100, 101, 102, 100, 101, 102
    )
  )
  
  # Backup nezaposlenost
  eurostat_data$unemployment <- data.table(
    yearmonth = seq(as.Date("2021-01-01"), as.Date("2024-11-01"), by = "month"),
    unemp_rate = c(
      8.5, 8.2, 7.8, 7.5, 7.2, 6.9, 6.6, 6.5, 6.4, 6.3, 6.2, 6.1,
      6.0, 5.9, 5.8, 5.7, 5.6, 5.5, 5.6, 5.7, 5.8, 5.9, 5.8, 5.7,
      5.6, 5.5, 5.4, 5.3, 5.2, 5.3, 5.4, 5.5, 5.4, 5.3, 5.2, 5.1,
      5.0, 4.9, 4.8, 4.9, 5.0, 5.1, 5.0, 4.9, 4.8, 4.9, 5.0
    )
  )
}
```

# Konstrukcija semantičkih indeksa

## Mjesečna agregacija

```{r monthly-aggregation}
#| label: monthly-aggregation

sem_cols_all <- c(sem_cols, names(dt)[grepl("^macro_", names(dt))], "semantic_total")

monthly <- dt[, c(
  .(N = .N,
    avg_length = mean(text_length, na.rm = TRUE)),
  lapply(.SD, sum, na.rm = TRUE)
), by = yearmonth, .SDcols = sem_cols_all][order(yearmonth)]

# Per article prosjeci
for(col in sem_cols_all) {
  monthly[, paste0(col, "_avg") := get(col) / N]
}
```

## Spajanje s Eurostat podacima

```{r merge-eurostat}
#| label: merge-eurostat

analysis <- copy(monthly)

# Spoji mjesečne indikatore
if(!is.null(eurostat_data$industrial)) {
  analysis <- merge(analysis, eurostat_data$industrial, by = "yearmonth", all.x = TRUE)
}
if(!is.null(eurostat_data$construction)) {
  analysis <- merge(analysis, eurostat_data$construction, by = "yearmonth", all.x = TRUE)
}
if(!is.null(eurostat_data$retail)) {
  analysis <- merge(analysis, eurostat_data$retail, by = "yearmonth", all.x = TRUE)
}
if(!is.null(eurostat_data$esi)) {
  analysis <- merge(analysis, eurostat_data$esi, by = "yearmonth", all.x = TRUE)
}
if(!is.null(eurostat_data$unemployment)) {
  analysis <- merge(analysis, eurostat_data$unemployment, by = "yearmonth", all.x = TRUE)
}

# Spoji kvartalne indikatore (BDP)
if(!is.null(eurostat_data$gdp)) {
  analysis[, yearquarter := floor_date(yearmonth, "quarter")]
  analysis <- merge(analysis, eurostat_data$gdp, by = "yearquarter", all.x = TRUE)
}

analysis <- analysis[order(yearmonth)]
```

## Konstrukcija indeksa

```{r construct-indices}
#| label: construct-indices

normalize_01 <- function(x) {
  if(all(is.na(x))) return(rep(0.5, length(x)))
  (x - min(x, na.rm = TRUE)) / (max(x, na.rm = TRUE) - min(x, na.rm = TRUE))
}

# === INDEKS 1: Simple Aggregate Index (SAI) ===
analysis[, SAI := normalize_01(semantic_total) * 100]

# === INDEKS 2: Weighted Semantic Index (WSI) ===
macro_cols <- names(analysis)[grepl("^macro_", names(analysis))]

# Korelacije s industrijskom proizvodnjom kao referentnim indikatorom
correlations_with_ref <- sapply(macro_cols, function(col) {
  cor(analysis[[col]], analysis$ind_prod_yoy, use = "complete.obs")
})

# Zamijeni NA s 0
correlations_with_ref[is.na(correlations_with_ref)] <- 0

weights <- pmax(correlations_with_ref, 0)
if(sum(weights) > 0) weights <- weights / sum(weights) else weights <- rep(1/length(weights), length(weights))

analysis[, WSI := {
  weighted_sum <- 0
  for(i in seq_along(macro_cols)) {
    weighted_sum <- weighted_sum + normalize_01(get(macro_cols[i])) * weights[i]
  }
  weighted_sum * 100
}]

# === INDEKS 3: Principal Component Index (PCI) ===
pca_data <- analysis[, .SD, .SDcols = macro_cols]
pca_data_complete <- pca_data[complete.cases(pca_data)]

if(nrow(pca_data_complete) > 10 && ncol(pca_data_complete) > 2) {
  pca_result <- prcomp(pca_data_complete, scale. = TRUE)
  pc1_loadings <- pca_result$rotation[,1]
  
  pca_matrix <- as.matrix(pca_data)
  pca_matrix[is.na(pca_matrix)] <- 0
  pc1_scores <- as.numeric(scale(pca_matrix %*% pc1_loadings))
  
  if(cor(pc1_scores, analysis$ind_prod_yoy, use = "complete.obs") < 0) {
    pc1_scores <- -pc1_scores
  }
  analysis[, PCI := normalize_01(pc1_scores) * 100]
} else {
  analysis[, PCI := SAI]
}

# === INDEKS 4: Sektorski kompozitni indeks (SCI) ===
# Kombinira ključne sektore: industrija, građevinarstvo, trgovina, turizam
key_sectors <- c("macro_industrija", "macro_gradevinarstvo", "macro_trgovina", "macro_turizam")
key_sectors <- key_sectors[key_sectors %in% names(analysis)]

if(length(key_sectors) > 0) {
  analysis[, SCI := rowMeans(.SD, na.rm = TRUE), .SDcols = key_sectors]
  analysis[, SCI := normalize_01(SCI) * 100]
} else {
  analysis[, SCI := SAI]
}

# === INDEKS 5: BDP fokusirani indeks (GDI) ===
# Samo kategorije direktno povezane s BDP-om
gdp_cats <- c("macro_bdp_agregat", "macro_investicije", "macro_potrosnja")
gdp_cats <- gdp_cats[gdp_cats %in% names(analysis)]

if(length(gdp_cats) > 0) {
  analysis[, GDI := rowMeans(.SD, na.rm = TRUE), .SDcols = gdp_cats]
  analysis[, GDI := normalize_01(GDI) * 100]
} else {
  analysis[, GDI := SAI]
}

# Klizni prosjeci
for(idx in c("SAI", "WSI", "PCI", "SCI", "GDI")) {
  analysis[, paste0(idx, "_MA3") := frollmean(get(idx), n = 3, align = "center")]
}
```

# Usporedba s službenim podacima

## Vizualizacija indeksa vs službeni pokazatelji

```{r indices-vs-official}
#| label: indices-vs-official
#| fig-cap: "Semantički indeksi vs industrijska proizvodnja"
#| fig-height: 8

# Skaliraj indekse za usporedbu
ind_range <- range(analysis$ind_prod_yoy, na.rm = TRUE)
scale_factor <- diff(ind_range) / 100
offset <- ind_range[1]

indices_comparison <- analysis[, .(
  yearmonth,
  SAI_scaled = SAI * scale_factor + offset,
  WSI_scaled = WSI * scale_factor + offset,
  SCI_scaled = SCI * scale_factor + offset,
  ind_prod_yoy
)]

indices_long <- melt(indices_comparison, id.vars = "yearmonth",
                     variable.name = "serija", value.name = "vrijednost")

ggplot(indices_long, aes(x = yearmonth, y = vrijednost, color = serija)) +
  geom_line(linewidth = 1, alpha = 0.8) +
  scale_color_manual(
    values = c(
      "SAI_scaled" = pal$cool,
      "WSI_scaled" = pal$success,
      "SCI_scaled" = pal$warm,
      "ind_prod_yoy" = pal$highlight
    ),
    labels = c(
      "SAI_scaled" = "SAI (skalirano)",
      "WSI_scaled" = "WSI (skalirano)",
      "SCI_scaled" = "SCI (skalirano)",
      "ind_prod_yoy" = "Industrijska proizvodnja (Y/Y)"
    )
  ) +
  scale_x_date(date_breaks = "3 months", date_labels = "%b\n%Y") +
  labs(
    title = "Semantički indeksi vs Industrijska proizvodnja",
    subtitle = "Indeksi skalirani na raspon industrijske proizvodnje",
    x = NULL,
    y = "Y/Y promjena (%)",
    color = NULL
  ) +
  theme(legend.position = "bottom")
```

## Usporedba po sektorima

```{r sector-comparison}
#| label: sector-comparison
#| fig-cap: "Sektorski semantički indeksi vs službeni pokazatelji"
#| fig-height: 12

# Industrija
p_ind <- ggplot(analysis, aes(x = yearmonth)) +
  geom_line(aes(y = normalize_01(macro_industrija) * diff(range(ind_prod_yoy, na.rm=TRUE)) + 
                  min(ind_prod_yoy, na.rm=TRUE), color = "Semantički"), linewidth = 1) +
  geom_line(aes(y = ind_prod_yoy, color = "Službeni"), linewidth = 1) +
  scale_color_manual(values = c("Semantički" = pal$cool, "Službeni" = pal$highlight)) +
  labs(title = "Industrija", x = NULL, y = "Y/Y %", color = NULL) +
  theme(legend.position = "bottom")

# Građevinarstvo
p_con <- ggplot(analysis, aes(x = yearmonth)) +
  geom_line(aes(y = normalize_01(macro_gradevinarstvo) * diff(range(construction_yoy, na.rm=TRUE)) + 
                  min(construction_yoy, na.rm=TRUE), color = "Semantički"), linewidth = 1) +
  geom_line(aes(y = construction_yoy, color = "Službeni"), linewidth = 1) +
  scale_color_manual(values = c("Semantički" = pal$cool, "Službeni" = pal$highlight)) +
  labs(title = "Građevinarstvo", x = NULL, y = "Y/Y %", color = NULL) +
  theme(legend.position = "bottom")

# Trgovina
p_ret <- ggplot(analysis, aes(x = yearmonth)) +
  geom_line(aes(y = normalize_01(macro_trgovina) * diff(range(retail_yoy, na.rm=TRUE)) + 
                  min(retail_yoy, na.rm=TRUE), color = "Semantički"), linewidth = 1) +
  geom_line(aes(y = retail_yoy, color = "Službeni"), linewidth = 1) +
  scale_color_manual(values = c("Semantički" = pal$cool, "Službeni" = pal$highlight)) +
  labs(title = "Maloprodaja", x = NULL, y = "Y/Y %", color = NULL) +
  theme(legend.position = "bottom")

# ESI
p_esi <- ggplot(analysis, aes(x = yearmonth)) +
  geom_line(aes(y = normalize_01(macro_sentiment_poslovni) * diff(range(esi, na.rm=TRUE)) + 
                  min(esi, na.rm=TRUE), color = "Semantički"), linewidth = 1) +
  geom_line(aes(y = esi, color = "Službeni (ESI)"), linewidth = 1) +
  scale_color_manual(values = c("Semantički" = pal$cool, "Službeni (ESI)" = pal$highlight)) +
  labs(title = "Poslovni sentiment", x = NULL, y = "Indeks", color = NULL) +
  theme(legend.position = "bottom")

(p_ind | p_con) / (p_ret | p_esi)
```

## Korelacijska matrica

```{r correlation-matrix}
#| label: correlation-matrix
#| fig-cap: "Korelacijska matrica: semantičke kategorije vs službeni pokazatelji"
#| fig-height: 10

# Pripremi podatke za korelacijsku matricu
cor_vars <- c(macro_cols, "ind_prod_yoy", "construction_yoy", "retail_yoy", "esi", "gdp_yoy")
cor_vars <- cor_vars[cor_vars %in% names(analysis)]

cor_data <- analysis[, .SD, .SDcols = cor_vars]
cor_matrix <- cor(cor_data, use = "pairwise.complete.obs")

# Preimenuj za čitljivost
rownames(cor_matrix) <- gsub("macro_", "", rownames(cor_matrix))
colnames(cor_matrix) <- gsub("macro_", "", colnames(cor_matrix))

corrplot(cor_matrix,
         method = "color",
         type = "upper",
         order = "hclust",
         tl.col = "black",
         tl.srt = 45,
         tl.cex = 0.7,
         addCoef.col = "black",
         number.cex = 0.5,
         col = colorRampPalette(c(pal$cool, "white", pal$highlight))(100),
         title = "Korelacijska matrica",
         mar = c(0,0,2,0))
```

## Performanse indeksa

```{r index-performance}
#| label: index-performance

calc_performance <- function(idx_col, ref_col) {
  complete_idx <- which(!is.na(analysis[[idx_col]]) & !is.na(analysis[[ref_col]]))
  if(length(complete_idx) < 5) return(list(cor = NA, rmse = NA, mae = NA))
  
  idx_scaled <- normalize_01(analysis[[idx_col]][complete_idx]) * 
    diff(range(analysis[[ref_col]][complete_idx])) + 
    min(analysis[[ref_col]][complete_idx])
  ref_vals <- analysis[[ref_col]][complete_idx]
  
  list(
    cor = cor(analysis[[idx_col]][complete_idx], ref_vals, use = "complete.obs"),
    rmse = sqrt(mean((idx_scaled - ref_vals)^2)),
    mae = mean(abs(idx_scaled - ref_vals))
  )
}

# Performanse vs razni pokazatelji
performance_results <- data.table(
  Indeks = character(),
  Referentni_pokazatelj = character(),
  Korelacija = numeric(),
  RMSE = numeric(),
  MAE = numeric()
)

for(idx in c("SAI", "WSI", "PCI", "SCI", "GDI")) {
  for(ref in c("ind_prod_yoy", "construction_yoy", "retail_yoy", "esi", "gdp_yoy")) {
    if(ref %in% names(analysis)) {
      perf <- calc_performance(idx, ref)
      performance_results <- rbind(performance_results, data.table(
        Indeks = idx,
        Referentni_pokazatelj = ref,
        Korelacija = round(perf$cor, 3),
        RMSE = round(perf$rmse, 2),
        MAE = round(perf$mae, 2)
      ))
    }
  }
}

# Prikaži najbolje performanse po indeksu
best_per_index <- performance_results[, .SD[which.max(Korelacija)], by = Indeks]

kable(best_per_index, caption = "Najbolje performanse po semantičkom indeksu") %>%
  kable_styling(bootstrap_options = c("striped", "hover"), full_width = FALSE) %>%
  row_spec(which.max(best_per_index$Korelacija), bold = TRUE, background = pal$success)
```

## Detaljna korelacijska tablica

```{r detailed-correlations}
#| label: detailed-correlations

# Korelacije svih makro kategorija sa svim službenim pokazateljima
cat_correlations <- data.table(
  Kategorija = macro_cols
)

for(ref in c("ind_prod_yoy", "construction_yoy", "retail_yoy", "esi", "gdp_yoy")) {
  if(ref %in% names(analysis)) {
    cat_correlations[, (ref) := sapply(macro_cols, function(col) {
      round(cor(analysis[[col]], analysis[[ref]], use = "complete.obs"), 3)
    })]
  }
}

cat_correlations[, Kategorija := gsub("macro_", "", Kategorija)]

kable(cat_correlations, caption = "Korelacije semantičkih kategorija sa službenim pokazateljima") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"), 
                full_width = FALSE, font_size = 11) %>%
  scroll_box(height = "400px")
```

# Analiza vremenskih pomaka

## Optimalni lagovi

```{r lag-analysis}
#| label: lag-analysis

find_optimal_lag <- function(x, y, max_lag = 6) {
  complete_idx <- which(!is.na(x) & !is.na(y))
  if(length(complete_idx) < 15) return(list(lag = NA, cor = NA))
  
  x <- x[complete_idx]
  y <- y[complete_idx]
  
  best_cor <- -Inf
  best_lag <- 0
  
  for(lag in (-max_lag):max_lag) {
    if(lag < 0) {
      x_shifted <- x[1:(length(x) + lag)]
      y_aligned <- y[(abs(lag) + 1):length(y)]
    } else if(lag > 0) {
      x_shifted <- x[(lag + 1):length(x)]
      y_aligned <- y[1:(length(y) - lag)]
    } else {
      x_shifted <- x
      y_aligned <- y
    }
    
    if(length(x_shifted) > 5) {
      cor_val <- cor(x_shifted, y_aligned, use = "complete.obs")
      if(!is.na(cor_val) && cor_val > best_cor) {
        best_cor <- cor_val
        best_lag <- lag
      }
    }
  }
  
  list(lag = best_lag, cor = best_cor)
}

# Lag analiza za sve kombinacije
lag_results <- data.table(
  Semanticka_kategorija = character(),
  Referentni_pokazatelj = character(),
  Optimalni_lag = integer(),
  Max_korelacija = numeric()
)

all_cats <- c(macro_cols, "SAI", "WSI", "SCI", "GDI")

for(cat in all_cats) {
  for(ref in c("ind_prod_yoy", "construction_yoy", "retail_yoy", "gdp_yoy")) {
    if(ref %in% names(analysis)) {
      opt <- find_optimal_lag(analysis[[cat]], analysis[[ref]])
      if(!is.na(opt$lag)) {
        lag_results <- rbind(lag_results, data.table(
          Semanticka_kategorija = gsub("macro_", "", cat),
          Referentni_pokazatelj = ref,
          Optimalni_lag = opt$lag,
          Max_korelacija = round(opt$cor, 3)
        ))
      }
    }
  }
}

lag_results[, Interpretacija := fcase(
  Optimalni_lag < 0, paste0("Predvodi za ", abs(Optimalni_lag), " mj."),
  Optimalni_lag > 0, paste0("Prati za ", Optimalni_lag, " mj."),
  default = "Istovremeno"
)]

# Prikaži leading indikatore
leading_indicators <- lag_results[Optimalni_lag < 0][order(-Max_korelacija)]

kable(head(leading_indicators, 15), 
      caption = "Top 15 leading indikatora (semantika predvodi službene podatke)") %>%
  kable_styling(bootstrap_options = c("striped", "hover"), full_width = FALSE) %>%
  row_spec(1:min(5, nrow(leading_indicators)), background = "#d4edda")
```

## Cross-correlation vizualizacija

```{r ccf-visualization}
#| label: ccf-visualization
#| fig-cap: "Cross-correlation: Semantički indeksi vs Industrijska proizvodnja"
#| fig-height: 8

# CCF za glavne indekse vs industrijsku proizvodnju
ccf_results <- list()

for(idx in c("SAI", "WSI", "SCI", "GDI")) {
  complete_idx <- which(!is.na(analysis[[idx]]) & !is.na(analysis$ind_prod_yoy))
  if(length(complete_idx) > 20) {
    ccf_obj <- ccf(analysis[[idx]][complete_idx], 
                   analysis$ind_prod_yoy[complete_idx],
                   lag.max = 6, plot = FALSE)
    ccf_results[[idx]] <- data.table(
      indeks = idx,
      lag = as.numeric(ccf_obj$lag),
      correlation = as.numeric(ccf_obj$acf)
    )
  }
}

ccf_df <- rbindlist(ccf_results)

ggplot(ccf_df, aes(x = lag, y = correlation, fill = indeks)) +
  geom_col(position = position_dodge(width = 0.7), alpha = 0.8) +
  geom_hline(yintercept = 0, color = "gray50") +
  geom_hline(yintercept = c(-0.2, 0.2), linetype = "dashed", color = "gray70") +
  facet_wrap(~indeks, ncol = 2) +
  scale_fill_manual(values = c(
    "SAI" = pal$cool,
    "WSI" = pal$success,
    "SCI" = pal$warm,
    "GDI" = pal$purple
  )) +
  scale_x_continuous(breaks = -6:6) +
  labs(
    title = "Cross-correlation: Semantički indeksi vs Industrijska proizvodnja",
    subtitle = "Negativni lag = semantika predvodi | Pozitivni lag = semantika prati",
    x = "Vremenski pomak (mjeseci)",
    y = "Korelacija"
  ) +
  theme(legend.position = "none")
```

# Sektorska dekompozicija

## Dinamika po sektorima

```{r sector-dynamics}
#| label: sector-dynamics
#| fig-cap: "Dinamika semantičkih kategorija kroz vrijeme"
#| fig-height: 14

# Odaberi ključne sektore za vizualizaciju
key_macro <- c("macro_bdp_agregat", "macro_industrija", "macro_gradevinarstvo",
               "macro_turizam", "macro_trgovina", "macro_investicije",
               "macro_trziste_rada", "macro_sentiment_poslovni")
key_macro <- key_macro[key_macro %in% names(analysis)]

sector_long <- melt(
  analysis[, c("yearmonth", key_macro), with = FALSE],
  id.vars = "yearmonth",
  variable.name = "sektor",
  value.name = "vrijednost"
)

sector_long[, sektor := gsub("macro_", "", sektor)]
sector_long[, vrijednost_norm := normalize_01(vrijednost) * 100, by = sektor]

ggplot(sector_long, aes(x = yearmonth, y = vrijednost_norm)) +
  geom_area(fill = pal$accent, alpha = 0.3) +
  geom_line(color = pal$primary, linewidth = 0.8) +
  geom_smooth(method = "loess", se = FALSE, color = pal$highlight, linewidth = 1) +
  facet_wrap(~sektor, ncol = 2, scales = "free_y") +
  scale_x_date(date_breaks = "6 months", date_labels = "%b %y") +
  labs(
    title = "Dinamika semantičkih sektora kroz vrijeme",
    subtitle = "Normalizirane vrijednosti s LOESS trendom",
    x = NULL,
    y = "Indeks (0-100)"
  ) +
  theme(
    strip.text = element_text(face = "bold"),
    axis.text.x = element_text(angle = 45, hjust = 1)
  )
```

## Sektorska heatmapa

```{r sector-heatmap}
#| label: sector-heatmap
#| fig-cap: "Heatmapa sektorske aktivnosti kroz vrijeme"
#| fig-height: 8

# Normaliziraj sve sektore za heatmapu
heatmap_data <- sector_long[, .(yearmonth, sektor, vrijednost_norm)]
heatmap_wide <- dcast(heatmap_data, yearmonth ~ sektor, value.var = "vrijednost_norm")

heatmap_long <- melt(heatmap_wide, id.vars = "yearmonth", 
                     variable.name = "sektor", value.name = "intenzitet")

ggplot(heatmap_long, aes(x = yearmonth, y = sektor, fill = intenzitet)) +
  geom_tile() +
  scale_fill_viridis_c(option = "plasma") +
  scale_x_date(date_breaks = "3 months", date_labels = "%b %y") +
  labs(
    title = "Heatmapa sektorske medijske aktivnosti",
    x = NULL,
    y = NULL,
    fill = "Intenzitet\n(0-100)"
  ) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    axis.text.y = element_text(size = 10)
  )
```

# Nowcasting model

## Konstrukcija modela

```{r nowcasting}
#| label: nowcasting

# Pripremi podatke za model
model_data <- analysis[!is.na(ind_prod_yoy) & !is.na(SAI)]

if(nrow(model_data) > 20) {
  
  # Model 1: AR(1) benchmark
  model_ar1 <- lm(ind_prod_yoy ~ shift(ind_prod_yoy, 1), data = model_data)
  
  # Model 2: AR(1) + SAI
  model_sai <- lm(ind_prod_yoy ~ shift(ind_prod_yoy, 1) + SAI, data = model_data)
  
  # Model 3: AR(1) + SCI
  model_sci <- lm(ind_prod_yoy ~ shift(ind_prod_yoy, 1) + SCI, data = model_data)
  
  # Model 4: AR(1) + sektorski
  sector_formula <- as.formula(paste(
    "ind_prod_yoy ~ shift(ind_prod_yoy, 1) +",
    "macro_industrija + macro_trgovina + macro_sentiment_poslovni"
  ))
  model_sector <- lm(sector_formula, data = model_data)
  
  # Usporedba modela
  model_comparison <- data.table(
    Model = c("AR(1) benchmark",
              "AR(1) + SAI",
              "AR(1) + SCI",
              "AR(1) + Sektorski"),
    R2 = c(
      round(summary(model_ar1)$r.squared, 3),
      round(summary(model_sai)$r.squared, 3),
      round(summary(model_sci)$r.squared, 3),
      round(summary(model_sector)$r.squared, 3)
    ),
    Adj_R2 = c(
      round(summary(model_ar1)$adj.r.squared, 3),
      round(summary(model_sai)$adj.r.squared, 3),
      round(summary(model_sci)$adj.r.squared, 3),
      round(summary(model_sector)$adj.r.squared, 3)
    ),
    AIC = c(
      round(AIC(model_ar1), 1),
      round(AIC(model_sai), 1),
      round(AIC(model_sci), 1),
      round(AIC(model_sector), 1)
    )
  )
  
  kable(model_comparison, caption = "Usporedba nowcasting modela za industrijsku proizvodnju") %>%
    kable_styling(bootstrap_options = c("striped", "hover"), full_width = FALSE) %>%
    row_spec(which.min(model_comparison$AIC), bold = TRUE, background = pal$success)
}
```

## Fitted vs Actual

```{r nowcast-plot}
#| label: nowcast-plot
#| fig-cap: "Nowcasting: Fitted vs Actual"
#| fig-height: 7

if(exists("model_sai") && exists("model_sector")) {
  
  model_data[, fitted_ar1 := predict(model_ar1, newdata = model_data)]
  model_data[, fitted_sai := predict(model_sai, newdata = model_data)]
  model_data[, fitted_sector := predict(model_sector, newdata = model_data)]
  
  nowcast_long <- melt(
    model_data[, .(yearmonth, 
                   Actual = ind_prod_yoy,
                   `AR(1)` = fitted_ar1,
                   `AR(1) + SAI` = fitted_sai,
                   `AR(1) + Sektorski` = fitted_sector)],
    id.vars = "yearmonth",
    variable.name = "model",
    value.name = "vrijednost"
  )
  
  ggplot(nowcast_long, aes(x = yearmonth, y = vrijednost, color = model)) +
    geom_line(linewidth = 1) +
    scale_color_manual(values = c(
      "Actual" = pal$dark,
      "AR(1)" = pal$muted,
      "AR(1) + SAI" = pal$cool,
      "AR(1) + Sektorski" = pal$highlight
    )) +
    scale_x_date(date_breaks = "3 months", date_labels = "%b\n%Y") +
    labs(
      title = "Nowcasting industrijske proizvodnje",
      subtitle = "Usporedba modela s i bez semantičkih podataka",
      x = NULL,
      y = "Industrijska proizvodnja Y/Y (%)",
      color = "Model"
    ) +
    theme(legend.position = "bottom")
}
```

# Semantička brzina i momentum

```{r velocity-momentum}
#| label: velocity-momentum
#| fig-cap: "Semantička brzina i momentum"
#| fig-height: 10

# Brzina = M/M promjena
analysis[, SAI_velocity := SAI - shift(SAI, 1)]
analysis[, SCI_velocity := SCI - shift(SCI, 1)]

# Momentum = 3-mjesečna promjena
analysis[, SAI_momentum := SAI - shift(SAI, 3)]
analysis[, SCI_momentum := SCI - shift(SCI, 3)]

# Akceleracija
analysis[, SAI_accel := SAI_velocity - shift(SAI_velocity, 1)]

p_vel <- ggplot(analysis, aes(x = yearmonth)) +
  geom_hline(yintercept = 0, linetype = "dashed", color = pal$muted) +
  geom_line(aes(y = SAI_velocity, color = "SAI"), linewidth = 1) +
  geom_line(aes(y = SCI_velocity, color = "SCI"), linewidth = 1) +
  scale_color_manual(values = c("SAI" = pal$cool, "SCI" = pal$warm)) +
  labs(title = "Semantička brzina (M/M promjena)", x = NULL, y = "Promjena", color = NULL) +
  theme(legend.position = "bottom")

p_mom <- ggplot(analysis, aes(x = yearmonth)) +
  geom_hline(yintercept = 0, linetype = "dashed", color = pal$muted) +
  geom_area(aes(y = SAI_momentum), fill = pal$cool, alpha = 0.3) +
  geom_line(aes(y = SAI_momentum), color = pal$primary, linewidth = 1) +
  labs(title = "Semantički momentum (3M promjena)", x = NULL, y = "Promjena")

p_accel <- ggplot(analysis, aes(x = yearmonth)) +
  geom_hline(yintercept = 0, linetype = "dashed", color = pal$muted) +
  geom_col(aes(y = SAI_accel, fill = SAI_accel > 0), alpha = 0.7) +
  scale_fill_manual(values = c("TRUE" = pal$success, "FALSE" = pal$highlight)) +
  labs(title = "Semantička akceleracija", x = NULL, y = "Promjena brzine") +
  theme(legend.position = "none")

p_vel / p_mom / p_accel
```

# Granger uzročnost

```{r granger-test}
#| label: granger-test

complete_data <- analysis[!is.na(SAI) & !is.na(ind_prod_yoy)]

if(nrow(complete_data) > 30) {
  
  # Test: SAI -> Industrijska proizvodnja?
  granger_sai_ind <- grangertest(ind_prod_yoy ~ SAI, order = 3, data = complete_data)
  
  # Test: Industrijska proizvodnja -> SAI?
  granger_ind_sai <- grangertest(SAI ~ ind_prod_yoy, order = 3, data = complete_data)
  
  # Test: SCI -> Industrijska proizvodnja?
  granger_sci_ind <- grangertest(ind_prod_yoy ~ SCI, order = 3, data = complete_data)
  
  granger_results <- data.table(
    Test = c("SAI → Ind. proizvodnja", 
             "Ind. proizvodnja → SAI",
             "SCI → Ind. proizvodnja"),
    F_statistika = c(
      round(granger_sai_ind$F[2], 3),
      round(granger_ind_sai$F[2], 3),
      round(granger_sci_ind$F[2], 3)
    ),
    P_vrijednost = c(
      round(granger_sai_ind$`Pr(>F)`[2], 4),
      round(granger_ind_sai$`Pr(>F)`[2], 4),
      round(granger_sci_ind$`Pr(>F)`[2], 4)
    ),
    Znacajno = c(
      ifelse(granger_sai_ind$`Pr(>F)`[2] < 0.05, "Da", "Ne"),
      ifelse(granger_ind_sai$`Pr(>F)`[2] < 0.05, "Da", "Ne"),
      ifelse(granger_sci_ind$`Pr(>F)`[2] < 0.05, "Da", "Ne")
    )
  )
  
  kable(granger_results, caption = "Granger uzročnost (lag = 3 mjeseca)") %>%
    kable_styling(bootstrap_options = c("striped", "hover"), full_width = FALSE)
}
```

# Export podataka

```{r export-excel}
#| label: export-excel

wb <- createWorkbook()

# Sheet 1: Glavni podaci
addWorksheet(wb, "Glavni_podaci")
export_main <- analysis[, .(
  Datum = yearmonth,
  Broj_clanaka = N,
  SAI, WSI, PCI, SCI, GDI,
  Ind_proizvodnja = ind_prod_yoy,
  Gradevinarstvo = construction_yoy,
  Maloprodaja = retail_yoy,
  ESI = esi,
  BDP = gdp_yoy,
  SAI_brzina = SAI_velocity,
  SAI_momentum = SAI_momentum
)]
writeData(wb, "Glavni_podaci", export_main)

# Sheet 2: Sektorske kategorije
addWorksheet(wb, "Sektori")
export_sectors <- analysis[, c("yearmonth", macro_cols), with = FALSE]
names(export_sectors) <- c("Datum", gsub("macro_", "", macro_cols))
writeData(wb, "Sektori", export_sectors)

# Sheet 3: Performanse
if(exists("performance_results")) {
  addWorksheet(wb, "Performanse")
  writeData(wb, "Performanse", performance_results)
}

# Sheet 4: Lag analiza
addWorksheet(wb, "Lag_analiza")
writeData(wb, "Lag_analiza", lag_results)

# Sheet 5: Korelacije
addWorksheet(wb, "Korelacije")
writeData(wb, "Korelacije", cat_correlations)

# Stilovi
header_style <- createStyle(
  textDecoration = "bold",
  fgFill = "#1a1a2e",
  fontColour = "white",
  halign = "center"
)

for(sheet in names(wb)) {
  addStyle(wb, sheet, header_style, rows = 1, cols = 1:30, gridExpand = TRUE)
  setColWidths(wb, sheet, cols = 1:30, widths = "auto")
}

output_path <- here("output", "semantic_activity_research.xlsx")
dir.create(here("output"), showWarnings = FALSE, recursive = TRUE)
saveWorkbook(wb, output_path, overwrite = TRUE)
message("Excel exportiran: ", output_path)
```

# Zaključci

## Ključni nalazi

```{r summary}
#| label: summary

# Nađi najbolje performanse
best_index <- best_per_index[which.max(Korelacija)]
best_leading <- leading_indicators[1]

summary_findings <- data.table(
  Nalaz = c(
    "Broj analiziranih članaka",
    "Vremenski raspon",
    "Najbolji semantički indeks",
    "Korelacija s ind. proizvodnjom",
    "Najbolji leading indikator",
    "Lead vrijeme",
    "Improvement R² vs AR(1)",
    "Broj semantičkih kategorija",
    "Broj makro sektora"
  ),
  Rezultat = c(
    format(nrow(dt), big.mark = ","),
    paste(format(date_min, "%m/%Y"), "-", format(date_max, "%m/%Y")),
    best_index$Indeks,
    as.character(best_index$Korelacija),
    ifelse(nrow(leading_indicators) > 0, best_leading$Semanticka_kategorija, "N/A"),
    ifelse(nrow(leading_indicators) > 0, paste0(abs(best_leading$Optimalni_lag), " mjeseca"), "N/A"),
    ifelse(exists("model_comparison"), 
           paste0(round((max(model_comparison$R2[-1]) - model_comparison$R2[1]) * 100, 1), " pp"),
           "N/A"),
    length(sem_cols),
    length(macro_cols)
  )
)

kable(summary_findings, caption = "Sažetak ključnih nalaza") %>%
  kable_styling(bootstrap_options = c("striped", "hover"), full_width = FALSE)
```

## Preporuke za daljnje istraživanje

1. **Granularnost**: Razbiti sektore na još finiju razinu (npr. podsektori industrije)
2. **Sentiment analiza**: Dodati dubinsku sentiment analizu za svaki sektor
3. **Real-time sustav**: Implementirati dnevno praćenje za nowcasting
4. **Kombinacija s drugim izvorima**: Integrirati s Google Trends, Twitter podacima
5. **Regionalna analiza**: Dekompozicija po hrvatskim regijama
6. **Međunarodna usporedba**: Usporediti sa semantičkim indeksima za susjedne zemlje

---

*Izvještaj generiran: `r Sys.time()`*

*GIMES Research | Semantički indeks gospodarske aktivnosti v1.0*
