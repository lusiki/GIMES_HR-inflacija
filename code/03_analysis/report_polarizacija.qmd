---
title: "Analiza medijske pokrivenosti političke polarizacije u Hrvatskoj"
subtitle: "Semantička analiza, konstrukcija indeksa i vremenske dinamike"
author: "GIMES Research"
date: today
format:
  html:
    toc: true
    toc-depth: 4
    toc-location: left
    number-sections: true
    theme: cosmo
    code-fold: true
    code-summary: "Prikaži kod"
    fig-width: 11
    fig-height: 7
    df-print: paged
    embed-resources: true
execute:
  warning: false
  message: false
  echo: false
lang: hr
---

```{r setup}
#| label: setup
#| include: false

# Core data manipulation
library(data.table)
library(lubridate)
library(stringi)

# Visualization
library(ggplot2)
library(scales)
library(plotly)
library(corrplot)
library(patchwork)

# Tables and output
library(knitr)
library(kableExtra)
library(openxlsx)

# Time series
library(zoo)
library(forecast)

# Project management
library(here)

colors_gimes <- c(
  "primary"   = "#2C3E50",
  "secondary" = "#E74C3C",
  "accent"    = "#3498DB",
  "success"   = "#27AE60",
  "warning"   = "#F39C12",
  "danger"    = "#C0392B",
  "light"     = "#ECF0F1",
  "purple"    = "#9B59B6",
  "teal"      = "#1ABC9C",
  "muted"     = "#7F8C8D"
)

# Topic specific colors
colors_gimes["left"] <- "#E74C3C"
colors_gimes["right"] <- "#3498DB"
colors_gimes["neutral"] <- "#95A5A6"

options(scipen = 999)

theme_gimes <- function() {
  theme_minimal(base_size = 12) +
    theme(
      plot.title = element_text(face = "bold", size = 14, color = colors_gimes["primary"]),
      plot.subtitle = element_text(size = 10, color = "gray40"),
      panel.grid.minor = element_blank(),
      legend.position = "bottom",
      axis.text = element_text(size = 9),
      strip.text = element_text(face = "bold", size = 10)
    )
}

theme_set(theme_gimes())
```

# Uvod

U ovom izvještaju se predstavlja sveobuhvatna analiza medijske pokrivenosti političke polarizacije u Hrvatskoj. Analizom se obuhvaća praćenje društvenih podjela, stranačkih sukoba, govora mržnje, povijesnih trauma i spornih društvenih pitanja temeljem članaka iz hrvatskih online medija.

## Motivacija i kontekst

Politička polarizacija predstavlja rastući fenomen u suvremenim demokracijama, uključujući Hrvatsku. Ovim izvještajem se nastoji odgovoriti na ključna pitanja:

1. Kako se medijsko izvještavanje o polarizacijskim temama razvijalo kroz vrijeme?
2. Koje su kategorije polarizacije najzastupljenije u hrvatskim medijima?
3. Postoje li sezonski obrasci u intenzitetu polarizacijskog diskursa?
4. Kako se različiti aspekti polarizacije međusobno odnose?

## Struktura izvještaja

U izvještaju se obrađuju sljedeće teme: metodologija identifikacije relevantnih članaka, eksploratorni pregled dataseta, semantička taksonomija polarizacijskih pojmova, konstrukcija specijaliziranih indeksa, vizualizacija indeksa, sektorska analiza, sentiment analiza, volatilnost i momentum te koncentracija tema.

```{r load-data}
#| label: load-data

#dt <- as.data.table(read.xlsx(here("data", "polarization_filtered.xlsx")))
dt <- as.data.table(read.xlsx("C:/Users/lsikic/Desktop/inflacija_filtered.xlsx"))

# Date conversion
if (is.numeric(dt$DATE)) {
  dt[, DATE := as.Date(DATE, origin = "1899-12-30")]
} else {
  dt[, DATE := as.Date(DATE)]
}

# Numeric conversions
if ("text_length" %in% names(dt)) dt[, text_length := as.numeric(text_length)]
if ("REACH" %in% names(dt)) dt[, REACH := as.numeric(REACH)]
if ("INTERACTIONS" %in% names(dt)) dt[, INTERACTIONS := as.numeric(INTERACTIONS)]

# Time variables (include both weekly and quarterly)
dt[, `:=`(
  date = DATE,
  year = year(DATE),
  month = month(DATE),
  week = isoweek(DATE),
  quarter = quarter(DATE),
  yearmonth = floor_date(DATE, "month"),
  yearweek = floor_date(DATE, "week"),
  yearquarter = floor_date(DATE, "quarter")
)]

# Store date range
date_min <- min(dt$date, na.rm = TRUE)
date_max <- max(dt$date, na.rm = TRUE)

cat("Učitano", format(nrow(dt), big.mark = ","), "članaka\n")
cat("Vremenski raspon:", format(date_min, "%d.%m.%Y"), "do", format(date_max, "%d.%m.%Y"), "\n")
```

# Metodologija identifikacije članaka

## Pregled procesa filtriranja

Identifikacija relevantnih članaka se provodi kroz sedmostupanjski proces filtriranja koji kombinira strukturne kriterije, ključne riječi i kontekstualnu validaciju. Proces osigurava da u analizu ulaze samo članci koji su stvarno relevantni za tematiku političke polarizacije u hrvatskom kontekstu.

::: {.callout-note collapse="true" title="Detaljna metodologija filtriranja"}

**Filter 1: Tip izvora**

Odabiru se samo web izvori kako bi se osigurala konzistentnost formata i dostupnost punog teksta članka.

**Filter 2: Relevantni news portali**

Koristi se lista verificiranih hrvatskih news portala kategoriziranih u pet skupina: nacionalni mediji, poslovni mediji, regionalni mediji, specijalizirani mediji i opinion portali.

**Filter 3: Minimalna duljina teksta**

Članci moraju sadržavati minimalno 500 znakova u punom tekstu.

**Filter 4: Naslov članka**

Naslov članka mora sadržavati polarizacijske pojmove: podjele, lijevo/desno, stranački sukobi, govor mržnje, povijesni sukobi, sporna društvena pitanja.

**Filter 5: Core polarizacijski pojmovi**

Puni tekst članka mora sadržavati core polarizacijske pojmove koji potvrđuju da se članak bavi polarizacijskom tematikom.

**Filter 6: Isključivanje irelevantnog sadržaja**

Isključuju se članci o sportu, zabavi i drugim irelevantnim temama, osim ako sadrže snažne override pojmove.

**Filter 7: Hrvatski kontekst**

Članci moraju sadržavati reference na hrvatsku politiku i društvo.

:::

# Eksploratorni pregled podataka

## Osnovne statistike

```{r basic-stats}
#| label: basic-stats

stats_summary <- data.table(
  Metrika = c(
    "Ukupan broj članaka",
    "Vremenski raspon",
    "Broj dana",
    "Prosječno članaka dnevno",
    "Broj izvora (portala)",
    "Broj kategorija izvora"
  ),
  Vrijednost = c(
    format(nrow(dt), big.mark = ","),
    paste(format(min(dt$date), "%d.%m.%Y"), "do", format(max(dt$date), "%d.%m.%Y")),
    as.character(as.numeric(max(dt$date) - min(dt$date))),
    round(nrow(dt) / as.numeric(max(dt$date) - min(dt$date)), 2),
    length(unique(dt$FROM)),
    length(unique(dt$source_category))
  )
)

kable(stats_summary, col.names = c("Metrika", "Vrijednost"),
      caption = "Osnovne statistike dataseta") %>%
  kable_styling(bootstrap_options = c("striped", "hover"), full_width = FALSE)
```

## Distribucija po kategorijama izvora

```{r source-category}
#| label: source-category
#| fig-cap: "Distribucija članaka po kategorijama izvora"

cat_summary <- dt[, .(
  N = .N,
  Postotak = round(.N / nrow(dt) * 100, 1)
), by = source_category][order(-N)]

ggplot(cat_summary, aes(x = reorder(source_category, N), y = N, fill = source_category)) +
  geom_col(show.legend = FALSE) +
  geom_text(aes(label = paste0(format(N, big.mark = ","), "\n(", Postotak, "%)")), 
            hjust = -0.1, size = 3.5) +
  coord_flip() +
  scale_y_continuous(labels = comma, expand = expansion(mult = c(0, 0.2))) +
  scale_fill_manual(values = c("national" = colors_gimes["primary"],
                               "business" = colors_gimes["accent"],
                               "regional" = colors_gimes["success"],
                               "specialized" = colors_gimes["warning"],
                               "opinion" = colors_gimes["secondary"])) +
  labs(
    title = "Broj članaka po kategoriji izvora",
    subtitle = "Opinion portali su posebno relevantni za polarizacijski sadržaj",
    x = NULL,
    y = "Broj članaka"
  )
```

## Top 20 izvora

```{r top-sources}
#| label: top-sources
#| fig-cap: "20 najaktivnijih izvora"

top_sources <- dt[, .(N = .N), by = FROM][order(-N)][1:20]

ggplot(top_sources, aes(x = reorder(FROM, N), y = N)) +
  geom_col(fill = colors_gimes["primary"]) +
  geom_text(aes(label = format(N, big.mark = ",")), hjust = -0.1, size = 3) +
  coord_flip() +
  scale_y_continuous(labels = comma, expand = expansion(mult = c(0, 0.15))) +
  labs(
    title = "Top 20 izvora po broju članaka o polarizaciji",
    x = NULL,
    y = "Broj članaka"
  )
```

## Distribucija duljine teksta

```{r text-length}
#| label: text-length
#| fig-cap: "Distribucija duljine članaka"

if ("text_length" %in% names(dt)) {
  ggplot(dt, aes(x = text_length)) +
    geom_histogram(bins = 50, fill = colors_gimes["primary"], alpha = 0.8, color = "white") +
    geom_vline(xintercept = median(dt$text_length, na.rm = TRUE), 
               color = colors_gimes["secondary"], linetype = "dashed", linewidth = 1) +
    annotate("text", x = median(dt$text_length, na.rm = TRUE) + 500, 
             y = Inf, vjust = 2, hjust = 0,
             label = paste("Medijan:", format(round(median(dt$text_length, na.rm = TRUE)), big.mark = ",")),
             color = colors_gimes["secondary"], fontface = "bold") +
    scale_x_continuous(labels = comma) +
    scale_y_continuous(labels = comma) +
    labs(
      title = "Distribucija duljine članaka",
      subtitle = "Broj znakova u punom tekstu",
      x = "Broj znakova",
      y = "Broj članaka"
    )
}
```

# Semantička taksonomija

## Hijerarhijska struktura pojmova

Semantička taksonomija se organizira u 12 makro kategorija koje obuhvaćaju različite aspekte polarizacijskog diskursa u hrvatskom kontekstu. Pojmovi se definiraju pomoću korijena riječi (stem) kako bi se osigurala šira morfološka pokrivenost hrvatskog jezika.

::: {.callout-note collapse="true" title="Detaljna metodologija semantičke taksonomije"}

**Princip konstrukcije rječnika:**

1. Kategorije predstavljaju konceptualno različite aspekte polarizacije
2. Regex uzorci se koriste za fleksibilno prepoznavanje morfoloških varijanti
3. Korijenski oblici osiguravaju prepoznavanje svih padežnih i glagolskih oblika

**Formula za brojanje:**

$$
\text{count}_{c,d} = \sum_{p \in P_c} \text{matches}(p, d)
$$

gdje je $P_c$ skup regex uzoraka za kategoriju $c$, a $d$ je tekst dokumenta.

:::

```{r semantic-dictionary}
#| label: semantic-dictionary

semantic_terms <- list(
  
  polarizacija_podjele = c(
    "polarizacij[a-zčćžšđ]*",
    "podijeljen[a-zčćžšđ]*",
    "podjel[aeiou]+[a-zčćžšđ]*",
    "rascjep[a-zčćžšđ]*",
    "razdor[a-zčćžšđ]*",
    "podvojen[a-zčćžšđ]*",
    "(dru[sš]tven|politi[cč]k)[a-zčćžšđ]*.{0,10}podjel[a-zčćžšđ]*"
  ),
  
  lijevo_desno = c(
    "ljevic[a-zčćžšđ]*",
    "desnic[a-zčćžšđ]*",
    "lijevi[a-zčćžšđ]*",
    "desni[a-zčćžšđ]*",
    "ljevi[cč]ar[a-zčćžšđ]*",
    "desni[cč]ar[a-zčćžšđ]*",
    "konzervativ[a-zčćžšđ]*",
    "liberal[a-zčćžšđ]*",
    "progresiv[a-zčćžšđ]*",
    "nacionalist[a-zčćžšđ]*",
    "populist[a-zčćžšđ]*",
    "suverenist[a-zčćžšđ]*"
  ),
  
  stranacki_sukobi = c(
    "(hdz|sdp).{0,20}(sukob|napad|optu[zž]|protiv|kritik)",
    "(mo[zž]emo|most|dp).{0,20}(sukob|napad|optu[zž]|protiv)",
    "vladaju[cć][a-zčćžšđ]*.{0,15}opor[a-zčćžšđ]*",
    "opor[a-zčćžšđ]*.{0,15}vladaju[cć]",
    "strna[cč]k[a-zčćžšđ]*.{0,10}sukob[a-zčćžšđ]*",
    "politi[cč]k[a-zčćžšđ]*.{0,10}sukob[a-zčćžšđ]*",
    "obra[cč]un[a-zčćžšđ]*.{0,15}(hdz|sdp|stranak)",
    "koalicij[a-zčćžšđ]*.{0,10}(kriz|sukob|raspad)"
  ),
  
  govor_mrznje = c(
    "govor[a-zčćžšđ]*.{0,5}mr[zž]nj[a-zčćžšđ]*",
    "mr[zž]nj[aeiou]+[a-zčćžšđ]*",
    "poticanj[a-zčćžšđ]*.{0,10}mr[zž]nj",
    "[sš]irenj[a-zčćžšđ]*.{0,10}mr[zž]nj",
    "(politi[cč]k|etni[cč]k|vjers|nacionaln)[a-zčćžšđ]*.{0,10}mr[zž]nj"
  ),
  
  netolerancija = c(
    "ksenofobij[a-zčćžšđ]*",
    "homofobij[a-zčćžšđ]*",
    "rasiz[a-zčćžšđ]*",
    "rasisti[cč]k[a-zčćžšđ]*",
    "antisemitiz[a-zčćžšđ]*",
    "mizoginij[a-zčćžšđ]*",
    "netrpeljivost[a-zčćžšđ]*",
    "nesno[sš]ljivost[a-zčćžšđ]*",
    "diskriminacij[a-zčćžšđ]*",
    "stigmatizacij[a-zčćžšđ]*"
  ),
  
  povijesni_sukobi = c(
    "usta[sš][a-zčćžšđ]*",
    "partizan[a-zčćžšđ]*",
    "\\bndh\\b",
    "za dom spremni",
    "jasenovac[a-zčćžšđ]*",
    "bleiburg[a-zčćžšđ]*",
    "kri[zž]ni put",
    "revizij[a-zčćžšđ]*.{0,10}povijesti",
    "instrumentalizacij[a-zčćžšđ]*.{0,10}(pro[sš]lost|povijest|[zž]rtav)"
  ),
  
  rodna_lgbt = c(
    "rodn[a-zčćžšđ]*.{0,10}ideologij[a-zčćžšđ]*",
    "istanbulsk[a-zčćžšđ]*.{0,10}konvencij[a-zčćžšđ]*",
    "istospoln[a-zčćžšđ]*.{0,10}(brak|zajednic|partnerstvo)",
    "lgbti?[a-zčćžšđ]*",
    "\\bpride\\b",
    "homoseksual[a-zčćžšđ]*",
    "trans.?(rodn|seksual)[a-zčćžšđ]*",
    "queer[a-zčćžšđ]*"
  ),
  
  pobacaj_prolife = c(
    "poba[cč]aj[a-zčćžšđ]*",
    "pravo.{0,10}poba[cč]aj",
    "hod.{0,5}[zž]ivot",
    "pro.?life",
    "pro.?choice",
    "nerodeno dijete",
    "pravo.{0,10}izbor"
  ),
  
  crkva_drzava = c(
    "crkv[a-zčćžšđ]*.{0,15}(politi|dr[zž]av|utjecaj)",
    "vjeronauk[a-zčćžšđ]*",
    "kri[zž].{0,10}[sš]kol",
    "sekulariz[a-zčćžšđ]*",
    "klerikaliz[a-zčćžšđ]*",
    "katoli[cč]k[a-zčćžšđ]*.{0,10}(crkv|biskupi|vatikan)",
    "(nadbiskup|biskup|kardinal|papa).{0,15}politi[cč]k"
  ),
  
  migracije = c(
    "migrant[a-zčćžšđ]*",
    "izbjegli[ck][a-zčćžšđ]*",
    "azilant[a-zčćžšđ]*",
    "anti.?migra[a-zčćžšđ]*",
    "(migrant|izbjegli).{0,15}(sukob|mr[zž]nj|netrpelj|napad)"
  ),
  
  dezinformacije = c(
    "dezinformacij[a-zčćžšđ]*",
    "la[zž]n[a-zčćžšđ]*.{0,5}vijesti",
    "fake.?news",
    "propagand[a-zčćžšđ]*",
    "manipulacij[a-zčćžšđ]*",
    "botov[aei]?[a-zčćžšđ]*",
    "informacijski.{0,5}rat",
    "medijski.{0,5}rat",
    "teorij[a-zčćžšđ]*.{0,10}zavjer"
  ),
  
  identitetska_politika = c(
    "identitetsk[a-zčćžšđ]*.{0,10}politik[a-zčćžšđ]*",
    "politi[cč]k[a-zčćžšđ]*.{0,5}rat",
    "kulturn[a-zčćžšđ]*.{0,5}rat",
    "kulturolo[sš]k[a-zčćžšđ]*.{0,10}sukob",
    "sukob.{0,10}vrijednosti",
    "svjetonazorsk[a-zčćžšđ]*",
    "mi.{0,5}protiv.{0,5}njih",
    "demonizacij[a-zčćžšđ]*",
    "dehumanizacij[a-zčćžšđ]*",
    "nepomirljiv[a-zčćžšđ]*"
  )
)

category_display <- c(
  "polarizacija_podjele" = "Polarizacija i podjele",
  "lijevo_desno" = "Lijevo desno spektar",
  "stranacki_sukobi" = "Stranački sukobi",
  "govor_mrznje" = "Govor mržnje",
  "netolerancija" = "Netolerancija i diskriminacija",
  "povijesni_sukobi" = "Povijesni sukobi",
  "rodna_lgbt" = "Rodna pitanja i LGBT",
  "pobacaj_prolife" = "Pobačaj i pro life",
  "crkva_drzava" = "Crkva i država",
  "migracije" = "Migracije",
  "dezinformacije" = "Dezinformacije i propaganda",
  "identitetska_politika" = "Identitetska politika"
)

term_summary <- data.table(
  Kategorija = names(semantic_terms),
  Broj_pojmova = sapply(semantic_terms, length),
  Primjeri = sapply(semantic_terms, function(x) paste(head(x, 2), collapse = ", "))
)
term_summary[, Kategorija_display := category_display[Kategorija]]

kable(term_summary[, .(Kategorija_display, Broj_pojmova, Primjeri)], 
      col.names = c("Kategorija", "Broj pojmova", "Primjeri regex uzoraka"),
      caption = "Pregled rječnika semantičkih pojmova za polarizaciju") %>%
  kable_styling(bootstrap_options = c("striped", "hover"), full_width = FALSE)
```

## Brojanje semantičkih pojmova

```{r count-semantic-terms}
#| label: count-semantic-terms

count_terms <- function(text, patterns) {
  if (is.na(text) || text == "") return(0)
  text_lower <- tolower(text)
  sum(sapply(patterns, function(p) {
    stri_count_regex(text_lower, p)
  }))
}

for (cat_name in names(semantic_terms)) {
  col_name <- paste0("count_", cat_name)
  dt[, (col_name) := sapply(FULL_TEXT, count_terms, patterns = semantic_terms[[cat_name]])]
}

dt[, count_all_semantic := rowSums(.SD), .SDcols = patterns("^count_")]
```

## Dinamika semantičkih kategorija

```{r monthly-semantic}
#| label: monthly-semantic

semantic_cols <- names(dt)[grepl("^count_", names(dt))]

monthly_semantic <- dt[, c(
  .(N = .N),
  lapply(.SD, sum, na.rm = TRUE),
  lapply(.SD, mean, na.rm = TRUE) |> setNames(paste0(names(.SD), "_avg"))
), by = yearmonth, .SDcols = semantic_cols][order(yearmonth)]

monthly_semantic[, total_mentions := count_all_semantic]
```

```{r semantic-time-series}
#| label: semantic-time-series
#| fig-cap: "Dinamika semantičkih kategorija kroz vrijeme"
#| fig-height: 12

semantic_long <- melt(
  monthly_semantic[, .(yearmonth, 
                       count_polarizacija_podjele,
                       count_lijevo_desno,
                       count_stranacki_sukobi,
                       count_govor_mrznje,
                       count_netolerancija,
                       count_povijesni_sukobi,
                       count_rodna_lgbt,
                       count_pobacaj_prolife,
                       count_crkva_drzava,
                       count_migracije,
                       count_dezinformacije,
                       count_identitetska_politika)],
  id.vars = "yearmonth",
  variable.name = "kategorija",
  value.name = "broj"
)

category_labels <- c(
  "count_polarizacija_podjele" = "Polarizacija/Podjele",
  "count_lijevo_desno" = "Lijevo Desno",
  "count_stranacki_sukobi" = "Stranački sukobi",
  "count_govor_mrznje" = "Govor mržnje",
  "count_netolerancija" = "Netolerancija",
  "count_povijesni_sukobi" = "Povijesni sukobi",
  "count_rodna_lgbt" = "Rodna/LGBT",
  "count_pobacaj_prolife" = "Pobačaj/Pro life",
  "count_crkva_drzava" = "Crkva Država",
  "count_migracije" = "Migracije",
  "count_dezinformacije" = "Dezinformacije",
  "count_identitetska_politika" = "Identitetska politika"
)

semantic_long[, kategorija_label := category_labels[as.character(kategorija)]]

ggplot(semantic_long, aes(x = yearmonth, y = broj, color = kategorija_label)) +
  geom_line(linewidth = 1) +
  facet_wrap(~kategorija_label, ncol = 3, scales = "free_y") +
  scale_x_date(date_breaks = "6 months", date_labels = "%b %y") +
  scale_color_brewer(palette = "Set3") +
  labs(
    title = "Dinamika semantičkih kategorija polarizacije kroz vrijeme",
    subtitle = "Mjesečni broj spominjanja po kategoriji pojmova",
    x = NULL,
    y = "Broj spominjanja",
    color = NULL
  ) +
  theme(
    legend.position = "none",
    axis.text.x = element_text(angle = 45, hjust = 1, size = 7)
  )
```

# Konstrukcija indeksa

### Political Polarization Index (PPI)

PPI kvantificira opću razinu polarizacijskog diskursa u medijima mjereći intenzitet pojmova koji direktno opisuju polarizaciju, podjele i rascjepe u društvu. Konstrukcija se temelji na prebrojavanju pojavljivanja korijena riječi poput polarizacij, podijeljen, podjel, rascjep, razdor i slično. Suma tih pojavljivanja normalizira se brojem članaka kako bi se dobila prosječna mjesečna frekvencija pojmova polarizacije. Rezultat se skalira na raspon 0 do 100 standardnom min max normalizacijom. Povišene vrijednosti PPI indeksa indiciraju intenzivan medijski diskurs o podjelama u društvu.

::: {.callout-note collapse="true"}
## Detaljna metodologija PPI indeksa

**Formula:**

$$
\text{PPI}_t = \text{normalize}_{0-100}\left(\frac{\text{count}_{polarizacija,t}}{N_t}\right)
$$

**Uključeni pojmovi:** polarizacija, podijeljenost, podjela, rascjep, razdor, podvojenost, društvene/političke podjele

:::

### Party Division Index (PDI)

PDI prati intenzitet sukoba između političkih stranaka u medijskom izvještavanju. Indeks se konstruira prebrojavanjem pojavljivanja pojmova vezanih uz međustranačke sukobe normaliziranih ukupnim brojem članaka. Vrhovi ukazuju na periode intenzivnih međustranačkih sukoba, često vezanih uz izbore ili političke krize.

::: {.callout-note collapse="true"}
## Detaljna metodologija PDI indeksa

**Formula:**

$$
\text{PDI}_t = \text{normalize}_{0-100}\left(\frac{\text{count}_{stranački,t}}{N_t}\right)
$$

**Uključeni pojmovi:** HDZ SDP sukobi, vladajući opozicija, stranački sukobi, politički obračuni, koalicijske krize

:::

### Hate Speech Index (HSI)

HSI mjeri prisutnost govora mržnje i netolerancije u medijskom prostoru. Indeks kombinira pojmove vezane uz govor mržnje i pojmove vezane uz različite oblike diskriminacije i netolerancije. Visoke vrijednosti signaliziraju pojačan diskurs o netoleranciji i diskriminaciji.

::: {.callout-note collapse="true"}
## Detaljna metodologija HSI indeksa

**Formula:**

$$
\text{HSI}_t = \text{normalize}_{0-100}\left(\frac{\text{count}_{mržnja,t} + \text{count}_{netolerancija,t}}{N_t}\right)
$$

**Uključeni pojmovi:** govor mržnje, mržnja, poticanje mržnje, ksenofobija, homofobija, rasizam, antisemitizam, diskriminacija, stigmatizacija

:::

### Historical Conflict Index (HCI)

HCI prati diskurs o povijesnim podjelama i traumama iz Drugog svjetskog rata i Domovinskog rata. Indeks je posebno relevantan za hrvatski kontekst s obzirom na nerazriješene povijesne traume. Vrhovi često koincidiraju s komemoracijama, političkim izjavama o prošlosti ili kontroverznim simbolima.

::: {.callout-note collapse="true"}
## Detaljna metodologija HCI indeksa

**Formula:**

$$
\text{HCI}_t = \text{normalize}_{0-100}\left(\frac{\text{count}_{povijesni,t}}{N_t}\right)
$$

**Uključeni pojmovi:** ustaše, partizani, NDH, Za dom spremni, Jasenovac, Bleiburg, Križni put, revizija povijesti, instrumentalizacija prošlosti

:::

### Culture War Index (CWI)

CWI mjeri intenzitet diskursa o spornim društvenim pitanjima vezanim uz rod, LGBT prava i reproduktivna prava. Indeks kombinira pojmove iz kategorija rodnih pitanja i pobačaja. Visoke vrijednosti ukazuju na intenzivne društvene debate o vrijednosnim pitanjima.

::: {.callout-note collapse="true"}
## Detaljna metodologija CWI indeksa

**Formula:**

$$
\text{CWI}_t = \text{normalize}_{0-100}\left(\frac{\text{count}_{rodna\_lgbt,t} + \text{count}_{pobačaj,t}}{N_t}\right)
$$

**Uključeni pojmovi:** rodna ideologija, Istanbulska konvencija, istospolni brak/zajednica, LGBT, Pride, pobačaj, Hod za život, pro life

:::

### Church State Index (CSI)

CSI prati tenzije između sekularnog i vjerskog u javnom prostoru. Indeks mjeri intenzitet diskursa o ulozi Crkve u politici i javnom životu. Visoke vrijednosti signaliziraju intenzivne debate o utjecaju Crkve na javne politike.

::: {.callout-note collapse="true"}
## Detaljna metodologija CSI indeksa

**Formula:**

$$
\text{CSI}_t = \text{normalize}_{0-100}\left(\frac{\text{count}_{crkva,t}}{N_t}\right)
$$

**Uključeni pojmovi:** crkva i politika, vjeronauk, križ u školama, sekularizam, klerikalizam, utjecaj Crkve na politiku

:::

### Migration Issue Index (MII)

MII mjeri intenzitet polarizacije oko tema vezanih uz migracije i izbjeglice. Vrhovi koincidiraju s migracijskim krizama ili političkim debatama o migrantima.

::: {.callout-note collapse="true"}
## Detaljna metodologija MII indeksa

**Formula:**

$$
\text{MII}_t = \text{normalize}_{0-100}\left(\frac{\text{count}_{migracije,t}}{N_t}\right)
$$

**Uključeni pojmovi:** migranti, izbjeglice, azilanti, anti migracija, sukobi vezani uz migrante

:::

### Disinformation Index (DII)

DII prati diskurs o lažnim vijestima, propagandi i informacijskom ratu. Visoke vrijednosti ukazuju na intenzivan diskurs o medijskoj manipulaciji i teorijama zavjere.

::: {.callout-note collapse="true"}
## Detaljna metodologija DII indeksa

**Formula:**

$$
\text{DII}_t = \text{normalize}_{0-100}\left(\frac{\text{count}_{dezinformacije,t}}{N_t}\right)
$$

**Uključeni pojmovi:** dezinformacije, lažne vijesti, fake news, propaganda, manipulacija, botovi, informacijski rat, teorije zavjere

:::

### Left Right Index (LRI)

LRI mjeri intenzitet ideološkog diskursa na lijevo desnom spektru. Visoke vrijednosti signaliziraju intenzivne ideološke debate o pozicioniranju na političkom spektru.

::: {.callout-note collapse="true"}
## Detaljna metodologija LRI indeksa

**Formula:**

$$
\text{LRI}_t = \text{normalize}_{0-100}\left(\frac{\text{count}_{lijevo\_desno,t}}{N_t}\right)
$$

**Uključeni pojmovi:** ljevica, desnica, lijevi, desni, konzervativci, liberali, progresivci, nacionalisti, populisti, suverenisti

:::

### Composite Polarization Index (CPI)

CPI predstavlja kompozitni indeks polarizacije koji agregira sve pojedinačne indekse u jednu mjeru ukupnog polarizacijskog diskursa. Izračunava se kao jednostavni prosjek svih 10 specijaliziranih indeksa čime se osigurava jednaka težina svakom aspektu polarizacije. Visoke vrijednosti indiciraju razdoblja intenzivnog polarizacijskog diskursa općenito.

::: {.callout-note collapse="true"}
## Detaljna metodologija CPI indeksa

**Formula:**

$$
\text{CPI}_t = \frac{1}{10} \sum_{i=1}^{10} \text{Indeks}_{i,t}
$$

**Interpretacija vrijednosti:**

Raspon 0 do 25 indicira nisku razinu polarizacijskog diskursa. Raspon 25 do 50 indicira umjerenu razinu. Raspon 50 do 75 indicira visoku razinu. Raspon 75 do 100 indicira vrlo visoku razinu tipičnu za krizna razdoblja.

:::

## Opis indeksa

```{r index-table-summary}
#| label: index-table-summary

index_desc <- data.table(
  Indeks = c("PPI", "PDI", "HSI", "HCI", "CWI", "CSI", "MII", "DII", "LRI", "IPI", "CPI"),
  Naziv = c("Political Polarization Index", "Party Division Index", "Hate Speech Index",
            "Historical Conflict Index", "Culture War Index", "Church State Index",
            "Migration Issue Index", "Disinformation Index", "Left Right Index",
            "Identity Politics Index", "Composite Polarization Index"),
  Opis = c("Opća razina polarizacijskog diskursa",
           "Intenzitet stranačkih sukoba",
           "Govor mržnje i netolerancija",
           "Povijesne podjele i traume",
           "Kulturni ratovi (rod, LGBT, pobačaj)",
           "Tenzije crkva država",
           "Polarizacija oko migracija",
           "Dezinformacije i propaganda",
           "Lijevo desni diskurs",
           "Identitetska politika",
           "Kompozitni indeks svih kategorija")
)

kable(index_desc, caption = "Pregled konstruiranih indeksa") %>%
  kable_styling(bootstrap_options = c("striped", "hover"), full_width = FALSE)
```

```{r index-calculation}
#| label: index-calculation

normalize <- function(x) {
  if (all(is.na(x))) return(rep(50, length(x)))
  min_x <- min(x, na.rm = TRUE)
  max_x <- max(x, na.rm = TRUE)
  if (max_x == min_x) return(rep(50, length(x)))
  (x - min_x) / (max_x - min_x) * 100
}

index_data <- dt[, .(
  volume = .N,
  avg_length = mean(text_length, na.rm = TRUE),
  avg_reach = if ("REACH" %in% names(.SD)) mean(REACH, na.rm = TRUE) else NA_real_,
  
  sem_polarizacija = sum(count_polarizacija_podjele, na.rm = TRUE),
  sem_lijevo_desno = sum(count_lijevo_desno, na.rm = TRUE),
  sem_stranacki = sum(count_stranacki_sukobi, na.rm = TRUE),
  sem_govor_mrznje = sum(count_govor_mrznje, na.rm = TRUE),
  sem_netolerancija = sum(count_netolerancija, na.rm = TRUE),
  sem_povijesni = sum(count_povijesni_sukobi, na.rm = TRUE),
  sem_rodna_lgbt = sum(count_rodna_lgbt, na.rm = TRUE),
  sem_pobacaj = sum(count_pobacaj_prolife, na.rm = TRUE),
  sem_crkva = sum(count_crkva_drzava, na.rm = TRUE),
  sem_migracije = sum(count_migracije, na.rm = TRUE),
  sem_dezinformacije = sum(count_dezinformacije, na.rm = TRUE),
  sem_identitetska = sum(count_identitetska_politika, na.rm = TRUE),
  sem_total = sum(count_all_semantic, na.rm = TRUE)
), by = yearmonth][order(yearmonth)]

index_data[, `:=`(
  PPI = normalize(sem_polarizacija / volume),
  PDI = normalize(sem_stranacki / volume),
  HSI = normalize((sem_govor_mrznje + sem_netolerancija) / volume),
  HCI = normalize(sem_povijesni / volume),
  CWI = normalize((sem_rodna_lgbt + sem_pobacaj) / volume),
  CSI = normalize(sem_crkva / volume),
  MII = normalize(sem_migracije / volume),
  DII = normalize(sem_dezinformacije / volume),
  LRI = normalize(sem_lijevo_desno / volume),
  IPI = normalize(sem_identitetska / volume)
)]

index_data[, CPI := (PPI + PDI + HSI + HCI + CWI + CSI + MII + DII + LRI + IPI) / 10]

index_cols <- c("PPI", "PDI", "HSI", "HCI", "CWI", "CSI", "MII", "DII", "LRI", "IPI", "CPI")
for (col in index_cols) {
  ma_col <- paste0(col, "_MA3")
  index_data[, (ma_col) := frollmean(get(col), n = 3, align = "center")]
}
```

# Vizualizacija indeksa

## Glavni indeksi

```{r cpi-plot}
#| label: cpi-plot
#| fig-cap: "Composite Polarization Index (CPI)"
#| fig-height: 7

ggplot(index_data, aes(x = yearmonth)) +
  geom_ribbon(aes(ymin = 0, ymax = CPI), fill = colors_gimes["secondary"], alpha = 0.3) +
  geom_line(aes(y = CPI), color = colors_gimes["secondary"], linewidth = 0.8, alpha = 0.5) +
  geom_line(aes(y = CPI_MA3), color = colors_gimes["primary"], linewidth = 1.2, na.rm = TRUE) +
  geom_point(aes(y = CPI_MA3), color = colors_gimes["primary"], size = 2, na.rm = TRUE) +
  scale_x_date(date_breaks = "3 months", date_labels = "%b\n%Y") +
  scale_y_continuous(limits = c(0, 100), breaks = seq(0, 100, 20)) +
  labs(
    title = "Composite Polarization Index (CPI)",
    subtitle = "Prosjek svih kategorija polarizacije (0 do 100) | Tamna linija = 3 mj. klizni prosjek",
    x = NULL,
    y = "CPI"
  )
```

## Indeksi političkih sukoba

```{r political-indices-plot}
#| label: political-indices-plot
#| fig-cap: "Indeksi političkih sukoba: PPI, PDI, LRI, IPI"
#| fig-height: 8

p_ppi <- ggplot(index_data, aes(x = yearmonth, y = PPI)) +
  geom_line(color = colors_gimes["primary"], linewidth = 1) +
  labs(title = "Political Polarization Index (PPI)", x = NULL, y = "Indeks (0 do 100)")

p_pdi <- ggplot(index_data, aes(x = yearmonth, y = PDI)) +
  geom_line(color = colors_gimes["secondary"], linewidth = 1) +
  labs(title = "Party Division Index (PDI)", x = NULL, y = "Indeks (0 do 100)")

p_lri <- ggplot(index_data, aes(x = yearmonth, y = LRI)) +
  geom_line(color = colors_gimes["accent"], linewidth = 1) +
  labs(title = "Left Right Index (LRI)", x = NULL, y = "Indeks (0 do 100)")

p_ipi <- ggplot(index_data, aes(x = yearmonth, y = IPI)) +
  geom_line(color = colors_gimes["purple"], linewidth = 1) +
  labs(title = "Identity Politics Index (IPI)", x = NULL, y = "Indeks (0 do 100)")

(p_ppi | p_pdi) / (p_lri | p_ipi)
```

## Indeksi društvenih sukoba

```{r social-indices-plot}
#| label: social-indices-plot
#| fig-cap: "Indeksi društvenih sukoba: HSI, HCI, CWI, CSI"
#| fig-height: 8

p_hsi <- ggplot(index_data, aes(x = yearmonth, y = HSI)) +
  geom_line(color = colors_gimes["danger"], linewidth = 1) +
  labs(title = "Hate Speech Index (HSI)", x = NULL, y = "Indeks (0 do 100)")

p_hci <- ggplot(index_data, aes(x = yearmonth, y = HCI)) +
  geom_line(color = colors_gimes["warning"], linewidth = 1) +
  labs(title = "Historical Conflict Index (HCI)", x = NULL, y = "Indeks (0 do 100)")

p_cwi <- ggplot(index_data, aes(x = yearmonth, y = CWI)) +
  geom_line(color = colors_gimes["success"], linewidth = 1) +
  labs(title = "Culture War Index (CWI)", x = NULL, y = "Indeks (0 do 100)")

p_csi <- ggplot(index_data, aes(x = yearmonth, y = CSI)) +
  geom_line(color = colors_gimes["teal"], linewidth = 1) +
  labs(title = "Church State Index (CSI)", x = NULL, y = "Indeks (0 do 100)")

(p_hsi | p_hci) / (p_cwi | p_csi)
```

## Indeksi specifičnih tema

```{r special-indices-plot}
#| label: special-indices-plot
#| fig-cap: "Migration Issue Index (MII) i Disinformation Index (DII)"
#| fig-height: 5

p_mii <- ggplot(index_data, aes(x = yearmonth, y = MII)) +
  geom_line(color = colors_gimes["muted"], linewidth = 1) +
  labs(title = "Migration Issue Index (MII)", x = NULL, y = "Indeks (0 do 100)")

p_dii <- ggplot(index_data, aes(x = yearmonth, y = DII)) +
  geom_line(color = colors_gimes["purple"], linewidth = 1) +
  labs(title = "Disinformation Index (DII)", x = NULL, y = "Indeks (0 do 100)")

p_mii | p_dii
```

## Tablica indeksa

```{r index-table}
#| label: index-table

index_labels <- c(
  "PPI" = "Political Polarization",
  "PDI" = "Party Division",
  "HSI" = "Hate Speech",
  "HCI" = "Historical Conflict",
  "CWI" = "Culture War",
  "CSI" = "Church State",
  "MII" = "Migration Issue",
  "DII" = "Disinformation",
  "LRI" = "Left Right",
  "IPI" = "Identity Politics"
)

index_table <- index_data[, .(
  Mjesec = format(yearmonth, "%b %Y"),
  `Broj članaka` = format(volume, big.mark = ","),
  CPI = round(CPI, 1),
  PPI = round(PPI, 1),
  PDI = round(PDI, 1),
  HSI = round(HSI, 1),
  HCI = round(HCI, 1),
  CWI = round(CWI, 1)
)]

kable(tail(index_table, 12), 
      caption = "Indeksi polarizacije: zadnjih 12 mjeseci",
      align = c("l", "r", rep("r", 6))) %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"), full_width = FALSE) %>%
  row_spec(0, bold = TRUE, background = colors_gimes["primary"], color = "white")
```

# Sektorska analiza

## Dinamika po sektorima

```{r sector-dynamics}
#| label: sector-dynamics
#| fig-cap: "Dinamika polarizacijskih kategorija po tipu izvora"
#| fig-height: 10

sector_monthly <- dt[, .(
  N = .N,
  polarizacija = sum(count_polarizacija_podjele, na.rm = TRUE),
  stranacki = sum(count_stranacki_sukobi, na.rm = TRUE),
  govor_mrznje = sum(count_govor_mrznje, na.rm = TRUE),
  povijesni = sum(count_povijesni_sukobi, na.rm = TRUE),
  kultura = sum(count_rodna_lgbt + count_pobacaj_prolife, na.rm = TRUE)
), by = .(yearmonth, source_category)][order(yearmonth)]

sector_long <- melt(sector_monthly, 
                    id.vars = c("yearmonth", "source_category", "N"),
                    variable.name = "kategorija",
                    value.name = "broj")

sector_labels <- c(
  "polarizacija" = "Polarizacija",
  "stranacki" = "Stranački sukobi",
  "govor_mrznje" = "Govor mržnje",
  "povijesni" = "Povijesni sukobi",
  "kultura" = "Kulturni ratovi"
)

sector_long[, kategorija_label := sector_labels[as.character(kategorija)]]

ggplot(sector_long, aes(x = yearmonth, y = broj, color = source_category)) +
  geom_line(linewidth = 0.8) +
  facet_wrap(~kategorija_label, ncol = 2, scales = "free_y") +
  scale_x_date(date_breaks = "6 months", date_labels = "%b %y") +
  scale_color_manual(values = c("national" = colors_gimes["primary"],
                                "business" = colors_gimes["accent"],
                                "regional" = colors_gimes["success"],
                                "specialized" = colors_gimes["warning"],
                                "opinion" = colors_gimes["secondary"])) +
  labs(
    title = "Dinamika polarizacijskih kategorija po tipu izvora",
    x = NULL,
    y = "Broj spominjanja",
    color = "Tip izvora"
  ) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, size = 7)
  )
```

## Heatmapa sektorske aktivnosti

```{r heatmap}
#| label: heatmap
#| fig-cap: "Heatmapa intenziteta polarizacijskih kategorija kroz vrijeme"
#| fig-height: 8

heatmap_data <- index_data[, .(yearmonth, PPI, PDI, HSI, HCI, CWI, CSI, MII, DII, LRI, IPI)]

heatmap_long <- melt(heatmap_data, 
                     id.vars = "yearmonth",
                     variable.name = "indeks",
                     value.name = "vrijednost")

heatmap_long[, indeks_label := index_labels[as.character(indeks)]]

ggplot(heatmap_long, aes(x = yearmonth, y = reorder(indeks_label, vrijednost), fill = vrijednost)) +
  geom_tile() +
  scale_fill_viridis_c(option = "plasma", name = "Intenzitet") +
  scale_x_date(date_breaks = "3 months", date_labels = "%b %y") +
  labs(
    title = "Heatmapa intenziteta polarizacijskih kategorija",
    subtitle = "Tamnije boje indiciraju viši intenzitet polarizacijskog diskursa",
    x = NULL,
    y = NULL
  ) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, size = 8),
    axis.text.y = element_text(size = 9),
    legend.position = "right"
  )
```

## Korelacijska struktura

```{r correlation-matrix}
#| label: correlation-matrix
#| fig-cap: "Korelacijska matrica indeksa polarizacije"
#| fig-height: 10

cor_vars <- c("PPI", "PDI", "HSI", "HCI", "CWI", "CSI", "MII", "DII", "LRI", "IPI", "CPI")
cor_data <- index_data[, .SD, .SDcols = cor_vars]
cor_matrix <- cor(cor_data, use = "pairwise.complete.obs")

corrplot(cor_matrix,
         method = "color",
         type = "upper",
         order = "hclust",
         tl.col = "black",
         tl.srt = 45,
         tl.cex = 0.8,
         addCoef.col = "black",
         number.cex = 0.6,
         col = colorRampPalette(c(colors_gimes["accent"], "white", colors_gimes["secondary"]))(100),
         title = "Korelacijska matrica indeksa polarizacije",
         mar = c(0, 0, 2, 0))
```

# Sentiment analiza

## Konstrukcija sentiment leksikona

```{r sentiment-lexicon}
#| label: sentiment-lexicon

sentiment_negative_stems <- c(
  "polarizacij[aeiou]*", "podjel[aeiou]*", "rascjep[a-zčćžšđ]*", "razdor[a-zčćžšđ]*",
  "sukob[a-zčćžšđ]*", "mr[zž]nj[aeiou]*", "netrpelj[a-zčćžšđ]*", "diskriminacij[a-zčćžšđ]*",
  "ksenofobij[a-zčćžšđ]*", "homofobij[a-zčćžšđ]*", "rasiz[a-zčćžšđ]*",
  "napad[a-zčćžšđ]*", "optu[zž][a-zčćžšđ]*", "kriz[aeiou]*", "konflikt[a-zčćžšđ]*"
)

sentiment_positive_stems <- c(
  "dijalog[a-zčćžšđ]*", "pomiren[a-zčćžšđ]*", "suradnj[aeiou]*", "konsenzus[a-zčćžšđ]*",
  "tolerancij[a-zčćžšđ]*", "ujedinjavanje", "razumijevanj[aeiou]*",
  "dogovor[a-zčćžšđ]*", "kompromis[a-zčćžšđ]*"
)

count_sentiment <- function(text, patterns) {
  if (is.na(text) || text == "") return(0)
  text_lower <- tolower(text)
  sum(sapply(patterns, function(p) stri_count_regex(text_lower, p)))
}

dt[, neg_count := sapply(FULL_TEXT, count_sentiment, patterns = sentiment_negative_stems)]
dt[, pos_count := sapply(FULL_TEXT, count_sentiment, patterns = sentiment_positive_stems)]
dt[, sentiment_score := (pos_count - neg_count) / (pos_count + neg_count + 1)]
dt[, AUTO_SENTIMENT := fcase(
  sentiment_score < -0.2, -1,
  sentiment_score > 0.2, 1,
  default = 0
)]
```

## Dinamika sentimenta kroz vrijeme

```{r sentiment-time}
#| label: sentiment-time
#| fig-cap: "Dinamika sentimenta kroz vrijeme"

sentiment_monthly <- dt[, .(
  avg_sentiment = mean(sentiment_score, na.rm = TRUE),
  N = .N,
  pct_negative = sum(AUTO_SENTIMENT == -1, na.rm = TRUE) / .N * 100,
  pct_positive = sum(AUTO_SENTIMENT == 1, na.rm = TRUE) / .N * 100,
  pct_neutral = sum(AUTO_SENTIMENT == 0, na.rm = TRUE) / .N * 100
), by = yearmonth][order(yearmonth)]

ggplot(sentiment_monthly, aes(x = yearmonth)) +
  geom_hline(yintercept = 0, color = "gray50", linetype = "dashed") +
  geom_ribbon(aes(ymin = pmin(avg_sentiment, 0), ymax = 0), 
              fill = colors_gimes["secondary"], alpha = 0.3) +
  geom_ribbon(aes(ymin = 0, ymax = pmax(avg_sentiment, 0)), 
              fill = colors_gimes["success"], alpha = 0.3) +
  geom_line(aes(y = avg_sentiment), color = colors_gimes["primary"], linewidth = 1.2) +
  geom_point(aes(y = avg_sentiment, size = N), color = colors_gimes["primary"], alpha = 0.6) +
  scale_x_date(date_breaks = "3 months", date_labels = "%b\n%Y") +
  scale_size_continuous(range = c(2, 6), labels = comma) +
  labs(
    title = "Prosječni sentiment članaka o polarizaciji kroz vrijeme",
    subtitle = "Negativne vrijednosti = konfliktni ton | Pozitivne vrijednosti = pomirljivi ton",
    x = NULL,
    y = "Prosječni sentiment",
    size = "Broj članaka"
  )
```

## Distribucija sentimenta

```{r sentiment-distribution}
#| label: sentiment-distribution
#| fig-cap: "Distribucija sentimenta članaka"

sentiment_dist <- dt[, .(N = .N), by = AUTO_SENTIMENT]
sentiment_dist[, Kategorija := fcase(
  AUTO_SENTIMENT == -1, "Negativan",
  AUTO_SENTIMENT == 0, "Neutralan",
  AUTO_SENTIMENT == 1, "Pozitivan"
)]

ggplot(sentiment_dist, aes(x = Kategorija, y = N, fill = Kategorija)) +
  geom_col(show.legend = FALSE) +
  geom_text(aes(label = paste0(format(N, big.mark = ","), "\n(", 
                               round(N/sum(N)*100, 1), "%)")), 
            vjust = -0.2, size = 4) +
  scale_fill_manual(values = c("Negativan" = colors_gimes["secondary"],
                               "Neutralan" = colors_gimes["light"],
                               "Pozitivan" = colors_gimes["success"])) +
  scale_y_continuous(labels = comma, expand = expansion(mult = c(0, 0.15))) +
  labs(
    title = "Distribucija sentimenta članaka o polarizaciji",
    x = NULL,
    y = "Broj članaka"
  )
```

# Volatilnost i momentum

## Konstrukcija volatilnosti i momentuma

```{r volatility-momentum}
#| label: volatility-momentum

index_data[, `:=`(
  CPI_vol_3m = frollapply(CPI, n = 3, FUN = sd, align = "right"),
  CPI_mom_1m = CPI - shift(CPI, 1),
  CPI_mom_3m = CPI - shift(CPI, 3)
)]

index_data[, `:=`(
  CPI_vol_3m_z = (CPI_vol_3m - mean(CPI_vol_3m, na.rm = TRUE)) / sd(CPI_vol_3m, na.rm = TRUE),
  CPI_mom_1m_z = (CPI_mom_1m - mean(CPI_mom_1m, na.rm = TRUE)) / sd(CPI_mom_1m, na.rm = TRUE),
  CPI_mom_3m_z = (CPI_mom_3m - mean(CPI_mom_3m, na.rm = TRUE)) / sd(CPI_mom_3m, na.rm = TRUE)
)]
```

```{r volatility-plot}
#| label: volatility-plot
#| fig-cap: "CPI volatilnost i momentum"
#| fig-height: 10

p_vol <- ggplot(index_data, aes(x = yearmonth, y = CPI_vol_3m)) +
  geom_line(color = colors_gimes["secondary"], linewidth = 1) +
  geom_hline(yintercept = mean(index_data$CPI_vol_3m, na.rm = TRUE), 
             linetype = "dashed", color = colors_gimes["muted"]) +
  labs(title = "CPI volatilnost (3M rolling SD)", x = NULL, y = "Volatilnost")

p_mom1 <- ggplot(index_data, aes(x = yearmonth, y = CPI_mom_1m)) +
  geom_col(aes(fill = CPI_mom_1m > 0), show.legend = FALSE) +
  scale_fill_manual(values = c("TRUE" = colors_gimes["success"], "FALSE" = colors_gimes["danger"])) +
  geom_hline(yintercept = 0, color = "gray50") +
  labs(title = "CPI momentum (M/M)", x = NULL, y = "Promjena")

p_mom3 <- ggplot(index_data, aes(x = yearmonth, y = CPI_mom_3m)) +
  geom_col(aes(fill = CPI_mom_3m > 0), show.legend = FALSE) +
  scale_fill_manual(values = c("TRUE" = colors_gimes["success"], "FALSE" = colors_gimes["danger"])) +
  geom_hline(yintercept = 0, color = "gray50") +
  labs(title = "CPI momentum (3M)", x = NULL, y = "Promjena")

p_vol / p_mom1 / p_mom3
```

```{r standardized-plot}
#| label: standardized-plot
#| fig-cap: "Standardizirani indeksi volatilnosti i momentuma"
#| fig-height: 6

std_long <- melt(
  index_data[, .(yearmonth, 
                 `Volatilnost (3M)` = CPI_vol_3m_z,
                 `Momentum (1M)` = CPI_mom_1m_z,
                 `Momentum (3M)` = CPI_mom_3m_z)],
  id.vars = "yearmonth",
  variable.name = "mjera",
  value.name = "z_vrijednost"
)

ggplot(std_long[!is.na(z_vrijednost)], aes(x = yearmonth, y = z_vrijednost, color = mjera)) +
  geom_hline(yintercept = 0, color = "gray50", linetype = "dashed") +
  geom_line(linewidth = 1) +
  scale_color_manual(values = c(
    "Volatilnost (3M)" = colors_gimes["secondary"],
    "Momentum (1M)" = colors_gimes["accent"],
    "Momentum (3M)" = colors_gimes["success"]
  )) +
  labs(
    title = "Standardizirani indeksi volatilnosti i momentuma (CPI)",
    subtitle = "Z vrijednosti omogućuju usporedbu različitih mjera",
    x = NULL,
    y = "Z vrijednost",
    color = NULL
  )
```

# Koncentracija tema

## Konstrukcija mjera koncentracije

::: {.callout-note collapse="true" title="Metodologija HHI indeksa"}

Herfindahl Hirschman Index (HHI) mjeri koncentraciju tema u medijskom prostoru. Izračunava se kao suma kvadrata udjela svake kategorije. Vrijednosti bliže 1 indiciraju visoku koncentraciju (dominacija jedne teme), dok vrijednosti bliže 0 indiciraju ravnomjerniju raspodjelu pozornosti.

**Formula:**

$$
\text{HHI}_t = \sum_{i=1}^{n} s_{i,t}^2
$$

gdje je $s_{i,t}$ udio kategorije $i$ u ukupnom broju spominjanja u mjesecu $t$.

:::

```{r hhi-calculation}
#| label: hhi-calculation

hhi_data <- monthly_semantic[, .(
  yearmonth,
  s_polarizacija = count_polarizacija_podjele / count_all_semantic,
  s_lijevo = count_lijevo_desno / count_all_semantic,
  s_stranacki = count_stranacki_sukobi / count_all_semantic,
  s_mrznja = count_govor_mrznje / count_all_semantic,
  s_netolerancija = count_netolerancija / count_all_semantic,
  s_povijesni = count_povijesni_sukobi / count_all_semantic,
  s_rodna = count_rodna_lgbt / count_all_semantic,
  s_pobacaj = count_pobacaj_prolife / count_all_semantic,
  s_crkva = count_crkva_drzava / count_all_semantic,
  s_migracije = count_migracije / count_all_semantic,
  s_dezinfo = count_dezinformacije / count_all_semantic,
  s_identitet = count_identitetska_politika / count_all_semantic
)]

share_cols <- names(hhi_data)[grepl("^s_", names(hhi_data))]
hhi_data[, HHI := rowSums(.SD^2, na.rm = TRUE), .SDcols = share_cols]

threshold <- 0.05
hhi_data[, n_active := rowSums(.SD > threshold, na.rm = TRUE), .SDcols = share_cols]

hhi_data[, HHI_norm := (HHI - (1/12)) / (1 - (1/12)) * 100]
hhi_data[, HHI_MA3 := frollmean(HHI_norm, n = 3, align = "center")]

index_data <- merge(index_data, hhi_data[, .(yearmonth, HHI, HHI_norm, n_active)], 
                    by = "yearmonth", all.x = TRUE)
```

```{r hhi-plot}
#| label: hhi-plot
#| fig-cap: "Koncentracija tema (HHI) i broj aktivnih kategorija"
#| fig-height: 8

p_hhi <- ggplot(hhi_data, aes(x = yearmonth)) +
  geom_line(aes(y = HHI_norm), color = colors_gimes["muted"], linewidth = 0.8) +
  geom_line(aes(y = HHI_MA3), color = colors_gimes["primary"], linewidth = 1.2, na.rm = TRUE) +
  labs(title = "Herfindahl Hirschman Index (HHI)", 
       subtitle = "Mjera koncentracije tema | Tamna linija = 3M klizni prosjek",
       x = NULL, y = "HHI (norm.)")

p_active <- ggplot(hhi_data, aes(x = yearmonth, y = n_active)) +
  geom_line(color = colors_gimes["accent"], linewidth = 1) +
  labs(title = "Broj aktivnih kategorija", 
       subtitle = "Kategorije s udjelom većim od 5%",
       x = NULL, y = "Broj kategorija")

p_hhi / p_active
```

# Korelacije između indeksa

```{r correlation-table}
#| label: correlation-table

cpi_correlations <- data.table(
  Indeks = cor_vars[cor_vars != "CPI"],
  Korelacija_s_CPI = sapply(cor_vars[cor_vars != "CPI"], function(x) {
    round(cor(index_data[[x]], index_data$CPI, use = "complete.obs"), 3)
  })
)[order(-Korelacija_s_CPI)]

kable(cpi_correlations, 
      col.names = c("Indeks", "Korelacija s CPI"),
      caption = "Korelacije pojedinačnih indeksa s Composite Polarization Index") %>%
  kable_styling(bootstrap_options = c("striped", "hover"), full_width = FALSE)
```

# Export

```{r export-excel}
#| label: export-excel

wb <- createWorkbook()

export_indices <- index_data[, .(
  Datum = yearmonth,
  Godina = year(yearmonth),
  Mjesec = month(yearmonth),
  Broj_clanaka = volume,
  CPI = round(CPI, 2),
  CPI_MA3 = round(CPI_MA3, 2),
  PPI = round(PPI, 2),
  PDI = round(PDI, 2),
  HSI = round(HSI, 2),
  HCI = round(HCI, 2),
  CWI = round(CWI, 2),
  CSI = round(CSI, 2),
  MII = round(MII, 2),
  DII = round(DII, 2),
  LRI = round(LRI, 2),
  IPI = round(IPI, 2)
)]

addWorksheet(wb, "Indeksi")
writeData(wb, "Indeksi", export_indices)

header_style <- createStyle(
  textDecoration = "bold",
  fgFill = "#2C3E50",
  fontColour = "white",
  halign = "center"
)
addStyle(wb, "Indeksi", header_style, rows = 1, cols = 1:ncol(export_indices))
setColWidths(wb, "Indeksi", cols = 1:ncol(export_indices), widths = "auto")

semantic_export <- monthly_semantic[, .(
  Datum = yearmonth,
  Broj_clanaka = N,
  Polarizacija_podjele = count_polarizacija_podjele,
  Lijevo_desno = count_lijevo_desno,
  Stranacki_sukobi = count_stranacki_sukobi,
  Govor_mrznje = count_govor_mrznje,
  Netolerancija = count_netolerancija,
  Povijesni_sukobi = count_povijesni_sukobi,
  Rodna_LGBT = count_rodna_lgbt,
  Pobacaj_prolife = count_pobacaj_prolife,
  Crkva_drzava = count_crkva_drzava,
  Migracije = count_migracije,
  Dezinformacije = count_dezinformacije,
  Identitetska_politika = count_identitetska_politika,
  Ukupno = count_all_semantic
)]

addWorksheet(wb, "Semanticke_kategorije")
writeData(wb, "Semanticke_kategorije", semantic_export)
addStyle(wb, "Semanticke_kategorije", header_style, rows = 1, cols = 1:ncol(semantic_export))
setColWidths(wb, "Semanticke_kategorije", cols = 1:ncol(semantic_export), widths = "auto")

dynamics_export <- index_data[, .(
  Datum = yearmonth,
  CPI = round(CPI, 2),
  CPI_vol_3m = round(CPI_vol_3m, 2),
  CPI_mom_1m = round(CPI_mom_1m, 2),
  CPI_mom_3m = round(CPI_mom_3m, 2)
)]

addWorksheet(wb, "Dinamike")
writeData(wb, "Dinamike", dynamics_export)
addStyle(wb, "Dinamike", header_style, rows = 1, cols = 1:ncol(dynamics_export))
setColWidths(wb, "Dinamike", cols = 1:ncol(dynamics_export), widths = "auto")

cor_export <- as.data.table(cor_matrix, keep.rownames = "Indeks")

addWorksheet(wb, "Korelacije")
writeData(wb, "Korelacije", cor_export)
addStyle(wb, "Korelacije", header_style, rows = 1, cols = 1:ncol(cor_export))
setColWidths(wb, "Korelacije", cols = 1:ncol(cor_export), widths = "auto")

output_path <- here("output", "gimes_polarization_indices.xlsx")
dir.create(here("output"), showWarnings = FALSE, recursive = TRUE)
saveWorkbook(wb, output_path, overwrite = TRUE)

message("Excel datoteka spremljena: ", output_path)
```

# Sažetak

```{r summary-findings}
#| label: summary-findings

peak_month <- index_data[which.max(CPI), yearmonth]
peak_value <- index_data[which.max(CPI), CPI]

all_indices <- c("PPI", "PDI", "HSI", "HCI", "CWI", "CSI", "MII", "DII", "LRI", "IPI")
category_means <- colMeans(index_data[, .SD, .SDcols = all_indices], na.rm = TRUE)
dominant_category <- names(which.max(category_means))

findings <- data.table(
  Nalaz = c(
    "Ukupno analiziranih članaka",
    "Vremenski raspon analize",
    "Broj izvora",
    "",
    "Vrh CPI indeksa",
    "Vrijednost vrha",
    "",
    "Dominantna kategorija",
    "Prosječna vrijednost",
    "",
    "Prosječni CPI",
    "Standardna devijacija CPI"
  ),
  Vrijednost = c(
    format(nrow(dt), big.mark = ","),
    paste(format(min(dt$date), "%m/%Y"), " do ", format(max(dt$date), "%m/%Y")),
    as.character(length(unique(dt$FROM))),
    "",
    format(peak_month, "%B %Y"),
    round(peak_value, 1),
    "",
    index_labels[dominant_category],
    round(category_means[dominant_category], 1),
    "",
    round(mean(index_data$CPI, na.rm = TRUE), 1),
    round(sd(index_data$CPI, na.rm = TRUE), 1)
  )
)

kable(findings, caption = "Sažetak ključnih nalaza analize") %>%
  kable_styling(bootstrap_options = c("striped", "hover"), full_width = FALSE) %>%
  row_spec(c(4, 7, 10), background = colors_gimes["light"])
```

---

*Izvještaj generiran: `r Sys.time()`*

*GIMES Research | Analiza medijske pokrivenosti političke polarizacije v2.0*
