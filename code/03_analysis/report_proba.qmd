---
title: "Semantički indeks inflacije"
subtitle: "Nova metodologija mjerenja inflacijskih očekivanja kroz analizu medijskog diskursa"
author: "GIMES Research"
date: today
format:
  html:
    toc: true
    toc-depth: 4
    toc-location: left
    number-sections: true
    theme: cosmo
    code-fold: true
    code-summary: "Prikaži kod"
    fig-width: 11
    fig-height: 7
    df-print: paged
    embed-resources: true
execute:
  warning: false
  message: false
lang: hr
---

```{r setup}
#| label: setup
#| include: false

library(data.table)
library(ggplot2)
library(scales)
library(lubridate)
library(stringi)
library(knitr)
library(kableExtra)
library(zoo)
library(openxlsx)
library(eurostat)
library(here)
library(forecast)
library(lmtest)
library(sandwich)
library(corrplot)
library(patchwork)
library(viridis)

options(scipen = 999)
theme_set(theme_minimal(base_size = 12))

pal <- list(
  dark = "#1a1a2e",
  primary = "#16213e",
  accent = "#0f3460",
  highlight = "#e94560",
  warm = "#f39c12",
  cool = "#3498db",
  success = "#27ae60",
  muted = "#7f8c8d",
  light = "#ecf0f1"
)
```

# Uvod i motivacija

## Zašto semantički pristup

Tradicionalni pristupi mjerenju inflacijskih očekivanja oslanjaju se na ankete (potrošačke i poslovne) ili financijske instrumente (inflation swaps, TIPS spreads). Ovi pristupi imaju ograničenja: ankete su rijetke i subjektivne, a financijski instrumenti odražavaju očekivanja sofisticiranih investitora.

Medijski diskurs nudi alternativni prozor u javnu percepciju inflacije. Hipoteza je da semantička struktura medijskog izvještavanja o inflaciji sadrži informacije koje mogu:

1. **Pratiti** stvarnu inflaciju s visokom korelacijom
2. **Predvidjeti** buduće inflacijske trendove (leading indicator)
3. **Objašnjavati** formiranje inflacijskih očekivanja u javnosti
4. **Identificirati** strukturne promjene u inflacijskom režimu

## Istraživačka pitanja

Ovaj izvještaj istražuje sljedeća pitanja:

- Može li semantička struktura medijskog diskursa bolje pratiti inflaciju nego jednostavan volumen članaka?
- Koje semantičke dimenzije (kategorije pojmova) imaju najveću prediktivnu moć?
- Postoje li asimetrije u medijskoj reakciji na rastuću vs padajuću inflaciju?
- Može li se konstruirati nowcasting model inflacije temeljen na semantičkim podacima?
- Koji je optimalni vremenski pomak između medijske pozornosti i službene inflacije?

```{r load-data}
#| label: load-data

dt <- as.data.table(read.xlsx(here("data", "inflacija_filtered.xlsx")))

if(is.numeric(dt$DATE)) {
  dt[, DATE := as.Date(DATE, origin = "1899-12-30")]
} else {
  dt[, DATE := as.Date(DATE)]
}

if("text_length" %in% names(dt)) dt[, text_length := as.numeric(text_length)]
if("REACH" %in% names(dt)) dt[, REACH := as.numeric(REACH)]

dt[, `:=`(
  date = DATE,
  year = year(DATE),
  month = month(DATE),
  yearmonth = floor_date(DATE, "month")
)]

dt <- dt[date <= as.Date("2024-11-01")]
```

# Prošireni semantički rječnik

## Taksonomija inflacijskih pojmova

Razvijamo hijerarhijsku taksonomiju pojmova organiziranu u tri razine:

1. **Makro kategorije**: široke tematske skupine
2. **Meso kategorije**: specifične podteme
3. **Mikro pojmovi**: individualni termini i fraze

```{r extended-dictionary}
#| label: extended-dictionary

semantic_taxonomy <- list(
  
  # === RAZINA 1: INFLACIJSKI FENOMEN ===
  inflacija_core = list(
    direktno = c("inflacij[a-zčćžšđ]*", "dezinflacij[a-zčćžšđ]*", 
                 "hiperinflacij[a-zčćžšđ]*", "stagflacij[a-zčćžšđ]*"),
    mjere = c("hicp", "cpi", "indeks.{0,15}potroš[a-zčćžšđ]*", 
              "harmoniziran[a-zčćžšđ]*.{0,10}indeks",
              "bazn[a-zčćžšđ]*.{0,10}inflacij[a-zčćžšđ]*",
              "jezgren[a-zčćžšđ]*.{0,10}inflacij[a-zčćžšđ]*",
              "stopa.{0,10}inflacij[a-zčćžšđ]*"),
    dinamika = c("rast.{0,10}inflacij[a-zčćžšđ]*", "pad.{0,10}inflacij[a-zčćžšđ]*",
                 "ubrzanj[a-zčćžšđ]*.{0,10}inflacij[a-zčćžšđ]*",
                 "usporavanje.{0,10}inflacij[a-zčćžšđ]*",
                 "vrhunac.{0,10}inflacij[a-zčćžšđ]*")
  ),
  
  # === RAZINA 2: CIJENE I TROŠKOVI ===
  cijene = list(
    opce = c("poskupljenj[a-zčćžšđ]*", "pojeftinjenj[a-zčćžšđ]*",
             "porast.{0,10}cijen[a-zčćžšđ]*", "pad.{0,10}cijen[a-zčćžšđ]*",
             "skok.{0,10}cijen[a-zčćžšđ]*", "rast.{0,10}cijen[a-zčćžšđ]*",
             "skupoc[a-zčćžšđ]*", "jeftin[a-zčćžšđ]*"),
    energenti = c("cijen[a-zčćžšđ]*.{0,15}energij[a-zčćžšđ]*",
                  "cijen[a-zčćžšđ]*.{0,15}struj[a-zčćžšđ]*",
                  "cijen[a-zčćžšđ]*.{0,15}plin[a-zčćžšđ]*",
                  "cijen[a-zčćžšđ]*.{0,15}naft[a-zčćžšđ]*",
                  "cijen[a-zčćžšđ]*.{0,15}goriva",
                  "cijen[a-zčćžšđ]*.{0,15}benzin[a-zčćžšđ]*",
                  "cijen[a-zčćžšđ]*.{0,15}dizel[a-zčćžšđ]*"),
    hrana = c("cijen[a-zčćžšđ]*.{0,15}hran[a-zčćžšđ]*",
              "cijen[a-zčćžšđ]*.{0,15}namirnic[a-zčćžšđ]*",
              "cijen[a-zčćžšđ]*.{0,15}kruh[a-zčćžšđ]*",
              "cijen[a-zčćžšđ]*.{0,15}mlijeka",
              "cijen[a-zčćžšđ]*.{0,15}mesa",
              "cijen[a-zčćžšđ]*.{0,15}voća",
              "cijen[a-zčćžšđ]*.{0,15}povrća"),
    stanovanje = c("cijen[a-zčćžšđ]*.{0,15}nekretnin[a-zčćžšđ]*",
                   "cijen[a-zčćžšđ]*.{0,15}stan[a-zčćžšđ]*",
                   "najamnin[a-zčćžšđ]*", "renta",
                   "komunalij[a-zčćžšđ]*", "režij[a-zčćžšđ]*"),
    usluge = c("cijen[a-zčćžšđ]*.{0,15}uslug[a-zčćžšđ]*",
               "cijen[a-zčćžšđ]*.{0,15}prijevoz[a-zčćžšđ]*",
               "cijen[a-zčćžšđ]*.{0,15}zdravstv[a-zčćžšđ]*",
               "cijen[a-zčćžšđ]*.{0,15}obrazovanj[a-zčćžšđ]*")
  ),
  
  # === RAZINA 3: EKONOMSKI KONTEKST ===
  ekonomski_kontekst = list(
    zivotni_standard = c("životn[a-zčćžšđ]*.{0,10}standard[a-zčćžšđ]*",
                         "kupovn[a-zčćžšđ]*.{0,10}moć[a-zčćžšđ]*",
                         "troškov[a-zčćžšđ]*.{0,10}život[a-zčćžšđ]*",
                         "egzistencij[a-zčćžšđ]*",
                         "siromaštv[a-zčćžšđ]*"),
    place = c("plać[a-zčćžšđ]*", "primanj[a-zčćžšđ]*",
              "mirovn[a-zčćžšđ]*", "penzi[a-zčćžšđ]*",
              "realn[a-zčćžšđ]*.{0,10}plać[a-zčćžšđ]*",
              "nominal[a-zčćžšđ]*.{0,10}plać[a-zčćžšđ]*",
              "rast.{0,10}plać[a-zčćžšđ]*",
              "povećanj[a-zčćžšđ]*.{0,10}plać[a-zčćžšđ]*"),
    potrosnja = c("potroš[a-zčćžšđ]*", "potrošač[a-zčćžšđ]*",
                  "košaric[a-zčćžšđ]*", "kupnj[a-zčćžšđ]*")
  ),
  
  # === RAZINA 4: MONETARNA POLITIKA ===
  monetarna_politika = list(
    institucije = c("hnb", "hrvatska.{0,10}narodna.{0,10}banka",
                    "ecb", "europska.{0,10}središnja.{0,10}banka",
                    "fed", "federal[a-zčćžšđ]*.{0,10}rezerv[a-zčćžšđ]*"),
    instrumenti = c("kamatn[a-zčćžšđ]*.{0,10}stop[a-zčćžšđ]*",
                    "kamat[a-zčćžšđ]*", "referenctn[a-zčćžšđ]*.{0,10}stop[a-zčćžšđ]*",
                    "eskontna.{0,10}stop[a-zčćžšđ]*",
                    "repo.{0,10}stop[a-zčćžšđ]*"),
    mjere = c("monetarn[a-zčćžšđ]*.{0,10}politik[a-zčćžšđ]*",
              "kvantitativn[a-zčćžšđ]*.{0,10}popuštanj[a-zčćžšđ]*",
              "zaoštravan[a-zčćžšđ]*.{0,10}monetarn[a-zčćžšđ]*",
              "restriktivn[a-zčćžšđ]*.{0,10}politik[a-zčćžšđ]*")
  ),
  
  # === RAZINA 5: FISKALNA POLITIKA ===
  fiskalna_politika = list(
    mjere = c("fiskaln[a-zčćžšđ]*.{0,10}politik[a-zčćžšđ]*",
              "proračun[a-zčćžšđ]*", "budžet[a-zčćžšđ]*",
              "subvencij[a-zčćžšđ]*", "potpor[a-zčćžšđ]*",
              "pomoć.{0,10}građan[a-zčćžšđ]*"),
    porezi = c("pdv", "porez[a-zčćžšđ]*", "trošarin[a-zčćžšđ]*",
               "akciz[a-zčćžšđ]*"),
    intervencije = c("zamrzavanj[a-zčćžšđ]*.{0,10}cijen[a-zčćžšđ]*",
                     "ograničenj[a-zčćžšđ]*.{0,10}cijen[a-zčćžšđ]*",
                     "kontrola.{0,10}cijen[a-zčćžšđ]*",
                     "regulacij[a-zčćžšđ]*.{0,10}cijen[a-zčćžšđ]*")
  ),
  
  # === RAZINA 6: UZROCI I ŠOKOVI ===
  uzroci = list(
    eksterni = c("energetsk[a-zčćžšđ]*.{0,10}kriz[a-zčćžšđ]*",
                 "ruska.{0,10}invazij[a-zčćžšđ]*",
                 "rat.{0,10}ukrajin[a-zčćžšđ]*",
                 "sankcij[a-zčćžšđ]*",
                 "lanc[a-zčćžšđ]*.{0,10}opskrb[a-zčćžšđ]*",
                 "supply.{0,10}chain",
                 "uvoz[a-zčćžšđ]*.{0,10}inflacij[a-zčćžšđ]*"),
    interni = c("domaći[a-zčćžšđ]*.{0,10}potražnj[a-zčćžšđ]*",
                "pregrijavanje.{0,10}ekonomij[a-zčćžšđ]*",
                "novčan[a-zčćžšđ]*.{0,10}mas[a-zčćžšđ]*"),
    strukturni = c("profit[a-zčćžšđ]*.{0,10}marž[a-zčćžšđ]*",
                   "greedflation",
                   "tržišn[a-zčćžšđ]*.{0,10}moć[a-zčćžšđ]*",
                   "monopol[a-zčćžšđ]*")
  ),
  
  # === RAZINA 7: OČEKIVANJA I BUDUĆNOST ===
  ocekivanja = list(
    forward_looking = c("očekivanj[a-zčćžšđ]*.{0,10}inflacij[a-zčćžšđ]*",
                        "prognoz[a-zčćžšđ]*.{0,10}inflacij[a-zčćžšđ]*",
                        "projekcij[a-zčćžšđ]*",
                        "predviđanj[a-zčćžšđ]*",
                        "očekuj[a-zčćžšđ]*.{0,10}rast",
                        "očekuj[a-zčćžšđ]*.{0,10}pad"),
    uncertainty = c("neizvjesnost[a-zčćžšđ]*", "rizik[a-zčćžšđ]*",
                    "volatilnost[a-zčćžšđ]*", "nepredvidiv[a-zčćžšđ]*"),
    targets = c("ciljn[a-zčćžšđ]*.{0,10}inflacij[a-zčćžšđ]*",
                "2.{0,5}posto", "dva.{0,5}posto",
                "cilj.{0,10}ecb", "cilj.{0,10}hnb")
  ),
  
  # === RAZINA 8: SENTIMENT I INTENZITET ===
  sentiment = list(
    negativni = c("kriz[a-zčćžšđ]*", "alarm[a-zčćžšđ]*",
                  "panik[a-zčćžšđ]*", "strah[a-zčćžšđ]*",
                  "katastof[a-zčćžšđ]*", "kolab[a-zčćžšđ]*",
                  "dramatičn[a-zčćžšđ]*", "šok[a-zčćžšđ]*"),
    pozitivni = c("stabilizacij[a-zčćžšđ]*", "normalizacij[a-zčćžšđ]*",
                  "poboljšanj[a-zčćžšđ]*", "oporavak[a-zčćžšđ]*",
                  "kontrola", "ublažavanj[a-zčćžšđ]*"),
    intenzitet = c("rekord[a-zčćžšđ]*", "povijesn[a-zčćžšđ]*",
                   "dosad.{0,10}neviđen[a-zčćžšđ]*",
                   "najviš[a-zčćžšđ]*", "najniž[a-zčćžšđ]*",
                   "eksplozij[a-zčćžšđ]*", "drastičn[a-zčćžšđ]*")
  ),
  
  # === RAZINA 9: EURO I MEĐUNARODNI KONTEKST ===
  medjunarodno = list(
    eurozona = c("euro", "eur", "euroz[a-zčćžšđ]*",
                 "europsk[a-zčćžšđ]*.{0,10}unij[a-zčćžšđ]*",
                 "eu.{0,5}inflacij[a-zčćžšđ]*"),
    usporedba = c("njemačk[a-zčćžšđ]*", "austrij[a-zčćžšđ]*",
                  "sloveni[a-zčćžšđ]*", "mađarsk[a-zčćžšđ]*",
                  "srbi[a-zčćžšđ]*", "region[a-zčćžšđ]*")
  )
)

# Flatten taxonomy za brojanje
flatten_taxonomy <- function(taxonomy) {
  result <- list()
  for(macro in names(taxonomy)) {
    for(meso in names(taxonomy[[macro]])) {
      key <- paste0(macro, "_", meso)
      result[[key]] <- taxonomy[[macro]][[meso]]
    }
  }
  result
}

flat_terms <- flatten_taxonomy(semantic_taxonomy)

# Prikaži strukturu taksonomije
tax_summary <- data.table(
  Makro_kategorija = character(),
  Meso_kategorija = character(),
  Broj_pojmova = integer()
)

for(macro in names(semantic_taxonomy)) {
  for(meso in names(semantic_taxonomy[[macro]])) {
    tax_summary <- rbind(tax_summary, data.table(
      Makro_kategorija = macro,
      Meso_kategorija = meso,
      Broj_pojmova = length(semantic_taxonomy[[macro]][[meso]])
    ))
  }
}

kable(tax_summary, caption = "Struktura semantičke taksonomije") %>%
  kable_styling(bootstrap_options = c("striped", "hover"), full_width = FALSE) %>%
  pack_rows(index = table(tax_summary$Makro_kategorija))
```

## Brojanje pojmova

```{r count-all-terms}
#| label: count-all-terms

count_patterns <- function(text, patterns) {
  if(is.na(text) || text == "") return(0)
  text_lower <- tolower(text)
  sum(sapply(patterns, function(p) stri_count_regex(text_lower, p)))
}

# Broji sve kategorije
for(cat_name in names(flat_terms)) {
  col_name <- paste0("sem_", cat_name)
  dt[, (col_name) := sapply(FULL_TEXT, count_patterns, patterns = flat_terms[[cat_name]])]
}

# Izračunaj agregatne mjere po makro kategorijama
macro_categories <- unique(tax_summary$Makro_kategorija)

for(macro in macro_categories) {
  meso_cats <- tax_summary[Makro_kategorija == macro, Meso_kategorija]
  col_names <- paste0("sem_", macro, "_", meso_cats)
  existing_cols <- col_names[col_names %in% names(dt)]
  if(length(existing_cols) > 0) {
    dt[, paste0("macro_", macro) := rowSums(.SD, na.rm = TRUE), .SDcols = existing_cols]
  }
}

# Ukupni semantički score
sem_cols <- names(dt)[grepl("^sem_", names(dt))]
dt[, semantic_total := rowSums(.SD, na.rm = TRUE), .SDcols = sem_cols]
```

# Konstrukcija semantičkog indeksa

## Metodološki pristupi

Razvijamo nekoliko alternativnih pristupa konstrukciji semantičkog indeksa:

### Pristup 1: Jednostavni agregatni indeks (SAI)

Zbroj svih semantičkih pojmova, normaliziran.

### Pristup 2: Ponderirani semantički indeks (WSI)

Pojmovi su ponderirani prema njihovoj korelaciji s inflacijom.

### Pristup 3: Faktorski semantički indeks (FSI)

Koristi principal component analysis za redukciju dimenzija.

### Pristup 4: Kompozitni leading indeks (CLI)

Kombinira samo kategorije koje pokazuju leading svojstva.

```{r aggregate-monthly}
#| label: aggregate-monthly

# Mjesečna agregacija svih semantičkih varijabli
sem_cols_all <- c(sem_cols, names(dt)[grepl("^macro_", names(dt))], "semantic_total")

monthly <- dt[, c(
  .(N = .N,
    avg_length = mean(text_length, na.rm = TRUE)),
  lapply(.SD, sum, na.rm = TRUE)
), by = yearmonth, .SDcols = sem_cols_all][order(yearmonth)]

# Dodaj per-article prosjeke
for(col in sem_cols_all) {
  monthly[, paste0(col, "_avg") := get(col) / N]
}
```

## Dohvaćanje službenih podataka o inflaciji

```{r get-official-data}
#| label: get-official-data

get_eurostat_safe <- function() {
  tryCatch({
    hicp <- get_eurostat("prc_hicp_manr", 
                         filters = list(geo = "HR", coicop = "CP00", unit = "RCH_A"),
                         time_format = "date")
    setDT(hicp)
    headline <- hicp[time >= "2021-01-01" & time <= "2024-11-01", 
                     .(yearmonth = time, hicp_yoy = values)]
    
    core <- get_eurostat("prc_hicp_manr",
                        filters = list(geo = "HR", coicop = "CP00XEF", unit = "RCH_A"),
                        time_format = "date")
    setDT(core)
    core_data <- core[time >= "2021-01-01" & time <= "2024-11-01",
                      .(yearmonth = time, core_yoy = values)]
    
    # Dohvati mjesečne indekse za M/m izračun
    hicp_idx <- get_eurostat("prc_hicp_midx",
                             filters = list(geo = "HR", coicop = "CP00", unit = "I15"),
                             time_format = "date")
    setDT(hicp_idx)
    idx_data <- hicp_idx[time >= "2020-12-01" & time <= "2024-11-01",
                         .(yearmonth = time, hicp_index = values)]
    
    result <- merge(headline, core_data, by = "yearmonth", all = TRUE)
    result <- merge(result, idx_data, by = "yearmonth", all = TRUE)
    
    # Izračunaj M/m promjenu
    result <- result[order(yearmonth)]
    result[, hicp_mom := (hicp_index / shift(hicp_index, 1) - 1) * 100]
    
    return(result)
    
  }, error = function(e) {
    message("Eurostat API error, using backup data")
    data.table(
      yearmonth = seq(as.Date("2021-01-01"), as.Date("2024-11-01"), by = "month"),
      hicp_yoy = c(0.2, 0.6, 0.8, 1.9, 2.4, 2.3, 2.6, 3.0, 3.3, 3.8, 4.8, 5.5,
                   5.8, 6.3, 7.3, 9.4, 10.8, 12.1, 12.3, 12.4, 12.8, 13.0, 13.0, 12.7,
                   12.0, 11.1, 10.5, 9.2, 8.4, 8.2, 7.3, 7.7, 7.1, 5.3, 4.9, 4.7,
                   4.3, 4.0, 3.9, 3.7, 3.6, 3.4, 3.2, 2.9, 2.8, 2.6, 2.4),
      core_yoy = c(0.5, 0.8, 1.0, 1.5, 1.8, 1.9, 2.0, 2.2, 2.4, 2.7, 3.2, 3.8,
                   4.2, 4.8, 5.6, 6.8, 7.9, 8.7, 8.9, 9.1, 9.4, 9.8, 10.2, 10.5,
                   10.8, 10.5, 10.0, 9.2, 8.5, 8.0, 7.2, 7.4, 7.0, 6.2, 5.8, 5.5,
                   5.2, 4.9, 4.6, 4.3, 4.1, 3.8, 3.5, 3.3, 3.2, 3.0, 2.9),
      hicp_mom = c(NA, 0.4, 0.3, 0.5, 0.3, 0.2, 0.1, 0.3, 0.4, 0.5, 0.6, 0.4,
                   0.5, 0.8, 1.2, 2.1, 1.5, 1.2, 0.8, 0.4, 0.3, 0.2, 0.1, -0.2,
                   0.3, 0.4, 0.5, 0.3, 0.2, 0.1, -0.1, 0.3, 0.2, 0.1, 0.2, 0.1,
                   0.2, 0.3, 0.2, 0.1, 0.2, 0.1, 0.1, 0.1, 0.2, 0.1, 0.1)
    )
  })
}

inflation_data <- get_eurostat_safe()

# Spoji s mjesečnim podacima
analysis <- merge(monthly, inflation_data, by = "yearmonth", all.x = TRUE)
```

## Konstrukcija indeksa

```{r construct-indices}
#| label: construct-indices

normalize_01 <- function(x) {
  if(all(is.na(x))) return(rep(0.5, length(x)))
  (x - min(x, na.rm = TRUE)) / (max(x, na.rm = TRUE) - min(x, na.rm = TRUE))
}

normalize_zscore <- function(x) {
  if(all(is.na(x))) return(rep(0, length(x)))
  (x - mean(x, na.rm = TRUE)) / sd(x, na.rm = TRUE)
}

# === INDEKS 1: Simple Aggregate Index (SAI) ===
analysis[, SAI := normalize_01(semantic_total) * 100]

# === INDEKS 2: Weighted Semantic Index (WSI) ===
# Korelacije kategorija s inflacijom za pondere
macro_cols <- names(analysis)[grepl("^macro_", names(analysis))]
correlations_with_hicp <- sapply(macro_cols, function(col) {
  cor(analysis[[col]], analysis$hicp_yoy, use = "complete.obs")
})

# Normaliziraj pondere (samo pozitivne korelacije)
weights <- pmax(correlations_with_hicp, 0)
weights <- weights / sum(weights)

analysis[, WSI := {
  weighted_sum <- 0
  for(i in seq_along(macro_cols)) {
    weighted_sum <- weighted_sum + normalize_01(get(macro_cols[i])) * weights[i]
  }
  weighted_sum * 100
}]

# === INDEKS 3: Principal Component Index (PCI) ===
pca_data <- analysis[, .SD, .SDcols = macro_cols]
pca_data <- pca_data[complete.cases(pca_data)]

if(nrow(pca_data) > 10) {
  pca_result <- prcomp(pca_data, scale. = TRUE)
  pc1_loadings <- pca_result$rotation[,1]
  
  # Ako PC1 negativno korelira s inflacijom, invertiraj
  pc1_scores <- as.numeric(scale(as.matrix(analysis[, .SD, .SDcols = macro_cols]) %*% pc1_loadings))
  if(cor(pc1_scores, analysis$hicp_yoy, use = "complete.obs") < 0) {
    pc1_scores <- -pc1_scores
  }
  analysis[, PCI := normalize_01(pc1_scores) * 100]
} else {
  analysis[, PCI := SAI]
}

# === INDEKS 4: Composite Leading Index (CLI) ===
# Identificiraj leading kategorije (korelacija s lag inflacijom)
leading_cats <- c()
for(col in macro_cols) {
  # Korelacija sa inflacijom sljedeći mjesec
  cor_lead <- cor(analysis[[col]][1:(nrow(analysis)-1)], 
                  analysis$hicp_yoy[2:nrow(analysis)], 
                  use = "complete.obs")
  if(!is.na(cor_lead) && cor_lead > 0.3) {
    leading_cats <- c(leading_cats, col)
  }
}

if(length(leading_cats) > 0) {
  analysis[, CLI := rowMeans(.SD, na.rm = TRUE), .SDcols = leading_cats]
  analysis[, CLI := normalize_01(CLI) * 100]
} else {
  analysis[, CLI := SAI]
}

# Klizni prosjeci
for(idx in c("SAI", "WSI", "PCI", "CLI")) {
  analysis[, paste0(idx, "_MA3") := frollmean(get(idx), n = 3, align = "center")]
}
```

## Usporedba indeksa

```{r compare-indices}
#| label: compare-indices
#| fig-cap: "Usporedba semantičkih indeksa s HICP inflacijom"
#| fig-height: 10

# Skaliraj indekse za usporedbu
scale_factor <- max(analysis$hicp_yoy, na.rm = TRUE) / 100

indices_long <- melt(
  analysis[, .(yearmonth, 
               SAI = SAI * scale_factor,
               WSI = WSI * scale_factor,
               PCI = PCI * scale_factor,
               CLI = CLI * scale_factor,
               HICP = hicp_yoy)],
  id.vars = "yearmonth",
  variable.name = "indeks",
  value.name = "vrijednost"
)

ggplot(indices_long, aes(x = yearmonth, y = vrijednost, color = indeks)) +
  geom_line(data = indices_long[indeks != "HICP"], linewidth = 0.8, alpha = 0.7) +
  geom_line(data = indices_long[indeks == "HICP"], linewidth = 1.5) +
  scale_color_manual(values = c(
    "SAI" = pal$cool,
    "WSI" = pal$success,
    "PCI" = pal$warm,
    "CLI" = pal$accent,
    "HICP" = pal$highlight
  )) +
  scale_x_date(date_breaks = "3 months", date_labels = "%b\n%Y") +
  labs(
    title = "Usporedba semantičkih indeksa s HICP inflacijom",
    subtitle = "Svi indeksi skalirani na raspon HICP-a za vizualnu usporedbu",
    x = NULL,
    y = "Vrijednost (skalirano)",
    color = "Indeks"
  ) +
  theme(legend.position = "bottom")
```

## Performanse indeksa

```{r index-performance}
#| label: index-performance

performance <- data.table(
  Indeks = c("SAI", "WSI", "PCI", "CLI"),
  Korelacija_HICP = numeric(4),
  Korelacija_Core = numeric(4),
  RMSE = numeric(4),
  MAE = numeric(4)
)

for(i in 1:4) {
  idx_name <- performance$Indeks[i]
  idx_scaled <- analysis[[idx_name]] * scale_factor
  
  performance[i, Korelacija_HICP := round(cor(idx_scaled, analysis$hicp_yoy, use = "complete.obs"), 3)]
  performance[i, Korelacija_Core := round(cor(idx_scaled, analysis$core_yoy, use = "complete.obs"), 3)]
  
  complete_idx <- which(!is.na(idx_scaled) & !is.na(analysis$hicp_yoy))
  performance[i, RMSE := round(sqrt(mean((idx_scaled[complete_idx] - analysis$hicp_yoy[complete_idx])^2)), 2)]
  performance[i, MAE := round(mean(abs(idx_scaled[complete_idx] - analysis$hicp_yoy[complete_idx])), 2)]
}

kable(performance, caption = "Performanse semantičkih indeksa") %>%
  kable_styling(bootstrap_options = c("striped", "hover"), full_width = FALSE) %>%
  row_spec(which.max(performance$Korelacija_HICP), bold = TRUE, background = pal$success)
```

# Analiza dimenzija semantičkog prostora

## Korelacijska matrica kategorija

```{r correlation-matrix}
#| label: correlation-matrix
#| fig-cap: "Korelacijska matrica makro kategorija"
#| fig-height: 8

cor_matrix <- cor(analysis[, .SD, .SDcols = macro_cols], use = "pairwise.complete.obs")

# Dodaj HICP za usporedbu
extended_data <- cbind(
  analysis[, .SD, .SDcols = macro_cols],
  hicp_yoy = analysis$hicp_yoy
)
cor_matrix_ext <- cor(extended_data, use = "pairwise.complete.obs")

corrplot(cor_matrix_ext, 
         method = "color",
         type = "upper",
         order = "hclust",
         tl.col = "black",
         tl.srt = 45,
         tl.cex = 0.8,
         addCoef.col = "black",
         number.cex = 0.6,
         col = colorRampPalette(c(pal$cool, "white", pal$highlight))(100),
         title = "Korelacijska matrica semantičkih kategorija i HICP",
         mar = c(0,0,2,0))
```

## Doprinos kategorija inflaciji

```{r category-contribution}
#| label: category-contribution
#| fig-cap: "Korelacije semantičkih kategorija s HICP inflacijom"

cat_correlations <- data.table(
  Kategorija = macro_cols,
  Korelacija = sapply(macro_cols, function(col) {
    cor(analysis[[col]], analysis$hicp_yoy, use = "complete.obs")
  })
)[order(-Korelacija)]

cat_correlations[, Kategorija := gsub("macro_", "", Kategorija)]

ggplot(cat_correlations, aes(x = reorder(Kategorija, Korelacija), y = Korelacija)) +
  geom_col(aes(fill = Korelacija > 0.5), show.legend = FALSE) +
  geom_text(aes(label = round(Korelacija, 2)), hjust = -0.1, size = 3.5) +
  coord_flip() +
  scale_fill_manual(values = c("TRUE" = pal$success, "FALSE" = pal$cool)) +
  scale_y_continuous(limits = c(0, 1), expand = expansion(mult = c(0, 0.15))) +
  labs(
    title = "Korelacije semantičkih makro kategorija s HICP inflacijom",
    x = NULL,
    y = "Pearsonova korelacija"
  ) +
  theme(plot.title = element_text(face = "bold"))
```

## Vremenska dinamika kategorija

```{r category-dynamics}
#| label: category-dynamics
#| fig-cap: "Dinamika semantičkih kategorija kroz vrijeme"
#| fig-height: 12

macro_long <- melt(
  analysis[, c("yearmonth", macro_cols), with = FALSE],
  id.vars = "yearmonth",
  variable.name = "kategorija",
  value.name = "vrijednost"
)

macro_long[, kategorija := gsub("macro_", "", kategorija)]

# Normaliziraj unutar svake kategorije za usporedbu
macro_long[, vrijednost_norm := normalize_01(vrijednost) * 100, by = kategorija]

ggplot(macro_long, aes(x = yearmonth, y = vrijednost_norm)) +
  geom_line(color = pal$primary, linewidth = 0.8) +
  geom_smooth(method = "loess", se = FALSE, color = pal$highlight, linewidth = 1) +
  facet_wrap(~kategorija, ncol = 3, scales = "free_y") +
  scale_x_date(date_breaks = "1 year", date_labels = "%Y") +
  labs(
    title = "Dinamika semantičkih kategorija kroz vrijeme",
    subtitle = "Normalizirane vrijednosti (0-100) s LOESS trendom",
    x = NULL,
    y = "Indeks (0-100)"
  ) +
  theme(
    strip.text = element_text(face = "bold", size = 9),
    axis.text.x = element_text(angle = 45, hjust = 1)
  )
```

# Analiza vremenskih pomaka (Lead/Lag)

## Cross-correlation funkcije

```{r ccf-analysis}
#| label: ccf-analysis
#| fig-cap: "Cross-correlation analiza: Semantički indeks vs HICP"
#| fig-height: 8

# Izračunaj CCF za svaki indeks
ccf_results <- list()

for(idx in c("SAI", "WSI", "PCI", "CLI")) {
  idx_data <- analysis[[idx]]
  hicp_data <- analysis$hicp_yoy
  
  complete_idx <- which(!is.na(idx_data) & !is.na(hicp_data))
  
  if(length(complete_idx) > 20) {
    ccf_obj <- ccf(idx_data[complete_idx], hicp_data[complete_idx], 
                   lag.max = 6, plot = FALSE)
    ccf_results[[idx]] <- data.table(
      indeks = idx,
      lag = as.numeric(ccf_obj$lag),
      correlation = as.numeric(ccf_obj$acf)
    )
  }
}

ccf_df <- rbindlist(ccf_results)

ggplot(ccf_df, aes(x = lag, y = correlation, fill = indeks)) +
  geom_col(position = position_dodge(width = 0.7), alpha = 0.8) +
  geom_hline(yintercept = 0, color = "gray50") +
  geom_hline(yintercept = c(-0.2, 0.2), linetype = "dashed", color = "gray70") +
  facet_wrap(~indeks, ncol = 2) +
  scale_fill_manual(values = c(
    "SAI" = pal$cool,
    "WSI" = pal$success,
    "PCI" = pal$warm,
    "CLI" = pal$accent
  )) +
  scale_x_continuous(breaks = -6:6) +
  labs(
    title = "Cross-correlation: Semantički indeksi vs HICP",
    subtitle = "Negativni lag = semantički indeks predvodi HICP | Pozitivni lag = prati HICP",
    x = "Vremenski pomak (mjeseci)",
    y = "Korelacija"
  ) +
  theme(legend.position = "none")
```

## Optimalni pomaci po kategorijama

```{r optimal-lags}
#| label: optimal-lags

find_optimal_lag <- function(x, y, max_lag = 6) {
  complete_idx <- which(!is.na(x) & !is.na(y))
  if(length(complete_idx) < 15) return(list(lag = NA, cor = NA))
  
  best_cor <- -Inf
  best_lag <- 0
  
  for(lag in (-max_lag):max_lag) {
    if(lag < 0) {
      x_shifted <- x[1:(length(x) + lag)]
      y_aligned <- y[(abs(lag) + 1):length(y)]
    } else if(lag > 0) {
      x_shifted <- x[(lag + 1):length(x)]
      y_aligned <- y[1:(length(y) - lag)]
    } else {
      x_shifted <- x
      y_aligned <- y
    }
    
    cor_val <- cor(x_shifted, y_aligned, use = "complete.obs")
    if(!is.na(cor_val) && cor_val > best_cor) {
      best_cor <- cor_val
      best_lag <- lag
    }
  }
  
  list(lag = best_lag, cor = best_cor)
}

# Nađi optimalne pomake za sve kategorije
lag_analysis <- data.table(
  Kategorija = c(macro_cols, "SAI", "WSI", "PCI", "CLI"),
  Optimalni_lag = numeric(length(macro_cols) + 4),
  Max_korelacija = numeric(length(macro_cols) + 4)
)

for(i in 1:nrow(lag_analysis)) {
  cat_name <- lag_analysis$Kategorija[i]
  opt <- find_optimal_lag(analysis[[cat_name]], analysis$hicp_yoy)
  lag_analysis[i, `:=`(Optimalni_lag = opt$lag, Max_korelacija = round(opt$cor, 3))]
}

lag_analysis[, Kategorija := gsub("macro_", "", Kategorija)]
lag_analysis <- lag_analysis[order(-Max_korelacija)]

lag_analysis[, Interpretacija := fcase(
  Optimalni_lag < 0, paste0("Predvodi HICP za ", abs(Optimalni_lag), " mj."),
  Optimalni_lag > 0, paste0("Prati HICP za ", Optimalni_lag, " mj."),
  default = "Istovremeno"
)]

kable(lag_analysis, caption = "Optimalni vremenski pomaci semantičkih kategorija") %>%
  kable_styling(bootstrap_options = c("striped", "hover"), full_width = FALSE) %>%
  row_spec(which(lag_analysis$Optimalni_lag < 0), background = "#d4edda")
```

# Analiza asimetrije

## Asimetrija u medijskoj reakciji

Istražujemo razlikuje li se medijska reakcija na rastuću vs padajuću inflaciju.

```{r asymmetry-analysis}
#| label: asymmetry-analysis
#| fig-cap: "Asimetrija medijske reakcije na promjene inflacije"
#| fig-height: 8

# Identificiraj periode rasta i pada inflacije
analysis[, hicp_change := hicp_yoy - shift(hicp_yoy, 1)]
analysis[, inflation_regime := fcase(
  hicp_change > 0.5, "Rast",
  hicp_change < -0.5, "Pad",
  default = "Stabilno"
)]

# Izračunaj prosječnu semantičku reakciju po režimu
regime_analysis <- analysis[!is.na(inflation_regime), .(
  Prosjecni_SAI = mean(SAI, na.rm = TRUE),
  Prosjecni_WSI = mean(WSI, na.rm = TRUE),
  Prosjecna_promjena_SAI = mean(SAI - shift(SAI, 1), na.rm = TRUE),
  Broj_mjeseci = .N
), by = inflation_regime]

kable(regime_analysis, caption = "Semantička reakcija po inflacijskom režimu", digits = 2) %>%
  kable_styling(bootstrap_options = c("striped", "hover"), full_width = FALSE)
```

```{r asymmetry-plot}
#| label: asymmetry-plot
#| fig-cap: "Distribucija semantičkog indeksa po inflacijskom režimu"

ggplot(analysis[!is.na(inflation_regime)], 
       aes(x = inflation_regime, y = SAI, fill = inflation_regime)) +
  geom_boxplot(alpha = 0.7) +
  geom_jitter(width = 0.2, alpha = 0.5, size = 2) +
  scale_fill_manual(values = c(
    "Rast" = pal$highlight,
    "Pad" = pal$success,
    "Stabilno" = pal$muted
  )) +
  labs(
    title = "Distribucija semantičkog indeksa po inflacijskom režimu",
    subtitle = "Rast = HICP MoM > 0.5pp | Pad = HICP MoM < -0.5pp",
    x = "Inflacijski režim",
    y = "SAI (Simple Aggregate Index)"
  ) +
  theme(legend.position = "none")
```

## Kvantilna regresija

```{r quantile-analysis}
#| label: quantile-analysis
#| fig-cap: "Odnos semantičkog indeksa i inflacije po kvantilima"
#| fig-height: 7

# Podijeli HICP u kvantile
analysis[, hicp_quantile := cut(hicp_yoy, 
                                 breaks = quantile(hicp_yoy, probs = c(0, 0.25, 0.5, 0.75, 1), na.rm = TRUE),
                                 labels = c("Q1 (niska)", "Q2", "Q3", "Q4 (visoka)"),
                                 include.lowest = TRUE)]

ggplot(analysis[!is.na(hicp_quantile)], 
       aes(x = SAI, y = hicp_yoy, color = hicp_quantile)) +
  geom_point(size = 3, alpha = 0.7) +
  geom_smooth(method = "lm", se = FALSE, linewidth = 1.2) +
  scale_color_viridis_d(option = "plasma") +
  labs(
    title = "Odnos semantičkog indeksa i inflacije po kvantilima",
    x = "SAI (Simple Aggregate Index)",
    y = "HICP Y/Y (%)",
    color = "HICP kvantil"
  ) +
  theme(legend.position = "bottom")
```

# Nowcasting model

## Konstrukcija nowcasting modela

Cilj je predvidjeti tekuću inflaciju koristeći semantičke podatke koji su dostupni u realnom vremenu (prije objave službenih statistika).

```{r nowcasting-model}
#| label: nowcasting-model

# Pripremi podatke za model
model_data <- analysis[!is.na(hicp_yoy) & !is.na(SAI)]

# Bazni model: samo lagirani HICP (AR1)
model_ar1 <- lm(hicp_yoy ~ shift(hicp_yoy, 1), data = model_data)

# Model s semantičkim podacima
model_semantic <- lm(hicp_yoy ~ shift(hicp_yoy, 1) + SAI + WSI, data = model_data)

# Model s kategorijama
formula_cats <- as.formula(paste("hicp_yoy ~ shift(hicp_yoy, 1) +", 
                                  paste(macro_cols[1:min(5, length(macro_cols))], collapse = " + ")))
model_cats <- lm(formula_cats, data = model_data)

# Usporedba modela
model_comparison <- data.table(
  Model = c("AR(1) - samo lagirani HICP",
            "AR(1) + Semantički indeksi (SAI, WSI)",
            "AR(1) + Top 5 kategorija"),
  R2 = c(
    round(summary(model_ar1)$r.squared, 3),
    round(summary(model_semantic)$r.squared, 3),
    round(summary(model_cats)$r.squared, 3)
  ),
  Adj_R2 = c(
    round(summary(model_ar1)$adj.r.squared, 3),
    round(summary(model_semantic)$adj.r.squared, 3),
    round(summary(model_cats)$adj.r.squared, 3)
  ),
  AIC = c(
    round(AIC(model_ar1), 1),
    round(AIC(model_semantic), 1),
    round(AIC(model_cats), 1)
  )
)

kable(model_comparison, caption = "Usporedba nowcasting modela") %>%
  kable_styling(bootstrap_options = c("striped", "hover"), full_width = FALSE) %>%
  row_spec(which.min(model_comparison$AIC), bold = TRUE, background = pal$success)
```

## Fitted vs Actual

```{r nowcast-plot}
#| label: nowcast-plot
#| fig-cap: "Nowcasting model: Fitted vs Actual inflacija"
#| fig-height: 7

model_data[, fitted_ar1 := predict(model_ar1, newdata = model_data)]
model_data[, fitted_semantic := predict(model_semantic, newdata = model_data)]

nowcast_long <- melt(
  model_data[, .(yearmonth, 
                 Actual = hicp_yoy,
                 `AR(1)` = fitted_ar1,
                 `AR(1) + Semantic` = fitted_semantic)],
  id.vars = "yearmonth",
  variable.name = "model",
  value.name = "vrijednost"
)

ggplot(nowcast_long, aes(x = yearmonth, y = vrijednost, color = model)) +
  geom_line(linewidth = 1) +
  scale_color_manual(values = c(
    "Actual" = pal$dark,
    "AR(1)" = pal$muted,
    "AR(1) + Semantic" = pal$highlight
  )) +
  scale_x_date(date_breaks = "3 months", date_labels = "%b\n%Y") +
  labs(
    title = "Nowcasting model: Usporedba s AR(1) benchmarkom",
    subtitle = "Dodavanje semantičkih podataka poboljšava predikciju",
    x = NULL,
    y = "HICP Y/Y (%)",
    color = "Model"
  ) +
  theme(legend.position = "bottom")
```

## Out-of-sample validacija

```{r oos-validation}
#| label: oos-validation

# Rolling window out-of-sample forecast
window_size <- 24
n_forecasts <- nrow(model_data) - window_size

if(n_forecasts > 6) {
  oos_results <- data.table(
    yearmonth = model_data$yearmonth[(window_size + 1):nrow(model_data)],
    actual = model_data$hicp_yoy[(window_size + 1):nrow(model_data)],
    forecast_ar1 = numeric(n_forecasts),
    forecast_semantic = numeric(n_forecasts)
  )
  
  for(i in 1:n_forecasts) {
    train_idx <- i:(i + window_size - 1)
    test_idx <- i + window_size
    
    train_data <- model_data[train_idx]
    
    # AR1 model
    m_ar1 <- lm(hicp_yoy ~ shift(hicp_yoy, 1), data = train_data)
    oos_results$forecast_ar1[i] <- predict(m_ar1, newdata = model_data[test_idx])
    
    # Semantic model
    m_sem <- lm(hicp_yoy ~ shift(hicp_yoy, 1) + SAI, data = train_data)
    oos_results$forecast_semantic[i] <- predict(m_sem, newdata = model_data[test_idx])
  }
  
  oos_results[, error_ar1 := actual - forecast_ar1]
  oos_results[, error_semantic := actual - forecast_semantic]
  
  oos_performance <- data.table(
    Model = c("AR(1)", "AR(1) + Semantic"),
    RMSE = c(
      round(sqrt(mean(oos_results$error_ar1^2, na.rm = TRUE)), 3),
      round(sqrt(mean(oos_results$error_semantic^2, na.rm = TRUE)), 3)
    ),
    MAE = c(
      round(mean(abs(oos_results$error_ar1), na.rm = TRUE), 3),
      round(mean(abs(oos_results$error_semantic), na.rm = TRUE), 3)
    )
  )
  
  kable(oos_performance, caption = "Out-of-sample performanse (rolling window)") %>%
    kable_styling(bootstrap_options = c("striped", "hover"), full_width = FALSE)
}
```

# Analiza strukturnih promjena

## Detekcija režima

```{r regime-detection}
#| label: regime-detection
#| fig-cap: "Detekcija strukturnih promjena u odnosu semantika-inflacija"
#| fig-height: 8

# Izračunaj rolling korelaciju (ručno jer frollapply ne podržava matrice)
window_size_cor <- 12
analysis[, rolling_cor := {
  n <- .N
  result <- rep(NA_real_, n)
  for(i in window_size_cor:n) {
    idx <- (i - window_size_cor + 1):i
    if(sum(!is.na(SAI[idx]) & !is.na(hicp_yoy[idx])) >= 6) {
      result[i] <- cor(SAI[idx], hicp_yoy[idx], use = "complete.obs")
    }
  }
  result
}]

# Identificiraj strukturne promjene
analysis[, regime := fcase(
  yearmonth < as.Date("2022-01-01"), "Pre-inflacijski",
  yearmonth >= as.Date("2022-01-01") & yearmonth < as.Date("2023-01-01"), "Inflacijski šok",
  yearmonth >= as.Date("2023-01-01") & yearmonth < as.Date("2024-01-01"), "Vrhunac i pad",
  default = "Normalizacija"
)]

p1 <- ggplot(analysis, aes(x = yearmonth)) +
  geom_rect(aes(fill = regime), 
            xmin = -Inf, xmax = Inf, ymin = -Inf, ymax = Inf, alpha = 0.3) +
  geom_line(aes(y = normalize_01(SAI) * max(hicp_yoy, na.rm = TRUE)), 
            color = pal$cool, linewidth = 1) +
  geom_line(aes(y = hicp_yoy), color = pal$highlight, linewidth = 1.2) +
  scale_fill_manual(values = c(
    "Pre-inflacijski" = pal$success,
    "Inflacijski šok" = pal$highlight,
    "Vrhunac i pad" = pal$warm,
    "Normalizacija" = pal$cool
  )) +
  scale_x_date(date_breaks = "6 months", date_labels = "%b %Y") +
  labs(
    title = "Semantički indeks i HICP kroz različite režime",
    x = NULL,
    y = "Vrijednost",
    fill = "Režim"
  ) +
  theme(legend.position = "bottom")

p2 <- ggplot(analysis[!is.na(rolling_cor)], aes(x = yearmonth, y = rolling_cor)) +
  geom_line(color = pal$primary, linewidth = 1) +
  geom_hline(yintercept = 0, linetype = "dashed", color = pal$muted) +
  geom_smooth(method = "loess", se = TRUE, color = pal$highlight, fill = pal$highlight, alpha = 0.2) +
  scale_x_date(date_breaks = "6 months", date_labels = "%b %Y") +
  labs(
    title = "Rolling korelacija (12 mjeseci) SAI vs HICP",
    x = NULL,
    y = "Korelacija"
  )

p1 / p2
```

## Korelacije po režimima

```{r regime-correlations}
#| label: regime-correlations

regime_stats <- analysis[!is.na(regime), .(
  N = .N,
  Prosjecni_HICP = round(mean(hicp_yoy, na.rm = TRUE), 1),
  Prosjecni_SAI = round(mean(SAI, na.rm = TRUE), 1),
  Korelacija = round(cor(SAI, hicp_yoy, use = "complete.obs"), 3)
), by = regime]

kable(regime_stats, caption = "Statistike po inflacijskim režimima") %>%
  kable_styling(bootstrap_options = c("striped", "hover"), full_width = FALSE)
```

# Semantička brzina i akceleracija

## Definicija semantičke brzine

Semantička brzina mjeri stopu promjene medijske pozornosti, dok akceleracija mjeri promjenu brzine.

```{r semantic-velocity}
#| label: semantic-velocity
#| fig-cap: "Semantička brzina i akceleracija"
#| fig-height: 10

# Brzina = prva derivacija (M/M promjena)
analysis[, SAI_velocity := SAI - shift(SAI, 1)]

# Akceleracija = druga derivacija
analysis[, SAI_acceleration := SAI_velocity - shift(SAI_velocity, 1)]

# Isto za HICP
analysis[, hicp_velocity := hicp_yoy - shift(hicp_yoy, 1)]

# Vizualizacija
p_velocity <- ggplot(analysis, aes(x = yearmonth)) +
  geom_hline(yintercept = 0, color = pal$muted, linetype = "dashed") +
  geom_line(aes(y = SAI_velocity, color = "Semantička brzina"), linewidth = 1) +
  geom_line(aes(y = hicp_velocity * 5, color = "HICP brzina (x5)"), linewidth = 1) +
  scale_color_manual(values = c(
    "Semantička brzina" = pal$cool,
    "HICP brzina (x5)" = pal$highlight
  )) +
  scale_x_date(date_breaks = "6 months", date_labels = "%b %Y") +
  labs(
    title = "Semantička vs HICP brzina (M/M promjena)",
    x = NULL,
    y = "Promjena",
    color = NULL
  ) +
  theme(legend.position = "bottom")

p_accel <- ggplot(analysis, aes(x = yearmonth)) +
  geom_hline(yintercept = 0, color = pal$muted, linetype = "dashed") +
  geom_area(aes(y = SAI_acceleration), fill = pal$cool, alpha = 0.5) +
  geom_line(aes(y = SAI_acceleration), color = pal$primary, linewidth = 1) +
  scale_x_date(date_breaks = "6 months", date_labels = "%b %Y") +
  labs(
    title = "Semantička akceleracija (promjena brzine)",
    subtitle = "Pozitivno = ubrzanje medijske pozornosti | Negativno = usporavanje",
    x = NULL,
    y = "Akceleracija"
  )

p_velocity / p_accel
```

## Korelacija brzina

```{r velocity-correlation}
#| label: velocity-correlation

vel_cor <- cor(analysis$SAI_velocity, analysis$hicp_velocity, use = "complete.obs")

cat(sprintf("Korelacija semantičke i HICP brzine: r = %.3f\n", vel_cor))

# Test prediktivnosti brzine
velocity_lags <- sapply(-3:3, function(lag) {
  if(lag < 0) {
    x <- analysis$SAI_velocity[1:(nrow(analysis) + lag)]
    y <- analysis$hicp_velocity[(abs(lag) + 1):nrow(analysis)]
  } else if(lag > 0) {
    x <- analysis$SAI_velocity[(lag + 1):nrow(analysis)]
    y <- analysis$hicp_velocity[1:(nrow(analysis) - lag)]
  } else {
    x <- analysis$SAI_velocity
    y <- analysis$hicp_velocity
  }
  cor(x, y, use = "complete.obs")
})

velocity_lag_df <- data.table(
  Lag = -3:3,
  Korelacija = round(velocity_lags, 3)
)

kable(velocity_lag_df, caption = "Korelacije brzina s različitim pomacima") %>%
  kable_styling(bootstrap_options = c("striped", "hover"), full_width = FALSE)
```

# Semantička širina vs dubina

## Definicija mjera

**Širina** = broj aktiviranih kategorija (diverzifikacija medijske pozornosti)

**Dubina** = intenzitet unutar aktiviranih kategorija

```{r breadth-depth}
#| label: breadth-depth
#| fig-cap: "Semantička širina vs dubina kroz vrijeme"
#| fig-height: 9

# Izračunaj širinu (broj kategorija iznad praga)
threshold <- 10  # Minimalan broj spominjanja za "aktiviranu" kategoriju

analysis[, semantic_breadth := rowSums(sapply(.SD, function(x) x > threshold)), 
         .SDcols = macro_cols]

# Izračunaj dubinu (prosječna vrijednost aktiviranih kategorija)
analysis[, semantic_depth := {
  active <- .SD[, lapply(.SD, function(x) ifelse(x > threshold, x, NA))]
  rowMeans(active, na.rm = TRUE)
}, .SDcols = macro_cols]

# Vizualizacija
p_breadth <- ggplot(analysis, aes(x = yearmonth)) +
  geom_line(aes(y = semantic_breadth), color = pal$cool, linewidth = 1) +
  geom_smooth(aes(y = semantic_breadth), method = "loess", 
              color = pal$highlight, se = FALSE, linewidth = 1.2) +
  scale_x_date(date_breaks = "6 months", date_labels = "%b %Y") +
  labs(
    title = "Semantička širina (broj aktivnih kategorija)",
    x = NULL,
    y = "Broj kategorija"
  )

p_depth <- ggplot(analysis, aes(x = yearmonth)) +
  geom_line(aes(y = semantic_depth), color = pal$warm, linewidth = 1) +
  geom_smooth(aes(y = semantic_depth), method = "loess", 
              color = pal$highlight, se = FALSE, linewidth = 1.2) +
  scale_x_date(date_breaks = "6 months", date_labels = "%b %Y") +
  labs(
    title = "Semantička dubina (intenzitet aktivnih kategorija)",
    x = NULL,
    y = "Prosječni intenzitet"
  )

p_scatter <- ggplot(analysis, aes(x = semantic_breadth, y = semantic_depth, color = hicp_yoy)) +
  geom_point(size = 3, alpha = 0.7) +
  scale_color_viridis_c(option = "plasma") +
  labs(
    title = "Odnos širine i dubine",
    x = "Širina (broj kategorija)",
    y = "Dubina (intenzitet)",
    color = "HICP (%)"
  )

(p_breadth / p_depth) | p_scatter
```

# Granger uzročnost

## Testiranje Granger uzročnosti

```{r granger-test}
#| label: granger-test

# Pripremi podatke kao vremenski niz
complete_data <- analysis[!is.na(SAI) & !is.na(hicp_yoy)]

if(nrow(complete_data) > 30) {
  # Test: SAI Granger-uzrokuje HICP?
  granger_sai_hicp <- grangertest(hicp_yoy ~ SAI, order = 3, data = complete_data)
  
  # Test: HICP Granger-uzrokuje SAI?
  granger_hicp_sai <- grangertest(SAI ~ hicp_yoy, order = 3, data = complete_data)
  
  granger_results <- data.table(
    Test = c("SAI → HICP", "HICP → SAI"),
    F_statistika = c(
      round(granger_sai_hicp$F[2], 3),
      round(granger_hicp_sai$F[2], 3)
    ),
    P_vrijednost = c(
      round(granger_sai_hicp$`Pr(>F)`[2], 4),
      round(granger_hicp_sai$`Pr(>F)`[2], 4)
    ),
    Značajno_5pct = c(
      ifelse(granger_sai_hicp$`Pr(>F)`[2] < 0.05, "Da", "Ne"),
      ifelse(granger_hicp_sai$`Pr(>F)`[2] < 0.05, "Da", "Ne")
    )
  )
  
  kable(granger_results, caption = "Granger uzročnost (lag = 3 mjeseca)") %>%
    kable_styling(bootstrap_options = c("striped", "hover"), full_width = FALSE)
}
```

# Export podataka

```{r export-excel}
#| label: export-excel

# Kreiraj workbook s više sheetova
wb <- createWorkbook()

# Sheet 1: Glavni podaci
addWorksheet(wb, "Glavni_podaci")
export_main <- analysis[, .(
  Datum = yearmonth,
  Broj_clanaka = N,
  SAI, WSI, PCI, CLI,
  HICP_YoY = hicp_yoy,
  HICP_Core = core_yoy,
  HICP_MoM = hicp_mom,
  SAI_brzina = SAI_velocity,
  SAI_akceleracija = SAI_acceleration,
  Sirina = semantic_breadth,
  Dubina = semantic_depth,
  Rezim = regime
)]
writeData(wb, "Glavni_podaci", export_main)

# Sheet 2: Sve kategorije
addWorksheet(wb, "Kategorije")
export_cats <- analysis[, c("yearmonth", macro_cols), with = FALSE]
names(export_cats) <- c("Datum", gsub("macro_", "", macro_cols))
writeData(wb, "Kategorije", export_cats)

# Sheet 3: Performanse
addWorksheet(wb, "Performanse")
writeData(wb, "Performanse", performance)

# Sheet 4: Lag analiza
addWorksheet(wb, "Lag_analiza")
writeData(wb, "Lag_analiza", lag_analysis)

# Sheet 5: Korelacije
addWorksheet(wb, "Korelacije")
cor_export <- data.table(
  Kategorija = c(macro_cols, "SAI", "WSI", "PCI", "CLI"),
  Korelacija_HICP = sapply(c(macro_cols, "SAI", "WSI", "PCI", "CLI"), 
                           function(x) round(cor(analysis[[x]], analysis$hicp_yoy, use = "complete.obs"), 3))
)
writeData(wb, "Korelacije", cor_export)

# Stilovi
header_style <- createStyle(
  textDecoration = "bold",
  fgFill = "#1a1a2e",
  fontColour = "white",
  halign = "center"
)

for(sheet in names(wb)) {
  addStyle(wb, sheet, header_style, rows = 1, cols = 1:20, gridExpand = TRUE)
  setColWidths(wb, sheet, cols = 1:20, widths = "auto")
}

# Spremi
output_path <- here("output", "semantic_inflation_research.xlsx")
dir.create(here("output"), showWarnings = FALSE, recursive = TRUE)
saveWorkbook(wb, output_path, overwrite = TRUE)
message("Excel exportiran: ", output_path)
```

# Zaključci

## Ključni nalazi

```{r summary}
#| label: summary

best_idx <- performance[which.max(Korelacija_HICP), Indeks]
best_cor <- performance[which.max(Korelacija_HICP), Korelacija_HICP]
best_leading <- lag_analysis[Optimalni_lag < 0][which.max(Max_korelacija)]

summary_findings <- data.table(
  Nalaz = c(
    "Najbolji semantički indeks",
    "Korelacija s HICP",
    "Najbolja leading kategorija",
    "Lead vrijeme",
    "Granger uzročnost (SAI → HICP)",
    "Improvement over AR(1)",
    "Broj analiziranih članaka",
    "Vremenski raspon"
  ),
  Rezultat = c(
    best_idx,
    as.character(best_cor),
    best_leading$Kategorija,
    paste0(abs(best_leading$Optimalni_lag), " mjeseca"),
    ifelse(exists("granger_results") && granger_results[1, P_vrijednost] < 0.05, "Značajno", "Nije značajno"),
    paste0(round((summary(model_semantic)$r.squared - summary(model_ar1)$r.squared) * 100, 1), " pp R²"),
    format(nrow(dt), big.mark = ","),
    paste(format(min(dt$date), "%m/%Y"), "-", format(max(dt$date), "%m/%Y"))
  )
)

kable(summary_findings, caption = "Sažetak ključnih nalaza") %>%
  kable_styling(bootstrap_options = c("striped", "hover"), full_width = FALSE)
```

## Daljnji pravci istraživanja

1. **Granularnije kategorije**: Razbiti taksonomiju na finiju razinu za preciznije praćenje sektorskih cijena
2. **Real-time aplikacija**: Implementirati sustav za dnevno praćenje semantičkog indeksa
3. **Tekstualni embedding modeli**: Koristiti LLM embeddings umjesto regex za fleksibilnije hvatanje semantike
4. **Proširenje na regiju**: Usporediti semantičke indekse za Sloveniju, Srbiju, Mađarsku
5. **Sentiment detaljnije**: Koristiti napredniju sentiment analizu (aspect-based, entity-level)
6. **Interakcija s očekivanjima**: Povezati sa anketama o inflacijskim očekivanjima

---

*Izvještaj generiran: `r Sys.time()`*

*GIMES Research | Semantički indeks inflacije v1.0*
